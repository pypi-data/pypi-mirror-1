Testing the flexible user registration
======================================

    >>> browser = self.browser
    >>> browser.open('http://nohost/plone')

    Self-registration is disabled, user does not see 'Register' link.
    >>> 'Register' in browser.contents
    False
    
    Enable self-registration
    >>> browser.open('http://nohost/plone/login_form')
    >>> browser.getControl('Login Name').value = 'admin'
    >>> browser.getControl('Password').value = 'secret'
    >>> browser.getControl('Log in').click()
    >>> browser.open('http://nohost/plone/@@security-controlpanel')
    >>> browser.getControl('Enable self-registration').selected = True
    >>> browser.getControl('Save').click()
    >>> 'Changes saved' in browser.contents
    True

    >>> browser.getLink(url='http://nohost/plone/logout').click()
    >>> 'Log in' in browser.contents
    True
    
    Logged out user should now see the register link.
    >>> 'Register' in browser.contents
    True
    
    >>> browser.getLink('Register').click()
    >>> '@@register' in browser.url
    True

    No mailhost has been set up yet. User should not be able to see the form.
    >>> browser.contents
    '...This site...valid email setup...cannot register at this time...'
    >>> 'User Name' in browser.contents
    False
    
    Check that the form is not displayed when no mailhost is defined and users
    cannot choose their own passwords. 
    >>> 'User Name' in browser.contents
    False
    >>> 'Password' in browser.contents
    False
    >>> 'Confirm password' in browser.contents
    False

    Set up a mailhost...
    >>> self.setMailHost()
    >>> browser.open('http://nohost/plone/@@register')

    The form should now be visible, sans password, since the user still cannot
    set it.
    >>> 'User Name' in browser.contents
    True
    >>> 'Password' in browser.contents
    False
    >>> 'Confirm password' in browser.contents
    False

    Ensure that fields are being validated
    >>> browser.getControl('Register').click()
    >>> browser.contents
    '...There were errors...User Name...Required input is missing...E-mail...Required input is missing...'
    
    Fill out the form. 
    >>> browser.getControl('User Name').value = 'user1'
    >>> browser.getControl('E-mail').value = 'user1@foo.com'
    >>> browser.getControl('Register').click()
    
    Disable the mailhost and enable user ability to set their own password.
    >>> self.unsetMailHost()
    >>> browser.open('http://nohost/plone/login_form')
    >>> browser.getControl('Login Name').value = 'admin'
    >>> browser.getControl('Password').value = 'secret'
    >>> browser.getControl('Log in').click()
    >>> browser.open('http://nohost/plone/@@security-controlpanel')
    >>> browser.getControl('Let users select their own passwords').selected = True
    >>> browser.getControl('Save').click()
    >>> 'Changes saved' in browser.contents
    True
    
    
    
    >>> browser.getLink(url='http://nohost/plone/logout').click()
    >>> 'Log in' in browser.contents
    True
    
    >>> browser.getLink('Register').click()
    >>> '@@register' in browser.url
    True
    
    Check that password is now displayed
    >>> 'Password' in browser.contents
    True
    >>> 'Confirm password' in browser.contents
    True
    
    Fill out the form.
    >>> browser.getControl('User Name').value = 'user1'
    >>> browser.getControl('E-mail').value = 'user1@foo.com'
    >>> browser.getControl('Password').value = 'secret'
    >>> browser.getControl('Confirm password').value = 'secret'
    >>> browser.getControl('Register').click()
    >>> browser.contents
    '...Welcome!...You have been registered...'

    Ensure that the user has, in fact, been added.
    >>> browser.open('http://nohost/plone/login_form')
    >>> browser.getControl('Login Name').value = 'admin'
    >>> browser.getControl('Password').value = 'secret'
    >>> browser.getControl('Log in').click()
    >>> browser.open('http://nohost/plone/@@usergroup-userprefs')
    >>> 'user1' in browser.contents
    True
    
    Great! The user-facing form works. Let's try the manager's version...
    >>> browser.open('http://nohost/plone/@@usergroup-userprefs')
    >>> browser.getControl('Add New User').click()
    >>> '@@new-user' in browser.url
    True    

    Check that password, mail prompt, and groups are displayed.
    >>> 'Password' in browser.contents
    True
    >>> 'Confirm password' in browser.contents
    True
    >>> 'Send a mail with the password' in browser.contents
    True
    >>> 'Add to the following groups' in browser.contents
    True
    
    Turn off the ability for users to set their own passwords.
    >>> browser.open('http://nohost/plone/@@security-controlpanel')
    >>> browser.getControl('Let users select their own passwords').selected = False
    >>> browser.getControl('Save').click()
    >>> 'Changes saved' in browser.contents
    True
    
    Check that password, mail prompt, and groups are still displayed.
    >>> browser.open('http://nohost/plone/@@new-user')
    >>> 'Password' in browser.contents
    True
    >>> 'Confirm password' in browser.contents
    True
    >>> 'Send a mail with the password' in browser.contents
    True
    >>> 'Add to the following groups' in browser.contents
    True
    
    Fill out the form.
    >>> browser.getControl('User Name').value = 'user2'
    >>> browser.getControl('E-mail').value = 'user2@foo.com'
    >>> browser.getControl('Password').value = 'secret'
    >>> browser.getControl('Confirm password').value = 'secret'
    >>> browser.getControl('Reviewers').selected = True
    >>> browser.getControl('Register').click()
    >>> '@@usergroup-userprefs' in browser.url
    True
    >>> browser.contents
    '...User added...user2...'
    
    Check that the selected group has been applied to the new user.
    >>> browser.getLink('user2').click()
    >>> browser.getLink('Group Memberships').click()
    >>> browser.contents
    '...Current Group Memberships...Reviewers...'
    
    
