<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>protlib - Easily implement binary network protocols &mdash; protlib v1.0 documentation</title>
    <link rel="stylesheet" href="_static/customizations.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '#',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="protlib v1.0 documentation" href="#" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="#">protlib v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <ul class="simple">
</ul>
<div class="section" id="protlib-easily-implement-binary-network-protocols">
<h1>protlib - Easily implement binary network protocols<a class="headerlink" href="#protlib-easily-implement-binary-network-protocols" title="Permalink to this headline">¶</a></h1>
<p>protlib builds on the
<a class="reference external" href="http://docs.python.org/library/struct.html">struct</a>
and
<a class="reference external" href="http://docs.python.org/library/socketserver.html">SocketServer</a>
modules in the standard library to make it easy to implement binary
network protocols. It provides support for default and constant struct
fields, nested structs, arrays of structs, better handling for strings
and arrays, struct inheritance, and convenient syntax for instantiating
and using your custom structs.</p>
<p>Here&#8217;s an example of defining, instantiating, writing, and reading a struct using file i/o:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">protlib</span> <span class="kn">import</span> <span class="o">*</span>
<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>

<span class="n">p1</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">p3</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">p1</span> <span class="o">==</span> <span class="n">p2</span> <span class="o">==</span> <span class="n">p3</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;point.dat&quot;</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">p1</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;point.dat&quot;</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">p4</span> <span class="o">=</span> <span class="n">Point</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">p1</span> <span class="o">==</span> <span class="n">p4</span>
</pre></div>
</div>
<p>You may use the
<a class="reference external" href="http://docs.python.org/library/socket.html#socket.socket.makefile">socket.makefile</a>
method to use this file i/o approach for sockets.</p>
</div>
<div class="section" id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h1>
<p>protlib requires Python 2.6 and will presumably work with Python 2.7 although this hasn&#8217;t
been tested.  It has no other dependencies.</p>
<p>You may <a class="reference external" href="http://courtwright.org/protlib/protlib.tar.gz">click here</a> to download protlib.
You may also run <tt class="docutils literal"><span class="pre">easy_install</span> <span class="pre">protlib</span></tt> if you have
<a class="reference external" href="http://peak.telecommunity.com/DevCenter/EasyInstall">EasyInstall</a> on your system.  The
project page for protlib in the Cheese Shop (aka the Python Package Index or PyPI) may
be found <a class="reference external" href="http://pypi.python.org/pypi/protlib/">here</a>.</p>
<p>You may also check out the development version of protlib with this command:</p>
<p><tt class="docutils literal"><span class="pre">svn</span> <span class="pre">checkout</span> <span class="pre">http://courtwright.org/svn/protlib</span></tt></p>
</div>
<div class="section" id="data-types">
<h1>Data Types<a class="headerlink" href="#data-types" title="Permalink to this headline">¶</a></h1>
<dl class="class">
<dt id="CType">
<em class="property">class </em><tt class="descname">CType</tt><big>(</big><em>**kwargs</em><big>)</big><a class="headerlink" href="#CType" title="Permalink to this definition">¶</a></dt>
<dd><p>This is the root class of all classes representing C data types
in the protlib library.  It may not be directly instantiated; you
must always use one of its subtypes instead.  There are three
optional arguments which you may pass to a CType:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>length</em> &#8211; only valid for the <tt class="docutils literal"><span class="pre">CString</span></tt> and <tt class="docutils literal"><span class="pre">CArray</span></tt> data types, for which
it is required</li>
<li><em>always</em> &#8211; <p>Use this to set a constant value for a field.  You won&#8217;t need to specify
this value, and a warning will be raised if the value differs from this
parameter when the struct is parsed or serialized.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">protlib</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">OriginPoint</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">y</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">op1</span> <span class="o">=</span> <span class="n">OriginPoint</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">op1</span>
<span class="go">OriginPoint(x=0, y=0)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">op1</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;origin.dat&quot;</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">op1</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="p">)</span>
<span class="gp">...</span>
<span class="go">protlib.py:159: CWarning: x should always be 0</span>
<span class="go">  warn(&quot;{0} should always be {1}&quot;.format(name, ctype.always), CWarning)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;origin.dat&quot;</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">op2</span> <span class="o">=</span> <span class="n">OriginPoint</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">protlib.py:149: CWarning: x should always be 0</span>
<span class="go">  warn(&quot;{0} should always be {1}&quot;.format(name, ctype.always), CWarning)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">op1</span> <span class="o">==</span> <span class="n">op2</span>
</pre></div>
</div>
</li>
<li><em>default</em> &#8211; <p>Like the <tt class="docutils literal"><span class="pre">always</span></tt> parameter, except that no warnings are raised when a
different value is parsed or serialized.  Also, a <tt class="docutils literal"><span class="pre">default</span></tt> parameter
may be either a value or a <tt class="docutils literal"><span class="pre">callable</span></tt> object.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">protlib</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">(</span><span class="n">default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">y</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">(</span><span class="n">default</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="mi">5</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span>
<span class="go">Point(x=0, y=5)</span>
</pre></div>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="attribute">
<dt id="CType.sizeof">
<tt class="descname">sizeof</tt><a class="headerlink" href="#CType.sizeof" title="Permalink to this definition">¶</a></dt>
<dd>The size of the packed binary data representing this <tt class="docutils literal"><span class="pre">CType</span></tt>.
Note that this is a <tt class="docutils literal"><span class="pre">classmethod</span></tt> for subclasses of <tt class="docutils literal"><span class="pre">CStruct</span></tt>.</dd></dl>

<dl class="attribute">
<dt id="CType.struct_format">
<tt class="descname">struct_format</tt><a class="headerlink" href="#CType.struct_format" title="Permalink to this definition">¶</a></dt>
<dd>The format string used by the underying
<a class="reference external" href="http://docs.python.org/library/struct.html">struct module</a>
to represent the packed binary data format.
Note that this is a <tt class="docutils literal"><span class="pre">classmethod</span></tt> for subclasses of <tt class="docutils literal"><span class="pre">CStruct</span></tt>.</dd></dl>

<dl class="method">
<dt id="CType.parse">
<tt class="descname">parse</tt><big>(</big><em>f</em><big>)</big><a class="headerlink" href="#CType.parse" title="Permalink to this definition">¶</a></dt>
<dd><p>Accepts either a string or a file-like object (anything with a <tt class="docutils literal"><span class="pre">read</span></tt> method)
and returns a Python object with the appropriate value.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">raw</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x00\x00\x00\x05</span><span class="s">&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span>
</pre></div>
</div>
<p>Note that unlike the struct module, strings are stripped of trailing null
bytes when they&#8217;re parsed.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">raw</span> <span class="o">=</span> <span class="s">&quot;foo</span><span class="se">\x00\x00</span><span class="s">&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">struct</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;5s&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&quot;foo</span><span class="se">\x00\x00</span><span class="s">&quot;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">protlib</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">CString</span><span class="p">(</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&quot;foo&quot;</span>
</pre></div>
</div>
<p>Note that this is a <tt class="docutils literal"><span class="pre">classmethod</span></tt> on subclasses of <tt class="docutils literal"><span class="pre">CStruct</span></tt>.</p>
</dd></dl>

<dl class="method">
<dt id="CType.serialize">
<tt class="descname">serialize</tt><big>(</big><em>x</em><big>)</big><a class="headerlink" href="#CType.serialize" title="Permalink to this definition">¶</a></dt>
<dd>Serializes the value according to the specific <tt class="docutils literal"><span class="pre">CType</span></tt> class.
Note that this takes no argument when called on a <tt class="docutils literal"><span class="pre">CStruct</span></tt>
instance.</dd></dl>

</dd></dl>

<div class="section" id="basic-data-types">
<h2>Basic Data Types<a class="headerlink" href="#basic-data-types" title="Permalink to this headline">¶</a></h2>
<p>Because protlib is built on top of struct module, each basic data type
in protlib uses a struct format string.  The list of struct format strings
<a class="reference external" href="http://docs.python.org/library/struct.html#struct.calcsize">may be found here</a>
and the protlib types which use them are listed below:</p>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="26%" />
<col width="46%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">C data type</th>
<th class="head">protlib class</th>
<th class="head">struct format string</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>char</td>
<td>CChar</td>
<td>b</td>
</tr>
<tr><td>unsigned char</td>
<td>CUChar</td>
<td>B</td>
</tr>
<tr><td>short</td>
<td>CShort</td>
<td>h</td>
</tr>
<tr><td>unsigned short</td>
<td>CUShort</td>
<td>H</td>
</tr>
<tr><td>int</td>
<td>CInt</td>
<td>i</td>
</tr>
<tr><td>unsigned int</td>
<td>CUInt</td>
<td>I</td>
</tr>
<tr><td>long</td>
<td>CLong</td>
<td>l</td>
</tr>
<tr><td>unsigned long</td>
<td>CULong</td>
<td>L</td>
</tr>
<tr><td>float</td>
<td>CFloat</td>
<td>f</td>
</tr>
<tr><td>double</td>
<td>CDouble</td>
<td>d</td>
</tr>
<tr><td>char[]</td>
<td>CString</td>
<td>Xs (e.g. 5s for char[5])</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="arrays">
<h2>Arrays<a class="headerlink" href="#arrays" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="CArray">
<em class="property">class </em><tt class="descname">CArray</tt><big>(</big><em>length</em>, <em>ctype</em><big>)</big><a class="headerlink" href="#CArray" title="Permalink to this definition">¶</a></dt>
<dd><p>You can make an array of any <tt class="docutils literal"><span class="pre">CType</span></tt>.  Arrays pack and unpack to and
from Python lists.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">ca</span> <span class="o">=</span> <span class="n">CArray</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">CInt</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">raw</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span> <span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">xs</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">xs</span> <span class="o">==</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
</pre></div>
</div>
<p>Arrays may either be given default/always values themselves or use the
default/always values of the <tt class="docutils literal"><span class="pre">CType</span></tt> they are given.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Triangle</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">xcoords</span> <span class="o">=</span> <span class="n">CArray</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">CInt</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">ycoords</span> <span class="o">=</span> <span class="n">CArray</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">CInt</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tri</span> <span class="o">=</span> <span class="n">Triangle</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">tri</span><span class="o">.</span><span class="n">xcoords</span> <span class="o">==</span> <span class="n">tri</span><span class="o">.</span><span class="n">ycoords</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="custom-structs">
<h2>Custom Structs<a class="headerlink" href="#custom-structs" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="CStruct">
<em class="property">class </em><tt class="descname">CStruct</tt><a class="headerlink" href="#CStruct" title="Permalink to this definition">¶</a></dt>
<dd><p>This should never be instantiated directly.  Instead, you should subclass
this when defining a custom struct.  Your subclass will be given a
constructor which takes the fields of your struct as positional and/or
keyword arguments.  However, you don&#8217;t have to provide values for your
fields at this time.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">y</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p1</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p2</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p2</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p2</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">6</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">p1</span> <span class="o">==</span> <span class="n">p2</span>
</pre></div>
</div>
<dl class="classmethod">
<dt id="CStruct.sizeof">
<em class="property">classmethod </em><tt class="descname">sizeof</tt><big>(</big><big>)</big><a class="headerlink" href="#CStruct.sizeof" title="Permalink to this definition">¶</a></dt>
<dd>Returns the size of the packed binary data needed to hold this
<tt class="docutils literal"><span class="pre">CStruct</span></tt></dd></dl>

<dl class="classmethod">
<dt id="CStruct.struct_format">
<em class="property">classmethod </em><tt class="descname">struct_format</tt><big>(</big><big>)</big><a class="headerlink" href="#CStruct.struct_format" title="Permalink to this definition">¶</a></dt>
<dd>Returns the format string used by the underlying struct module to
represent this <tt class="docutils literal"><span class="pre">CStruct</span></tt></dd></dl>

<dl class="classmethod">
<dt id="CStruct.parse">
<em class="property">classmethod </em><tt class="descname">parse</tt><big>(</big><em>f</em><big>)</big><a class="headerlink" href="#CStruct.parse" title="Permalink to this definition">¶</a></dt>
<dd>Accepts a string or file-like object and returns an instance of
this <tt class="docutils literal"><span class="pre">CStruct</span></tt>.</dd></dl>

<dl class="method">
<dt id="CStruct.serialize">
<tt class="descname">serialize</tt><big>(</big><big>)</big><a class="headerlink" href="#CStruct.serialize" title="Permalink to this definition">¶</a></dt>
<dd>Returns the packed binary data representing the values of
this <tt class="docutils literal"><span class="pre">CStruct</span></tt>.  This is what should be written to files and sockets.</dd></dl>

<dl class="method">
<dt id="CStruct.__repr__">
<tt class="descname">__repr__</tt><big>(</big><big>)</big><a class="headerlink" href="#CStruct.__repr__" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a literal representation of the <tt class="docutils literal"><span class="pre">CStruct</span></tt>.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">y</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span>
<span class="go">Point(x=5, y=6)</span>
</pre></div>
</div>
</dd></dl>

<dl class="classmethod">
<dt id="CStruct.get_fields">
<em class="property">classmethod </em><tt class="descname">get_fields</tt><big>(</big><big>)</big><a class="headerlink" href="#CStruct.get_fields" title="Permalink to this definition">¶</a></dt>
<dd>Returns a list of the <tt class="docutils literal"><span class="pre">CType</span></tt> objects which define the fields of
this struct in the order in which they were declared.</dd></dl>

<dl class="classmethod">
<dt id="CStruct.get_type">
<em class="property">classmethod </em><tt class="descname">get_type</tt><big>(</big><em>**kwargs</em><big>)</big><a class="headerlink" href="#CStruct.get_type" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns an objects which may be used to declare a <tt class="docutils literal"><span class="pre">CStruct</span></tt> as a
field in another <tt class="docutils literal"><span class="pre">CStruct</span></tt>.  This accepts the same <tt class="docutils literal"><span class="pre">default</span></tt>
and <tt class="docutils literal"><span class="pre">always</span></tt> parameters as the <tt class="docutils literal"><span class="pre">CType</span></tt> constructor.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">y</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Vector</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">p1</span> <span class="o">=</span> <span class="n">Point</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">p2</span> <span class="o">=</span> <span class="n">Point</span><span class="o">.</span><span class="n">get_type</span><span class="p">(</span><span class="n">default</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">v</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">p1</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>The order of struct fields is defined by the order in which the <tt class="docutils literal"><span class="pre">CType</span></tt>
subclasses for those fields were instantiated.  In other words, if you say</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">protlib</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">y_field</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>
<span class="n">x_field</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_field</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y_field</span>
</pre></div>
</div>
<p>then when you serialize your struct, the <tt class="docutils literal"><span class="pre">y</span></tt> field will come <strong>before</strong>
the <tt class="docutils literal"><span class="pre">x</span></tt> field because its <tt class="docutils literal"><span class="pre">CInt</span></tt> value was instantiated first.  Similarly,
if you say</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">protlib</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>
</pre></div>
</div>
<p class="last">then the order of the x and y fields is undefined since they share the same
<tt class="docutils literal"><span class="pre">CInt</span></tt> instance.  In this second case, a warning will be raised,
but the first case is not automatically detected by the protlib library.</p>
</div>
</div>
</div>
<div class="section" id="protocol-handlers">
<h1>Protocol Handlers<a class="headerlink" href="#protocol-handlers" title="Permalink to this headline">¶</a></h1>
<p>protlib also provides a convenient framework for implementing servers which receive and
return <tt class="docutils literal"><span class="pre">CStruct</span></tt> objects.  This makes it easy to implement custom binary protocols in
which structs are passed back and forth over socket connections.  This is based on
<a class="reference external" href="http://docs.python.org/library/socketserver.html">the SocketServer module</a>
in the Python standard library.</p>
<p>In order to use these examples, you must do only two things.</p>
<ul class="simple">
<li>First, make sure that each struct which represents a message begins with a constant
value which uniquely identifies that struct.</li>
<li>Second, define a subclass of the appropriate handler class, either <tt class="docutils literal"><span class="pre">TCPHandler</span></tt> or
<tt class="docutils literal"><span class="pre">UDPHandler</span></tt>, and define a handler method for each message type you wish to respond to.</li>
</ul>
<div class="section" id="an-example-client-server">
<h2>An example client/server<a class="headerlink" href="#an-example-client-server" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s walk through a simple example.  We&#8217;ll define several structs to represent geometric
concepts: a Point, a Vector, and a Rectangle.  Each of these structs is a message which
can be sent between the client and server. We&#8217;ll also define a variable-length message
called PointGroup; this struct contains the number of Point messages which immediately
follow the PointGroup struct in the message.</p>
<p>Note that first field in each of these messages is a constant value that uniquely
identifies the message.</p>
<p>This entire example can be found in the <tt class="docutils literal"><span class="pre">examples/geocalc</span></tt> directory.  Here&#8217;s the
<tt class="docutils literal"><span class="pre">common.py</span></tt> file, which is imported by both the <tt class="docutils literal"><span class="pre">server.py</span></tt> and <tt class="docutils literal"><span class="pre">client.py</span></tt> programs:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;../..&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">protlib</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">SERVER_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">12321</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">CShort</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">x</span>    <span class="o">=</span> <span class="n">CFloat</span><span class="p">()</span>
    <span class="n">y</span>    <span class="o">=</span> <span class="n">CFloat</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Vector</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">CShort</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">p1</span>   <span class="o">=</span> <span class="n">Point</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
    <span class="n">p2</span>   <span class="o">=</span> <span class="n">Point</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">PointGroup</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">CShort</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Rectangle</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">CShort</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">CArray</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">Point</span><span class="p">)</span>
</pre></div>
</div>
<p>For our server, we define a handler class with a handler method for each message we wish
to accept.  The name of each handler method should be the name of the message class in
lower case with the words separated by underscores.  For example, the <tt class="docutils literal"><span class="pre">Vector</span></tt> class
is handled by the <tt class="docutils literal"><span class="pre">vector</span></tt> method, and the <tt class="docutils literal"><span class="pre">PointGroup</span></tt> class is handled by the
<tt class="docutils literal"><span class="pre">point_group</span></tt> method.  Each of these handler methods takes a single parameter other
than <tt class="docutils literal"><span class="pre">self</span></tt> which is the actual message read and parsed from the socket.</p>
<p>Here&#8217;s the <tt class="docutils literal"><span class="pre">server.py</span></tt> file which uses our subclasses of
<a class="reference external" href="http://docs.python.org/library/socketserver.html">the SocketServer module</a>
classes to accept and handle incoming messages:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">TCPHandler</span><span class="p">):</span>
    <span class="n">LOG_TO_SCREEN</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns the mid-point of the line segment&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns the endpoint closest to the origin&quot;&quot;&quot;</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="p">[(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">points</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">dists</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">point_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns a rectangle which encompasses all points in the group&quot;&quot;&quot;</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">count</span><span class="p">)]</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">)</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">)</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Rectangle</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="p">[</span>
            <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ymin</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ymax</span><span class="p">),</span>
            <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ymin</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ymax</span><span class="p">)</span>
        <span class="p">])</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">LoggingTCPServer</span><span class="p">(</span><span class="n">SERVER_ADDR</span><span class="p">,</span> <span class="n">Handler</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>To test this server, we have a simple client which sends a series of messages to the
server and then reads back the responses, logging everything with our <tt class="docutils literal"><span class="pre">protlib.Logger</span></tt>
class.  Here&#8217;s our <tt class="docutils literal"><span class="pre">client.py</span></tt> script:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>

<span class="k">def</span> <span class="nf">rand_point</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">also_print</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">(</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">)</span>
<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">SERVER_ADDR</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&quot;r+b&quot;</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">vec</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">p1</span><span class="o">=</span><span class="n">rand_point</span><span class="p">(),</span> <span class="n">p2</span><span class="o">=</span><span class="n">rand_point</span><span class="p">())</span>
<span class="n">logger</span><span class="o">.</span><span class="n">log_and_write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">vec</span><span class="o">.</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">pt</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">vec</span><span class="o">.</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span> <span class="ow">or</span> <span class="n">vec</span><span class="o">.</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">pt</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">vec</span><span class="o">.</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span>
<span class="k">assert</span> <span class="n">vec</span><span class="o">.</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">vec</span><span class="o">.</span><span class="n">p2</span><span class="o">.</span><span class="n">y</span> <span class="ow">or</span> <span class="n">vec</span><span class="o">.</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">vec</span><span class="o">.</span><span class="n">p2</span><span class="o">.</span><span class="n">y</span>

<span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                         <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
                         <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                         <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">5</span><span class="p">)])</span>
<span class="n">logger</span><span class="o">.</span><span class="n">log_and_write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">pt</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span>

<span class="n">logger</span><span class="o">.</span><span class="n">log_and_write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">PointGroup</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log_and_write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">rand_point</span><span class="p">())</span>
<span class="n">rect</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">rect</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">Rectangle</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">always</span>

<span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Our server does all of our logging automatically, but we need to manually invoke the
logger on the client.  The logs created and their format are explained below.</p>
</div>
<div class="section" id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>If you use the <tt class="docutils literal"><span class="pre">LoggingTCPServer</span></tt> and <tt class="docutils literal"><span class="pre">LoggingUDPServer</span></tt> classes, then everything is
logged for us.  There are 4 logs created, a <cite>struct_log</cite>, a <cite>raw_log</cite>, an <cite>error_log</cite>, and
a <cite>stack_log</cite>.  The log prefix is the name of the script being executed.  So if we&#8217;re
executing <tt class="docutils literal"><span class="pre">server.py</span></tt> then our log files will be <tt class="docutils literal"><span class="pre">server.struct_log</span></tt>, <tt class="docutils literal"><span class="pre">server.raw_log</span></tt>,
etc.  All logs are opened in append mode.</p>
<p>Each log message contains a timestamp followed by a unique identifier which indicates the
specific message being received.  This makes it easy to match the log messages in the
different files to one another, since the unique message identifier will be present in
each of the 4 logs.</p>
<p>Here&#8217;s a description of each log:</p>
<dl class="attribute">
<dt id="struct_log">
<tt class="descname">struct_log</tt><a class="headerlink" href="#struct_log" title="Permalink to this definition">¶</a></dt>
<dd><p>This contains the literal representation of each request and response, for example:</p>
<div class="highlight-none"><div class="highlight"><pre>2010-01-14 11:14:37.771015 (1263485677_0): received Vector(code=2, p1=Point(code=1, x=31.0, y=24.0), p2=Point(code=1, x=12.0, y=52.0))
2010-01-14 11:14:37.771170 (1263485677_0): sending Point(code=1, x=21.5, y=38.0)
</pre></div>
</div>
<p>This is convenient because the structs are logged with the Python code which represents
them.  Therefore we can paste them directly into a Python command prompt to inspect and
play around with them:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">21.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">38.0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span>
<span class="go">Point(code=1, x=21.5, y=38.0)</span>
</pre></div>
</div>
</dd></dl>

<dl class="attribute">
<dt id="raw_log">
<tt class="descname">raw_log</tt><a class="headerlink" href="#raw_log" title="Permalink to this definition">¶</a></dt>
<dd><p>This contains the raw data in the form of a Python string of each request and response,
for example:</p>
<div class="highlight-none"><div class="highlight"><pre>2010-01-14 11:14:37.770419 (1263485677_0): received &#39;\x00\x02\x00\x01A\xf8\x00\x00A\xc0\x00\x00\x00\x01A@\x00\x00BP\x00\x00&#39;
2010-01-14 11:14:37.771247 (1263485677_0): sending &#39;\x00\x01A\xac\x00\x00B\x18\x00\x00&#39;
</pre></div>
</div>
<p>This is convenient because we can paste these strings into a Python command prompt
and play around with them.  If they are valid then we can parse them into structs, and
if they aren&#8217;t then we can examine exactly why; this log will always log what we receive
even in the case of unparsable binary data:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x00\x01</span><span class="s">A</span><span class="se">\xac\x00\x00</span><span class="s">B</span><span class="se">\x18\x00\x00</span><span class="s">&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span>
<span class="go">Point(code=1, x=21.5, y=38.0)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s">&quot;bad&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Point</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n-Identifier">&lt;module&gt;</span>
  File <span class="nb">&quot;protlib.py&quot;</span>, line <span class="m">230</span>, in <span class="n-Identifier">parse</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_type</span><span class="p">(</span><span class="n">cached</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  File <span class="nb">&quot;protlib.py&quot;</span>, line <span class="m">141</span>, in <span class="n-Identifier">parse</span>
    <span class="k">raise</span> <span class="n">CError</span><span class="p">(</span><span class="s">&quot;{0} requires {1} bytes and was only given {2} ({3!r})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclass</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizeof</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">buf</span><span class="p">))</span>
<span class="nc">protlib.CError</span>: <span class="n-Identifier">Point requires 10 bytes and was only given 3 (&#39;bad&#39;)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s">&quot;invalid but with enough data&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="go">../../protlib.py:148: CWarning: code should always be 1</span>
<span class="go">  warn(&quot;{0} should always be {1}&quot;.format(name, ctype.always), CWarning)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span>
<span class="go">Point(code=26990, x=1.1430328245747994e+33, y=1.1834294514326081e+22)</span>
</pre></div>
</div>
</dd></dl>

<dl class="attribute">
<dt id="error_log">
<tt class="descname">error_log</tt><a class="headerlink" href="#error_log" title="Permalink to this definition">¶</a></dt>
<dd>This contains messages for common errors, such as when a message is too short, or
when we have no handler to match a message we&#8217;ve received, etc.  These messages
contain as much information as possible to help reconstruct the problem, which
usually includes the raw data involved (also present in the <tt class="docutils literal"><span class="pre">raw_log</span></tt>).</dd></dl>

<dl class="attribute">
<dt id="stack_log">
<tt class="descname">stack_log</tt><a class="headerlink" href="#stack_log" title="Permalink to this definition">¶</a></dt>
<dd>This contains any stack traces which occur while the server is running.  This is
useful for diagnosing problems in your handler methods.</dd></dl>

</div>
<div class="section" id="protocol-handler-classes">
<h2>Protocol Handler Classes<a class="headerlink" href="#protocol-handler-classes" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="ProtHandler">
<em class="property">class </em><tt class="descname">ProtHandler</tt><a class="headerlink" href="#ProtHandler" title="Permalink to this definition">¶</a></dt>
<dd><p>The user does not instantiate this class or any of its subclasses directly.  Instead,
you declare your own handler class which subclasses either <tt class="docutils literal"><span class="pre">TCPServer</span></tt> or
<tt class="docutils literal"><span class="pre">UDPServer</span></tt>, which are themselves subclasses of <tt class="docutils literal"><span class="pre">ProtHandler</span></tt>.  They also extend
<a class="reference external" href="http://docs.python.org/library/socketserver.html#requesthandler-objects">the StreamRequestHandler and DatagramRequestHandler classes</a>
of the SocketServer module, respectively.</p>
<p>Here are all fields and methods which the user is expected to call and/or override:</p>
<dl class="attribute">
<dt id="ProtHandler.STRUCT_MOD">
<tt class="descname">STRUCT_MOD</tt><a class="headerlink" href="#ProtHandler.STRUCT_MOD" title="Permalink to this definition">¶</a></dt>
<dd><p>By default, your handler will detect all messages present in the same module
where the handler class itself is defined.  So you can either define your handler
in the same module where your structs are  defined, or you can import those
structs into the handler module.  This is the recommended way to integrate your
handlers with your struct definitions.</p>
<p>However, you may instead set the STRUCT_MOD field to the module where the structs
are declared. (Technically you can set this to anything with <tt class="docutils literal"><span class="pre">__dict__</span></tt> and
<tt class="docutils literal"><span class="pre">__name__</span></tt> fields.)  You may also set this to a string which is the name of
the module where they are declared.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">module_with_structs</span>

<span class="k">class</span> <span class="nc">SomeHandler</span><span class="p">(</span><span class="n">TCPHandler</span><span class="p">):</span>
    <span class="n">STRUCT_MOD</span> <span class="o">=</span> <span class="n">module_with_structs</span>

    <span class="c"># handler methods go here</span>

<span class="k">class</span> <span class="nc">AnotherHandler</span><span class="p">(</span><span class="n">UDPHandler</span><span class="p">):</span>
    <span class="n">STRUCT_MOD</span> <span class="o">=</span> <span class="s">&quot;module_with_structs&quot;</span>

    <span class="c"># handler methods go here</span>
</pre></div>
</div>
</dd></dl>

<dl class="attribute">
<dt id="ProtHandler.LOG_DIR">
<tt class="descname">LOG_DIR</tt><a class="headerlink" href="#ProtHandler.LOG_DIR" title="Permalink to this definition">¶</a></dt>
<dd>This is <tt class="docutils literal"><span class="pre">&quot;.&quot;</span></tt> by default and determines the location of the log files.</dd></dl>

<dl class="attribute">
<dt id="ProtHandler.LOG_TO_SCREEN">
<tt class="descname">LOG_TO_SCREEN</tt><a class="headerlink" href="#ProtHandler.LOG_TO_SCREEN" title="Permalink to this definition">¶</a></dt>
<dd>This is <tt class="xref docutils literal"><span class="pre">False</span></tt> by default, but if set to <tt class="xref docutils literal"><span class="pre">True</span></tt>, every log message will be
printed to the screen in addition to being written to the appropriate log.</dd></dl>

<dl class="attribute">
<dt id="ProtHandler.HEX_LOGGING">
<tt class="descname">HEX_LOGGING</tt><a class="headerlink" href="#ProtHandler.HEX_LOGGING" title="Permalink to this definition">¶</a></dt>
<dd><p>This is <tt class="xref docutils literal"><span class="pre">False</span></tt> but default, but if set to <tt class="xref docutils literal"><span class="pre">True</span></tt>, the <tt class="docutils literal"><span class="pre">raw_log</span></tt> will
contain a nicely formatted hex dump of the binary data sent and received.
For example:</p>
<div class="highlight-none"><div class="highlight"><pre>2010-01-14 13:47:37.237310 (1263494857_2): sending &#39;\x00\x04\x00\x01A\x98\x00\x00AP\x00\x00\x00\x01A\x98\x00\x00B\xae\x00\x00\x00\x01B\xc2\x00\x00AP\x00\x00\x00\x01B\xc2\x00\x00B\xae\x00\x00&#39;
     0  1  2  3  4  5  6  7
  0  00 04 00 01 41 98 00 00
  8  41 50 00 00 00 01 41 98
 16  00 00 42 ae 00 00 00 01
 24  42 c2 00 00 41 50 00 00
 32  00 01 42 c2 00 00 42 ae
 40  00 00
</pre></div>
</div>
<p>These are best set where your custom handler class is defined, for example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">TCPHandler</span><span class="p">):</span>
    <span class="n">HEX_LOGGING</span> <span class="o">=</span> <span class="n">LOG_TO_SCREEN</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># handler methods would go here</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="ProtHandler.raw_data">
<tt class="descname">raw_data</tt><big>(</big><em>data</em><big>)</big><a class="headerlink" href="#ProtHandler.raw_data" title="Permalink to this definition">¶</a></dt>
<dd>This is the default handler for any message for which no struct has been
defined.  By default this logs an error message and sends no reply.  Override
this if you wish to have your own handler for unclassified binary messages;
the <tt class="docutils literal"><span class="pre">data</span></tt> parameter is a string containing the binary data of the message.</dd></dl>

<dl class="method">
<dt id="ProtHandler.reply">
<tt class="descname">reply</tt><big>(</big><em>data</em><big>)</big><a class="headerlink" href="#ProtHandler.reply" title="Permalink to this definition">¶</a></dt>
<dd><p>Anything you return a handler method is sent back to the client, whether it&#8217;s
a struct or just binary data in a string.  However, sometimes you may need to
send multiple messages back to the client.  You can manually concatenate the
binary data strings, or you can use the <tt class="docutils literal"><span class="pre">reply</span></tt> method, for example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RepeatRequest</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">CShort</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CString</span><span class="p">(</span><span class="n">length</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
    <span class="n">repititions</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">TCPHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">repeat_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rr</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">repititions</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s">&quot;Hello &quot;</span> <span class="o">+</span> <span class="n">sm</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="LoggingTCPServer">
<em class="property">class </em><tt class="descname">LoggingTCPServer</tt><big>(</big><em>addr</em>, <em>handler_class</em><big>)</big><a class="headerlink" href="#LoggingTCPServer" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="class">
<dt id="LoggingUDPServer">
<em class="property">class </em><tt class="descname">LoggingUDPServer</tt><big>(</big><em>addr</em>, <em>handler_class</em><big>)</big><a class="headerlink" href="#LoggingUDPServer" title="Permalink to this definition">¶</a></dt>
<dd>These classes extend the
<a class="reference external" href="http://docs.python.org/library/socketserver.html#socketserver-tcpserver-example">TCPServer</a>
and the
<a class="reference external" href="http://docs.python.org/library/socketserver.html#socketserver-udpserver-example">UDPServer</a>
classes from the SocketServer module, respectively.  You should use these to get the
automated logging described above.  However, you may simply use the <tt class="docutils literal"><span class="pre">TCPServer</span></tt>
and <tt class="docutils literal"><span class="pre">UDPServer</span></tt> classes instead if you&#8217;d prefer to do your own logging.</dd></dl>

<dl class="class">
<dt id="Logger">
<em class="property">class </em><tt class="descname">Logger</tt><big>(</big><span class="optional">[</span><em>log_dir=&quot;.&quot;</em><span class="optional">[</span>, <em>hex_logging=False</em><span class="optional">[</span>, <em>also_print=False</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#Logger" title="Permalink to this definition">¶</a></dt>
<dd><p>A logging object which creates the 4 logs listed above.  If <tt class="docutils literal"><span class="pre">prefix</span></tt> is omitted, then
all log messages are printed to standard output and no files are created.</p>
<p>If you use the logging servers listed above then the logging is done automatically, but
if you&#8217;re implementing a client program, then you can use this class to perform
the same type of logging.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>log_dir</em> &#8211; the directory where the logfiles will be written</li>
<li><em>hex_logging</em> &#8211; whether to print a hexdump as part of each <tt class="docutils literal"><span class="pre">raw_log</span></tt> message</li>
<li><em>also_print</em> &#8211; whether to also print log messages to the screen</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="Logger.log_struct">
<tt class="descname">log_struct</tt><big>(</big><em>inst</em><span class="optional">[</span>, <em>trans_type=&quot;received&quot;</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#Logger.log_struct" title="Permalink to this definition">¶</a></dt>
<dd><p>Logs the <tt class="docutils literal"><span class="pre">repr</span></tt> of an instance of a <tt class="docutils literal"><span class="pre">CStruct</span></tt> subclass to the <tt class="docutils literal"><span class="pre">struct_log</span></tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>inst</em> &#8211; the instance of the struct to be logged</li>
<li><em>trans_type</em> &#8211; a prefix to the log message, generally this should be either
<tt class="docutils literal"><span class="pre">&quot;sending&quot;</span></tt> or <tt class="docutils literal"><span class="pre">&quot;received&quot;</span></tt></li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Logger.log_raw">
<tt class="descname">log_raw</tt><big>(</big><em>data</em><span class="optional">[</span>, <em>trans_type=&quot;received&quot;</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#Logger.log_raw" title="Permalink to this definition">¶</a></dt>
<dd><p>Logs the <tt class="docutils literal"><span class="pre">repr</span></tt> of the packed binary data to the <tt class="docutils literal"><span class="pre">raw_log</span></tt>.  If hex logging
is enabled, this will also log a nicely formatted table of the hexadecimal
values of this data immediately after the log message.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>data</em> &#8211; the packed binary data, such as what&#8217;s produced by calling
<tt class="docutils literal"><span class="pre">s.serialize()</span></tt> on an instance of a <tt class="docutils literal"><span class="pre">CStruct</span></tt> subclass</li>
<li><em>trans_type</em> &#8211; a prefix to the log message, generally this should be either
<tt class="docutils literal"><span class="pre">&quot;sending&quot;</span></tt> or <tt class="docutils literal"><span class="pre">&quot;received&quot;</span></tt></li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Logger.log_error">
<tt class="descname">log_error</tt><big>(</big><em>message</em>, <em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#Logger.log_error" title="Permalink to this definition">¶</a></dt>
<dd>Logs the message to the <tt class="docutils literal"><span class="pre">error_log</span></tt>.  The <tt class="docutils literal"><span class="pre">message</span></tt> parameter should be
a string, and the <tt class="docutils literal"><span class="pre">*args</span></tt> and <tt class="docutils literal"><span class="pre">**kwargs</span></tt> to this method are used as the
parameters to <a class="reference external" href="http://docs.python.org/library/stdtypes.html#str.format">str.format</a></dd></dl>

<dl class="method">
<dt id="Logger.log_stacktrace">
<tt class="descname">log_stacktrace</tt><big>(</big><big>)</big><a class="headerlink" href="#Logger.log_stacktrace" title="Permalink to this definition">¶</a></dt>
<dd>Logs the value of <a class="reference external" href="http://docs.python.org/library/traceback.html#traceback.format_exc">traceback.format_exc()</a>
to the <tt class="docutils literal"><span class="pre">stack_log</span></tt>.</dd></dl>

</dd></dl>

<dl class="class">
<dt id="Parser">
<em class="property">class </em><tt class="descname">Parser</tt><big>(</big><span class="optional">[</span><em>module</em><span class="optional">[</span>, <em>logger</em><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#Parser" title="Permalink to this definition">¶</a></dt>
<dd><p>If you know what struct you want, then you can use the <tt class="docutils literal"><span class="pre">CStruct.parse</span></tt> classmethod
to read an instance of that struct from a file, e.g. <tt class="docutils literal"><span class="pre">p</span> <span class="pre">=</span> <span class="pre">Point.parse(f)</span></tt>.  However,
in some cases you want to read some data from a file or socket but aren&#8217;t sure what
message is coming across.  This class&#8217;s <tt class="docutils literal"><span class="pre">parse</span></tt> method figures out which message
is being read and returns an instance of the correct struct.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>module</em> &#8211; This is exactly the same as the <tt class="docutils literal"><span class="pre">ProtHandler.STRUCT_MOD</span></tt> field;
if present then it indicates which module contains the struct classes
you want to use.  If omitted, then the module where this class is
instantiated is used.</li>
<li><em>logger</em> &#8211; The instance of the <tt class="docutils literal"><span class="pre">Logger</span></tt> class to use to perform logging.  If
omitted, no logging will be performed.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="Parser.parse">
<tt class="descname">parse</tt><big>(</big><em>f</em><big>)</big><a class="headerlink" href="#Parser.parse" title="Permalink to this definition">¶</a></dt>
<dd><p>This method accepts a string or file and returns an instance of the struct
it reads from that string/file.  If the data it finds cannot be parsed into
a struct, then it just returns all of the data it is able to read.  This
may be an empty string if no data is available.</p>
<p><tt class="xref docutils literal"><span class="pre">None</span></tt> will be returned in the case of an incomplete message.  In this case
a message will be written to the <tt class="docutils literal"><span class="pre">error_log</span></tt> if a logger was provided.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="struct-inheritance">
<h2>Struct Inheritance<a class="headerlink" href="#struct-inheritance" title="Permalink to this headline">¶</a></h2>
<p>Many binary protocols have many message types, but every message has exactly the same
fields, even if those fields have different lengths.  It would be annoying if you had
to write a bunch of mostly-identical struct definitions, so protlib lets you subclass
your custom structs and only override the fields which are different in some way,
such as having a default value in some subclasses but not others, etc.</p>
<p>Let&#8217;s walk through a simple example, which is available in the <tt class="docutils literal"><span class="pre">examples/struct_inheritance</span></tt>
directory.  First, we define our messages in <tt class="docutils literal"><span class="pre">common.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;../..&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">protlib</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">SERVER_ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">5665</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Message</span><span class="p">(</span><span class="n">CStruct</span><span class="p">):</span>
    <span class="n">code</span>      <span class="o">=</span> <span class="n">CInt</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">CString</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">))</span>
    <span class="n">comment</span>   <span class="o">=</span> <span class="n">CString</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">params</span>    <span class="o">=</span> <span class="n">CArray</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">CInt</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">ErrorMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span> <span class="n">code</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CCRequest</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>    <span class="n">code</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CCResponse</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>   <span class="n">code</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ZipRequest</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>   <span class="n">code</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ZipResponse</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>  <span class="n">code</span> <span class="o">=</span> <span class="n">CInt</span><span class="p">(</span><span class="n">always</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case we have a standard message format, and the only thing that varies is
the value of the <tt class="docutils literal"><span class="pre">code</span></tt> field, so we need only specify that field in our subclasses.
If we needed to override other fields, we could do so in any order; the order of
fields would remain as however they were declared in the parent class.</p>
<p>Since these messages all have different constant values in their first field, we can
write a normal handler class in our <tt class="docutils literal"><span class="pre">server.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">credit_card_lookup</span><span class="p">(</span><span class="n">ssn</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ssn</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">9</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">randrange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">zip_lookup</span><span class="p">(</span><span class="n">ssn</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ssn</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">9</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">randrange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">TCPHandler</span><span class="p">):</span>
    <span class="n">LOG_TO_SCREEN</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">cc_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the credit card number of the person with the given SSN&quot;&quot;&quot;</span>
        <span class="n">ssn</span> <span class="o">=</span> <span class="n">ccr</span><span class="o">.</span><span class="n">params</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">cc_num</span> <span class="o">=</span> <span class="n">credit_card_lookup</span><span class="p">(</span><span class="n">ssn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cc_num</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CCResponse</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="n">cc_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ErrorMessage</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">ssn</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&quot;No matching SSN&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">zip_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the zip code of the person with the given SSN&quot;&quot;&quot;</span>
        <span class="n">ssn</span> <span class="o">=</span> <span class="n">zr</span><span class="o">.</span><span class="n">params</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">zip_code</span> <span class="o">=</span> <span class="n">zip_lookup</span><span class="p">(</span><span class="n">ssn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zip_code</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZipResponse</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="n">zip_code</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ErrorMessage</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">ssn</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&quot;No matching SSN&quot;</span><span class="p">)</span>
        
<span class="n">server</span> <span class="o">=</span> <span class="n">LoggingTCPServer</span><span class="p">(</span><span class="n">SERVER_ADDR</span><span class="p">,</span> <span class="n">Handler</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>Since our handler can return different types of messages depending on whether our lookup
was successful, our <tt class="docutils literal"><span class="pre">client.py</span></tt> uses the <tt class="docutils literal"><span class="pre">Parser</span></tt> class to parse all incoming messages:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">also_print</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">(</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rand_ssn</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">randrange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">)]</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">SERVER_ADDR</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&quot;r+b&quot;</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">log_and_write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">CCRequest</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">rand_ssn</span><span class="p">()))</span>
<span class="n">ccresp</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">ccresp</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">CCResponse</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">always</span>

<span class="n">logger</span><span class="o">.</span><span class="n">log_and_write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ZipRequest</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">rand_ssn</span><span class="p">()))</span>
<span class="n">zresp</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">zresp</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">ZipResponse</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">always</span>

<span class="n">logger</span><span class="o">.</span><span class="n">log_and_write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ZipRequest</span><span class="p">())</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">err</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">ErrorMessage</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">always</span>

<span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="miscellaneous-classes-methods-and-constants">
<h1>Miscellaneous classes, methods, and constants<a class="headerlink" href="#miscellaneous-classes-methods-and-constants" title="Permalink to this headline">¶</a></h1>
<dl class="class">
<dt id="CError">
<em class="property">class </em><tt class="descname">CError</tt><a class="headerlink" href="#CError" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="class">
<dt id="CWarning">
<em class="property">class </em><tt class="descname">CWarning</tt><a class="headerlink" href="#CWarning" title="Permalink to this definition">¶</a></dt>
<dd>All exceptions and warnings raised by the protlib module will be instances of these classes.</dd></dl>

<dl class="function">
<dt id="underscorize">
<tt class="descname">underscorize</tt><big>(</big><em>name</em><big>)</big><a class="headerlink" href="#underscorize" title="Permalink to this definition">¶</a></dt>
<dd><p>This is the function used to convert between <tt class="docutils literal"><span class="pre">camelCased</span></tt> and
<tt class="docutils literal"><span class="pre">separated_with_underscores</span></tt> names.  Pass it a string and it returns an
all-lower-case string with underscores inserted in the appropriate places.  You
never have to call this method yourself, but you can use it as a test if you&#8217;re
unsure of the correct handler method name for one of your <tt class="docutils literal"><span class="pre">CStruct</span></tt> class.  To
make it even clearer, here are some examples:</p>
<div class="highlight-none"><div class="highlight"><pre>SomeStruct   -&gt; some_struct
SSNLookup    -&gt; ssn_lookup
RS485Adaptor -&gt; rs485_adaptor
Rot13Encoded -&gt; rot13_encoded
RequestQ     -&gt; request_q
John316      -&gt; john316
</pre></div>
</div>
<p>If your struct names are already lower case then this function will just return the
original string, whether or not you are already using underscores.
So the <tt class="docutils literal"><span class="pre">rs485adaptor</span></tt> struct would be handled by the <tt class="docutils literal"><span class="pre">rs485adaptor</span></tt> handler
method, and the <tt class="docutils literal"><span class="pre">rot13_encoded</span></tt> struct would be handled by the <tt class="docutils literal"><span class="pre">rot13_encoded</span></tt>
handler method, etc.</p>
</dd></dl>

<dl class="function">
<dt id="hexdump">
<tt class="descname">hexdump</tt><big>(</big><em>data</em><big>)</big><a class="headerlink" href="#hexdump" title="Permalink to this definition">¶</a></dt>
<dd><p>Takes a string and returns a string containing a nicely formatted table of the
hexadecimal values of the data in that string.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">protlib</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">hexdump</span><span class="p">(</span><span class="s">&quot;Hello World!&quot;</span><span class="p">)</span>
<span class="go">     0  1  2  3  4  5  6  7</span>
<span class="go">  0  48 65 6c 6c 6f 20 57 6f</span>
<span class="go">  8  72 6c 64 21</span>
</pre></div>
</div>
</dd></dl>

<dl class="attribute">
<dt id="BYTE_ORDER">
<tt class="descname">BYTE_ORDER</tt><a class="headerlink" href="#BYTE_ORDER" title="Permalink to this definition">¶</a></dt>
<dd>The first character of the format string passed to
<a class="reference external" href="http://docs.python.org/library/struct.html">the struct module</a>
which determines the byte order used to parse and serialize our structs.  By default
this is set to <tt class="docutils literal"><span class="pre">&quot;!&quot;</span></tt>, which indicates network byte order.  You may change it to
any of the options availbale in the struct module.</dd></dl>

<dl class="attribute">
<dt id="PROTLIB_DEFAULT_TIMEOUT">
<tt class="descname">PROTLIB_DEFAULT_TIMEOUT</tt><a class="headerlink" href="#PROTLIB_DEFAULT_TIMEOUT" title="Permalink to this definition">¶</a></dt>
<dd><p>When protlib is imported, it checks whether anyone has set a default socket timeout
with the <a class="reference external" href="http://docs.python.org/library/socket.html#socket.setdefaulttimeout">socket.setdefaulttimeout</a>
method and if a default does not already exist, it sets the timeout to this value,
which is 5 seconds.</p>
<p>Even if you unset the default timeout, this value will still be used in calls to
<a class="reference external" href="http://docs.python.org/library/select.html#select.select">select</a>
by the <tt class="docutils literal"><span class="pre">TCPHandler</span></tt> class.</p>
</dd></dl>

</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="#">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">protlib - Easily implement binary network protocols</a></li>
<li><a class="reference external" href="#installation">Installation</a></li>
<li><a class="reference external" href="#data-types">Data Types</a><ul>
<li><a class="reference external" href="#basic-data-types">Basic Data Types</a></li>
<li><a class="reference external" href="#arrays">Arrays</a></li>
<li><a class="reference external" href="#custom-structs">Custom Structs</a></li>
</ul>
</li>
<li><a class="reference external" href="#protocol-handlers">Protocol Handlers</a><ul>
<li><a class="reference external" href="#an-example-client-server">An example client/server</a></li>
<li><a class="reference external" href="#logging">Logging</a></li>
<li><a class="reference external" href="#protocol-handler-classes">Protocol Handler Classes</a></li>
<li><a class="reference external" href="#struct-inheritance">Struct Inheritance</a></li>
</ul>
</li>
<li><a class="reference external" href="#miscellaneous-classes-methods-and-constants">Miscellaneous classes, methods, and constants</a></li>
</ul>

            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/index.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="#">protlib v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2010, Eli Courtwright.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.4.
    </div>
  </body>
</html>