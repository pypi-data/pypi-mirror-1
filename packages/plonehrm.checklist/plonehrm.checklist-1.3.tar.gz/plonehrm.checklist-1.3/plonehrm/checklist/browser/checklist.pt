<div i18n:domain="checklist"
     tal:define="mtool context/portal_membership"
     tal:omit-tag=""
     tal:condition="python: mtool.checkPermission('plonehrm: view tasks viewlet', context)">

  <dl class="module" id="checklist">
    <dt class="moduleHeader">

      <a class="moduleButton" href=""
	 id="add_task_button"
	 tal:condition="view/canEditItems">
        <img src="add_icon.gif"
             alt="Add task"
             title="Add task"
             i18n:attributes="title label_add_task;
                              alt label_add_task;" />
      </a>

      <span tal:omit-tag=""
            i18n:translate="head_checklist">Tasks</span>
    </dt>
    <dd class="moduleItem">

      <!-- If the mode is set to list, we display the list of items. -->
      <tal:block tal:condition="python: view.view_mode == 'list'"
		 tal:define="toLocalizedTime nocall:context/@@plone/toLocalizedTime;">
	<form name="remaining_items_form"
              method="post"
              id="remainingitemsform"
              action=""
              tal:attributes="action string:${context/absolute_url}/@@update_checklist"
              tal:condition="view/any_items_left">

	  <table class="noteslist">
        <thead>
       <tr>
          <th />
          <th class="checklist-header-tasks" i18n:translate="checklist-header-tasks">Tasks</th>
          <th class="checklist-header-date" i18n:translate="checklist-header-date">Due date</th>
          <th />
       </tr>
        </thead>
	    <tbody tal:define="edit_manager view/canEditManagerItems;
                               edit_normal view/canEditItems;">
              <tal:block tal:repeat="item view/checklist/remainingAllItems">
		<tr tal:define="can_edit_this_item python:
				(item.isManager and edit_manager) or (not item.isManager and edit_normal)">
		  <td>
		    <input type="checkbox"
			   tal:condition="can_edit_this_item"
			   name="item"
			   id="item"
			   value="item"
			   tal:attributes="name item/id;
					   id item/id;
					   value item/id;"/>
		    <input type="checkbox"
			   tal:condition="not:can_edit_this_item"
			   name="item"
			   id="item"
			   value="item"
			   disabled="1"
			   tal:attributes="name item/id;
					   id item/id;
					   value item/text;"/>
		  </td>
		  <td>
		    <tal:dummy i18n:translate="manager"
			       tal:condition="item/isManager">manager:</tal:dummy>

		    <span tal:content="structure item/text"
			  tal:attributes="class python:'item-' + item.get_style()"
			  tal:condition="not:item/is_link"/>

		    <a tal:content="structure item/text"
		       tal:attributes="href item/link_url;
				       class python:'item-' + item.get_style();
				       title item/link_title"
		       tal:condition="item/is_link"/>
		    <br/>
		  </td>
		  <td  class="discreet">
		    <tal:block tal:condition="item/date">
		    <span tal:content="python:toLocalizedTime(item.date)"
			  tal:attributes="class python:'item-' + item.get_style()"
			  tal:condition="not:item/is_link"/>

		      <a tal:content="python:toLocalizedTime(item.date)"
			 tal:attributes="href item/link_url;
					 class python: 'item-' + item.get_style();
					 title item/link_title"
			 tal:condition="item/is_link"/>
		    </tal:block>
                    <tal:alert tal:condition="item/notification">
                      <img src="mail_icon.gif"
                           alt="Email notification is set"
                           title="Email notification is set"
                           i18n:attributes="alt label_email_notification_set;
                                            title label_email_notification_set" />
                    </tal:alert>
		  </td>
		  <td>
		    <a class="edit-item action-icon"
		       title="Edit task"
		       tal:condition="can_edit_this_item"
		       tal:attributes="id python: 'item-' + str(item.id)"
		       i18n:attributes="title edit_task">

		      <img src="edit.gif"
			   alt="Edit task"
			   i18n:attributes="alt edit_task" />
		    </a>
		    <span tal:condition="not:can_edit_this_item">&nbsp;</span>
		  </td>
		</tr>
              </tal:block>
	    </tbody>
	  </table>
          <input type="button"
		 value="Update"
		 class="button context"
		 id="update-checklist"
		 tal:condition="python: view.canEditItems() or view.canEditManagerItems()"
		 i18n:attributes="value" />
	</form>

	<div tal:condition="python:not view.any_items_left()"
             i18n:translate="everything-done">Everything is done!</div>

      </tal:block>

      <!-- If the mode is not set to list, we display the form. -->
      <tal:block tal:condition="python: not view.view_mode == 'list'"
		 tal:define="item view/editedItem">

	<form name="add_or_edit_item_form">

	  <input type="hidden" id="item_id" name="item_id"
		 tal:attributes="value item/id | nothing" />


	  <p id="checklist_error_notitle"
	     class="dont-show"
	     i18n:translate="label_checklist_no_title">Error: no text has
	     been set.</p>

          <label i18n:translate="label_task_text"
		 for="item_text">Task</label>
          <input name="item_text"
                 value=""
                 type="text"
                 size="30"
                 id="item_text"
		 tal:define="text item/text | nothing"
                 tal:attributes="value python: view.unescape_text(text)" />
          <br />

	  <p id="checklist_error_pastdate"
	     class="dont-show"
	     i18n:translate="label_checklist_pastdate">Error: due date must
	     be in the future.</p>

          <p id="checklist_error_date_required_notification"
            class="dont-show"
            i18n:translate="label_checklist_date_required_notification">
            Error: due date is required to receive a notification.</p>

          <label for="item_due_date"
                 i18n:translate="label_due_date">Due date</label>

          <tal:start
	     condition="python: not view.view_mode == 'edit_form'"
             define="today python:modules['DateTime'].now();
                     utils python:modules['Products.CMFPlone.utils'];
                     uniqueItemIndex python:utils.RealIndexIterator(pos=0);
                     fieldName string:item_due_date;
                     id fieldName;
                     show_hm python:False;
                     show_ymd python:True;
                     starting_year python:today.year() - 1;
                     ending_year python:today.year() + 1;
                     inputname fieldName;
                     formname string:add_or_edit_item_form;
                     inputvalue item/date | nothing;
                     tabindex python:1;">
            <metal:box use-macro="here/calendar_macros/macros/calendarDatePickerBox|here/calendar_slot/macros/calendarDatePickerBox">
              a calendar, hopefully
            </metal:box>
          </tal:start>

          <tal:start
	     condition="python: view.view_mode == 'edit_form'"
             define="today python:modules['DateTime'].now();
                     utils python:modules['Products.CMFPlone.utils'];
                     uniqueItemIndex python:utils.RealIndexIterator(pos=0);
                     fieldName string:item_due_date;
                     id fieldName;
                     show_hm python:False;
                     show_ymd python:True;
                     starting_year python:today.year() - 1;
                     ending_year python:today.year();
                     inputname fieldName;
                     formname string:add_or_edit_item_form;
                     inputvalue python: None;
                     tabindex python:1;">
            <metal:box use-macro="here/calendar_macros/macros/calendarDatePickerBox|here/calendar_slot/macros/calendarDatePickerBox">
              a calendar, hopefully
            </metal:box>
          </tal:start>

	  <p id="checklist_error_email_no_notification"
	     class="dont-show"
	     i18n:translate="label_checklist_email_no_notification">
            Error: email notification is mandatory if email address is given.</p>

          <input tal:condition="python: view.view_mode == 'form_new'"
                 name="item_notification"
                 id="item_notification"
                 type="checkbox"
                 value="1"
                 checked="1" />
          <input tal:condition="python: view.view_mode == 'form_edit'"
                 name="item_notification"
                 id="item_notification"
                 type="checkbox"
                 value="1"
                 tal:attributes="checked item/notification" />
          <label class="inline" for="item_notification"
                 i18n:translate="label_notification">Email notification</label>
          <br />

	  <p id="checklist_error_invalid_email"
	     class="dont-show"
	     i18n:translate="label_checklist_invalid_email">
            Error: this is not a valid email address.</p>

          <label for="item_notification_email"
                 i18n:translate="label_notification_email">Notification email address</label>
          <input name="item_notification_email"
                 value=""
                 type="text"
                 size="30"
                 id="item_notification_email"
                 tal:attributes="value item/email|nothing" />
          <br />

<!-- 	  The button displayed differs depending on the fact that we
 	  add or edit an item. -->

          <input value="Add task"
                 id="submit-add-task"
                 class="context"
                 i18n:attributes="value label_add_task;"
                 type="submit"
		 tal:condition="python: view.view_mode == 'form_new'"
		 />
          <input value="Edit task"
                 id="submit-edit-task"
                 class="context"
                 i18n:attributes="value label_edit_task;"
                 type="submit"
		 tal:condition="python: view.view_mode == 'form_edit'"
		 />
          <input value="Cancel"
                 id="cancel-checklist-form"
                 class="context"
		 i18n:domain="plone"
                 i18n:attributes="value label_cancel;"
                 type="submit" />
	</form>
      </tal:block>
    </dd>
  </dl>
</div>
