<div i18n:domain="checklist"
  tal:omit-tag="">

  <dl class="module" id="checklist">
    <dt class="moduleHeader">

      <a class="moduleButton" href=""
	 id="add_task_button"
	 tal:condition="view/canEditItems">
        <img src="add_icon.gif"
             alt="Add task"
             title="Add task"
             i18n:attributes="title label_add_task;
                              alt label_add_task;" />
      </a>

      <span tal:omit-tag=""
            i18n:translate="head_checklist">Tasks</span>
    </dt>
    <dd class="moduleItem">
      
      <!-- If the mode is set to list, we display the list of items. -->
      <tal:block tal:condition="python: view.view_mode == 'list'"
		 tal:define="toLocalizedTime nocall:context/@@plone/toLocalizedTime;">
	<form name="remaining_items_form"
              method="post"
              id="remainingitemsform"
              action=""
              tal:attributes="action string:${context/absolute_url}/@@update_checklist"
              tal:condition="view/any_items_left">
	  
	  <table class="noteslist">
	    <tbody>
              <tal:block tal:repeat="item view/checklist/remainingAllItems">
		<tr>
		  <td>
		    <input type="checkbox"
			   tal:condition="view/canEditItems"
			   name="item"
			   id="item"
			   value="item"
			   tal:attributes="name item/id;
					   id item/id;
					   value item/id;"/>
		    <input type="checkbox"
			   tal:condition="not:view/canEditItems"
			   name="item"
			   id="item"
			   value="item"
			   disabled="1"
			   tal:attributes="name item/id;
					   id item/id;
					   value item/text;"/>
		  </td>
		  <td>
		    <tal:dummy i18n:translate="manager"
			       tal:condition="item/isManager">manager:</tal:dummy>

		    <span tal:content="structure item/text"
			  tal:attributes="class python:'item-' + item.get_style()"
			  tal:condition="not:item/is_link"/>

		    <a tal:content="structure item/text"
		       tal:attributes="href item/link_url;
				       class python:'item-' + item.get_style();
				       title item/link_title"
		       tal:condition="item/is_link"/>
		    <br/>
		  </td>
		  <td>
		    <tal:block tal:condition="item/date">
		    <span tal:content="python:toLocalizedTime(item.date)"
			  tal:attributes="class python:'item-' + item.get_style()"
			  tal:condition="not:item/is_link"/>
		      
		      <a tal:content="python:toLocalizedTime(item.date)"
			 tal:attributes="href item/link_url;
					 class python: 'item-' + item.get_style();
					 title item/link_title"
			 tal:condition="item/is_link"/>
		    </tal:block>
		  </td>
		  <td>
		    <a class="edit-item action-icon"
		       title="Edit task"
		       tal:attributes="id python: 'item-' + str(item.id)"
		       i18n:attributes="title edit_task">

		      <img src="edit.gif"
			   alt="Edit task"
			   tal:condition="view/canEditItems"   
			   i18n:attributes="alt edit_task" />
		    </a>
		  </td>
		</tr>
              </tal:block>
	    </tbody>
	  </table>
          <input type="button"
		 value="Update"
		 class="button context"
		 id="update-checklist"
		 i18n:attributes="value" />
	</form>
	
	<div tal:condition="python:not view.any_items_left()"
             i18n:translate="everything-done">Everything is done!</div>
	
      </tal:block>
      
      <!-- If the mode is not set to list, we display the form. -->
      <tal:block tal:condition="python: not view.view_mode == 'list'"
		 tal:define="item view/editedItem">

	<form name="add_or_edit_item_form">

	  <input type="hidden" id="item_id" name="item_id"
		 tal:attributes="value item/id | nothing" />
		 

	  <p id="checklist_error_notitle"
	     class="dont-show"
	     i18n:translate="label_checklist_no_title">Error: no text has
	     been set.</p>

          <label i18n:translate="label_task_text"
		 for="item_text">Task</label>
          <input name="item_text"
                 value=""
                 type="text"
                 size="30"
                 id="item_text"
                 tal:attributes="value item/text | nothing" />
          <br />

	  <p id="checklist_error_pastdate"
	     class="dont-show"
	     i18n:translate="label_checklist_pastdate">Error: due date must
	     be in the future.</p>

          <label for="item_due_date"
                 i18n:translate="label_due_date">Due date</label>

          <tal:start
	     condition="python: not view.view_mode == 'edit_form'"
             define="today python:modules['DateTime'].now();
                     utils python:modules['Products.CMFPlone.utils'];
                     uniqueItemIndex python:utils.RealIndexIterator(pos=0);
                     fieldName string:item_due_date;
                     id fieldName;
                     show_hm python:False;
                     show_ymd python:True;
                     starting_year python:today.year() - 1;
                     ending_year python:today.year();
                     inputname fieldName;
                     formname string:add_or_edit_item_form;
                     inputvalue item/date | nothing;
                     tabindex python:1;">
            <metal:box use-macro="here/calendar_macros/macros/calendarDatePickerBox|here/calendar_slot/macros/calendarDatePickerBox">
              a calendar, hopefully
            </metal:box>
          </tal:start>

          <tal:start
	     condition="python: view.view_mode == 'edit_form'"
             define="today python:modules['DateTime'].now();
                     utils python:modules['Products.CMFPlone.utils'];
                     uniqueItemIndex python:utils.RealIndexIterator(pos=0);
                     fieldName string:item_due_date;
                     id fieldName;
                     show_hm python:False;
                     show_ymd python:True;
                     starting_year python:today.year() - 1;
                     ending_year python:today.year();
                     inputname fieldName;
                     formname string:add_or_edit_item_form;
                     inputvalue python: None;
                     tabindex python:1;">
            <metal:box use-macro="here/calendar_macros/macros/calendarDatePickerBox|here/calendar_slot/macros/calendarDatePickerBox">
              a calendar, hopefully
            </metal:box>
          </tal:start>

<!-- 	  The button displayed differs depending on the fact that we
 	  add or edit an item. -->

          <input value="Add task"
                 id="submit-add-task"
                 class="context"
                 i18n:attributes="value label_add_task;"
                 type="submit"
		 tal:condition="python: view.view_mode == 'form_new'"
		 />
          <input value="Edit task"
                 id="submit-edit-task"
                 class="context"
                 i18n:attributes="value label_edit_task;"
                 type="submit"
		 tal:condition="python: view.view_mode == 'form_edit'"
		 />
          <input value="Cancel"
                 id="cancel-checklist-form"
                 class="context"
		 i18n:domain="plone"
                 i18n:attributes="value label_cancel;"
                 type="submit"  /> 
	</form>
      </tal:block>
    </dd>
  </dl>
</div>
