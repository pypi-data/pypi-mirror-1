<script language="JavaScript">
<!--
	var currentExpression = '';
	var currentSelectedIndex = '';

	function updateSearchExpression(input_id) {
		input_box = document.getElementById(input_id);
		currentExpression = input_box.value;
		currentSelectedIndex = input_box.getAttribute("selectedIndex");
		document.getElementById(safe_name(input_id) + "_concepts").value = input_box.getAttribute("concepts");
		document.getElementById(input_id + "_autocompleteConceptsAction").value = currentExpression;
		document.getElementById(input_id + "_autocompleteConceptsAction").setAttribute("concepts", input_box.getAttribute("concepts"));
		document.getElementById(input_id + "_autocompleteConceptsAction").setAttribute("selectedIndex", currentSelectedIndex);
		document.getElementById(input_id + "_chooseSelectedConceptAction").value = currentExpression;
		document.getElementById(input_id + "_chooseSelectedConceptAction").setAttribute("concepts", input_box.getAttribute("concepts"))
		document.getElementById(input_id + "_chooseSelectedConceptAction").setAttribute("selectedIndex", currentSelectedIndex)
	}

	function keypressed(input_id, e) {
		if(window.event)
		  keynum = e.keyCode;
		else if(e.keyCode)
		  keynum = e.keyCode;
		else if(e.which)
		  keynum = e.which;
		keychar = String.fromCharCode(keynum);
		updateSearchExpression(input_id);
		if(keychar == ",") {
			raiseChooseSelectedConceptEvent(input_id);
			proceedAction = false;
		}
		else if(keynum == 38) { // Up arrow
			increment_selectedIndex(input_id, -1);
			proceedAction = false;
		}
		else if(keynum == 40) { // Down arrow
			increment_selectedIndex(input_id, +1);
			proceedAction = false;
		}
		else {
			proceedAction = true;
		}
		return proceedAction;
	}

	function increment_selectedIndex(input_id, count) {
		input_box = document.getElementById(input_id);
		selectedIndex = input_box.getAttribute("selectedIndex");
		if(selectedIndex != "")
			selectedIndex = parseInt(selectedIndex) + count;
		else
			selectedIndex = "1";
		input_box.setAttribute("selectedIndex", selectedIndex);
	}

	function timerIncrementalSearchSelect(input_id)
	{
		input_box = document.getElementById(input_id);
		if(input_box.value != currentExpression)
			input_box.setAttribute("selectedIndex", "");
		if(input_box.value != currentExpression || input_box.getAttribute("selectedIndex") != currentSelectedIndex) {		
			updateSearchExpression(input_id);
			raiseListConceptsEvent(input_id);
		}
		autocomplete(input_id);
		correct_selected_index(input_id);
		setTimeout("timerIncrementalSearchSelect('" + input_id + "')", 100);
	}

	function autocomplete(input_id) {
		input_box = document.getElementById(input_id);
		autocompleted_box = document.getElementById(safe_name(input_id) + "_autocompletedExpression");
		if(autocompleted_box.value != "") {
			input_box.value = autocompleted_box.value;
			input_box.setAttribute("concepts", autocompleted_box.getAttribute("concepts"));
			autocompleted_box.value = "";
			updateSearchExpression(input_id);
		}
	}

	function correct_selected_index(input_id) {
		input_box = document.getElementById(input_id);
		selectedIndex_field = document.getElementById(safe_name(input_id) + "_selectedIndex");
		if(selectedIndex_field.value != "") {
			input_box.setAttribute("selectedIndex", selectedIndex_field.value);
			selectedIndex_field.value = "";
			updateSearchExpression(input_id);
		}
	}

	function raiseListConceptsEvent(input_id) {
		actionField = document.getElementById(input_id + "_autocompleteConceptsAction");
		dispatchClickEvent(actionField);
	}

	function raiseChooseSelectedConceptEvent(input_id) {
		actionField = document.getElementById(input_id + "_chooseSelectedConceptAction");
		dispatchClickEvent(actionField);
	}
	
	function dispatchClickEvent(targetElement)
	{
		var event = document.createEvent("MouseEvents");
		event.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, null, null);
		targetElement.dispatchEvent(event);
	}

	function safe_name(nombre) {
		return nombre.replace(".", "")
	}

	// not succesfull function:
	function setKukitStateVar(variable, valor) {
		oper = kukit.op.Oper.prototype.clone();
		dict = { 'parms' : { 'varname': variable, 'value': valor } };
		oper.unrestrictedUpdate(dict, false);
		kukit.ar.actionRegistry.get("setStateVar")(oper);
	}

	function getKukitStateVar(variable) {
		return kukit.statevars[variable];
	}

	function replace_debug(str) {
		document.getElementById("debug_text").value = str;
	}

//-->
</script>
