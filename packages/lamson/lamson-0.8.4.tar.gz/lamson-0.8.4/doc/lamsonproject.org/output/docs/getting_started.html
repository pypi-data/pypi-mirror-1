<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title>Lamson: Getting Started With Lamson</title>
	<link rel="stylesheet" href="/css/style.css" type="text/css" media="all" charset="utf-8" />
	<!--[if IE]><link rel="stylesheet" href="/css/style_ie.css" type="text/css" media="all" charset="utf-8" /><![endif]-->
	
</head>

<body>
	
	<div id="serious_black">
		
		<!-- header -->
		<div id="header">
			<div class="wrap clear">
				<!-- logo -->
				<div id="logo">
					<h1><a href="/">Lamson Mail Server</a></h1>
                    <h2>Pipes and aliases are so 1970.</h2>
				</div>
				<!-- / logo -->
				
				<!-- navigation -->
				<div id="nav">
					<a href="/"><span><span><span><span>Home</span></span></span></span></a>
					<a href="/blog/"><span><span><span><span>News</span></span></span></span></a>
					<a href="/download.html"><span><span><span><span>Download</span></span></span></span></a>
					<a href="/docs/"><span><span><span><span>Docs</span></span></span></span></a>
				</div>
				<!-- / navigation -->
			</div>
		</div>
		<!-- / header -->
		
		<!-- middle -->
		<div id="middle">
			<div class="middle-tr">
				<div class="middle-bl">
					<div class="middle-br">
						
						<div class="wrap clear">
							<!-- content -->
                            <div id="content">
                                <h1>Getting Started With Lamson</h1>
                                	<p>Lamson is designed to work like modern web application frameworks like Django, TurboGears,
<span class="caps">ASP</span>.<span class="caps">NET</span>, Ruby on Rails, and whatever <span class="caps">PHP</span> is using these days.  At every design decision 
Lamson tries to emulate terminology and features found in these frameworks.  This Getting Started
document will help you get through that terminology, get you started running your first
lamson application, and walk you through the code you should read.</p>

	<p>In total it should take you about 30 minutes to an hour to complete.  If you just want
to try Lamson, at least go through the 30 <strong>second</strong> introduction given first.</p>

	<h2>The 30 Second Introduction</h2>

	<p>If you have Python and easy_install already, then try this out:</p>

<pre>
$ easy_install lamson
$ lamson gen -project mymailserver
$ cd mymailserver
$ lamson syncdb
$ lamson start
$ lamson log -queue run/queue -port 8899
$ nosetests
$ lamson help -for send
$ lamson send -sender me@mydomain.com -to test@test.com \
        -subject &#34;My test.&#34; -body &#34;Hi there.&#34; -port 8823
$ less logs/lamson.log
$ mutt -F muttrc
$ lamson stop -ALL run
</pre>

	<p>You now have a working base Lamson setup ready for you to work on with the following installed:</p>

	<ul>
		<li>Lamson and all dependencies (SQLAlchemy, Mako, nosetests)</li>
		<li>Code for your project in mymailserver.  Look in app/handlers and config/settings.py</li>
		<li>Two initial tests that verify your server is not an open relay and forwards mail in tests/handlers/open_relay_tests.py</li>
		<li>A &#8220;logger&#8221; server running on port 8899 that dumps all of its mail into run/queue</li>
		<li>A config script for mutt (muttrc) that you can use to inspect the run/queue <strong>and</strong> also send mail using Lamson&#8217;s <strong>send</strong> command.</li>
	</ul>

	<h2>Important Terminology</h2>

	<p>If you are an old <span class="caps">SMTP</span> guru and/or you&#8217;ve never written a web application with a modern web framework, then 
some of the terminology used in Lamson may seem confusing.  Other terms may just confuse you or scare you 
because they sound complicated.  I tried my best to make the concepts used in Lamson understandable and the
code that implements them easy to read.  In fact, you could probably read the code to Lamson in an evening
and understand how everything works.</p>

	<p>Experience though has taught me that nobody reads the code, even if it is small.  Therefore, here are 
the most important concepts you should know to get a grasp of Lamson and how it works.</p>

	<p>	<ul>
		<li><acronym title="Model View Controller">MVC</acronym> &#8212; Model View Controller is a design methodology used in web application frameworks</li>
	</ul>
where the data (model), presentation (view), and logic (controller) layers of the application are strictly 
separated.
	<ul>
		<li><acronym title="Finite State Machine">FSM</acronym> &#8212; Finite State Machine is a special Lamson handler that stores it&#8217;s state</li>
	</ul>
between executions.  Each time it runs it will perform an action based on what it is send <strong>and</strong> what
it was doing last.  <span class="caps">FSM</span> in computer science class are overly complex, but in Lamson they are as easy
to use as a <em>return</em> statement.
	<ul>
		<li>Template &#8212; Lamson generates the bodies of it&#8217;s messages using Templates, which are text files</li>
	</ul>
that have parts that get replaced with variables you pass in.  Templates are converted to their
final form with a process called <strong>rendering</strong>.
	<ul>
		<li>Relay &#8212; The <strong>relay</strong> for a Lamson server is where Lamson delivers it&#8217;s messages.  Usually the Relay</li>
	</ul>
is a smart tougher server that&#8217;s not as smart, but very good at delivering mail.  Lamson can also be
run as a Relay for testing purposes.
	<ul>
		<li>Receiver &#8212; Lamson typically runs as the Receiver of email.  If you are familiar with a web application setup,</li>
	</ul>
then Lamson is the inverse.  Instead of Lamson runing &#8220;behind&#8221; an Apache or Nginx server, Lamson runs &#8220;in front&#8221;
of an <span class="caps">SMTP</span> server like Postfix.  It listens on port 25, handles the mail it should, and forwards the rest
to the Relay.  This makes Lamson much more of a Proxy or filter server.
	<ul>
		<li>Queue &#8212; Lamson can also do all of its processing off a queue.  In this setup you would have your normal</li>
	</ul>
mail server dump all mail to a maildir queue, and then tell Lamson to process messages out of there.  This
can be combined with the usual Receiver+Relay configuration for processing messages that might take a long
time.
	<ul>
		<li>Maildir &#8212; A standard created for the qmail project with stores mail in a directory such that you can access</li>
	</ul>
the mail atomically and store it on a shared disk without conflicts or locking.</p>

	<h2>Managing Your Server</h2>

	<p>Your Lamson application is now running inside the Lamson Python server.  This is a very simple server based on Python&#8217;s
<a href="http://docs.python.org/library/smtpd.html">smtpd</a> and <a href="http://docs.python.org/library/asyncore.html">asyncore</a> libraries.</p>

	<blockquote>
		<p>If you want to know more about how it operates, take a look at the <em>lamson/server.py</em> file in the source distribution.</p>
	</blockquote>

	<p>You&#8217;ll need to use a few Lamson commands to manage the server.  You already experienced them in the 
30 second introduction, and you can review <a href="/docs/lamson_commands.html">them all</a> or see them
by using the <em>lamson help</em> command.</p>

	<p>Right now you have Lamson running on port 8823 and a &#8220;lamson logger&#8221; running on 8899.  Before we
learn how to manage them and what they do, open up the <em>config/settings.py</em> file and take a look
at the following lines:</p>

<pre>
relay = { &#34;host&#34;: &#34;localhost&#34;, &#34;port&#34;: 8899, &#34;debug&#34;: 1}
receiver = { &#34;host&#34;: &#34;localhost&#34;, &#34;port&#34;: 8823}
</pre>

	<p>Your file probably has some comments telling you what these do, but it&#8217;s important to understand
how they work.</p>

	<p>The <em>receiver</em> setting is used by the <em>lamson start</em> command to figure out where to listen
for incoming <span class="caps">SMTP</span> connections.  In a real installation this would be port <strong>25</strong> on your external
IP address.  It&#8217;s where the internet talks to your server.</p>

	<p>The <em>relay</em> setting is used by Lamson to figure out where to forward message replies (responses)
for real delivery.  Normally this would be a &#8220;smart host&#8221; running a more established server
like <a href="http://www.postfix.org/">Postfix</a> or <a href="http://www.exim.org/">Exim</a> to do the grunt work
of delivering to the final recipients.</p>

	<blockquote>
		<p>Lamson can deliver directly, but that is a waste of resources.  In the same way
you wouldn&#8217;t have Python or Ruby deliver video, static text, or images over <span class="caps">HTTP</span>, you 
don&#8217;t want Lamson bothering with the nasty business of delivering mail to people.</p>
	</blockquote>

	<p>You probably don&#8217;t have another <span class="caps">SMTP</span> server running, and even if you did, it&#8217;d
be a pain to configure it for development purposes.  You&#8217;d have to setup aliases, new
mail boxes, restart it all the time, and other annoyances.</p>

	<p>For development, what we want is our own little private <span class="caps">SMTP</span> relay, and since Lamson can
also deliver mail, that is what we get with the command:</p>

<pre>
$ lamson log -queue run/queue -port 8899
</pre>

	<p>This tells Lamson to run as a &#8220;logging server&#8221;, which doesn&#8217;t actually deliver
any mail.  If you don&#8217;t give a -queue option, then it will log to <em>logs/lamson.log</em>
and print out any emails it receives.  In this case we actually want the logger to
dump mail it receives into the <em>run/queue</em> Maildir.  That&#8217;s what -queue does in this
command.</p>

	<blockquote>
		<p>Lamson uses Maildir by default since it is the most reliable and fastest mail queue
format available.  It could also store mail messages to any queue supported by Python&#8217;s
<a href="http://docs.python.org/library/mailbox.html">mailbox</a> library.  If you were
adventurous you could also use a <span class="caps">RDBMS</span>, but that&#8217;s just silly.</p>
	</blockquote>

	<h3>Stopping Lamson</h3>

	<p>The <acronym title="Process ID">PID</acronym> files are stored in the <em>run</em> directory.  Here&#8217;s a sample
session where I stop all the running servers:</p>

	<p><pre>
$ ls -l run/*.pid
-rw-r&#8212;r&#8212;  1 zedshaw  staff  5 May 16 16:41 run/log.pid
-rw-r&#8212;r&#8212;  1 zedshaw  staff  5 May 16 16:41 run/smtp.pid</p>

	<p>$ lamson stop -<span class="caps">ALL</span> run
Stopping processes with the following <span class="caps">PID</span> files: ['run/log.pid&#8217;, 'run/smtp.pid&#8217;]
Attempting to stop lamson at pid 1693
Attempting to stop lamson at pid 1689
</pre></p>

	<p>You can also pass other options to the stop command to just stop one server.  Use
<em>lamson help -for stop</em> to see all the options.</p>

	<h3>Starting Lamson Again</h3>

	<p>Hopefully you&#8217;ve been paying attention and have figured out how to restart lamson and the
logging server.  Just in case, here it is again:</p>

<pre>
$ lamson start
$ lamson log -queue run/queue -port 8899
</pre>

	<p>You should also look in the logs/lamson.log file to see that it actually started.  The
other files in the logs directory contain messages dumped to various output methods (like
Python&#8217;s stdout and stderr).  Periodically, if the information you want is not in 
logs/lamson.log then it is probably in the other files.</p>

	<blockquote>
		<p> You can change your logging configuration by eddin the logging line your config/settings.py file.</p>
	</blockquote>

	<h2>Other Useful Commands</h2>

	<p>You should read the <a href="/docs/lamson_commands.html">available commands</a> documentation to get an
overview, and you can also use <em>lamson help</em> to see them at any time.</p>

	<h3>send</h3>

	<p>The first useful command is <em>lamson send</em>, which lets you send mail to <span class="caps">SMTP</span> servers (not
just Lamson) and watch the full <span class="caps">SMTP</span> protocol chatter.  Here&#8217;s a sample:</p>

<pre>
$ lamson send -port 25 -host zedshaw.com -debug 1 \
    -sender tester@test.com -to zedshaw@zedshaw.com \
    -subject &#34;Hi there&#34; -body &#34;Test body.&#34;
send: &#39;ehlo zed-shaws-macbook.local\r\n&#39;
reply: &#39;502 Error: command &#34;EHLO&#34; not implemented\r\n&#39;
reply: retcode (502); Msg: Error: command &#34;EHLO&#34; not implemented
send: &#39;helo zed-shaws-macbook.local\r\n&#39;
reply: &#39;250 localhost.localdomain\r\n&#39;
reply: retcode (250); Msg: localhost.localdomain
send: &#39;mail FROM:&#60;tester@test.com&#62;\r\n&#39;
reply: &#39;250 Ok\r\n&#39;
reply: retcode (250); Msg: Ok
send: &#39;rcpt TO:&#60;zedshaw@zedshaw.com&#62;\r\n&#39;
reply: &#39;250 Ok\r\n&#39;
reply: retcode (250); Msg: Ok
send: &#39;data\r\n&#39;
reply: &#39;354 End data with &#60;CR&#62;&#60;LF&#62;.&#60;CR&#62;&#60;LF&#62;\r\n&#39;
reply: retcode (354); Msg: End data with &#60;CR&#62;&#60;LF&#62;.&#60;CR&#62;&#60;LF&#62;
data: (354, &#39;End data with &#60;CR&#62;&#60;LF&#62;.&#60;CR&#62;&#60;LF&#62;&#39;)
send: &#39;Content-Type: text/plain; charset=&#34;us-ascii&#34;\r\nMIME-Version: 1.0\r\nContent-Transfer-Encoding: 7bit\r\nSubject: Hi there\r\nFrom: tester@test.com\r\nTo: zedshaw@zedshaw.com\r\n\r\n.\r\n&#39;
reply: &#39;250 Ok\r\n&#39;
reply: retcode (250); Msg: Ok
data: (250, &#39;Ok&#39;)
send: &#39;quit\r\n&#39;
reply: &#39;221 Bye\r\n&#39;
reply: retcode (221); Msg: Bye
</pre>

	<p>Using this helps you debug your Lamson server by showing you the exact protocol sent
between you and the server.  It is also a useful <span class="caps">SMTP</span> server debug command by itself.</p>

	<blockquote>
		<p> When you use the supplied muttrc you&#8217;ll be configured to use Lamson&#8217;s sendmail
(not *send) command as your delivery command.  This lets you use mutt as a complete development
tool with minimal configuration.</p>
	</blockquote>

	<h3>queue</h3>

	<p>The <em>lamson queue</em> command lets you investigate and manipulate the run/queue (or any maildir).
You can pop a message off, get a message by its key, remove a message by its key, count the messages,clear the queue, list keys in the queue.   It gives you a lower level view of the queue than
mutt would, and lets you manipulate it behind the scenes.</p>

	<h3>restart</h3>

	<p>Lamson does reload the code of your project when it receives a new request (probably too
frequently), but if you change the <em>config/settings.py</em> file then you need to restart.
Easiest way to do that is with the restart command.</p>

	<h3>deq</h3>

	<p>A more advanced configuration is to have Lamson or another mail server deliver pending
messages to the run/queue, and then you run a &#8220;dequeue server&#8221; that processes the 
messages in it.  A dequeue server is great for processing that would take too long or
needs to be distributed.  Using it is outside the scope of this manual, but you can 
check its help and look at the mailinglist sample to see how you might do this.</p>

	<h3>syncdb</h3>

	<p>Lamson uses the SQLAlchemy library as its <span class="caps">ORM</span> layer, and also needs a working database
to process any requests.  This is because the <acronym title="Finite State Machine">FSM</acronym> system needs to
store status information in a table in the database.</p>

	<p>To get your database start use the <em>lamson syncdb</em> command, and if you make changes to
your model rerun it.</p>

	<h2>Testing It With Mutt</h2>

	<p>Mutt is a very handy testing tool, and with our development Lamson setup we can use the included
muttrc to fake Mutt out.  Here&#8217;s the muttrc:</p>

<pre>
set mbox_type=Maildir
set folder=&#34;run/queue&#34;
set mask=&#34;!^\\.[^.]&#34;
set mbox=&#34;run/queue&#34;
set record=&#34;+.Sent&#34;
set postponed=&#34;+.Drafts&#34;
set spoolfile=&#34;run/queue&#34;
set sendmail=&#34;/usr/local/bin/lamson sendmail -port 8823 -host 127.0.0.1&#34;
</pre>

	<p>This tells Mutt to use the <em>run/queue</em> directory as a Maildir queue for its
inbox.  It also configures it to use the <em>/usr/local/bin/lamson</em> command
to do the delivery.  Using the <em>lamson sendmail</em> command (<span class="caps">NOT</span> *send) lets
Mutt deliver to different ports and servers in a development situation.</p>

	<blockquote>
		<p> Another example of how difficult <span class="caps">SMTP</span> systems are to use is the fact that
you have to reconfigure the postfix main.cf to make the sendmail command use a 
different port or server.  There are no command line options to specify it.</p>
	</blockquote>

	<h2>Walking Through The Code</h2>

	<p>Coming soon&#8230;.</p>

	<h2>Writing A Unit Test</h2>

	<p>Coming soon&#8230;.</p>

	<h2>Making It Do Something</h2>

	<p>Coming soon&#8230;.</p>

	<h2>Other Examples</h2>

	<p>Next you&#8217;ll want to sink your teeth in a bigger example.  Go grab <a href="/releases/">the source distribution .tar.gz</a> and 
extract it so you can get at the examples:</p>

<pre>
$ tar -xzvf lamson-VERSION.tar.gz
$ cd lamson-VERSION
$ cd examples/mailinglist
</pre>

	<p>You are now in the mailinglist example.  Using what you&#8217;ve learned so far you can start reviewing the code
and finding out how a working example operates.</p>

	<h2>Getting Help</h2>

	<p>As you work through this documentation, send your questions <a href="/contact.html">to me</a> and I&#8217;ll try to help
you.</p>


							</div>
							<!-- / content -->

							<!-- sidebar -->
							<div id="sidebar">
								<!-- box -->
								<div class="sidebar-nav box">
									<div class="tr">
										<div class="br">

											<h3>Things To Read</h3>
											<ul>
												<li><a href="/blog/">blog with latest news.</a></li>
                                                <li><a href="/feed.xml">rss feed for you.</a></li>
                                                <li><a href="/download.html">download the gear.</a></li>
                                                <li><a href="/docs/getting_started.html">getting started.</a></li>
                                                <li><a href="/docs/">more documentation.</a></li>
                                                <li><a href="/docs/faq.html">frequently asked questions.</a></li>
                                                <li><a href="/lists/">mailing lists to join.</a></li>
                                                <li><a href="/about.html">about lamson.</a></li>
                                                <li><a href="/contact.html">getting help.</a></li>
											</ul>
										</div>
									</div>
								</div>
								<!-- / box -->

								<!-- box -->
								<div class="box">
									<div class="tr">
										<div class="br">

											<h3>Getting Started</h3>
                                            <p>See the <a href="/download.html">download instructions</a> for information
                                            on getting lamson, and read the <a href="/docs/getting_started.html">getting started
                                                instructions</a> to start your own application in less than 10 minutes.
                                            </p>

										</div>
									</div>
								</div>
                                <!-- / box -->

								<!-- box -->
								<div class="box">
									<div class="tr">
										<div class="br">

											<h3>About</h3>
                                            <p>
                                            Lamson is a Python based SMTP (E-Mail) server and application framework that
                                            let's you write e-mail applications the way you'd write modern web applications.
                                            </p>

										</div>
									</div>
								</div>
								<!-- / box -->
							</div>
							<!-- / sidebar -->
						</div>
						
						
					</div>
				</div>
			</div>
		</div>
		<!-- / middle -->
		
		<!-- footer -->
		<div id="footer">
			<div class="wrap">
				<p class="cp">&copy; 2009 <a href="http://zedshaw.com/">Zed A. Shaw</a> <span>//</span> valid xhtml 1.0 strict</p>
				<p>designed by <a href="http://www.renehornig.com/" title="webdesign berlin">hornig</a></p>
			</div>
		</div>
		<!-- / footer -->
		
	</div>

</body>
</html>
