<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />	
		<title>LamsonProject: Writing A Lamson State Storage Backend</title>
		<link rel="stylesheet" href="/styles/global.css" type="text/css" charset="utf-8" />
		<!--[if IE 7]>
		<style type="text/css" media="screen">
			div#column_left ul.sidebar_menu li div.color{
				display: none;
			}
		</style>
		<![endif]-->
		
	</head>
	<body>
		<div id="content_centered">			
			<div id="header">
				<h1><img id="logo" src="/images/lamson.png" alt="Lamson Project(TM) - Pipes and aliases are so 1970." /></h1>
				<ul id="header_menu">
					<li><a href="/">Home</a></li>
					<li><a href="/blog/">News</a></li>
                    <li><a href="/feed.xml">Feed</a></li>
					<li><a href="/download.html">Download</a></li>
					<li><a href="/docs/">Documentation</a></li>
					<li><a href="/docs/api/">API</a></li>
				</ul>
			</div>


            <div id="main_content">
                <h1>Writing A Lamson State Storage Backend</h1>
                	<p>Earlier versions of Lamson assumed that you would use SQLAlchemy, and
that you wouldn&#8217;t mind storing your state in the database using
SQLAlchemy.  Well, during the 0.9 redesign it became very easy to let
you store the state however and wherever you want.  In the new Lamson setup
there is a bit more work to create alternative storage, but Lamson comes with
two default stores that you can use to get started.</p>

	<h2>The Default Stores</h2>

	<p>When you get started with Lamson you&#8217;ll definitely not want to go through the 
trouble of setting up a custom store.  For your first days of development, using
the default <a href="http://lamsonproject.org/docs/api/lamson.routing.MemoryStorage-class.html">MemoryStorage</a>
is the way to go.  After you get further in your development you want to
switch to the <a href="http://lamsonproject.org/docs/api/lamson.routing.ShelveStorage-class.html">ShelveStorage</a>
to store the state in a simple Python <a href="http://docs.python.org/library/shelve.html">shelve</a>
store.</p>

	<p><code>MemoryStorage</code> keeps the routing state in a simple dict in memory, and doesn&#8217;t
provide any thread protection.  Its purpose is for developer testing and unit
test runs where keeping the state between disks is more of a pain than it is
worth.  Use the <code>MemoryStorage</code> (which is the default) for your development
runs and for simple servers where the state does need to be maintained (very
rare).</p>

	<p><code>ShelveStorage</code> is used for your small deployments where you are mostly just
testing the deployment process or doing a small service.  It will store your
data between runs, and is probably fast enough for most sites, but you&#8217;ll want
to ditch it if you ever:</p>

	<ol>
		<li>Run more than one process that needs the state information.</li>
		<li>Start to store everything in a database anyway.</li>
	</ol>

	<h2>Using The ShelveStorage</h2>

	<p>You can use <code>ShelveStorage</code> by simply adding this line to your <code>config/boot.py</code> 
file just before you do anything else with the <code>Router</code>:</p>

<pre class="code">
Router.STATE_STORE=ShelveStorage(&#8220;run/states&#8221;)
</pre>

	<p>It actually doesn&#8217;t matter currently when you do it, but it&#8217;s good practice right now.</p>

	<p>After you do that, restart lamson and it will start using the new store.  Notice
that your <strong>tests will not use this</strong>.  It&#8217;s not a good idea to have tests use
<code>ShelveStorage</code>, but if you want to turn it on for a run to see what happens,
then you can modify <code>config/testing.py</code> the same way.  You could also write a
unit test that did this temporarily by putting that line in your test case.</p>

	<h2>What To Implement</h2>

	<p>If you want to implement your own then you just have to implement the methods in
<a href="http://lamsonproject.org/docs/api/lamson.routing.StateStorage-class.html">StateStorage</a>
and make sure it behaves the same as MemoryStorage.  Look at
<a href="http://lamsonproject.org/docs/api/lamson.routing-pysrc.html#ShelveStorage">the code to ShelveStorage</a>
to get started.</p>

	<h2>Important Considerations</h2>

	<p>I am purposefully <strong>not</strong> telling you how to exactly implement it because I&#8217;m not
exactly sure what is needed as of the 0.9 release.  I use a SQLAlchemy setup and
the ShelveStorage, but I&#8217;d like to hear what other people have written and then
start building infrastructure to make that easier.</p>

	<p>There are some important things to consider when you implement your storage
though:</p>

	<ol>
		<li>Make sure that the calls to all methods are thread safe, and potentially process safe.</li>
		<li>If you do thread locking, use the <strong>with</strong> statement and an RLock.</li>
		<li>If your storage is potentially very slow, then consider a caching scheme inside, but <strong>write that after making it work correctly.</strong></li>
		<li>Do <strong>NOT</strong> be tempted to store junk in this like it is a &#8220;session&#8221;.  It should be lean and mean and only do state.</li>
		<li>Make sure you keep the key being used exactly as given.  You can seriously mess up Lamson&#8217;s Router if you start getting fancy.</li>
	</ol>

	<h2>Attaching It To The Router</h2>

	<p>Your storage backend will then be attached to the lamson.routing.Router in the
same way as what you did with ShelveStorage.  It really should be that simple
since the data stored in the state store is very minimal.</p>


			</div>

			<div id="column_left">
				<ul class="sidebar_menu">
					<li>
						<div class="item">
							<div class="color" style="background-color: #ff0000;">&nbsp;</div>
                            <a href="/blog/">Latest News</a>
						</div>
					</li>
					<li>
						<div class="item">
							<div class="color" style="background-color: #ff9900;">&nbsp;</div>
							<a href="/download.html">Download the Gear</a>
						</div>
					</li>
					<li>
						<div class="item">
							<div class="color" style="background-color: #99cc00;">&nbsp;</div>
							<a href="/docs/getting_started.html">Getting Started</a>
						</div>
					</li>
					<li>
						<div class="item">
							<div class="color" style="background-color: #3399ff;">&nbsp;</div>
							<a href="/docs/">Documentation</a>
						</div>
					</li>
					<li>
						<div class="item">
							<div class="color" style="background-color: #ff3399;">&nbsp;</div>
							<a href="/docs/faq.html">Frequently Asked Questions</a>
						</div>
					</li>
					<li>
						<div class="item">
							<div class="color" style="background-color: #006699;">&nbsp;</div>
							<a href="/about.html">About Lamson</a>
						</div>
					</li>
					<li>
						<div class="item">
							<div class="color" style="background-color: #0099cc;">&nbsp;</div>
							<a href="/contact.html">Getting Help with Lamson</a>
						</div>
					</li>
				</ul>
				
				<div class="sidebar_item">
					<h3>Quick Start</h3>
					<p>See the download instructions for information on getting lamson, and read the getting started instructions to start your own application in less than 10 minutes.</p>
                </div>

                <br/>

				<div class="sidebar_item">
					<h3>Mailing Lists</h3>
                    <p>Lamson hosts its own <a href="/lists/">mailing lists</a> as well as provides a free open mailing list 
                    service for anyone who needs one.  Simply send an email to the list you want at lists.lamsonproject.org and it will
                    get you started.</p>
				</div>
				
			</div>
			
			<div id="footer">
				<div class="footer_content">
                    Lamson Project(TM) and all material on this site Copyright &copy; 2009 <a href="http://zedshaw.com/" title="Zed Shaw's blog">Zed Shaw</a> unless otherwise stated.<br/>
                    
                    Website Designed by <a href="http://kenkeiter.com/">Kenneth Keitner</a> and donated to the LamsonProject.
				</div>
			</div>
			
			<!-- end:centered_content -->
		</div>
	</body>
</html>
	
