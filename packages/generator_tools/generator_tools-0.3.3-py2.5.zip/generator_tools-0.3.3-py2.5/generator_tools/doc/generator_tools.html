<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="content-type">
  <title>generator_tools</title>
  <meta content="Kay Schluehr" name="author">
</head>
<body>
<table
 style="text-align: left; margin-left: auto; margin-right: auto; width: 100%;"
 cellpadding="0" cellspacing="2">
  <tbody>
    <tr>
      <td
 style="background-color: rgb(153, 153, 153); width: 100%; text-align: left;">
      <div style="text-align: center;"> </div>
      <div style="margin-left: 240px; text-align: left;"><big><span
 style="font-weight: bold; font-family: arial; color: rgb(255, 0, 0);">&nbsp;&nbsp;&nbsp;&nbsp;
g
e n e r a t o r _ t o o l s</span></big><br>
      </div>
      </td>
    </tr>
  </tbody>
</table>
<img alt="" src="FS.png" style="width: 76px; height: 71px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br>
<table style="text-align: left; width: 798px; height: 343px;" border="0"
 cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      </td>
      <td style="vertical-align: top;">
      <h1><img style="width: 454px; height: 216px;" alt=""
 src="generator_tools.png">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <br>
      </h1>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"> <br>
      <h3 style="text-align: left;"><small><a
 href="../../../../downloads/downloads.html">Package download</a></small></h3>
      </td>
      <td style="vertical-align: top;"><small><span
 style="font-family: copperplate gothic light;"><big
 style="font-family: franklin gothic book;">&nbsp;&nbsp;&nbsp; &nbsp;
&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp;
Author: Kay Schluehr</big></span><big
 style="font-family: franklin gothic book;"><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;
&nbsp; Date: 2008-07-07<br>
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Version: 0.3.3<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
E-Mail: kay@fiber-space.de<br>
      </big><span style="font-family: arial;"><span
 style="font-family: copperplate gothic bold;"> </span></span></small></td>
    </tr>
  </tbody>
</table>
<small><span style="font-family: arial;"><span
 style="font-family: copperplate gothic bold;">
</span></span></small>
<table style="text-align: left; width: 754px; height: 2773px;"
 border="0" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;"> <span
 style="font-weight: bold;"><br>
      </span><big style="font-weight: bold;"><big><a
 href="#1._Introduction_">1.
Introduction</a><br>
      <br>
      </big></big> What are generator_tools about?<br>
      <br>
      <big><big> <a href="#2._copy_generator_"><span
 style="font-weight: bold;">2. copy_generator</span></a><br>
      <br>
      </big></big> Explains API and implementation of copying
generators.<br>
      <h2> </h2>
      <big><big><a href="#3._pickle_generator"><span
 style="font-weight: bold;">3. The picklegenerators module</span></a></big></big>
      <h2> </h2>
A natural enhancement of making generators copyable is to make them
also persistent. The picklegenerators module serves as a replacement
for the pickle module.<br>
      <br>
      <big><big><a href="#4._Caveats"><span style="font-weight: bold;">4.
Caveats</span></a><br>
      </big></big><br>
Troublesome issues you need to care about when using generator_tools.<br>
      <br>
      <big><big><a href="#5._Acknowledgements"><span
 style="font-weight: bold;">5. Acknowledgements</span></a><br>
      </big></big><br>
To those who deserve them.<br>
      <br>
      <big><big><a href="#6._History"><span style="font-weight: bold;">6.
History</span></a><br>
      </big></big> <br>
Change history.<br>
      <br>
      <h1><a name="1._Introduction_"></a>1. Introduction<br>
      </h1>
Generators are a fundamental abstraction of the Python language.
Generators were first introduced in Python 2.2 together with the yield
keyword turning a function into an generator. In subsequent releases
Python became ever more generator friendly with generator expressions
and finally with turning yield statements into yield expressions and
generators into proper coroutines. A few limitations however remained.
Most notably generators are not copyable and can't be pickled which is
an
obstacle for using generators to implement lightweight concurrency a la
Erlang and distribute them transparently across different OS level
processes. These problems have been solved by the <a
 href="http://www.stackless.com/">Stackless Python</a> dialect of
Python which addressed coroutines and cooperative multitasking
specifically.While SP preceeded CPythons development of coroutines for
years, the arival of Python 2.5 means a significant feature overlap
between SP tasklets and generators. <br>
      <br>
As long as no native implementation for copying generators is available
the generator_tools package can be used to close the gap. The package
is implemented in pure Python and it is available for Python 2.5 and
also Python 3.0. <br>
      <br>
The basic facilities are the <small
 style="font-family: Courier New,Courier,monospace;">copy_generator</small>
and <small style="font-family: Courier New,Courier,monospace;">pickle_generator</small>
functions. Those were described in sections 2 and 3.<br>
      <br>
      <h1><a name="2._copy_generator_"></a>2. copy_generator<br>
      </h1>
The implementation of copy_generator is based on a deep bytecode hack
or expressed in less pejorative manner: it uses runtime introspection
and Python bytecode assembler synthesis. For those who are impatient
and not interested in detail design the API is treated first. Later in
section 2.2 the implementation strategy is iluminated.<br>
      <br>
      <h2>2.1 copy_generator usage</h2>
      <dl>
        <dt>
          <table cellpadding="0" cellspacing="0">
            <tbody>
              <tr valign="baseline">
                <td><nobr><span style="font-family: monospace;"><span
 style="font-weight: bold;">copy_generator</span></span>(</nobr></td>
                <td><var></var><span style="font-style: italic;">f_gen,
[copy_filter]</span>)</td>
              </tr>
            </tbody>
          </table>
        </dt>
        <dd>Keeps a generator object and returns a <small
 style="font-family: Courier New,Courier,monospace;">generatorcopy</small>
object. A <small style="font-family: Courier New,Courier,monospace;">generatorcopy</small>
object provides the same public interface and behaviour as a generator
object but stores additional data used for re-copying. Passing a <small
 style="font-family: Courier New,Courier,monospace;">generatorcopy</small>
object is permitted as well. <br>
          <span style="font-weight: bold;"></span><span
 style="color: rgb(153, 0, 0); font-weight: bold;">New in version
0.2:</span><span style="font-weight: bold;"></span> You can pass an
optional copy_filter parameter which is a boolean function of one
argument. The argument being passed on call of copy_filter is a local
variable of the copied generator. The default behaviour is such that
all locals ( and therefore the generator ) is deepcopied. An exception
is made with objects that have an attribute "sharable" with value
sharable = True. Locals which are assigned as sharable are passed into
the generatorcopy uncopied i.e. without creating new object identities
( see also 2.1.2 for examples ).<br>
        </dd>
      </dl>
      <span style="font-weight: bold;">Example 1:</span><br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-weight: bold;"></span>def
f(start):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
# generator<br>
&nbsp;&nbsp;&nbsp; i = start<br>
&nbsp;&nbsp;&nbsp; while i&lt;start+10:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; yield i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i+=1<br>
            <br>
&gt;&gt;&gt; f_gen = f(3)&nbsp; # creating a generator object f_gen<br>
&gt;&gt;&gt; f_gen.next()&nbsp; # do some action<br>
3<br>
&gt;&gt;&gt; g_gen = copy_generator(f_gen)<br>
&gt;&gt;&gt; g_gen.next()<br>
4<br>
&gt;&gt;&gt; f_gen.next()<br>
4<br>
&gt;&gt;&gt; list(f_gen) == list(g_gen)<br>
True<br>
            </small></td>
          </tr>
        </tbody>
      </table>
      <br>
      <h3>2.1.1 copy_generator and for-loops<br>
      </h3>
Copying generators containing while-loops, even nested while loops
doesn't cause known problems. Also interactions with try...except
statements is not troublesome. However for-loop defintions don't work
out of the
box. We elaborate on this in the nexrt subsection. Here I will present
the
workaround only that makes for-loops copyable. Note, this workaround is
enforced by the current implementation and a <small
 style="font-family: Courier New,Courier,monospace;">CopyGeneratorException</small>
is raised when not being detected.<br>
      <br>
Syntactically a for-loop has three user defined parts:<br>
      <br>
      <small style="font-family: Courier New,Courier,monospace;"><span
 style="font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
for_stmt: 'for' exprlist 'in' testlist ':' suite <br>
      <br>
      </span></small>We are only interested in the <small
 style="font-family: Courier New,Courier,monospace;">testlist</small>
part which is highlighted in the following example:<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-weight: bold;"></span>for k in <span
 style="font-weight: bold; color: rgb(204, 0, 0);">range(20)</span><span
 style="color: rgb(204, 0, 0);">:</span>&nbsp;&nbsp;&nbsp; # in this
form copy_generator can't transfer state<br>
&nbsp;&nbsp;&nbsp;
yield k<br>
            </small></td>
          </tr>
        </tbody>
      </table>
      <br>
This testlist part has to be factored out. But this alone is not
sufficient. It has to be wrapped using the <small><span
 style="font-family: Courier New,Courier,monospace;">for_iter</span></small>
function:<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-weight: bold;"></span>it = <span
 style="font-weight: bold; color: rgb(204, 0, 0);">for_iter(</span></small><small
 style="font-weight: bold;"><span style="color: rgb(204, 0, 0);">range(20))</span>&nbsp;
            </small><small># required boilerplate</small><small><span
 style="font-weight: bold;"></span></small><br>
            <small>for k in it:&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;
yield k<br>
            </small></td>
          </tr>
        </tbody>
      </table>
      <small style="font-family: Courier New,Courier,monospace;"><span
 style="font-weight: bold;"></span></small><small><span
 style="font-family: Courier New,Courier,monospace;"></span></small><br>
      <dl>
        <dt>
          <table cellpadding="0" cellspacing="0">
            <tbody>
              <tr valign="baseline">
                <td><nobr><span style="font-family: monospace;"><span
 style="font-weight: bold;">for_iter</span></span>(</nobr></td>
                <td><var></var><span style="font-style: italic;">iterable</span>)</td>
              </tr>
            </tbody>
          </table>
        </dt>
        <dd>Keeps an iterable and returns an object of type
IteratorView. IteratorViews can be saved and copied. Different
IteratorViews can share a unique iterator and maintain
their own state of iteration.</dd>
      </dl>
IteratorViews being exposed as local variables enable the
copy_generator function to deal with nested
for-loops and generator sequences:<br>
      <br>
      <span style="font-weight: bold;">Example 2 ( continues Example 1):</span><br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-weight: bold;"></span>def g(x,y):<br>
&nbsp;&nbsp;&nbsp;&nbsp; r = for_iter(range(x,y))<br>
&nbsp;&nbsp;&nbsp;&nbsp; for i in r:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; yield i<br>
            <br>
def f():<br>
&nbsp;&nbsp;&nbsp; G = for_iter([g(0,7), g(7,14), g(14, 21)])<br>
&nbsp;&nbsp;&nbsp; for h in G:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; H = for_iter(h)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for item in H:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
yield item<br>
            <br>
&gt;&gt;&gt; gen_f = f()<br>
&gt;&gt;&gt; gen_f.next()<br>
0<br>
            </small><small>&gt;&gt;&gt; gen_f.next()<br>
1<br>
&gt;&gt;&gt; gen_g.next()<br>
2<br>
&gt;&gt;&gt; gen_f.next()<br>
2<br>
&gt;&gt;&gt; list(gen_f) == list(gen_g)<br>
True</small><small><br>
            </small></td>
          </tr>
        </tbody>
      </table>
      <br>
For additional examples you might take a look at unit tests
implemented in test/test_copygenerators.py<br>
      <br>
      <h3>2.1.2 Modify the copying behaviour ( <span
 style="color: rgb(102, 51, 102);"><span style="color: rgb(153, 0, 0);">new
in version 0.2</span> </span>)<br>
      </h3>
Basically the copy_generator function produces deepcopies of generator
objects. However this can be regulated. The second optional parameter
is a function with signature <small
 style="font-family: Courier New,Courier,monospace;">object -&gt; bool</small>.
It is called copy_filter. The copy_generator function has a default
copy_filter defined as:<br>
      <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <small
 style="font-family: Courier New,Courier,monospace;">lambda loc :
hasattr(loc, "sharable") and loc.sharable</small><br>
      <br>
The idea is that only those objects that pass the filter get shared or
passed unmodifed into the generator copy. All others are deepcopied and
a shared nothing policy is applied.<br>
      <br>
One other relevant copy_filter is simple:<br>
      <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <small
 style="font-family: Courier New,Courier,monospace;">lambda loc : True<br>
      <br>
      </small>Here everying is shared. This copy_filter is used on
reconstring a generator object from pickling. The usecase is motivated
as follows. One cannot pickle a generator object gen_f directly but has
to map it onto a GeneratorSnapshot object GS_f&nbsp; first that can be
pickled. On unpickling GS_f will be reconstructed and to get gen_f back
one has to apply copy_generator(GS_f) once. Here we share each local of
GS_f with the new gen_f and throw GS_f away in the next step. Note this
is fully automized and you usually don't have to care unless you want
to implement your own pickling routines.<br>
      <br>
      <h2>2.2 copy_generator implementation<br>
      </h2>
The implementation of copy_generator is based on two ideas:<br>
      <ol>
        <li>Modify the generator assembly and generate JUMP_ABSOLUTE
commands on certain jump addresses. That's easy on a first try but hard
to get it right s.t. no stack is corrupted.</li>
        <li>Read all local variables of an existing generator object
f_gen using runtime introspection and pass them as parameters into a
newly created generator function g. These parameters constitute the
local
environment for executing the generator object g_gen created from g.</li>
      </ol>
      <br>
      <h3>2.2.1 Making a JUMP ABSOLUTE<br>
      </h3>
Let's consider the following simple Python generator containing two
nested while-loops and the related disassembly:<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-weight: bold;"></span></small><small>def f(x, y):<br>
&nbsp;&nbsp;&nbsp; i = 0<br>
&nbsp;&nbsp;&nbsp; while i&lt;x:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; j = 0<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; yield i<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; while j&lt;y:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; yield (i,j)<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; j+=1<br>
            <br>
&gt;&gt;&gt; import dis<br>
&gt;&gt;&gt; dis.dis(f)<br>
            <br>
            </small><small><span
 style="font-family: Courier New,Courier,monospace;">&nbsp;
2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0
LOAD_CONST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 (0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (i)<br>
            <br>
&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6
SETUP_LOOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
71 (to 80)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp;&nbsp; 9
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
12
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
15
COMPARE_OP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (&lt;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
18
JUMP_IF_FALSE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
57 (to 78)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
21
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
            <br>
&nbsp; 4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 22
LOAD_CONST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 (0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
25
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 (j)<br>
            <br>
&nbsp; 5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 28
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (i)<span style="font-weight: bold;"><br>
            </span></span></small><small style="color: rgb(204, 0, 0);"><span
 style="font-family: Courier New,Courier,monospace;"><span
 style="font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
31 YIELD_VALUE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></small><br>
            <small><span
 style="font-family: Courier New,Courier,monospace;"><span
 style="font-weight: bold;"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
32
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
            <br>
&nbsp; 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 33
SETUP_LOOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
39 (to 75)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; 36
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 (j)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
39
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 (y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
42
COMPARE_OP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (&lt;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
45
JUMP_IF_FALSE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
25 (to 73)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
48
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
            <br>
&nbsp; 7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 49
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
52
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 (j)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
55
BUILD_TUPLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2<br>
            <span style="font-weight: bold;"></span></span></small><small
 style="color: rgb(204, 0, 0);"><span
 style="font-family: Courier New,Courier,monospace;"><span
 style="font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
58 YIELD_VALUE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></small><small><span
 style="font-family: Courier New,Courier,monospace;"><span
 style="font-weight: bold;"></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
59
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
            <br>
&nbsp; 8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 60
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 (j)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
63
LOAD_CONST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
66 INPLACE_ADD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
67
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 (j)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
70
JUMP_ABSOLUTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
36<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; 73
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
74
POP_BLOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; 75
JUMP_ABSOLUTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
9<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; 78
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
79
POP_BLOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; 80
LOAD_CONST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (None)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
83 RETURN_VALUE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
            </span></small><br>
            </td>
          </tr>
        </tbody>
      </table>
      <br>
In case of stopping the generator and yielding the first value ( here
it is <span style="font-style: italic;">i</span> ) the last executed
instruction has the index 31 which is considered as a label or offset
when counting from the start of the bytecode sequence. We can read this
value from an generator object in a state of execution with non-empty
stack frame:<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-weight: bold;"></span>&gt;&gt;&gt; f_gen = f(3,4)<br>
&gt;&gt;&gt; f_gen.gi_frame.f_lasti<br>
-1<br>
&gt;&gt;&gt; f_gen.next()<br>
0<br>
&gt;&gt;&gt; f_gen.gi_frame.f_lasti<br>
31<br>
            </small><small><br>
            </small></td>
          </tr>
        </tbody>
      </table>
      <br>
Actually we can keep more information from f_gen, namely the current
local context of evaluation:<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-weight: bold;"></span>&gt;&gt;&gt; f_gen.gi_frame.f_locals<br>
{'i': 0, 'y': 4, 'j': 0, 'x': 3}</small><small><br>
            </small></td>
          </tr>
        </tbody>
      </table>
      <br>
Now suppose we have a function g which keeps all local variables at
jump address 31 of f as parameters:<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small>def
g(x, y, i, j):<br>
&nbsp;&nbsp;&nbsp; i = 0<br>
&nbsp;&nbsp;&nbsp; while i&lt;x:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; j = 0<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; yield i<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; while j&lt;y:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; yield (i,j)<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; j+=1</small><br>
            <small> </small></td>
          </tr>
        </tbody>
      </table>
      <br>
But instead of starting evaluation with a LOAD_CONST bytecode we aim to
jump directly of the offset 31 i.e. exactly to the place where
evaluation of f_gen has
stopped. The bytecode interpreter actually needs to jump a little
further because evaluating
POP_TOP is meaningfull only when a preceeding stack operation was
performed. So we increment the offset by 2. <br>
      <br>
We express our decision by prepending a
JUMP_ABSOLUTE bytecode with 33 as its argument.<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-family: Courier New,Courier,monospace;"><br>
&nbsp; 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span
 style="font-weight: bold; color: rgb(204, 0, 0);">0
JUMP_ABSOLUTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
33 </span></span></small><br>
            <small><span
 style="font-family: Courier New,Courier,monospace;">&nbsp; &nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3
LOAD_CONST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 (0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
6
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (i)<br>
            <br>
&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 9
SETUP_LOOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
74 (to 83)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; 12
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
15
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
....<br>
            </span></small><small> </small></td>
          </tr>
        </tbody>
      </table>
      <br>
With this modified bytecode we can create the function g which resumes
execution where f_gen was stopped.<br>
      <br>
      <h3>2.2.2&nbsp; A crash with many causes<br>
      </h3>
The first naive solution has been suggested as a <a
 href="http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/528949">recipe</a>
in the ActiveState Python Cookbook and it failed as Klaus Mï¿½ller from
the <a href="http://simpy.sourceforge.net/">SimPy</a> projected
pointed out. The cause of error is not easy to see. There are three
factors:<br>
      <ol>
        <li>The first implementation didn't correct the jump addresses
of all other JUMP_ABSOLUTE calls. This caused the error message Klaus
reported. The algorithm jumped to invalid address. <br>
        </li>
        <li>With SETUP_LOOP and other SETUP_XXX commands a block is
pushed on a block stack. The complementary action is POP_BLOCK. While
an
underflow ( too many POP_BLOCK calls ) leads to immediate crash, an
upper threshold for SETUP_LOOP calls ( currently 20 ) that guides
overflow exceptions. You can check this out by creating 20 nested
while-loops for example.<br>
        </li>
        <li>Klaus example contained a for-loop. For-loops are more
complex to handle than while-loops. On bytecode level they are
distincted by the
additional bytecodes GET_ITER and FOR_ITER. GET_ITER creates an
internal iterable not being exposed a user level code and pushes it on
the stack. Without exposition it can't be copied. But what's worse
GET_ITER must be called to enable subsequent calls of FOR_ITER and
GET_ITER is not a jump target for one next iteration but FOR_ITER only.
          <br>
        </li>
      </ol>
      <br>
      <h3>2.2.3&nbsp; Chains of jumps and blocks<br>
      </h3>
As a solution for problem 2) and 3) chains of JUMP_ABSOLUTE bytecodes
are used to connect different SETUP_XXX bytecodes preceeding the
cricical offset. So we are hopping from one SETUP to the next and
initialize the block stack.&nbsp; In case of a SETUP_LOOP belonging to
a for-loop we are processing all bytecodes until the first one after
FOR_ITER . <br>
      <br>
However generating jumps alone is not sufficient because each jump
shall be processed exactly one. We need to deactivate all jumps when
reaching the target offset. This cannot be done dynamically or by
another bytecode transformation. Instead we use a local variable called
      <small style="font-family: Courier New,Courier,monospace;">jump_forward_on
      </small>as a switch and prepare a bytecode block carefully s.t.
the JUMP_ABSOLUTE command is called when <small
 style="font-family: Courier New,Courier,monospace;">jump_forward_on =
True</small> and skipped otherwise. <br>
      <br>
      <table style="text-align: left; width: 70%;" border="0"
 cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td style="vertical-align: top;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
            </td>
            <td style="vertical-align: top;"><img
 style="width: 654px; height: 473px;" alt="" src="Bytecodes.PNG"><br>
            </td>
          </tr>
          <tr>
            <td style="vertical-align: top;"><br>
            </td>
            <td style="vertical-align: top;"><br>
            </td>
          </tr>
        </tbody>
      </table>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <br>
The final block is a modified version of the block shown in the
diagram. When <small
 style="font-family: Courier New,Courier,monospace;">jump_forward_on </small>is
True a second variable called <small
 style="font-family: Courier New,Courier,monospace;">jump_forward_off </small>is
loaded and its value is assigned to <small
 style="font-family: Courier New,Courier,monospace;">jump_forward_on</small>.
If this value is False the JUMP_IF_FALSE command causes skipping
JUMP_ABSOLUTE in the next iteration:<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-family: Courier New,Courier,monospace;"><br>
            </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n&nbsp;&nbsp;
(jump_forward_on)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3&nbsp;
JUMP_IF_FALSE&nbsp;&nbsp; 10<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6&nbsp;
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n+1 (jump_forward_off)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 9&nbsp;
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 12 POP_TOP<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 13 JUMP_ABSOLUTE&nbsp;&nbsp;
setup_offset<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 16 POP_TOP<br>
            </small><small><span
 style="font-family: Courier New,Courier,monospace;"><br>
            </span></small><small> </small></td>
          </tr>
        </tbody>
      </table>
      <br>
Finally we summarize and highlight changes on transformations of our
original bytecode.<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-family: Courier New,Courier,monospace;"><br>
            </span>&gt;&gt;&gt; f_gen = f(3,4)<br>
&gt;&gt;&gt; f_gen.next()<br>
0<br>
&gt;&gt;&gt; f_gen.next()<br>
1<br>
&gt;&gt;&gt; g_gen = copy_generator(f_gen)<br>
&gt;&gt;&gt; import dis<br>
&gt;&gt;&gt; dis.dis(g_gen._g)<br>
            <br>
352&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span
 style="color: rgb(204, 0, 0); font-weight: bold;">0
JUMP_ABSOLUTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: rgb(204, 0, 0);">9</span> </span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3
LOAD_CONST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 (0) <br>
            <br>
353&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (i) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span
 style="color: rgb(102, 0, 204);"><span style="color: rgb(51, 0, 51);">&gt;&gt;</span></span><span
 style="font-weight: bold; color: rgb(102, 0, 204);">&nbsp;&nbsp;&nbsp;
            <span style="color: rgb(102, 51, 255); font-weight: bold;">9</span></span><span
 style="color: rgb(102, 51, 255); font-weight: bold;">
SETUP_LOOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
99 (to 111) </span><br>
            <span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
12
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
4 (jump_forward_on) </span><br
 style="color: rgb(204, 0, 0); font-weight: bold;">
            <span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
15
JUMP_IF_FALSE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
4 (to 22) </span><br style="color: rgb(204, 0, 0); font-weight: bold;">
            <span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
18
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </span><br style="color: rgb(204, 0, 0); font-weight: bold;">
            <span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
19
JUMP_ABSOLUTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: rgb(51, 51, 255);">47 </span></span><br
 style="color: rgb(204, 0, 0); font-weight: bold;">
            <br style="color: rgb(204, 0, 0); font-weight: bold;">
            <span style="color: rgb(51, 0, 51);">354&nbsp;&nbsp;&nbsp;&nbsp;
&gt;&gt;</span><span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;
22
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </span><br style="color: rgb(204, 0, 0); font-weight: bold;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; 23
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (i) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
26
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (x) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
29
COMPARE_OP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (&lt;) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
32
JUMP_IF_FALSE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
74 (to 109) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
35
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
36
LOAD_CONST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 (0) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
39
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 (j) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
42
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (i) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
45 YIELD_VALUE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
46
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; <span
 style="color: rgb(102, 51, 255); font-weight: bold;">47
SETUP_LOOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
56 (to 106) </span><br>
            <span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
50
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
4 (jump_forward_on) </span><br
 style="color: rgb(204, 0, 0); font-weight: bold;">
            <span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
53
JUMP_IF_FALSE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
10 (to 66) </span><br style="color: rgb(204, 0, 0); font-weight: bold;">
            <span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
56
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
5 (jump_forward_off) </span><br
 style="color: rgb(204, 0, 0); font-weight: bold;">
            <span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
59
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
4 (jump_forward_on) </span><br
 style="color: rgb(204, 0, 0); font-weight: bold;">
            <span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
62
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </span><br style="color: rgb(204, 0, 0); font-weight: bold;">
            <span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
63
JUMP_ABSOLUTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: rgb(51, 51, 255);">91 </span></span><br
 style="color: rgb(204, 0, 0); font-weight: bold;">
            <span style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </span><span style="color: rgb(204, 0, 0);"><span
 style="color: rgb(51, 0, 51);">&gt;&gt;</span></span><span
 style="color: rgb(204, 0, 0); font-weight: bold;">&nbsp;&nbsp; 66
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </span><br style="color: rgb(204, 0, 0); font-weight: bold;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; 67
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 (j) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
70
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 (y) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
73
COMPARE_OP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (&lt;) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
76
JUMP_IF_FALSE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
25 (to 104) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
79
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
80
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (i) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
83
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 (j) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
86
BUILD_TUPLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
89 YIELD_VALUE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
90
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; <span
 style="color: rgb(51, 51, 255); font-weight: bold;">91
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 (j) </span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
94
LOAD_CONST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (1) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
97 INPLACE_ADD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
98
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 (j) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 101
JUMP_ABSOLUTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
67 <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp; 104
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 105
POP_BLOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp; 106
JUMP_ABSOLUTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
23 <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp; 109
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 110
POP_BLOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp; 111
LOAD_CONST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (None) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 114
RETURN_VALUE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
            </small> <br>
            <br>
            </td>
          </tr>
        </tbody>
      </table>
      <br>
      <h2>2.3 How to clone a running for-loop ?<br>
      </h2>
How can one clone an iterator? Hasn't this question been answered
already with regard to cloning generators? Or else: if we invent a
different cloning algorithm for iterators why not applying it also
towards generators, something more simple than bytecode hackery? The
basic answer for cloning iterators is very simple: turn them into lists
and clone those. But this is inefficient and a serialization strategy
at best - something being important when we pickle iterators. <br>
      <br>
The answer to copying iterators is to provide IteratorViews. This means
we do not copy iterators at all but provide copies of IteratorView
objects that refer to one unique _IterWrapper object which encapsulate
an iterator and caches its values. The real iterator is therefore
shared among different IteratorViews. An IteratorView just stored the <span
 style="font-style: italic;">state</span> of its own iteration. This
state is an index into the cached iterator value list. When an
IteratorView is copied it is the index that is copied as well and it
will then be incremented separately in subsequent calls to next().<br>
      <br>
However the truth about IteratorViews is actually a little bit more
complicated as will be shown below:<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-family: Courier New,Courier,monospace;">&gt;&gt;&gt;
r&nbsp; = range(4)&nbsp;&nbsp; <br>
&gt;&gt;&gt; iv = for_iter(r)<br>
&gt;&gt;&gt; iv<br>
&lt;__main__.IteratorView object at 0x0134B330&gt;<br>
&gt;&gt;&gt; iv.next()&nbsp;&nbsp; # iv.offset -&gt; 0 , recorded -&gt;
[0]<br>
0<br>
&gt;&gt;&gt; iv.next()&nbsp;&nbsp; # iv.offset -&gt; 1 , recorded -&gt;
[0, 1]<br>
1<br>
&gt;&gt;&gt; iv2 = iv.__gencopy__()&nbsp; # copy iv with offset = 1<br>
&gt;&gt;&gt; iv2.next()&nbsp; <br>
1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <span style="font-weight: bold;"># ??? Bug? <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
# Didn't we all expect the offset being 1 and the next value being 2 ?</span></span></small><small><span
 style="font-family: Courier New,Courier,monospace;"><br>
            </span></small><small><span
 style="font-family: Courier New,Courier,monospace;"><br>
            </span></small></td>
          </tr>
        </tbody>
      </table>
      <br>
The reason for this admittedly strange behaviour is the fact that
for_iter is not used primarily for just copying iterators but copying
iterators of for-loops. To understand why we decrement the offset on
copy we need to decompile an iterator containing a for-loop.<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 741px; height: 54px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-family: Courier New,Courier,monospace;"><br>
            </span>352&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: rgb(51, 0, 51);">0
JUMP_ABSOLUTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
21 </span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3
LOAD_GLOBAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (for_iter) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
6
LOAD_GLOBAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 (range) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
9
LOAD_CONST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 (10) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
12
CALL_FUNCTION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
15
CALL_FUNCTION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 <br>
            <br>
353&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 18
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (it) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; <span
 style="color: rgb(51, 0, 51);">21</span>
SETUP_LOOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
36 (to 60) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
24
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (it) <br>
            <span style="color: rgb(153, 51, 153); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
27
GET_ITER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </span><br
 style="color: rgb(153, 51, 153); font-weight: bold;">
            <span style="color: rgb(153, 51, 153); font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&gt;&gt;&nbsp;&nbsp; 28
FOR_ITER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
28 (to 59) </span><br
 style="color: rgb(153, 51, 153); font-weight: bold;">
            <br style="color: rgb(153, 51, 153); font-weight: bold;">
            <span style="color: rgb(153, 51, 153); font-weight: bold;">354&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
31
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 (i) </span><br style="color: rgb(204, 0, 0); font-weight: bold;">
            <span style="color: rgb(51, 0, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
34
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (jump_forward_on) </span><br style="color: rgb(51, 0, 51);">
            <span style="color: rgb(51, 0, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
37
JUMP_IF_FALSE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
10 (to 50) </span><br style="color: rgb(51, 0, 51);">
            <span style="color: rgb(51, 0, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
40
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3 (jump_forward_off) </span><br style="color: rgb(51, 0, 51);">
            <span style="color: rgb(51, 0, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
43
STORE_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2 (jump_forward_on) </span><br style="color: rgb(51, 0, 51);">
            <span style="color: rgb(51, 0, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
46
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </span><br style="color: rgb(51, 0, 51);">
            <span style="color: rgb(51, 0, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
47
JUMP_ABSOLUTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
56 </span><br style="color: rgb(51, 0, 51);">
            <span style="color: rgb(51, 0, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&gt;&gt;&nbsp;&nbsp; 50
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </span><br style="color: rgb(51, 0, 51);">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
51
LOAD_FAST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1 (i) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
54 YIELD_VALUE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
55
POP_TOP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; <span
 style="font-weight: bold; color: rgb(204, 0, 0);">56
JUMP_ABSOLUTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
28</span> <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; 59
POP_BLOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;&gt;&nbsp;&nbsp; 60
LOAD_CONST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0 (None) <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
63 RETURN_VALUE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
            </small> <small><span
 style="font-family: Courier New,Courier,monospace;"><br>
            </span></small><small> </small></td>
          </tr>
        </tbody>
      </table>
      <br>
The critical section is highlighted. What happened here is that the
iterator is called once with FOR_ITER before the JUMP_ABSOLUTE command
at offset 56 is reached which continues iteration with another jump to
FOR_ITER. So FOR_ITER is called twice! By decrementing the index in the
IteratorView we ensure that the correct value is used at each
iteration. <br>
      <br>
Maybe you have noticed that the name of the copy function is called
__gencopy__ and it might be applied for internal copying purposes only.
Another function is called __itercopy__ and it provides non-surprising
behaviour as being shown in the next example:<br>
      <br>
      <small> </small><small> </small><small> </small><small> </small><small>
      </small> <small> </small>
      <table
 style="background-color: rgb(255, 255, 239); font-family: courier new; text-align: left; width: 777px; height: 365px;"
 border="0" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="background-color: rgb(236, 236, 236); vertical-align: top;"><small><span
 style="font-family: Courier New,Courier,monospace;"></span>&gt;&gt;&gt;
iv = for_iter(range(4))<br>
&gt;&gt;&gt; iv.next()<br>
0<br>
&gt;&gt;&gt; iv.next()<br>
1<br>
&gt;&gt;&gt; iv2 = iv.__itercopy__()<br>
&gt;&gt;&gt; iv2.next()<br>
2<br>
&gt;&gt;&gt; iv2.next()<br>
3<br>
&gt;&gt;&gt; iv.next()<br>
2<br>
&gt;&gt;&gt; list(iv)<br>
[3]<br>
&gt;&gt;&gt; iv2.next()<br>
            <span style="color: rgb(255, 0, 0);">Traceback (most recent
call last):</span><br style="color: rgb(255, 0, 0);">
            <span style="color: rgb(255, 0, 0);">&nbsp; File
"&lt;interactive input&gt;", line 1, in &lt;module&gt;</span><br
 style="color: rgb(255, 0, 0);">
            <span style="color: rgb(255, 0, 0);">&nbsp; File
"c:\lang\python25\lib\site-packages\generator_tools\copygenerators.py",
line 64, in next</span><br style="color: rgb(255, 0, 0);">
            <span style="color: rgb(255, 0, 0);">&nbsp;&nbsp;&nbsp;
item = self.itwrap.next(self)</span><br style="color: rgb(255, 0, 0);">
            <span style="color: rgb(255, 0, 0);">&nbsp; File
"c:\lang\python25\lib\site-packages\generator_tools\copygenerators.py",
line 28, in next</span><br style="color: rgb(255, 0, 0);">
            <span style="color: rgb(255, 0, 0);">&nbsp;&nbsp;&nbsp;
item = self.it.next()</span><br style="color: rgb(255, 0, 0);">
            <span style="color: rgb(255, 0, 0);">StopIteration</span><br
 style="color: rgb(255, 0, 0);">
            <br>
            </small><small><span
 style="font-family: Courier New,Courier,monospace;"></span></small></td>
          </tr>
        </tbody>
      </table>
      <br>
You can use also use copy.deepcopy to achieve the same effect.<br>
      <br>
      <h1><a name="3._pickle_generator"></a>3. The picklegenerators
module<br>
      </h1>
      <span style="color: rgb(153, 0, 0); font-weight: bold;">Changed
in
version
0.3</span><br>
      <br>
The picklegenerators modules serves as a full replacement for the
pickle
module. You can use convenient API functions like dump, dumps or load
or the classes Pickler, Unpickler. The only notable difference is that
generator objects ( as well as some derived objects ) can now be
pickled / unpickled. Classes like GeneratorPickler or functions like
unpickle_generator are marked as deprecated and a warning is sent when
being called. They will be entirely removed in version 0.5 of
generator_tools.<br>
      <br>
      <h1><a name="4._Caveats"></a>4. Caveats</h1>
      <span style="font-weight: bold;"></span>Some additional advices
for the user of generator_tools<br>
      <h2>4.1 avoid yield expressions in finally clauses</h2>
On a few occasions yield expressions in finally clauses crashed my
Python interpreter. This behaviour even lead to drop of those tests
from the test suite and leave the note here instead. While not always
being harmfull when copied there are at least indications for not
working correctly and they shall be avoided.<br>
      <br>
      <h2>4.2 Python 3.0 is not dry yet</h2>
I've done some wrapping of datatypes after unpickling. I believe
pickling/unpickling is broken in Python 3.0 at this stage of
development but I expected struggling with type conversions anyway. <br>
      <br>
      <span style="color: rgb(153, 0, 0); font-weight: bold;">New in
version
0.2:</span><span style="font-weight: bold;"></span> pickling is
troublesome using Python 3.0 a2. Not sure if it's a bug in
generator_tools or in Python 3.0. I will suspend additional releases
supporting 3.0 and wait until the first beta.<br>
      <br>
      <h1><a name="5._Acknowledgements"></a>5. Acknowledgements</h1>
Thanks to Klaus MÃ¼ller, Jenna Louis, Lorenz Quack, Marek Majkowski for
important reinforcements. Special thanks to
Lorenz Quack for providing a redesign of the picklegenerators module.<br>
      <br>
      <h1><a name="6._History"></a>6. History</h1>
      <br>
      <table style="text-align: left; width: 785px; height: 212px;"
 border="1" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td
 style="vertical-align: top; text-align: left; background-color: rgb(240, 240, 240);"><span
 style="font-weight: bold;">Date</span><br>
            </td>
            <td
 style="vertical-align: top; text-align: left; background-color: rgb(240, 240, 240);"><span
 style="font-weight: bold;">Version</span><br>
            </td>
            <td
 style="vertical-align: top; text-align: left; background-color: rgb(240, 240, 240);"><span
 style="font-weight: bold;">Change</span><br>
            </td>
          </tr>
          <tr>
            <td style="vertical-align: top;">2008-07-07<br>
            </td>
            <td style="vertical-align: top;">0.3.3<br>
            </td>
            <td style="vertical-align: top;">
            <ul>
              <li>For simple yield expressions or simple sequences of
yield expressions no jump was generated. This bug came in with version
0.3.2.</li>
              <li>Make functions loads() and dumps() visible on package
level.<br>
              </li>
            </ul>
            </td>
          </tr>
          <tr>
            <td style="vertical-align: top;">2008-05-17<br>
            </td>
            <td style="vertical-align: top;">0.3.2<br>
            </td>
            <td style="vertical-align: top;">
            <ul>
              <li>Fix initialization bug. When a generator gen_f
contains a nested for loop or a sequence of for loops not all for_iter
IteratorViews might have been initialized. When gen_f is copied the
copying routine counts the number of IteratorView objects and compares
it with the number of FOR_ITER opcodes available in gen_f. This is too
eager and the copying routine has been modified s.t. only the number of
FOR_ITER opcodes preceeding the last_i opcode are counted.</li>
              <li>Fixing sequences of for-loops. When two or more for
loops occured within a generator in sequence generator_tools produced a
wrong jump sequence. This has been adjusted in this version.<br>
              </li>
            </ul>
            </td>
          </tr>
          <tr>
            <td style="vertical-align: top;">2008-03-28<br>
            </td>
            <td style="vertical-align: top;">0.3.1<br>
            </td>
            <td style="vertical-align: top;">
            <ul>
              <li>Fix sameness bug for
pickling generators. A generator object G which existed at different
locations loc1, loc2 has been converted into distinct
GeneratorSnapshots GS1, GS2 for pickling which lead to distinct
unpickled generators uG1, uG2. We have established now a unique
correspondence of G with uG.</li>
            </ul>
            </td>
          </tr>
          <tr>
            <td
 style="vertical-align: top; background-color: rgb(250, 250, 250);">2008-01-26
&nbsp;&nbsp; <br>
            </td>
            <td style="vertical-align: top;">0.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <br>
            </td>
            <td style="vertical-align: top;">
            <ul>
              <li>Redesign of the
picklegenerators module ( by Lorenz Quack )</li>
            </ul>
            </td>
          </tr>
          <tr>
            <td
 style="vertical-align: top; background-color: rgb(250, 250, 250);">2008-01-22<br>
            </td>
            <td style="vertical-align: top;">0.2<br>
            </td>
            <td style="vertical-align: top;">
            <ul>
              <li>Implement copy_filter function as second optional
parameter</li>
              <li>Modify unpickling s.t. GeneratorSnapshot is not
deepcopied anymore</li>
              <li>Adapt interface of GeneratorPickler to be complient
with interface of pickler.Pickler and declare the old interface as
deprecated.</li>
              <li>Delay a 0.2 release for Python 3.0<br>
              </li>
            </ul>
            </td>
          </tr>
          <tr>
            <td
 style="vertical-align: top; background-color: rgb(250, 250, 250);">2007-10-5<br>
            </td>
            <td style="vertical-align: top;">0.1<br>
            </td>
            <td style="vertical-align: top;">Initial release<br>
            </td>
          </tr>
        </tbody>
      </table>
      <br>
      <br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<br>
</body>
</html>
