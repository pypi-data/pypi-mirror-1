<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="upfrontcontacts">
  <body>
    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border', 1)" />

    <div metal:fill-slot="main">
      <div metal:define-macro="main"
       tal:omit-tag=""
       tal:define="
            contactstool nocall:portal/upfront_contacts_tool;
            import_type request/import_type;
            fieldnames python:contactstool.contactTypeFieldNames(import_type);
            quote_char request/quote_char;
            delimiter request/delimiter;
            link_via_title python:request.get('link_via_title', 0);
            coding request/coding;
            rows python:contactstool.csv_parser(delimiter=delimiter, coding=coding, quote_char=quote_char)[:10];
                   ">

    <h1 i18n:translate="heading_import_contacts">Import contacts</h1>

    <h4 i18n:translate="heading_map_fields">Step 3: Map data fields</h4>

    <form name="form" action="." method="post"
            tal:attributes="action here/upfront_contacts_tool/absolute_url">

            <input type="hidden" name="import_type" tal:attributes="value import_type">
            <input type="hidden" name="quote_char" tal:attributes="value quote_char">
            <input type="hidden" name="delimiter" tal:attributes="value delimiter">
            <input type="hidden" name="coding" tal:attributes="value coding">
            <input type="hidden" name="link_via_title:int" tal:attributes="value link_via_title">
            <input type="hidden" name="n_fields:int" 
                    tal:attributes="value python:len(rows[0])"
                    tal:condition="rows">

        <div style="width: 500px;" i18n:translate="map_fields_intro">
        
        Here you must define how columns are mapped to contact fields.<br/>
        
        If there is no sensible field to map a column to, it can either be 
        discarded or appended to the body/note field.<br/>
        
        If more than one column is mapped to the same field, the values are 
        joined.<br/>
        
        </div>
        <br/>
        <div tal:condition="not:rows">
        <b i18n:translate="missing_file">Missing or empty file</b>
        </div>

        <table border="1" cellspacing="0" cellpadding="4"
                tal:condition="rows">
            <tr align="left" valign="top">
                <td tal:repeat="cell python:rows[0]">
                    <select tal:attributes="name string:fields_map_${repeat/cell/index}">
                        <option value="*discard*" selected i18n:translate="discard_field"> - Discard field - </option>
                        <option tal:repeat="fieldname fieldnames"
                                tal:content="fieldname"
                                tal:attributes="value fieldname;"
                                i18n:translate="">fieldname</option>
                    </select>
                </td>
            </tr>
            <tr align="left" valign="top"
                tal:repeat="row rows">
                <td tal:repeat="cell row"
                    tal:content="cell">
                    cell
                </td>
            </tr>
        </table>

        <br/>
        <div class="submit" tal:condition="rows">
            <div i18n:translate="uploading_may_take">
            [Uploading might take many minutes!]
            </div>
            <br/>
            <input class="context"
                    type="submit"
                    value="Upload"
                    name="importCSV:method"
                    i18n:attributes="value"
                    tabindex=""
                    tal:attributes="tabindex tabindex/next;"
                    />

            <input type="hidden" name="current_path"
                tal:attributes="value python:'/'.join(here.getPhysicalPath())">

        </div>

    </form>

      </div>
    </div>
  </body>
</html>
