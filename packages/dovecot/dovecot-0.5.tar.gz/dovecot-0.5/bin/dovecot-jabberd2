#!/usr/bin/env python

# Copyright 2008-2009 Thomas Arnett
# Licensed under the Open Software License, version 3.0

'''pipe authenticator for Dovecot and jabberd2
http://jabberd2.xiaoka.com/export/250/trunk/docs/dev/c2s-pipe-authenticator'''

import sys

import dovecot

SERVICE = 'jabberd'

# COMPAT
input = getattr(__builtins__, 'raw_input', input)
_print = getattr(__builtins__, 'print', lambda *args: 
	sys.stdout.write('%s\n' % ' '.join(map(str, args)))
)

commands = {
	'USER-EXISTS': lambda user: 
		master.user(user, SERVICE),
	'CHECK-PASSWORD': lambda user, pass_b64: 
		client.auth(user, pass_b64.decode('base64'), SERVICE),
	'FREE':
		exit
}

# handshake with Dovecot
client = dovecot.Client()
master = dovecot.Master(client)

# handshake with jabberd2
args = ['OK'] + commands.keys()
_print(*args)
sys.stdout.flush()

while True:
	try:
		args = input().split(' ')
		ok = commands[args.pop(0)](*args)
	except EOFError:
		exit()
	except Exception:
		ok = False
	
	_print('OK' if ok else 'NO')
	sys.stdout.flush()
