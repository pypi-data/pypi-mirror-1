<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Основные компоненты сервера &mdash; СпамоБорец: документация</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '0.2',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="СпамоБорец: документация" href="../index.html" />
    <link rel="up" title="Руководство пользователя" href="index.html" />
    <link rel="next" title="Настройка сервера" href="configure.html" />
    <link rel="prev" title="Запуск сервера" href="running.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="configure.html" title="Настройка сервера"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="running.html" title="Запуск сервера"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">СпамоБорец: документация</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Руководство пользователя</a> &raquo;</li> 
      </ul>
    </div>  
    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  
  <div class="section" id="id1">
<h1>Основные компоненты сервера<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>В этом разделе описаны основные компоненты сервера, их функционирование, настройка,
взаимосвязи.</p>
<div class="section" id="id2">
<span id="domain"></span><span id="index-18"></span><h2>Домен<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Домен - это контекст выполнения любого запроса в рамках СпамоБорца. Домен представляет собой
просто набор пар вида: имя свойства, значение свойства. Свойствами домена могут быть простые
значения: числа, строки и т.п., так и более сложные элементы, являющиеся компонентами СпамоБорца:
<a class="reference internal" href="#message-log"><em>лог сообщений</em></a>, <a class="reference internal" href="#firewall"><em>firewall</em></a>.</p>
<p>У домена может быть <em>предок</em> (тоже являющийся доменом). Тогда операция получения свойства домена при отсутствии свойства
у данного домена будет обращаться с запросом к предку, так можно организовать наследование доменов:
домен-предок содержит свойства &#8220;по умолчанию&#8221;, а домены-наследники (его дети) переопределяют
необходимые свойства, уточняя поведение сервера для различных ситуаций. Например, базовый домен определяет
свойства анализа сообщений для всего сайта, а поддомены-наследники конкретизируют эти свойства для
различных видов общения (чат, личные сообщения и т.п.)</p>
<img alt="../_images/domains-png.png" src="../_images/domains-png.png" />
<p>Домен может иметь <em>имя</em>, тогда он становится адресуемым относительно своего предка (аналогично адресуемости
каталогов в файловой системе). Относительного одного домена адрес другого может выглядеть так: <tt class="docutils literal"><span class="pre">a/b</span></tt>, тогда
относительно текущего корневого домена мы должны взять потомка с именем <tt class="docutils literal"><span class="pre">a</span></tt>, а у него потомка с именем <tt class="docutils literal"><span class="pre">b</span></tt>.</p>
<div class="section" id="id3">
<h3>Примеры<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Пример дерева доменов:</p>
<img alt="../_images/domains.png" src="../_images/domains.png" />
<p>В этом примере в корневому домену прикреплено три дочерних поддомена, каждый из которых отвечает за фильтрацию спама
в трех различных разделах сайта:</p>
<ul class="simple">
<li><em>pm</em> - личные сообщения;</li>
<li><em>chat</em> - чат;</li>
<li><em>comments</em> - пользовательские комментарии.</li>
</ul>
<p>Пример содержимого домена:</p>
<img alt="../_images/rootdomain.png" src="../_images/rootdomain.png" />
<p>В данном домене находится:</p>
<ul class="simple">
<li><a class="reference internal" href="#storage"><em>хранилище данных</em></a> (storage);</li>
<li><a class="reference internal" href="#model"><em>модель анализа сообщений</em></a> (model);</li>
<li><a class="reference internal" href="#firewall"><em>firewall</em></a> (messageAnalyzer);</li>
<li><a class="reference internal" href="#message-log"><em>лог сообщений</em></a> (messageLog).</li>
</ul>
</div>
<div class="section" id="id4">
<h3>Домен по умолчанию<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>В системе существует <em>домен по умолчанию</em>, который является предком всех корневых доменов партнеров.
Домен по умолчанию может определять свойства, которые будут служить значениями по умолчанию для всех
поддоменов. Сам по себе домен по умолчанию недоступен для изменения, он не может быть адресован через
<a class="reference external" href="../api/index.html#api"><em>API СпамоБорца</em></a>.</p>
</div>
</div>
<div class="section" id="id5">
<span id="partner"></span><span id="index-19"></span><h2>Партнер<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>Партнер - единица авторизации относительно сервера. Практически все запросы <a class="reference external" href="../api/index.html#api"><em>API СпамоБорца</em></a> требуют авторизации, т.е. указания
партнера, от имени которого выполняется запрос. Партнер может обладать функциональностью биллинга/аккаунтинга (т.е. вести
учет количества запросов к серверу и т.п.). Партнеры изолированы друг от друга, авторизовавшись под одним партнером нет
возможности повлиять на данные другого партнера.</p>
<p>Самое главное свойство партнера - его корневой <a class="reference internal" href="#domain"><em>домен</em></a>, который определяет корень возможных контекстов
исполнения запросов. Любой запрос, выполненный от имени партнера, будет исполняться в его корневом домене или в доменах,
являющихся потомками корневого домена.</p>
<div class="section" id="id6">
<span id="authorize-provider"></span><span id="index-20"></span><h3>Механизм авторизации партнеров<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>Механизм авторизации партнеров определяет способ, которым по информации, переданной в <a class="reference external" href="../api/index.html#api"><em>API СпамоБорца</em></a>, определяется текущий
партнер для выполнения запроса.</p>
<div class="section" id="id7">
<span id="null-partner-authorizer"></span><h4>Доверительный механизм авторизации<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>Доверительный механизм применяется для инсталляций, обслуживающих один проект, когда нет необходимости каким-то образом
авторизовать входящие запросы. В данной ситуации сервер СпамоБорец защищен от посторонних запросов либо сетевым firewall,
либо дополнительным HTTP-proxy с возможностью блокировки по IP-адресу или HTTP-авторизацией.</p>
<p>В случае доверительного механизма авторизации существует всего один партнер, который определяет свой единственный корневой
домен.</p>
</div>
</div>
</div>
<div class="section" id="id8">
<span id="message"></span><span id="index-21"></span><h2>Сообщение<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>Сообщение - единица передачи информации в СпамоБорец. Сообщение состоит из <a class="reference internal" href="#message-attribute"><em>атрибутов</em></a>, набор которых,
типы и т.п., полностью настраиваются в рамках <a class="reference internal" href="#domain"><em>домена</em></a>. Типичные атрибуты сообщения:</p>
<blockquote>
<ul class="simple">
<li>текст сообщения: чаще всего подвергается анализу различными методами;</li>
<li>ID пользователя, отправившего сообщение: может использовать при анализе на частоту отправки сообщений, для выявления и блокировки
спамеров и т.п.;</li>
<li>другие атрибуты: e-mail отправителя, ник, логин, IP-адрес, данные об адресате сообщения, любая другая информация, которая может быть полезна
для анализа сообщения.</li>
</ul>
</blockquote>
<p>Сообщение при передаче через <a class="reference external" href="../api/index.html#api"><em>API СпамоБорца</em></a> проходит через механизм сериализации, который, используя данные о типах атрибутов, осуществляет
корректное сохранение и восстановление сообщения.</p>
<table border="1" class="docutils">
<caption>Пример сообщения</caption>
<colgroup>
<col width="11%" />
<col width="29%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Атрибут</th>
<th class="head">Домен атрибута</th>
<th class="head">Значение атрибута</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>text</td>
<td>Текстовый домен</td>
<td>&#8220;Ты не хочешь пойти сегодня погулять? Часиков в восемь?&#8221;</td>
</tr>
<tr><td>fromID</td>
<td>Уник. целоцисленный домен</td>
<td>38</td>
</tr>
<tr><td>fromIP</td>
<td>IP-адрес</td>
<td>127.0.0.1</td>
</tr>
<tr><td>fromEmail</td>
<td>E-mail</td>
<td><a class="reference external" href="mailto:bob&#37;&#52;&#48;example&#46;com">bob<span>&#64;</span>example<span>&#46;</span>com</a></td>
</tr>
</tbody>
</table>
<div class="section" id="id9">
<span id="message-attribute"></span><span id="index-22"></span><h3>Атрибут сообщения<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>Атрибут сообщения - составная часть <a class="reference internal" href="#message"><em>сообщения</em></a>. Атрибут хранит свое значение, а также свой тип -
<a class="reference internal" href="#attribute-domain"><em>домен атрибута</em></a>. Тип значения определяется доменом: для текстового домена это будет
строка, а для целочисленного, например, - число.</p>
</div>
<div class="section" id="id10">
<span id="attribute-domain"></span><span id="index-23"></span><h3>Домен атрибута сообщений<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>Домен атрибута определяет тип <a class="reference internal" href="#message-attribute"><em>атрибута сообщения</em></a>. Разнообразие доменов атрибутов
определяет возможные типы данных и смысл атрибутов сообщений. Домен может определять не только тип значения,
но и дополнительные логические характеристики (например, уникальность значения).</p>
<div class="section" id="id11">
<span id="index-24"></span><h4>Текстовый домен<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>Текстовый домен используется обычно для передачи текста сообщения. Внутренняя кодировка хранения - Unicode, т.е.
СпамоБорец готов к обработке данных на любых языках. При передаче данных через <a class="reference external" href="../api/index.html#api"><em>API СпамоБорца</em></a> значение такого атрибута
обычно кодируется в кодировке UTF-8.</p>
<p>При десериализации атрибута текстового домена убираются пробельные символы в начале и в конце строки.</p>
<dl class="function">
<dt id="TextAttributeDomain">
<!--[TextAttributeDomain]--><tt class="descname">TextAttributeDomain</tt><big>(</big><em>name</em><big>)</big><a class="headerlink" href="#TextAttributeDomain" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>name</em> &#8211; имя атрибута</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="id12">
<span id="index-25"></span><h4>Целочисленный домен<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>Целочисленный домен может использоваться для передачи различных чисел, связанных с сообщением или его адресатами
и адресантами.</p>
<p>При передаче в <a class="reference external" href="../api/index.html#api"><em>API СпамоБорца</em></a> используется тип данных &#8220;число&#8221;.</p>
<dl class="function">
<dt id="IntAttributeDomain">
<!--[IntAttributeDomain]--><tt class="descname">IntAttributeDomain</tt><big>(</big><em>name</em><big>)</big><a class="headerlink" href="#IntAttributeDomain" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>name</em> &#8211; имя атрибута</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="id13">
<span id="index-26"></span><h4>Уникальный целочисленный домен<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>Уникальный целочисленный домен отличается от целочисленного только логической привязкой &#8220;уникальный&#8221;, которая
определяет смысл атрибута. Данный домен может использоваться, например, для передачи ID пользователя - отправителя сообщения.</p>
<dl class="function">
<dt id="UniqueIntAttributeDomain">
<!--[UniqueIntAttributeDomain]--><tt class="descname">UniqueIntAttributeDomain</tt><big>(</big><em>name</em><big>)</big><a class="headerlink" href="#UniqueIntAttributeDomain" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>name</em> &#8211; имя атрибута</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
<div class="section" id="id14">
<span id="message-domain"></span><span id="index-27"></span><h3>Домен сообщения<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>Домен сообщения - это набор <a class="reference internal" href="#attribute-domain"><em>доменов атрибутов</em></a> <a class="reference internal" href="#message"><em>сообщения</em></a>. Домен определяет
формат сообщений. Домен определяет возможный набор атрибутов сообщения, каждое сообщение может содержать лишь часть
перечисленных атрибутов (например, если данных недостаточно).</p>
<p>Домен сообщения хранится в <a class="reference internal" href="#domain"><em>домене</em></a> в свойстве с именем <tt class="docutils literal"><span class="pre">messageDomain</span></tt>. Наличие домена сообщения является
обязательным.</p>
<dl class="function">
<dt id="MessageDomain">
<!--[MessageDomain]--><tt class="descname">MessageDomain</tt><big>(</big><em>attributeDomain1</em><span class="optional">[</span>, <em>...</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#MessageDomain" title="Permalink to this definition">¶</a></dt>
<dd>В качестве параметров конструктора домен сообщения принимает список доменов атрибутов.</dd></dl>

<p>Пример:</p>
<div class="highlight-python"><pre>MessageDomain(TextAttributeDomain("text"), UniqueIntAttributeDomain("fromID))</pre>
</div>
</div>
</div>
<div class="section" id="id15">
<span id="model"></span><span id="index-28"></span><h2>Модель анализа сообщений<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h2>
<p>Модель анализа сообщений осуществляет классификацию сообщений, выделяя в потоке сообщений, например,
спам, флуд, оскорбления, предложения интимного характера и т.п. классы. Работа модели основана на процессе
обучения. В режиме обучения модель получает образец исходных данных с необходимой пометкой - к какому
классу относится тот или иной элемент. После обучения модель готова на новых данных готова классифицировать
поступающие на вход данные.</p>
<p>Модель анализа сообщений поддерживает два условных класса: &#8220;хороший&#8221; (<tt class="docutils literal"><span class="pre">good</span></tt>) и &#8220;плохой&#8221; (<tt class="docutils literal"><span class="pre">bad</span></tt>). Интерпретация
классов зависит от задачи: одна модель может отвечать за классификацию &#8220;спам&#8221; - не-&#8220;спам&#8221;, другая: &#8220;мат&#8221; - не &#8220;мат&#8221;.
Модель стремится минимизировать ошибки классификации, связанные с классификацией &#8220;хорошего&#8221; сообщения как &#8220;плохого&#8221;.
Модель в качестве исходных данных на вход принимает текст сообщения.</p>
<p>Модель анализа сообщений хранится в <a class="reference internal" href="#domain"><em>домене</em></a> в свойствах с произвольным именем.</p>
<div class="section" id="bayesmodel">
<span id="index-29"></span><h3>Простая Байесовская модель (BayesModel)<a class="headerlink" href="#bayesmodel" title="Permalink to this headline">¶</a></h3>
<p>Простая Байесовская модель основана на теореме Байеса <a class="footnote-reference" href="#bayes" id="id16">[1]</a>. Данная модель не имеет практической ценности,
т.к. состояние модели (обучения) не сохраняется, а находится лишь в оперативной памяти и при перезапуске сервера
пропадает.</p>
<dl class="function">
<dt id="BayesModel">
<!--[BayesModel]--><tt class="descname">BayesModel</tt><big>(</big><big>)</big><a class="headerlink" href="#BayesModel" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="datamining-dataminingmodel">
<span id="index-30"></span><h3>DataMining-модель (DataMiningModel)<a class="headerlink" href="#datamining-dataminingmodel" title="Permalink to this headline">¶</a></h3>
<p>Данная модель построена на принципах интеллектуального анализа данных <a class="footnote-reference" href="#datamining" id="id17">[2]</a>. Она обладает хорошей возможностью
к обучению, высокой эффективностью и точностью классификации.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Данная модель доступна только в Pro-варианте СпамоБорца.</p>
</div>
<dl class="function">
<dt id="DataMiningModel">
<!--[DataMiningModel]--><tt class="descname">DataMiningModel</tt><big>(</big><big>)</big><a class="headerlink" href="#DataMiningModel" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
</div>
<div class="section" id="id18">
<span id="storage"></span><span id="index-31"></span><h2>Хранилище данных<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<p>Хранилище данных используется для хранения данных в рамках <a class="reference internal" href="#domain"><em>домена</em></a>. Хранилище предоставляет
абстракцию коллекции пар (ключ, значение), при этом каждый ключ может иметь срок годности (предельное время
хранения). Хранилище может обладать разными характеристиками по скорости доступа, отношения к перезапуску (надежность),
а также к распределенному использованию.</p>
<div class="section" id="domainmemorystorage">
<h3>Хранилище в памяти (DomainMemoryStorage)<a class="headerlink" href="#domainmemorystorage" title="Permalink to this headline">¶</a></h3>
<p>Данные такого хранилища хранятся в оперативной памяти сервера, теряются при перезапуске сервера. Может использоваться
для хранения ключей с малым временем жизни, использующихся, например, при анализе частоты отправки сообщений за
небольшой промежуток времени (полчаса и меньше).</p>
<dl class="function">
<dt id="DomainMemoryStorage">
<!--[DomainMemoryStorage]--><tt class="descname">DomainMemoryStorage</tt><big>(</big><big>)</big><a class="headerlink" href="#DomainMemoryStorage" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="domaineddbmstorage">
<h3>Хранилище на диске (DomainedDBMStorage)<a class="headerlink" href="#domaineddbmstorage" title="Permalink to this headline">¶</a></h3>
<p>Хранилище на диске обеспечивает постоянное, надежное хранение информации на локальном диске сервера, на котором
работает СпамоБорец. Содержимое хранилища не теряется при перезапуске сервера. Скорость доступа ниже, чем у хранилища
в памяти.</p>
<dl class="function">
<dt id="DomainedDBMStorage">
<!--[DomainedDBMStorage]--><tt class="descname">DomainedDBMStorage</tt><big>(</big><big>)</big><a class="headerlink" href="#DomainedDBMStorage" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
</div>
<div class="section" id="id19">
<span id="rules"></span><span id="index-32"></span><h2>Правила<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h2>
<p>Правила анализа сообщений выполняют основную работу по анализу сообщений, они применяются в рамках
работы <a class="reference internal" href="#firewall"><em>firewall</em></a> к сообщениями относительно текущего домена. Вызов правила синтаксически
совпадает с вызовом правила: у правила есть имя, а также набор именованных параметров.</p>
<p>Таким образом, каждое правило в качестве неявного параметра получает сообщение и домен, относительно
которого происходит анализ данного сообщения. Домен используется правилами для получения дополнительных
параметров настройки, дополнительных компонентов, например, хранилищ данных.</p>
<div class="section" id="id20">
<span id="index-33"></span><h3>Правила, связанные с моделью анализа сообщений<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p>Все правила этого раздела принимают в качестве параметра имя модели анализа сообщения, сама модель
должна быть доступна через текущий домен.</p>
<span class="target" id="index-34"></span><dl class="function">
<dt id="modelClassify">
<!--[modelClassify]--><tt class="descname">modelClassify</tt><big>(</big><em>model=&quot;model&quot;</em>, <em>attribute=&quot;text'</em><big>)</big><a class="headerlink" href="#modelClassify" title="Permalink to this definition">¶</a></dt>
<dd><p>Классифицировать сообщение с помощью модели анализа сообщения.</p>
<p>Правило через домен обращается к модели с указанными именем, из сообщения
берет значение текстового атрибута (текст сообщения), после чего текст сообщения
передается модели на классификацию. Если модель классифицирует данное сообщение
как &#8220;хорошее&#8221;, правило возвращает истину, иначе - ложь.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><em>model</em> &#8211; имя модели анализа сообщений в текущем домене</li>
<li><em>attribute</em> &#8211; имя атрибута сообщения, содержащего текст сообщения, который и будет передан модели</li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">истина, если модель классифицирует текст сообщения как &#8220;хороший&#8221;, и ложь, если наоборот</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="index-35"></span><dl class="function">
<dt id="modelTrain">
<!--[modelTrain]--><tt class="descname">modelTrain</tt><big>(</big><em>model=&quot;model&quot;</em>, <em>attribute=&quot;text&quot;</em>, <em>marker=&quot;good&quot;</em><big>)</big><a class="headerlink" href="#modelTrain" title="Permalink to this definition">¶</a></dt>
<dd><p>Обучить модель анализа сообщений на тексте сообщения, указав категорию сообщения: &#8220;плохое&#8221; или &#8220;хорошее&#8221;.</p>
<p>Правило через домен обращается к модели с указанным именем, из сообщения
берет значение текстового атрибута (текст сообщения), который передается в модель
анализа сообщений на обучение, модель обучается на указанном тексте в соответствие со значением
маркера: хорошее это сообщение или плохое.</p>
<p>Правило всегда истинно.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><em>model</em> &#8211; имя модели анализа сообщений в текущем домене</li>
<li><em>attribute</em> &#8211; имя атрибута сообщения, содержащего текст сообщения, который и будет передан модели</li>
<li><em>marker</em> &#8211; классификация сообщения для модели: &#8220;good&#8221; - хорошее или &#8220;bad&#8221; - плохое</li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">истина</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="id21">
<span id="index-36"></span><h3>Правила, связанные с логом сообщений<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-37"></span><dl class="function">
<dt id="messageLogPut">
<!--[messageLogPut]--><tt class="descname">messageLogPut</tt><big>(</big><em>log=&quot;messageLog&quot;</em>, <em>tag=None</em><big>)</big><a class="headerlink" href="#messageLogPut" title="Permalink to this definition">¶</a></dt>
<dd><p>Положить сообщение с текущим набором тегов в лог.</p>
<p>Правило находит в домене лог сообщений с указанным именем и помещает в него сообщение. Вместе с сообщением
в лог записываются тэги, которые были присвоены сообщению предыдущими действиями <a class="reference internal" href="#firewall"><em>firewall</em></a>.
С помощью параметра tag можно добавить к записи в логе (не с самому сообщению) дополнительный тэг.</p>
<p>Правило всегда истинно.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><em>log</em> &#8211; имя лога сообщений в текущем домене</li>
<li><em>tag</em> &#8211; имя тэга, дополнительно дописываемого к записи в логе</li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">истина</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="id22">
<span id="index-38"></span><h3>Правила валидации<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h3>
<p>Правила данного раздела осуществляют проверки сообщения на валидность (длину, регулярное выражение и т.п.)</p>
<span class="target" id="index-39"></span><dl class="function">
<dt id="regexpCheck">
<!--[regexpCheck]--><tt class="descname">regexpCheck</tt><big>(</big><em>regexp</em>, <em>attribute=&quot;text&quot;</em><big>)</big><a class="headerlink" href="#regexpCheck" title="Permalink to this definition">¶</a></dt>
<dd><p>Правило применяет к значению текстового атрибута сообщения указанное регулярное выражение,
результатом правила является успешность применения выражения.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><em>regexp</em> &#8211; регулярное выражение, синтаксис Python, например: <tt class="docutils literal"><span class="pre">.*lala{2,3}(|bcd)</span></tt></li>
<li><em>attribute</em> &#8211; имя атрибута сообщения, содержащего текст сообщения</li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">результат применения регулярного выражения: соответствует текст ему или нет</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="index-40"></span><dl class="function">
<dt id="lengthCheck">
<!--[lengthCheck]--><tt class="descname">lengthCheck</tt><big>(</big><em>minLength=None</em>, <em>maxLength=None</em>, <em>attribute=&quot;text&quot;</em><big>)</big><a class="headerlink" href="#lengthCheck" title="Permalink to this definition">¶</a></dt>
<dd><p>Правило проверяет длину текстового атрибута сообщения.</p>
<p>Правило берет из сообщения текстовый атрибут с указанным именем и сравнивает его длину
с указанными пределами (<tt class="docutils literal"><span class="pre">minLength</span></tt> и <tt class="docutils literal"><span class="pre">maxLength</span></tt>). Если параметр <tt class="docutils literal"><span class="pre">minLength</span></tt> задан и длина
текстового атрибута меньше <tt class="docutils literal"><span class="pre">minLength</span></tt>, правило вернет &#8220;ложь&#8221;. Аналгично, если задан <tt class="docutils literal"><span class="pre">maxLength</span></tt>
и длина значения атрибута больше <tt class="docutils literal"><span class="pre">maxLength</span></tt>, правило вернет &#8220;ложь&#8221;. Во всех остальных
случаях результатом вычисления будет &#8220;истина&#8221;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>minLength</em> &#8211; минимальная длина значения атрибута или <tt class="xref docutils literal"><span class="pre">None</span></tt>, если не надо осуществлять проверку
на минимальную длину</li>
<li><em>maxLength</em> &#8211; максимальная длина значения атрибута или <tt class="xref docutils literal"><span class="pre">None</span></tt>, если не надо осуществлять проверку
на максимальную длину</li>
<li><em>attribute</em> &#8211; имя атрибута сообщения, содержащего текст сообщения</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="index-41"></span><dl class="function">
<dt id="attributeCheck">
<!--[attributeCheck]--><tt class="descname">attributeCheck</tt><big>(</big><em>attribute</em>, <em>value</em><big>)</big><a class="headerlink" href="#attributeCheck" title="Permalink to this definition">¶</a></dt>
<dd><p>Правило проверяет соответствие значения атрибута сообщения указанному значению.</p>
<p>Т.е. правило выполняет проверку вида: <tt class="docutils literal"><span class="pre">message.attribute</span> <span class="pre">==</span> <span class="pre">value</span> <span class="pre">?</span></tt></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><em>attribute</em> &#8211; имя атрибута сообщения</li>
<li><em>value</em> &#8211; проверяемое значение атрибута</li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">истина, если значение атрибута совпадает с указанным значением</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="index-42"></span><dl class="function">
<dt id="hasAttribute">
<!--[hasAttribute]--><tt class="descname">hasAttribute</tt><big>(</big><em>attribute</em><big>)</big><a class="headerlink" href="#hasAttribute" title="Permalink to this definition">¶</a></dt>
<dd><p>Правило проверяет наличие указанного атрибута у сообщения</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><em>attribute</em> &#8211; имя атрибута сообщения</li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">истина, если у сообщения имеется указанный атрибут</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="id23">
<h3>Правила анализа текста сообщений<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<p>Данная группа осуществляет проверку текста сообщений.</p>
<span class="target" id="index-43"></span><dl class="function">
<dt id="messageFloodCheck">
<!--[messageFloodCheck]--><tt class="descname">messageFloodCheck</tt><big>(</big><em>attribute='text'</em>, <em>minLength=16</em>, <em>minMean=1.5</em>, <em>maxVariance=2.0</em><big>)</big><a class="headerlink" href="#messageFloodCheck" title="Permalink to this definition">¶</a></dt>
<dd><p>Правило анализирует значение текстового атрибута сообщение на флуд. Под флудом понимается отправка большого
количества похожих фраз в тексте сообщения.</p>
<p>Алгоритм работы:
Текст сообщения разбивается на триграммы (например для фразы &#8220;привет андрей!&#8221; будут составлены следующие триграммы: &#8220;при&#8221;, &#8220;рив&#8221;, &#8220;иве&#8221;, &#8220;вет&#8221;,
&#8220;ета&#8221;, &#8220;тан&#8221;, &#8220;анд&#8221;, &#8220;ндр&#8221;, &#8220;дре&#8221;, &#8220;рей&#8221;, &#8220;ей!&#8221;), и подсчитывается количество вхождений каждой триграммы. В результате получается
последовательность чисел, для которой рассчитывается значение математического ожидания и дисперсии. Сообщение будет считаться флудом
(возвращаемое значение &#8220;ложь&#8221;), если значение математического ожидания меньше <tt class="docutils literal"><span class="pre">minMean</span></tt>, а значение дисперсии больше <tt class="docutils literal"><span class="pre">maxVariance</span></tt>.</p>
<p>Если длина сообщения меньше <tt class="docutils literal"><span class="pre">minLength</span></tt>, правило вернет &#8220;истину&#8221; (анализ коротких сообщений может дать большую погрешность при рассчете
математического ожидания и дисперсии).</p>
<p>При запуске на тестовой базе, содержащей нормальные сообщения, из 16674 сообщений правило не заблокировала ни одного сообщения.
При запуске на тестовой базе, содержащей флуд, из 1477 было обнаружено 956 сообщений, содержащих флуд, что составляет 65% от общего числа сообщений.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>attribute</em> &#8211; имя атрибута сообщения, содержащего текст сообщения</li>
<li><em>minLength</em> &#8211; минимальная длина значения атрибута</li>
<li><em>minMean</em> &#8211; минимальное значение математического ожидания появления триграмма</li>
<li><em>maxVariance</em> &#8211; максимальное значение дисперсии</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="id24">
<h3>Правила проверки на частоту<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<p>Данная группа осуществляет проверку на частоту (скорость) тех или иных событий, ограничивая, например,
число сообщений в секунду.</p>
<span class="target" id="index-44"></span><dl class="function">
<dt id="messageFrequencyCheck">
<!--[messageFrequencyCheck]--><tt class="descname">messageFrequencyCheck</tt><big>(</big><em>attribute=&quot;text&quot;</em>, <em>storage=&quot;storage&quot;</em>, <em>timeout=300</em>, <em>count=3</em>, <em>minLength=10</em><big>)</big><a class="headerlink" href="#messageFrequencyCheck" title="Permalink to this definition">¶</a></dt>
<dd><p>Проверка на частоту отправки сообщений с одним и тем же (или похожим) текстом.</p>
<p>Правило берет значение текстового атрибута сообщения. Проверка выполняется, если его длина больше <tt class="docutils literal"><span class="pre">minLength</span></tt> символов.
Далее текст сообщения нормализуется (убираются пробельные символы, символы переводятся в нижний регистр). От полученной
строки вычисляется md5-хэш. Полученный хэш используется для сравнения сообщений, если хэши равны, то считается, что
и сообщения равны.</p>
<p>Правило проверяет, что в течение <tt class="docutils literal"><span class="pre">timeout</span></tt> секунд не было отправлено более <tt class="docutils literal"><span class="pre">count</span></tt> сообщений с одним и тем же
хэшом. Если количество отправленных сообщений превышает <tt class="docutils literal"><span class="pre">count</span></tt>, правило возвращает &#8220;ложь&#8221;, иначе &#8220;истину&#8221;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>attribute</em> &#8211; имя атрибута сообщения, содержащего текст сообщения</li>
<li><em>storage</em> &#8211; имя свойства домена, содержащего хранилище, которое используется правилом для хранения информации</li>
<li><em>timeout</em> &#8211; анализируемый на частоту отправки период времени, секунды</li>
<li><em>count</em> &#8211; максимальное число отправляемых в течение <tt class="docutils literal"><span class="pre">timeout</span></tt> секунд сообщений с одинаковым хэшом</li>
<li><em>minLength</em> &#8211; минимальная длина сообщения, при достижении которого правило начинает работать</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="index-45"></span><dl class="function">
<dt id="userFrequencyCheck">
<!--[userFrequencyCheck]--><tt class="descname">userFrequencyCheck</tt><big>(</big><em>attribute=&quot;from&quot;</em>, <em>storage=&quot;storage&quot;</em>, <em>timeout=300</em>, <em>count=3</em><big>)</big><a class="headerlink" href="#userFrequencyCheck" title="Permalink to this definition">¶</a></dt>
<dd><p>Проверка на частоту отправки сообщений одним пользователем (или группой пользователей).</p>
<p>Группа или пользователь определяются атрибутом сообщения с именем <tt class="docutils literal"><span class="pre">from</span></tt>. Значением этого атрибута,
может быть, например, ID пользователя, отправившего сообщение. Правило проверяет, что в течение
<tt class="docutils literal"><span class="pre">timeout</span></tt> секунд не было отправлено более <tt class="docutils literal"><span class="pre">count</span></tt> сообщений с одним и тем же значением атрибута
<tt class="docutils literal"><span class="pre">from</span></tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>attribute</em> &#8211; имя атрибута сообщения, которое определяет отправителя сообщения</li>
<li><em>storage</em> &#8211; имя свойства домена, содержащего хранилище, которое используется правилом для хранения информации</li>
<li><em>timeout</em> &#8211; анализируемый на частоту отправки период времени, секунды</li>
<li><em>count</em> &#8211; максимальное число отправляемых в течение <tt class="docutils literal"><span class="pre">timeout</span></tt> секунд сообщений с одинаковым <tt class="docutils literal"><span class="pre">from</span></tt></li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="id25">
<h3>Правила, используемые для тестирования<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<p>Правила этой группы могут использоваться для целей отладки, тестирования сервиса.</p>
<span class="target" id="index-46"></span><dl class="function">
<dt id="ruleTrue">
<!--[ruleTrue]--><tt class="descname">ruleTrue</tt><big>(</big><big>)</big><a class="headerlink" href="#ruleTrue" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Returns:</th><td class="field-body">истина</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="index-47"></span><dl class="function">
<dt id="ruleFlase">
<!--[ruleFlase]--><tt class="descname">ruleFlase</tt><big>(</big><big>)</big><a class="headerlink" href="#ruleFlase" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Returns:</th><td class="field-body">ложь</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
<div class="section" id="id26">
<span id="firewall"></span><span id="index-48"></span><h2>Firewall<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h2>
<p>Firewall определяет цепочку действий, которые выполняются над входящим сообщением. Результат выполнения
действий firewall - результат анализа, строка, которая классифицирует сообщение (спам, флуд и т.п.) Сообщение
с дополнительными метками (тэгами) проходит через цепочку действий firewall, при этом к сообщению
добавляются новые метки (тэги), а на выходе из firewall формируется окончательное решение - результат анализа.</p>
<div class="section" id="id27">
<span id="index-49"></span><h3>Синтаксис действий firewall<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<pre>
<strong id="grammar-token-firewall">firewall        </strong> ::=  <a class="reference internal" href="#grammar-token-rule"><tt class="xref docutils literal"><span class="pre">rule</span></tt></a>+
<strong id="grammar-token-rule">rule            </strong> ::=  [<a class="reference internal" href="#grammar-token-label"><tt class="xref docutils literal"><span class="pre">label</span></tt></a> &quot;:&quot;] [<a class="reference internal" href="#grammar-token-if_condition"><tt class="xref docutils literal"><span class="pre">if_condition</span></tt></a>] <a class="reference internal" href="#grammar-token-statement"><tt class="xref docutils literal"><span class="pre">statement</span></tt></a>
<strong id="grammar-token-label">label           </strong> ::=  &quot;0-9&quot;+
<strong id="grammar-token-if_condition">if_condition    </strong> ::=  &quot;if&quot; [&quot;not&quot;] <a class="reference internal" href="#grammar-token-tags_list"><tt class="xref docutils literal"><span class="pre">tags_list</span></tt></a>
<strong id="grammar-token-statement">statement       </strong> ::=  <a class="reference internal" href="#grammar-token-do_statement"><tt class="xref docutils literal"><span class="pre">do_statement</span></tt></a> | <a class="reference internal" href="#grammar-token-skip_statement"><tt class="xref docutils literal"><span class="pre">skip_statement</span></tt></a> | <a class="reference internal" href="#grammar-token-stop_statement"><tt class="xref docutils literal"><span class="pre">stop_statement</span></tt></a>
<strong id="grammar-token-do_statement">do_statement    </strong> ::=  &quot;do&quot; <a class="reference internal" href="#grammar-token-rule_call"><tt class="xref docutils literal"><span class="pre">rule_call</span></tt></a> [&quot;mark&quot; <a class="reference internal" href="#grammar-token-tags_list"><tt class="xref docutils literal"><span class="pre">tags_list</span></tt></a>]
<strong id="grammar-token-skip_statement">skip_statement  </strong> ::=  &quot;skip&quot; &quot;to&quot; <a class="reference internal" href="#grammar-token-label"><tt class="xref docutils literal"><span class="pre">label</span></tt></a>
<strong id="grammar-token-stop_statement">stop_statement  </strong> ::=  &quot;stop&quot; &quot;as&quot; <a class="reference internal" href="#grammar-token-decision"><tt class="xref docutils literal"><span class="pre">decision</span></tt></a>
<strong id="grammar-token-tags_list">tags_list       </strong> ::=  <a class="reference internal" href="#grammar-token-tag"><tt class="xref docutils literal"><span class="pre">tag</span></tt></a> (, <a class="reference internal" href="#grammar-token-tag"><tt class="xref docutils literal"><span class="pre">tag</span></tt></a>)*
<strong id="grammar-token-rule_call">rule_call       </strong> ::=  <a class="reference internal" href="#grammar-token-rule_name"><tt class="xref docutils literal"><span class="pre">rule_name</span></tt></a> &quot;(&quot; <a class="reference internal" href="#grammar-token-rule_param"><tt class="xref docutils literal"><span class="pre">rule_param</span></tt></a> (, <a class="reference internal" href="#grammar-token-rule_param"><tt class="xref docutils literal"><span class="pre">rule_param</span></tt></a>)*  &quot;)&quot;
<strong id="grammar-token-rule_param">rule_param      </strong> ::=  <a class="reference internal" href="#grammar-token-rule_param_name"><tt class="xref docutils literal"><span class="pre">rule_param_name</span></tt></a> &quot;=&quot; <a class="reference internal" href="#grammar-token-rule_param_value"><tt class="xref docutils literal"><span class="pre">rule_param_value</span></tt></a>
<strong id="grammar-token-tag">tag             </strong> ::=  &quot;A-z0-9&quot;+
<strong id="grammar-token-decision">decision        </strong> ::=  &quot;A-z0-9&quot;+
<strong id="grammar-token-rule_name">rule_name       </strong> ::=  &quot;A-z0-9&quot;+
<strong id="grammar-token-rule_param_name">rule_param_name </strong> ::=  &quot;A-z0-9&quot;+
<strong id="grammar-token-rule_param_value">rule_param_value</strong> ::=  &quot;&quot;&quot; &quot;string&quot; &quot;&quot;&quot; | &quot;0-9&quot;+
</pre>
<p>Набор действий firewall состоит из отдельных действий, каждое из которых располагается на новой строке. К каждому
действию слева может быть добавлена числовая метка <cite>label</cite>. Действие может начинаться с условия <cite>if</cite>,
тогда в зависимости от тэгов сообщения, действие может быть выполнено или пропущено.</p>
<p>Существует три вида действий:</p>
<ul class="simple">
<li>действие <cite>do</cite> осуществляет применение <a class="reference internal" href="#rules"><em>правила</em></a> к сообщению, и, в зависимости от результатов выполнения правила,
привязывает к сообщению дополнительные метки;</li>
<li>действие <cite>skip</cite> осуществляет переход вниз по цепочке действий к действию с указанной меткой, пропуская часть
действий;</li>
<li>действие <cite>stop</cite> останавливает работу firewall, указывая сформировавшийся результат анализа - решение, принятое
firewall.</li>
</ul>
<div class="section" id="do">
<h4>Действие do<a class="headerlink" href="#do" title="Permalink to this headline">¶</a></h4>
<pre>
<strong id="id28">do_statement</strong> ::=  &quot;do&quot; <a class="reference internal" href="#grammar-token-rule_name"><tt class="xref docutils literal"><span class="pre">rule_name</span></tt></a> &quot;(&quot; <a class="reference internal" href="#grammar-token-rule_param"><tt class="xref docutils literal"><span class="pre">rule_param</span></tt></a> (, <a class="reference internal" href="#grammar-token-rule_param"><tt class="xref docutils literal"><span class="pre">rule_param</span></tt></a>)*  &quot;)&quot; [&quot;mark&quot; <a class="reference internal" href="#grammar-token-tags_list"><tt class="xref docutils literal"><span class="pre">tags_list</span></tt></a>]
</pre>
<p>Действие <cite>do</cite> выполняет <a class="reference internal" href="#rules"><em>правило</em></a> и, в зависимости от результата выполнения правила, дописывает к сообщению
указанные тэги. Выполнение правила также может иметь побочный эффект (например, запись сообщения в <a class="reference internal" href="#message-log"><em>лог сообщений</em></a>).</p>
<p>Вызов правила синтаксически похож на вызов функции с набором именованных параметров. В соответствие с набором документированных
параметров правила, в действии <cite>do</cite> можно указать аргументы правила с их значениями или оставить им значения по умолчанию, например:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">lengthCheck</span><span class="p">(</span><span class="n">minLength</span><span class="o">=</span><span class="mf">3</span><span class="p">)</span>
</pre></div>
</div>
<p>Такое обращение приведет к вызову правилу <cite>lengthCheck</cite> с параметрами (неуказанные явно параметры приняли значения по умолчанию):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">minLength</span><span class="o">=</span><span class="mf">3</span><span class="p">,</span> <span class="n">maxLength</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s">&quot;text&quot;</span>
</pre></div>
</div>
<p>Если результатом вычисления правила будет <strong>ложь</strong> и в правиле присутствует <tt class="docutils literal"><span class="pre">mark</span></tt>-часть, то теги из списка <tt class="docutils literal"><span class="pre">tags_list</span></tt> будут
присоединены к текущему списку тэгов сообщения.</p>
<p>Рассмотрим пример. На входе в firewall у сообщения пустой набор тэгов - <tt class="docutils literal"><span class="pre">[]</span></tt>. После выполнения правила:</p>
<div class="highlight-python"><pre>do ruleFalse() mark a, b</pre>
</div>
<p>У сообщения набор тэгов станет таким: <tt class="docutils literal"><span class="pre">[a,</span> <span class="pre">b]</span></tt>.</p>
<p>После выполнения правила:</p>
<div class="highlight-python"><pre>do lengthCheck(minLength=3) mark tooshort</pre>
</div>
<p>Если длина текста сообщения меньше 3 символов к сообщению добавится тэг <tt class="docutils literal"><span class="pre">tooshort</span></tt>: <tt class="docutils literal"><span class="pre">[a,</span> <span class="pre">b,</span> <span class="pre">tooshort]</span></tt>, а если длина
текста больше либо равна 3 символам, набор тэгов не изменится.</p>
</div>
<div class="section" id="skip">
<h4>Действие skip<a class="headerlink" href="#skip" title="Permalink to this headline">¶</a></h4>
<pre>
<strong id="id29">skip_statement</strong> ::=  &quot;skip&quot; &quot;to&quot; <a class="reference internal" href="#grammar-token-label"><tt class="xref docutils literal"><span class="pre">label</span></tt></a>
</pre>
<p>Действие <cite>skip</cite> пропускает действия firewall до тех пор, пока не найдется действие, метка которого будет равна <tt class="docutils literal"><span class="pre">label</span></tt>. Поиск
осуществляется только вниз, то есть возвратов &#8220;назад&#8221; этим правилом организовать нельзя. В случае, если действия с указанной
в правиле <cite>skip</cite> не найдется, такая ситуация считается ошибочным выполнением firewall.</p>
<p>Например:</p>
<div class="highlight-python"><pre>skip to 10
do messageLogPut()
10: doLengthCheck(maxLength=1000) mark toolong</pre>
</div>
<p>При таком наборе действий второе действие (<tt class="docutils literal"><span class="pre">do</span> <span class="pre">messageLogPut()</span></tt>) не будет никогда выполняться, т.к. первое действие осуществляет
безусловный переход к третьему.</p>
</div>
<div class="section" id="stop">
<h4>Действие stop<a class="headerlink" href="#stop" title="Permalink to this headline">¶</a></h4>
<pre>
<strong id="id30">stop_statement</strong> ::=  &quot;stop&quot; &quot;as&quot; <a class="reference internal" href="#grammar-token-decision"><tt class="xref docutils literal"><span class="pre">decision</span></tt></a>
</pre>
<p>Действие <cite>stop</cite> останавливает выполнение набора действий firewall, возвращая <tt class="docutils literal"><span class="pre">decision</span></tt> в качестве результата выполнения firewall.</p>
<p>Например:</p>
<div class="highlight-python"><pre>stop as OK</pre>
</div>
<p>Остановить выполнение firewall, вернуть <tt class="docutils literal"><span class="pre">&quot;OK&quot;</span></tt> в качестве результата выполнения.</p>
</div>
<div class="section" id="if">
<h4>Условие if<a class="headerlink" href="#if" title="Permalink to this headline">¶</a></h4>
<p>Условие <tt class="docutils literal"><span class="pre">if</span></tt> может быть присоединено слева к любому из вышеописанных действий.</p>
<pre>
<strong id="id31">if_condition</strong> ::=  &quot;if&quot; [&quot;not&quot;] <a class="reference internal" href="#grammar-token-tags_list"><tt class="xref docutils literal"><span class="pre">tags_list</span></tt></a>
</pre>
<p>Условие позволяет выключить выполнения действий для определенной комбинации тэгов проходящего через действие сообщения.
Условие <tt class="docutils literal"><span class="pre">if</span></tt> позволить выполнить действие, если у сообщения есть все тэги из списка <tt class="docutils literal"><span class="pre">tags_list</span></tt>, а условие <tt class="docutils literal"><span class="pre">if</span> <span class="pre">not</span></tt>
позволит выполнить действие, если у сообщения нет ни одного тэга из списка <tt class="docutils literal"><span class="pre">tags_list</span></tt>.</p>
<p>Например:</p>
<div class="highlight-python"><pre>do lengthCheck(minLength=3) mark tooshort
if not tooshort do messageLogPut()</pre>
</div>
<p>В лог сообщений не попадут слишком короткие сообщения.</p>
</div>
</div>
<div class="section" id="id32">
<h3>Примеры наборов действий<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h3>
<p>Пустой набор действий не считается валидным для firewall, при его обработке будет получен результат <tt class="docutils literal"><span class="pre">UNKNOWN</span></tt>. Если все
действия firewall выполнены, и не встретилось по пути ни одного действия <tt class="docutils literal"><span class="pre">stop</span></tt>, результатом выполнения будет также <tt class="docutils literal"><span class="pre">UNKNOWN</span></tt>.</p>
<p>Если выполнения какого либо правила привело к ошибке или при выполнении действия <tt class="docutils literal"><span class="pre">skip</span></tt> не было найдено действие с соответствующей
меткой, выполнение firewall считается ошибочным и клиенту возвращается ошибка.</p>
<p>Пример:</p>
<div class="highlight-python"><pre>do lengthCheck(minLength=1, maxLength=1000) mark invalid
if invalid skip to 1000
do messageFrequencyCheck() mark messagefrequent, frequent
do userFrequencyCheck() mark userfrequent, frequent
if frequent skip to 1000
do modelClassify() mark spam
1000: do messageLogPut()
if invalid stop as INVALID
if frequent stop as FREQUENT
if spam stop as SPAM
stop as OK</pre>
</div>
<p>Содержимое домена для выполнения такого набора правил:</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">storage</span></tt>: <tt class="docutils literal"><span class="pre">DomainMemoryStorage</span></tt></li>
<li><tt class="docutils literal"><span class="pre">messageDomain</span></tt> : <tt class="docutils literal"><span class="pre">MessageDomain(TextAttributeDomain(&quot;text&quot;),</span> <span class="pre">UniqueIntAttributeDomain(&quot;from&quot;))</span></tt></li>
<li><tt class="docutils literal"><span class="pre">messageAnalyzer</span></tt> : firewall с приведенными выше правилами</li>
<li><tt class="docutils literal"><span class="pre">messageLog</span></tt> : <tt class="docutils literal"><span class="pre">MessageLog()</span></tt></li>
<li><tt class="docutils literal"><span class="pre">model</span></tt> : <tt class="docutils literal"><span class="pre">BayesModel()</span></tt></li>
</ul>
</blockquote>
</div>
</div>
<div class="section" id="id33">
<span id="message-log"></span><span id="index-50"></span><h2>Лог сообщений<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h2>
<p>Лог сообщений позволяет сохранить на какое-то время сообщения, прошедшие через <a class="reference internal" href="#firewall"><em>firewall</em></a> вместе с тэгами,
которые были им присвоены. Сам лог сообщений хранится в <a class="reference internal" href="#domain"><em>домене</em></a>, являясь его свойством.</p>
<dl class="function">
<dt id="MessageLog">
<!--[MessageLog]--><tt class="descname">MessageLog</tt><big>(</big><em>storage=&quot;storage&quot;</em>, <em>timeChunk=10</em>, <em>numChunks=100</em><big>)</big><a class="headerlink" href="#MessageLog" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><em>storage</em> &#8211; имя свойства домена, в котором находится <a class="reference internal" href="#storage"><em>хранилище</em></a></li>
<li><em>timeChunk</em> &#8211; емкость одного ключа хранилища в секундах</li>
<li><em>numChunks</em> &#8211; количество выделяемых в хранилище ключей</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Лог сообщений является кольцевым логом, который хранит сообщения за последние <tt class="docutils literal"><span class="pre">timeChunk*(numChunks-1)</span></tt> секунд
в указанном хранилище. По запросу клиента лог может вернуть произвольное подмножество сохраненных записей.</p>
<p>При записи в лог каждое сообщение получает ID, который увеличивается с каждым новом сообщением, и является
уникальным в пределах данного лога сообщений.</p>
<table class="docutils footnote" frame="void" id="bayes" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id16">[1]</a></td><td><a class="reference external" href="http://ru.wikipedia.org/wiki">http://ru.wikipedia.org/wiki</a>/Теорема_Байеса</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="datamining" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id17">[2]</a></td><td><a class="reference external" href="http://ru.wikipedia.org/wiki/Data_mining">http://ru.wikipedia.org/wiki/Data_mining</a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="">Основные компоненты сервера</a><ul>
<li><a class="reference external" href="#id2">Домен</a><ul>
<li><a class="reference external" href="#id3">Примеры</a></li>
<li><a class="reference external" href="#id4">Домен по умолчанию</a></li>
</ul>
</li>
<li><a class="reference external" href="#id5">Партнер</a><ul>
<li><a class="reference external" href="#id6">Механизм авторизации партнеров</a><ul>
<li><a class="reference external" href="#id7">Доверительный механизм авторизации</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference external" href="#id8">Сообщение</a><ul>
<li><a class="reference external" href="#id9">Атрибут сообщения</a></li>
<li><a class="reference external" href="#id10">Домен атрибута сообщений</a><ul>
<li><a class="reference external" href="#id11">Текстовый домен</a></li>
<li><a class="reference external" href="#id12">Целочисленный домен</a></li>
<li><a class="reference external" href="#id13">Уникальный целочисленный домен</a></li>
</ul>
</li>
<li><a class="reference external" href="#id14">Домен сообщения</a></li>
</ul>
</li>
<li><a class="reference external" href="#id15">Модель анализа сообщений</a><ul>
<li><a class="reference external" href="#bayesmodel">Простая Байесовская модель (BayesModel)</a></li>
<li><a class="reference external" href="#datamining-dataminingmodel">DataMining-модель (DataMiningModel)</a></li>
</ul>
</li>
<li><a class="reference external" href="#id18">Хранилище данных</a><ul>
<li><a class="reference external" href="#domainmemorystorage">Хранилище в памяти (DomainMemoryStorage)</a></li>
<li><a class="reference external" href="#domaineddbmstorage">Хранилище на диске (DomainedDBMStorage)</a></li>
</ul>
</li>
<li><a class="reference external" href="#id19">Правила</a><ul>
<li><a class="reference external" href="#id20">Правила, связанные с моделью анализа сообщений</a></li>
<li><a class="reference external" href="#id21">Правила, связанные с логом сообщений</a></li>
<li><a class="reference external" href="#id22">Правила валидации</a></li>
<li><a class="reference external" href="#id23">Правила анализа текста сообщений</a></li>
<li><a class="reference external" href="#id24">Правила проверки на частоту</a></li>
<li><a class="reference external" href="#id25">Правила, используемые для тестирования</a></li>
</ul>
</li>
<li><a class="reference external" href="#id26">Firewall</a><ul>
<li><a class="reference external" href="#id27">Синтаксис действий firewall</a><ul>
<li><a class="reference external" href="#do">Действие do</a></li>
<li><a class="reference external" href="#skip">Действие skip</a></li>
<li><a class="reference external" href="#stop">Действие stop</a></li>
<li><a class="reference external" href="#if">Условие if</a></li>
</ul>
</li>
<li><a class="reference external" href="#id32">Примеры наборов действий</a></li>
</ul>
</li>
<li><a class="reference external" href="#id33">Лог сообщений</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="running.html" title="previous chapter">Запуск сервера</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="configure.html" title="next chapter">Настройка сервера</a></p>
          <h3>Quick search</h3>
            <form class="search" action="../search.html" method="get">
              <input type="text" name="q" size="18" /> <input type="submit" value="Go" />
              <input type="hidden" name="check_keywords" value="yes" />
              <input type="hidden" name="area" value="default" />
            </form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="configure.html" title="Настройка сервера"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="running.html" title="Запуск сервера"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">СпамоБорец: документация</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Руководство пользователя</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2008, NetStream.
      Last updated on Feb 27, 2009.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.5.
    </div>
  </body>
</html>