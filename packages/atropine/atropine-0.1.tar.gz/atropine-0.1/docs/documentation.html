<html>
  <head>
    <title>Atropine Documentation</title>
    <style type="text/css">
       a:link { color: #880000; }
       a:hover { color: #000000; }
       a:visited { color: #880000; }
       a:active { color: #FFFFFF; }
      body { font-family: monospace; font-size: 1.2em;
             background-image: url(http://atropine.sourceforge.net/belladonna.png);
             background-position: bottom right;
             background-attachment: fixed;
             background-repeat: no-repeat; }
      .literal { color: #880000 }
      .code { font-family: monospace;  }
      .code-body { background: #CCCCCC; padding: 5px; }
      .special { color: #007B40; }
      .keyword { font-weight: bold }
      .maria { margin-left: 20px; border: dashed 1px #000000; border-spacing: 0; }
      .h2block { margin-left: 20px; border-left: solid 1px #CACACA; }
      .outerblock { margin-left: 20px; }
      .comment { color: #002396; font-style: italic; }
      .arg { font-weight: bold }
      .heading { font-size: 1.2em;
                 font-weight: bold;
                 text-decoration: underline }
      .ind { margin-left: 1em; margin-top: .6em; }
      #reference { width: 70%; }
    </style>

  </head>

  <body>
    <h1>Atropine Documentation</h1>
<div class="outerblock">
written on 2005-10-20 by Moe Aboulkheir (moe@divmod.com)<p/>
    <i>please note, using this library is not as complicated as it sounds, it consists of only 275 lines of
    python,<br/> which is several orders of magnitude shorter than this documentation.</i>

<h2>Ideas</h2>
<ul>
<li>It is better to get no data than to get the wrong data</li>
<li>The key to screen-scraping the right data is to make a painful amount of assertions about document structure</li>
</ul>

<h2>Examples</h2>
<div class="h2block" style="border: none;">
here is a simple example session:
<p/>

<table class="maria">
  <tr>
    <td class="code-body">
      <pre class="code">
<span class="keyword">from</span> atropine <span class="keyword">import</span> go, check, special
<span class="keyword">from</span> atropine.atropine <span class="keyword">import</span> Atropine
<span class="keyword">import</span> re

<span class="special">atropine</span> = Atropine(<span class="literal">'''
  &lt;!-- snip -->
  &lt;table id="earningsTable">
    &lt;tbody>
      &lt;tr>
        &lt;td class="headerTableCell">
          Quarterly Earnings
        &lt;/td>
        &lt;td class="dataTableCell">
          &lt;span class="unhelpfulClassName">GBP&lt;/span>
          &lt;span class="unhelpfulClassName">123.45&lt;/span>
        &lt;/td>
      &lt;/tr>
    &lt;/tbody>
  &lt;/table>'''</span>, <span class="arg">ignorewhitespace</span>=<span class="special">True</span>)

<span class="special">qearningsregex</span> = re.compile(r<span class="literal">'quarterly earnings'</span>, <span class="special">re.IGNORECASE</span>)
<span class="special">atropine</span> = <span class="special">atropine</span>.resolve(go.only(<span class="arg">tag</span>=<span class="literal">'table'</span>, <span class="arg">attrs</span>=<span class="special">dict</span>(<span class="arg">id</span>=<span class="literal">'earningsTable'</span>)),

                            go.child(<span class="arg">0</span>), check.has(<span class="arg">tag</span>=<span class="literal">'tbody'</span>),
                            go.child(<span class="arg">0</span>), check.has(<span class="arg">tag</span>=<span class="literal">'tr'</span>),
                            go.child(<span class="arg">0</span>), check.has(<span class="arg">tag</span>=<span class="literal">'td'</span>,
                                                   <span class="arg">cls</span>=<span class="literal">'headerTableCell'</span>,
                                                   <span class="arg">onlytext</span>=qearningsregex),

                            go.nextsib,  check.has(<span class="arg">tag</span>=<span class="literal">'td'</span>, <span class="arg">cls</span>=<span class="literal">'dataTableCell'</span>),

                            special.collect(<span class="literal">'earnings-info'</span>, <span class="arg">alltext</span>=True))

(<span class="special">currency</span>, <span class="special">amount</span>) = <span class="special">atropine</span>.collection[<span class="literal">'earnings-info'</span>]
<span class="special">amount</span> = int(float(<span class="special">amount</span>) * 100)
<span class="comment"># store these variables somewhere</span>
</pre>
</td>
</tr>
</table>
</div>
</div>

<h2>Reference</h2>
<div id="reference">
<div class="h2block" style="font-family: monospace">
  <span class="special">Atropine</span>(<span class="arg">html</span>, <span class="arg">ignorewhitespace</span>=True)<br/>
  <div class="ind">
    just like <a href="http://www.crummy.com/software/BeautifulSoup/">BeautifulSoup</a>, <span class="arg">html</span>
    can be a string or a file like object. the <span class="arg">ignorewhitespace</span> argument determines whether
    text nodes consisting only of white space characters should be considered.<p/>
</div>

<span class="special">Atropine</span>.<span class="special">soup</span><br/>
<div class="ind">
instance variable representing the underlying <span class="special">BeautifulSoup</span> instance.  this will generally
be the result of parsing the html passed to <span class="special">Atropine</span>.
</div>
<p/>

<span class="special">Atropine</span>.<span class="special">current</span><br/>
<div class="ind">
instance variable that represents the current tag (as a <span class="special">BeautifulSoup</span>.<span class="special">Tag</span> instance).  this will
only be set to something sensible when an <span class="special">Atropine</span>.<span class="special">resolve</span> call
is underway.
</div><p/>
<span class="special">Atropine</span>.<span class="special">registerchecker</span>(<span class="arg">name</span>, <span class="arg">function</span>)<br/>
<div class="ind">
this method does pretty much what the signature says - registers the checker function <span class="arg">function</span> under the name
<span class="arg">name</span>.  the <a href="#nullresolvers">null resolvers</a> section talks about checker functions.
</div>
<p/>
<span class="special">Atropine</span>.<span class="special">getchecker</span>(<span class="arg">name</span>)<br/>
<div class="ind">
returns the checker function associated with <span class="arg">name</span>
</div><p/>
<span class="special">Atropine</span>.<span class="special">istextnode</span>(<span class="arg">tag</span>)<br/>
<div class="ind">
static method - returns a boolean indicating whether the <span class="special">BeautifulSoup</span>.<span class="special">Tag</span>
instance <span class="arg">tag</span> is a text node
</div><p/>

<span class="special">Atropine</span>.<span class="special">onlytext</span>(<span class="arg">tag</span>)<br/>
<div class="ind">
returns the contents of <span class="tag">tag</span>, if it contains only one element, which also happens to be a text node.
otherwise it explodes
</div><p/>

<span class="special">Atropine</span>.<span class="special">assimilate</span>(<span class="arg">tag</span>)<br/>
<div class="ind">
this method sets the value of <span class="special">self</span>.<span class="special">current</span>
to <span class="arg">tag</span>, while asserting that whatever it is passed is a sane value.  it is typically
called only by <a href="#directional">directional resolvers</a>.
</div>
<p/>
    <span class="special">Atropine</span>.<span class="special">resolve</span>(<span class="arg">resolver</span>, [<span class="arg">resolver</span>, ...])<br/>
    <div class="ind">
    <span class="special">resolve</span> takes any number of callables as its arguments.  these callables generally
    locate some node in the document, and set the current node in the associated <span class="special">Atropine</span>
    instance, so they are called resolvers.  there are a bunch of built in resolvers -
    directional resolvers live in the <b>atropine.go</b> module, and null resolvers live in
    the <b>atropine.check</b> module.  resolvers that do weird things live in <b>atropine.special</b>.<p/>

    a null resolver is defined as any resolver that asserts some stuff about the current node,
    but doesn't change it - conversely, a directional resolver is one which locates some node
    and sets it as the current one.<p/>

    <span class="special">resolve</span> returns a new <span class="special">Atropine</span> instance that
    represents the current tag at the end of the <span class="special">resolve</span> call<p/>
</div>

    <a name="directional" />
    <span class="heading">Directional Resolvers</span><p/>
    <div class="h2block">
    <span class="special">go</span>.<span class="special">child</span>(<span class="arg">n</span>)<br/>
    <div class="ind">
    set the current tag to the <span class="arg">n</span>th child of the current tag<p/>
    </div>

    <span class="special">go</span>.<span class="special">only</span>(<span class="arg">tag</span>=None, <span class="arg">cls</span>=None, <span class="arg">attrs</span>=None)<br/>
    <div class="ind">
        assert that the current tag only has one child that meets the given criteria,
        and set that tag to the current one.  <span class="arg">cls</span> expands to 'class', which is  a reserved
        word in python.  all of the keyword arguments can be strings or sequences of strings,
        and the values in the <span class="arg">attrs</span> dictionary can be strings, sequences of strings, regular
        expression objects or functions which accept strings and return a boolean.<p/>
        </div>

        <b>examples</b>:<p/>
        <div class="h2block">

        <span class="special">go</span>.<span class="special">only</span>(<span class="arg">cls</span>=(<span class="literal">'textbox-container'</span>, <span class="literal">'button-container'</span>))<br/>
            <div class="ind">
            will assert that the current tag only has one child whose 'class' attribute
            has a value of either <span class="literal">'textbox-container'</span> or <span class="literal">'button-container'</span>, and will
            set that child as the current tag<p/>
            </div>

            <span class="special">go</span>.<span class="special">only</span>(<span class="arg">tag</span>=<span class="literal">'tr'</span>, <span class="arg">attrs</span>=<span class="special">dict</span>(<span class="arg">id</span>='<span class="literal">123'</span>))<br/>
            <div class="ind">
            will assert that the current tag only has one child with a tag name of <span class="literal">'tr'</span>
            and an attribute <span class="literal">'id'</span> with the value <span class="literal">'123'</span>, and will set the current tag to this tag.<p/>
            </div>

            <span class="special">go</span>.<span class="special">only</span>()<br/>
            <div class="ind">
            will assert the current tag only has one child, and will set the current tag to this tag.<p/>
            </div>
            </div>
            <span class="special">go</span>.<span class="special">parent</span>(<span class="arg">n</span>)<br/>
            <div class="ind">
            set the current tag to the <span class="arg">n</span>th parent of the current tag.<p/>
            </div>

            <span class="special">go</span>.<span class="special">prevsib</span><br/>
            <div class="ind">
        set the current tag to the previous sibling of the current tag.
        this is a predicate resolver, and so does not take any user-supplied arguments<p/>
        </div>

        <span class="special">go</span>.<span class="special">nextsib</span><br/>
        <div class="ind">
        same as <span class="special">go</span>.<span class="special">prevsib</span>, but sets the current tag to the next sibling of the current tag<p/>
</div>
        <span class="special">go</span>.<span class="special">nth</span>(<span class="arg">n</span>, <span class="arg">tag</span>=None, <span class="arg">cls</span>=None, <span class="arg">attrs</span>=None)<br/>
        <div class="ind">
        set the current tag to the nth child of the current tag which meets the given criteria.  the keyword
        arguments are the same as <span class="special">go</span>.<span class="special">only</span>()<p/>
        </div>
</div>

        <span class="heading">Writing Your Own Directional Resolver</span><p/>
        <table class="maria">
          <tr>
            <td class="code-body">
              <pre class="code">
<span class="keyword">def</span> <span class="special">randomchild</span>(<span class="arg">atropine</span>):
<span class="comment">  # Atropine.assimilate is identical to assigning to
  # atropine.current, but it asserts it argument is not
  # BeautifulSoup.Null or None</span>

  <span class="special">atropine</span>.assimilate(<span class="special">random</span>.choice(<span class="special">atropine</span>.current.contents))

<span class="comment"># then use it just as you would any other resolver</span>
<span class="special">atropine</span>.resolve(<span class="special">randomchild</span>)
</pre>
</td>
</tr>
</table><p/>
</div>
<a name="#nullresolvers"/>
<span class="heading">Null Resolvers</span><p/>
<div class="h2block">
<span class="special">check</span>.<span class="special">has</span>(<span class="arg">**k</span>)<br/>
<div class="ind">
check that the current tag meets all of the given criteria<p/>
</div>

<span class="special">check</span>.<span class="special">doesnthave</span>(<span class="arg">**k</span>)<br/>
<div class="ind">
inverse of <span class="special">check</span>.<span class="special">has</span>()<p/>
</div>

The arguments accepted by <span class="special">check</span>.<span class="special">has</span> and <span class="special">check</span>.<span class="special">doesnthave</span>
are keyword arguments that name "checker" functions - checkers are functions that accept two arguments - an <span class="special">Atropine</span> instance, as well as
the value of the keyword argument. as checkers are expected to return a boolean indicating matchingness,  all <span class="special">check</span>.<span class="special">has</span>
does is call each checker in turn, raising an exception if any one of them returns False.  <span class="special">check</span>.<span class="special">doesnthave</span>
does the same, but explodes if any checker returns True.<p/>

      <span class="heading">Writing Your Own Checkers</span><p/>
          <table class="maria">
            <tr>
              <td class="code-body">
                <pre class="code">
<span class="keyword">def</span> <span class="special">ntextnodes</span>(<span class="arg">atropine</span>, <span class="arg">n</span>):
  <span class="comment">#(check.equal is a utility function equal(x, y) that returns
  # x == y if y is not a sequence, or x in y, if y is a sequence)</span>
  <span class="keyword">return</span> <span class="special">check</span>.<span class="special">equal</span>(<span class="special">len</span>(<span class="arg">t</span> <span class="keyword">for</span> <span class="arg">t</span> <span class="keyword">in</span> <span class="special">atropine</span>.<span class="special">current</span>.<span class="special">contents</span>
                              <span class="keyword">if</span> <span class="special">atropine</span>.<span class="special">istextnode</span>(<span class="arg">t</span>)), <span class="arg">n</span>)

<span class="special">atropine</span>.<span class="special">registerchecker</span>(<span class="literal">'ntextnodes'</span>, <span class="arg">ntextnodes</span>)

<span class="comment"># you can now use this like so:</span>
<span class="special">atropine</span>.<span class="special">resolve</span>(<span class="special">check</span>.<span class="special">has</span>(<span class="arg">tag</span>=<span class="literal">'td'</span>, <span class="arg">ntextnodes</span>=4))
<span class="special">atropine</span>.<span class="special">resolve</span>(<span class="special">check</span>.<span class="special">has</span>(<span class="arg">tag</span>=<span class="literal">'td'</span>, <span class="arg">ntextnodes</span>=(1, 2, 3, 4)))
</pre>
</td>
</tr>
</table>
</div>
<div class="h2block">
  <span class="heading">Simple Checkers</span><p/>
  <div class="h2block">

          all simple checkers accept a string or integer, or a sequence of strings or integers.<p/>

<span class="special">indexonparent</span><br/>
<div class="ind">
assert that the current tag is (or is not) the nth child of its parent tag
(starting from 0)<p/>
</div>

<span class="special">id</span><br/>
<div class="ind">
          assert that the current tag has (or doesnt have) an id attribute with the given value<p/>
</div>

          <span class="special">cls</span><br/>
          <div class="ind">
          same as <span class="special">id</span>, but checks the 'class' attribute<p/>
          </div>


          <span class="special">tag</span><br/>
          <div class="ind">
          assert that the current tag has (or doesnt have) the given tag name<p/>
          </div>

          <b>examples</b>:<p/>
          <div class="h2block">
          <span class="special">check</span>.<span class="special">has</span>(<span class="arg">id</span>=<span class="literal">'something'</span>)<br/>
          <div class="ind">
          will match <span class="literal">'&lt;anything id="something">'</span><p/>
          </div>

          <span class="special">check</span>.<span class="special">has</span>(<span class="arg">id</span>=(<span class="literal">'something'</span>, <span class="literal">'something_else'</span>))<br/>
          <div class="ind">
          will match <span class="literal">'&lt;anything id="something">'</span>
          and <span class="literal">'&lt;anything id="something_else"></span><p/>
</div>

          <span class="special">check</span>.<span class="special">doesnthave</span>(<span class="arg">id</span>=<span class="literal">'something'</span>)<br/>
          <div class="ind">
          will match everything that doesnt have an id of <span class="literal">'something'</span><p/>
          </div>
        </div>
      </div>
    </div>

        <div class="h2block">
          <span class="heading">Not So Simple Checkers</span><p/>
          <div class="h2block">
          <span class="special">attrs</span><br/>
          <div class="ind">
          accepts a dictionary of attributename:attributevalue, and checks that
          the attributes of the current tag match (or dont match) the given attribute
          values.  note that only the given attributes are checked, e.g.
          <span class="special">check</span>.<span class="special">has</span>(<span class="arg">tag</span>=<span class="literal">'td'</span>, <span class="arg">attrs</span>=<span class="special">dict</span>(<span class="arg">x</span>=<span class="literal">'x'</span>, <span class="arg">y</span>=<span class="literal">'y'</span>))
          will match <span class="literal">'&lt;td x="x" y="y" somethingunrelated="abc">'</span>.
          the values in the dictionary can be either strings, sequences of strings, regular expression objects or functions that take a string and a return a boolean</p>
          </div>

          <span class="special">allchildren</span><br/>
          <div class="ind">
          accepts a function and asserts that it returns True across all children
          of the current tag<p/>
          </div>

          <span class="special">onlytext</span><br/>
          <div class="ind">
          assert that the current tag has only one child node, which is a text node,
          whose contents match (or dont match, if you are using <span class="special">check</span>.<span class="special">doesnthave</span>) 
          the given value.  the value can be a string, a regular expression object, or a callable that returns a boolean<p/>
          </div>

          <b>examples</b>:<p/>
          <div class="h2block">
          <span class="special">check</span>.<span class="special">has</span>(<span class="arg">tag</span>=<span class="literal">'span'</span>, <span class="arg">onlytext</span>=<span class="literal">'abc'</span>)<br/>

          <div class="ind">
          will match <span class="literal">'&lt;span>abc&lt/span>'</span><p/>
          </div>

          <span class="special">check</span>.<span class="special">has</span>(<span class="arg">tag</span>=<span class="literal">'span'</span>, <span class="arg">onlytext</span>=<span class="special">re</span>.<span class="special">compile</span>(<span class="literal">'\d+,\d+,\d+'</span>))<br/>
          <div class="ind">
          will match <span class="literal">'&lt;span>1,2,3&lt;/span>'</span> and <span class="literal">'&lt;span>3,2,1&lt;/span>'</span>, etc<p/>
          </div>

          <span class="special">check</span>.<span class="special">has</span>(<span class="arg">tag</span>=<span class="literal">'span'</span>, <span class="arg">onlytext</span>=<span class="keyword">lambda</span> <span class="arg">text</span>: True)<br/>
          <div class="ind">
          will match a span element that contains any one text node, no matter what characters it is composed of<p/>
          </div>

        </div>
          <span class="special">alltext</span><br/>
          <div class="ind">
          probably useless - it checks that all of the text nodes that are children
          of the current node match (or dont match) the given value<p/>
          </div>
          <b>examples</b>:<p/>
          <div class="h2block">
          <span class="special">check</span>.<span class="special">has</span>(<span class="arg">tag</span>=<span class="literal">'span'</span>, <span class="arg">alltext</span>=<span class="literal">'HELLO!'</span>)<br/>
          <div class="ind">
          will match <span class="literal">'&lt;span>&lt;b>HELLO!&lt;/b>&lt;b>HELLO!&lt;/b>&lt;/span>'</span><p/>
          </div>

          <span class="special">check</span>.<span class="special">has</span>(<span class="arg">tag</span>=<span class="literal">'span'</span>, <span class="arg">alltext</span>=<span class="keyword">lambda</span> <span class="arg">text</span>: <span class="special">text</span>.<span class="special">startswith</span>(<span class="literal">'H'</span>))<br/>
          <div class="ind">
          will match <span class="literal">'&lt;span>&lt;b>HELLO!&lt;/b>&lt;b>HOWDY&lt;/b>&lt;/span>'</span>, etc<p/>
          </div>

          <span class="special">check</span>.<span class="special">doesnthave</span>(<span class="arg">alltext</span>=<span class="special">re</span>.<span class="special">compile</span>(<span class="literal">'cheese</span>'))<br/>
          <div class="ind">
          will match any element which doesn't have any descendant text nodes that contain <span class="literal">'cheese'</span><p/>
        </div>
        </div>
      </div>

<span class="heading">
  Special Resolvers
</span><p/>

<div class="h2block">

  <span class="special">special</span>.<span class="special">collect</span>(<span class="arg">keyname</span>,
  <span class="arg">alltext</span>=False,
  <span class="arg">onlytext</span>=False)<br/>

  <div class="ind">
    if <span class="arg">alltext</span> is True, all descendant text nodes of the current
    element will be stored in a list under the key <span class="arg">keyname</span> in a dictionary
    which can be accessed via the <span class="special">collection</span> instance attribute
    of the <span class="special">Atropine</span> instance returned by the
    current <span class="special">resolve</span> call.  the same goes for
    <span class="arg">onlytext</span>, except it will be asserted that the current node contains
    only one element (which is a text node) and the value of that node will be stored (as a string).
  </div>

</div>
