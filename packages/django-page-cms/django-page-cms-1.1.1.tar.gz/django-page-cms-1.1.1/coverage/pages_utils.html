<!doctype html PUBLIC "-//W3C//DTD html 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>Coverage for pages.utils</title>
<link rel='stylesheet' href='style.css' type='text/css'>
<script src='jquery-1.3.2.min.js'></script>
<script>
function toggle_lines(btn, cls) {
    var btn = $(btn);
    if (btn.hasClass("hide")) {
        $("#source ."+cls).removeClass("hide");
        btn.removeClass("hide");
    }
    else {
        $("#source ."+cls).addClass("hide");
        btn.addClass("hide");
    }
}
</script>
</head>
<body>
<div id='header'>
    <div class='content'>
        <h1>Coverage for <b>pages.utils</b> :
            <span class='pc_cov'>56%</span>
        </h1>
        <h2 class='stats'>
            102 statements
            <span class='run hide' onclick='toggle_lines(this, "run")'>57 run</span>
            <span class='exc' onclick='toggle_lines(this, "exc")'>0 excluded</span>
            <span class='mis' onclick='toggle_lines(this, "mis")'>45 missing</span>
        </h2>
    </div>
</div>

<div id='source'>
<table cellspacing='0' cellpadding='0'>
<tr>
<td class='linenos' valign='top'>
<p class='pln'>1</p>
<p class='stm run hide'>2</p>
<p class='stm run hide'>3</p>
<p class='stm run hide'>4</p>
<p class='stm run hide'>5</p>
<p class='stm run hide'>6</p>
<p class='stm run hide'>7</p>
<p class='stm run hide'>8</p>
<p class='stm run hide'>9</p>
<p class='pln'>10</p>
<p class='stm run hide'>11</p>
<p class='pln'>12</p>
<p class='stm run hide'>13</p>
<p class='stm run hide'>14</p>
<p class='stm mis'>15</p>
<p class='stm run hide'>16</p>
<p class='pln'>17</p>
<p class='stm run hide'>18</p>
<p class='pln'>19</p>
<p class='pln'>20</p>
<p class='pln'>21</p>
<p class='pln'>22</p>
<p class='stm run hide'>23</p>
<p class='stm run hide'>24</p>
<p class='stm mis'>25</p>
<p class='stm mis'>26</p>
<p class='pln'>27</p>
<p class='stm run hide'>28</p>
<p class='stm run hide'>29</p>
<p class='pln'>30</p>
<p class='pln'>31</p>
<p class='stm run hide'>32</p>
<p class='stm run hide'>33</p>
<p class='stm run hide'>34</p>
<p class='stm run hide'>35</p>
<p class='pln'>36</p>
<p class='stm run hide'>37</p>
<p class='pln'>38</p>
<p class='pln'>39</p>
<p class='pln'>40</p>
<p class='stm run hide'>41</p>
<p class='pln'>42</p>
<p class='stm run hide'>43</p>
<p class='pln'>44</p>
<p class='pln'>45</p>
<p class='stm run hide'>46</p>
<p class='stm run hide'>47</p>
<p class='pln'>48</p>
<p class='pln'>49</p>
<p class='stm run hide'>50</p>
<p class='stm run hide'>51</p>
<p class='pln'>52</p>
<p class='pln'>53</p>
<p class='stm run hide'>54</p>
<p class='pln'>55</p>
<p class='stm run hide'>56</p>
<p class='stm run hide'>57</p>
<p class='stm run hide'>58</p>
<p class='stm mis'>59</p>
<p class='stm run hide'>60</p>
<p class='stm run hide'>61</p>
<p class='stm run hide'>62</p>
<p class='stm run hide'>63</p>
<p class='stm run hide'>64</p>
<p class='pln'>65</p>
<p class='stm run hide'>66</p>
<p class='stm run hide'>67</p>
<p class='pln'>68</p>
<p class='stm run hide'>69</p>
<p class='stm run hide'>70</p>
<p class='pln'>71</p>
<p class='pln'>72</p>
<p class='stm run hide'>73</p>
<p class='stm run hide'>74</p>
<p class='pln'>75</p>
<p class='stm run hide'>76</p>
<p class='stm run hide'>77</p>
<p class='stm run hide'>78</p>
<p class='stm mis'>79</p>
<p class='stm mis'>80</p>
<p class='stm run hide'>81</p>
<p class='stm run hide'>82</p>
<p class='pln'>83</p>
<p class='stm run hide'>84</p>
<p class='pln'>85</p>
<p class='pln'>86</p>
<p class='pln'>87</p>
<p class='pln'>88</p>
<p class='stm run hide'>89</p>
<p class='stm mis'>90</p>
<p class='pln'>91</p>
<p class='stm run hide'>92</p>
<p class='stm run hide'>93</p>
<p class='stm run hide'>94</p>
<p class='stm run hide'>95</p>
<p class='pln'>96</p>
<p class='stm mis'>97</p>
<p class='stm mis'>98</p>
<p class='stm mis'>99</p>
<p class='stm mis'>100</p>
<p class='stm mis'>101</p>
<p class='stm mis'>102</p>
<p class='stm mis'>103</p>
<p class='stm mis'>104</p>
<p class='stm mis'>105</p>
<p class='pln'>106</p>
<p class='pln'>107</p>
<p class='stm run hide'>108</p>
<p class='pln'>109</p>
<p class='pln'>110</p>
<p class='pln'>111</p>
<p class='pln'>112</p>
<p class='pln'>113</p>
<p class='pln'>114</p>
<p class='pln'>115</p>
<p class='pln'>116</p>
<p class='pln'>117</p>
<p class='pln'>118</p>
<p class='pln'>119</p>
<p class='pln'>120</p>
<p class='pln'>121</p>
<p class='stm mis'>122</p>
<p class='stm mis'>123</p>
<p class='stm mis'>124</p>
<p class='stm mis'>125</p>
<p class='stm mis'>126</p>
<p class='stm mis'>127</p>
<p class='stm mis'>128</p>
<p class='pln'>129</p>
<p class='stm run hide'>130</p>
<p class='pln'>131</p>
<p class='stm run hide'>132</p>
<p class='pln'>133</p>
<p class='pln'>134</p>
<p class='pln'>135</p>
<p class='pln'>136</p>
<p class='pln'>137</p>
<p class='pln'>138</p>
<p class='stm mis'>139</p>
<p class='stm mis'>140</p>
<p class='stm mis'>141</p>
<p class='stm mis'>142</p>
<p class='stm mis'>143</p>
<p class='stm mis'>144</p>
<p class='stm mis'>145</p>
<p class='stm mis'>146</p>
<p class='stm mis'>147</p>
<p class='stm mis'>148</p>
<p class='stm mis'>149</p>
<p class='stm mis'>150</p>
<p class='pln'>151</p>
<p class='stm mis'>152</p>
<p class='stm mis'>153</p>
<p class='stm mis'>154</p>
<p class='pln'>155</p>
<p class='stm mis'>156</p>
<p class='stm mis'>157</p>
<p class='stm mis'>158</p>
<p class='stm mis'>159</p>
<p class='stm mis'>160</p>
<p class='stm mis'>161</p>
<p class='stm mis'>162</p>
    
</td>
<td class='text' valign='top'>
<p class='pln'># -*- coding: utf-8 -*-</p>
<p class='stm run hide'>&quot;&quot;&quot;A collection of functions for Page CMS&quot;&quot;&quot;</p>
<p class='stm run hide'>import sys, re, logging, pprint, traceback</p>
<p class='stm run hide'>from django.conf import settings as django_settings</p>
<p class='stm run hide'>from django.template import TemplateDoesNotExist</p>
<p class='stm run hide'>from django.template import loader, Context, RequestContext</p>
<p class='stm run hide'>from django.core.cache import cache</p>
<p class='stm run hide'>from pages import settings</p>
<p class='stm run hide'>from pages.http import get_request_mock, get_language_from_request</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>def get_context_mock():</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;return a mockup dictionnary to use in get_placeholders.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; context = {&#39;current_page&#39;:None}</p>
<p class='stm run hide'>&nbsp; &nbsp; if settings.PAGE_EXTRA_CONTEXT:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; context.update(settings.PAGE_EXTRA_CONTEXT())</p>
<p class='stm run hide'>&nbsp; &nbsp; return context</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>def get_placeholders(template_name):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;Return a list of PlaceholderNode found in the given template.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; :param template_name: the name of the template file</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; try:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; temp = loader.get_template(template_name)</p>
<p class='stm mis'>&nbsp; &nbsp; except TemplateDoesNotExist:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return []</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; request = get_request_mock()</p>
<p class='stm run hide'>&nbsp; &nbsp; context = get_context_mock()</p>
<p class='pln'>&nbsp; &nbsp; # I need to render the template in order to extract</p>
<p class='pln'>&nbsp; &nbsp; # placeholder tags</p>
<p class='stm run hide'>&nbsp; &nbsp; temp.render(RequestContext(request, context))</p>
<p class='stm run hide'>&nbsp; &nbsp; plist, blist = [], []</p>
<p class='stm run hide'>&nbsp; &nbsp; _placeholders_recursif(temp.nodelist, plist, blist)</p>
<p class='stm run hide'>&nbsp; &nbsp; return plist</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>def _placeholders_recursif(nodelist, plist, blist):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;Recursively search into a template node list for PlaceholderNode</p>
<p class='pln'>&nbsp; &nbsp; node.&quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; # I needed to import make this lazy import to make the doc compile</p>
<p class='stm run hide'>&nbsp; &nbsp; from django.template.loader_tags import BlockNode</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; for node in nodelist:</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # extends node</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if hasattr(node, &#39;parent_name&#39;):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _placeholders_recursif(node.get_parent(Context()).nodelist,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; plist, blist)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # include node</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; elif hasattr(node, &#39;template&#39;):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _placeholders_recursif(node.template.nodelist, plist, blist)</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # It&#39;s a placeholder</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if hasattr(node, &#39;page&#39;) and hasattr(node, &#39;parsed&#39;) and \</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hasattr(node, &#39;as_varname&#39;) and hasattr(node, &#39;name&#39;):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; already_in_plist = False</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for pl in plist:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if pl.name == node.name:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; already_in_plist = True</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if not already_in_plist:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if len(blist):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node.found_in_block = blist[len(blist)-1]</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; plist.append(node)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node.render(Context())</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; for key in (&#39;nodelist&#39;, &#39;nodelist_true&#39;, &#39;nodelist_false&#39;):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if isinstance(node, BlockNode):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # delete placeholders found in a block of the same name</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for index, pl in enumerate(plist):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if pl.found_in_block and \</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pl.found_in_block.name == node.name \</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and pl.found_in_block != node:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; del plist[index]</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blist.append(node)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if hasattr(node, key):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _placeholders_recursif(getattr(node, key), plist, blist)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; except:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if isinstance(node, BlockNode):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blist.pop()</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>def has_page_add_permission(request, page=None):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;Return true if the current user has permission to add a new page.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; :param page: not used</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; if not settings.PAGE_PERMISSION:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return True</p>
<p class='pln'>&nbsp; &nbsp; else:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; from pages.models import PagePermission</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; permission = PagePermission.objects.get_page_id_list(request.user)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if permission == &quot;All&quot;:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return True</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # the user has the right to add a page under a page he control</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; target = request.GET.get(&#39;target&#39;, None)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if target is not None:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; target = int(target)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if target in permission:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return True</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; except:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass</p>
<p class='stm mis'>&nbsp; &nbsp; return False</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>def normalize_url(url):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;Return a normalized url with trailing and without leading slash.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &gt;&gt;&gt; normalize_url(None)</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &#39;/&#39;</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &gt;&gt;&gt; normalize_url(&#39;/&#39;)</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &#39;/&#39;</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &gt;&gt;&gt; normalize_url(&#39;/foo/bar&#39;)</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &#39;/foo/bar&#39;</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &gt;&gt;&gt; normalize_url(&#39;foo/bar&#39;)</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &#39;/foo/bar&#39;</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &gt;&gt;&gt; normalize_url(&#39;/foo/bar/&#39;)</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &#39;/foo/bar&#39;</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; if not url or len(url)==0:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return &#39;/&#39;</p>
<p class='stm mis'>&nbsp; &nbsp; if not url.startswith(&#39;/&#39;):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; url = &#39;/&#39; + url</p>
<p class='stm mis'>&nbsp; &nbsp; if len(url)&gt;1 and url.endswith(&#39;/&#39;):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; url = url[0:len(url)-1]</p>
<p class='stm mis'>&nbsp; &nbsp; return url</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>PAGE_CLASS_ID_REGEX = re.compile(&#39;page_([0-9]+)&#39;)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>def filter_link(content, page, language, content_type):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;Transform the HTML link href to point to the targeted page</p>
<p class='pln'>&nbsp; &nbsp; absolute URL.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &gt;&gt;&gt; filter_link(&#39;&lt;a class=&quot;page_1&quot;&gt;hello&lt;/a&gt;&#39;, page, &#39;en-us&#39;, body)</p>
<p class='pln'>&nbsp; &nbsp;&nbsp; &#39;&lt;a href=&quot;/pages/page-1&quot; class=&quot;page_1&quot;&gt;hello&lt;/a&gt;&#39;</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; if not settings.PAGE_LINK_FILTER:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return content</p>
<p class='stm mis'>&nbsp; &nbsp; if content_type in (&#39;title&#39;, &#39;slug&#39;):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return content</p>
<p class='stm mis'>&nbsp; &nbsp; from BeautifulSoup import BeautifulSoup</p>
<p class='stm mis'>&nbsp; &nbsp; tree = BeautifulSoup(content)</p>
<p class='stm mis'>&nbsp; &nbsp; tags = tree.findAll(&#39;a&#39;)</p>
<p class='stm mis'>&nbsp; &nbsp; if len(tags) == 0:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return content</p>
<p class='stm mis'>&nbsp; &nbsp; for tag in tags:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; tag_class = tag.get(&#39;class&#39;, False)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if tag_class:</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # find page link with class &#39;page_ID&#39;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = PAGE_CLASS_ID_REGEX.search(content)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if result and result.group:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TODO: try the cache before fetching the Page object</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from pages.models import Page</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; target_page = Page.objects.get(pk=int(result.group(1)))</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tag[&#39;href&#39;] = target_page.get_url_path(language)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; except Page.DoesNotExist:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache.set(Page.PAGE_BROKEN_LINK_KEY % page.id, True)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tag[&#39;class&#39;] = &#39;pagelink_broken&#39;</p>
<p class='stm mis'>&nbsp; &nbsp; return unicode(tree)</p>
    
</td>
</tr>
</table>
</div>

</body>
</html>
