<!doctype html PUBLIC "-//W3C//DTD html 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>Coverage for pages.models</title>
<link rel='stylesheet' href='style.css' type='text/css'>
<script src='jquery-1.3.2.min.js'></script>
<script>
function toggle_lines(btn, cls) {
    var btn = $(btn);
    if (btn.hasClass("hide")) {
        $("#source ."+cls).removeClass("hide");
        btn.removeClass("hide");
    }
    else {
        $("#source ."+cls).addClass("hide");
        btn.addClass("hide");
    }
}
</script>
</head>
<body>
<div id='header'>
    <div class='content'>
        <h1>Coverage for <b>pages.models</b> :
            <span class='pc_cov'>47%</span>
        </h1>
        <h2 class='stats'>
            211 statements
            <span class='run hide' onclick='toggle_lines(this, "run")'>99 run</span>
            <span class='exc' onclick='toggle_lines(this, "exc")'>0 excluded</span>
            <span class='mis' onclick='toggle_lines(this, "mis")'>112 missing</span>
        </h2>
    </div>
</div>

<div id='source'>
<table cellspacing='0' cellpadding='0'>
<tr>
<td class='linenos' valign='top'>
<p class='pln'>1</p>
<p class='stm run hide'>2</p>
<p class='stm run hide'>3</p>
<p class='pln'>4</p>
<p class='stm run hide'>5</p>
<p class='stm run hide'>6</p>
<p class='stm run hide'>7</p>
<p class='stm run hide'>8</p>
<p class='stm run hide'>9</p>
<p class='stm run hide'>10</p>
<p class='stm run hide'>11</p>
<p class='stm run hide'>12</p>
<p class='pln'>13</p>
<p class='stm run hide'>14</p>
<p class='stm run hide'>15</p>
<p class='stm run hide'>16</p>
<p class='stm run hide'>17</p>
<p class='pln'>18</p>
<p class='stm run hide'>19</p>
<p class='pln'>20</p>
<p class='pln'>21</p>
<p class='pln'>22</p>
<p class='pln'>23</p>
<p class='pln'>24</p>
<p class='pln'>25</p>
<p class='pln'>26</p>
<p class='pln'>27</p>
<p class='pln'>28</p>
<p class='pln'>29</p>
<p class='pln'>30</p>
<p class='pln'>31</p>
<p class='pln'>32</p>
<p class='pln'>33</p>
<p class='pln'>34</p>
<p class='pln'>35</p>
<p class='pln'>36</p>
<p class='pln'>37</p>
<p class='pln'>38</p>
<p class='pln'>39</p>
<p class='pln'>40</p>
<p class='pln'>41</p>
<p class='pln'>42</p>
<p class='pln'>43</p>
<p class='pln'>44</p>
<p class='pln'>45</p>
<p class='pln'>46</p>
<p class='stm run hide'>47</p>
<p class='stm run hide'>48</p>
<p class='stm run hide'>49</p>
<p class='stm run hide'>50</p>
<p class='stm run hide'>51</p>
<p class='pln'>52</p>
<p class='pln'>53</p>
<p class='pln'>54</p>
<p class='pln'>55</p>
<p class='pln'>56</p>
<p class='stm run hide'>57</p>
<p class='stm run hide'>58</p>
<p class='pln'>59</p>
<p class='pln'>60</p>
<p class='stm run hide'>61</p>
<p class='stm run hide'>62</p>
<p class='pln'>63</p>
<p class='stm run hide'>64</p>
<p class='pln'>65</p>
<p class='stm run hide'>66</p>
<p class='pln'>67</p>
<p class='stm run hide'>68</p>
<p class='pln'>69</p>
<p class='stm run hide'>70</p>
<p class='pln'>71</p>
<p class='pln'>72</p>
<p class='stm run hide'>73</p>
<p class='pln'>74</p>
<p class='pln'>75</p>
<p class='pln'>76</p>
<p class='stm run hide'>77</p>
<p class='pln'>78</p>
<p class='stm run hide'>79</p>
<p class='stm run hide'>80</p>
<p class='pln'>81</p>
<p class='pln'>82</p>
<p class='stm run hide'>83</p>
<p class='pln'>84</p>
<p class='pln'>85</p>
<p class='stm run hide'>86</p>
<p class='pln'>87</p>
<p class='pln'>88</p>
<p class='pln'>89</p>
<p class='pln'>90</p>
<p class='stm run hide'>91</p>
<p class='pln'>92</p>
<p class='pln'>93</p>
<p class='stm run hide'>94</p>
<p class='pln'>95</p>
<p class='stm run hide'>96</p>
<p class='pln'>97</p>
<p class='pln'>98</p>
<p class='pln'>99</p>
<p class='stm run hide'>100</p>
<p class='pln'>101</p>
<p class='stm run hide'>102</p>
<p class='stm run hide'>103</p>
<p class='stm run hide'>104</p>
<p class='pln'>105</p>
<p class='stm run hide'>106</p>
<p class='pln'>107</p>
<p class='stm run hide'>108</p>
<p class='stm run hide'>109</p>
<p class='stm run hide'>110</p>
<p class='pln'>111</p>
<p class='stm run hide'>112</p>
<p class='pln'>113</p>
<p class='stm mis'>114</p>
<p class='stm mis'>115</p>
<p class='pln'>116</p>
<p class='stm mis'>117</p>
<p class='stm mis'>118</p>
<p class='pln'>119</p>
<p class='stm mis'>120</p>
<p class='stm mis'>121</p>
<p class='stm mis'>122</p>
<p class='pln'>123</p>
<p class='stm mis'>124</p>
<p class='pln'>125</p>
<p class='stm mis'>126</p>
<p class='stm mis'>127</p>
<p class='pln'>128</p>
<p class='stm mis'>129</p>
<p class='stm mis'>130</p>
<p class='pln'>131</p>
<p class='stm run hide'>132</p>
<p class='pln'>133</p>
<p class='pln'>134</p>
<p class='pln'>135</p>
<p class='pln'>136</p>
<p class='stm mis'>137</p>
<p class='stm mis'>138</p>
<p class='stm mis'>139</p>
<p class='pln'>140</p>
<p class='stm mis'>141</p>
<p class='stm mis'>142</p>
<p class='stm mis'>143</p>
<p class='pln'>144</p>
<p class='stm mis'>145</p>
<p class='stm run hide'>146</p>
<p class='pln'>147</p>
<p class='stm run hide'>148</p>
<p class='pln'>149</p>
<p class='stm mis'>150</p>
<p class='pln'>151</p>
<p class='stm run hide'>152</p>
<p class='pln'>153</p>
<p class='pln'>154</p>
<p class='stm mis'>155</p>
<p class='pln'>156</p>
<p class='pln'>157</p>
<p class='stm mis'>158</p>
<p class='stm mis'>159</p>
<p class='stm mis'>160</p>
<p class='stm mis'>161</p>
<p class='stm mis'>162</p>
<p class='pln'>163</p>
<p class='pln'>164</p>
<p class='stm mis'>165</p>
<p class='stm mis'>166</p>
<p class='pln'>167</p>
<p class='stm mis'>168</p>
<p class='pln'>169</p>
<p class='pln'>170</p>
<p class='stm mis'>171</p>
<p class='stm mis'>172</p>
<p class='stm mis'>173</p>
<p class='pln'>174</p>
<p class='pln'>175</p>
<p class='stm run hide'>176</p>
<p class='pln'>177</p>
<p class='pln'>178</p>
<p class='pln'>179</p>
<p class='stm mis'>180</p>
<p class='stm mis'>181</p>
<p class='stm mis'>182</p>
<p class='pln'>183</p>
<p class='stm mis'>184</p>
<p class='pln'>185</p>
<p class='pln'>186</p>
<p class='stm mis'>187</p>
<p class='stm mis'>188</p>
<p class='stm mis'>189</p>
<p class='stm mis'>190</p>
<p class='pln'>191</p>
<p class='stm run hide'>192</p>
<p class='pln'>193</p>
<p class='stm mis'>194</p>
<p class='stm mis'>195</p>
<p class='stm mis'>196</p>
<p class='pln'>197</p>
<p class='stm run hide'>198</p>
<p class='pln'>199</p>
<p class='pln'>200</p>
<p class='pln'>201</p>
<p class='pln'>202</p>
<p class='pln'>203</p>
<p class='stm mis'>204</p>
<p class='stm mis'>205</p>
<p class='stm mis'>206</p>
<p class='stm mis'>207</p>
<p class='pln'>208</p>
<p class='stm run hide'>209</p>
<p class='pln'>210</p>
<p class='pln'>211</p>
<p class='pln'>212</p>
<p class='pln'>213</p>
<p class='pln'>214</p>
<p class='pln'>215</p>
<p class='pln'>216</p>
<p class='stm mis'>217</p>
<p class='pln'>218</p>
<p class='stm run hide'>219</p>
<p class='pln'>220</p>
<p class='pln'>221</p>
<p class='pln'>222</p>
<p class='pln'>223</p>
<p class='stm mis'>224</p>
<p class='stm mis'>225</p>
<p class='stm mis'>226</p>
<p class='stm mis'>227</p>
<p class='stm mis'>228</p>
<p class='pln'>229</p>
<p class='stm mis'>230</p>
<p class='stm mis'>231</p>
<p class='stm mis'>232</p>
<p class='pln'>233</p>
<p class='stm mis'>234</p>
<p class='pln'>235</p>
<p class='stm mis'>236</p>
<p class='pln'>237</p>
<p class='stm run hide'>238</p>
<p class='pln'>239</p>
<p class='pln'>240</p>
<p class='pln'>241</p>
<p class='pln'>242</p>
<p class='pln'>243</p>
<p class='pln'>244</p>
<p class='pln'>245</p>
<p class='stm mis'>246</p>
<p class='pln'>247</p>
<p class='stm run hide'>248</p>
<p class='pln'>249</p>
<p class='pln'>250</p>
<p class='pln'>251</p>
<p class='pln'>252</p>
<p class='pln'>253</p>
<p class='pln'>254</p>
<p class='pln'>255</p>
<p class='pln'>256</p>
<p class='stm mis'>257</p>
<p class='pln'>258</p>
<p class='pln'>259</p>
<p class='stm mis'>260</p>
<p class='pln'>261</p>
<p class='stm run hide'>262</p>
<p class='pln'>263</p>
<p class='pln'>264</p>
<p class='pln'>265</p>
<p class='pln'>266</p>
<p class='pln'>267</p>
<p class='pln'>268</p>
<p class='pln'>269</p>
<p class='stm mis'>270</p>
<p class='stm mis'>271</p>
<p class='pln'>272</p>
<p class='stm mis'>273</p>
<p class='pln'>274</p>
<p class='pln'>275</p>
<p class='stm run hide'>276</p>
<p class='pln'>277</p>
<p class='pln'>278</p>
<p class='pln'>279</p>
<p class='pln'>280</p>
<p class='pln'>281</p>
<p class='stm mis'>282</p>
<p class='stm mis'>283</p>
<p class='pln'>284</p>
<p class='stm mis'>285</p>
<p class='stm mis'>286</p>
<p class='stm mis'>287</p>
<p class='stm mis'>288</p>
<p class='stm mis'>289</p>
<p class='pln'>290</p>
<p class='stm mis'>291</p>
<p class='stm mis'>292</p>
<p class='pln'>293</p>
<p class='stm mis'>294</p>
<p class='pln'>295</p>
<p class='stm run hide'>296</p>
<p class='pln'>297</p>
<p class='pln'>298</p>
<p class='pln'>299</p>
<p class='pln'>300</p>
<p class='pln'>301</p>
<p class='stm mis'>302</p>
<p class='stm mis'>303</p>
<p class='stm mis'>304</p>
<p class='stm mis'>305</p>
<p class='stm mis'>306</p>
<p class='stm mis'>307</p>
<p class='pln'>308</p>
<p class='stm run hide'>309</p>
<p class='pln'>310</p>
<p class='pln'>311</p>
<p class='pln'>312</p>
<p class='pln'>313</p>
<p class='stm mis'>314</p>
<p class='stm mis'>315</p>
<p class='pln'>316</p>
<p class='stm mis'>317</p>
<p class='stm mis'>318</p>
<p class='stm mis'>319</p>
<p class='stm mis'>320</p>
<p class='stm mis'>321</p>
<p class='stm mis'>322</p>
<p class='pln'>323</p>
<p class='stm run hide'>324</p>
<p class='pln'>325</p>
<p class='pln'>326</p>
<p class='pln'>327</p>
<p class='pln'>328</p>
<p class='stm mis'>329</p>
<p class='pln'>330</p>
<p class='stm run hide'>331</p>
<p class='pln'>332</p>
<p class='pln'>333</p>
<p class='pln'>334</p>
<p class='pln'>335</p>
<p class='pln'>336</p>
<p class='stm mis'>337</p>
<p class='stm mis'>338</p>
<p class='stm mis'>339</p>
<p class='stm mis'>340</p>
<p class='stm mis'>341</p>
<p class='pln'>342</p>
<p class='pln'>343</p>
<p class='stm mis'>344</p>
<p class='pln'>345</p>
<p class='stm run hide'>346</p>
<p class='pln'>347</p>
<p class='pln'>348</p>
<p class='stm mis'>349</p>
<p class='stm mis'>350</p>
<p class='stm mis'>351</p>
<p class='stm mis'>352</p>
<p class='stm mis'>353</p>
<p class='pln'>354</p>
<p class='stm run hide'>355</p>
<p class='stm mis'>356</p>
<p class='pln'>357</p>
<p class='stm run hide'>358</p>
<p class='stm mis'>359</p>
<p class='stm mis'>360</p>
<p class='pln'>361</p>
<p class='stm mis'>362</p>
<p class='stm mis'>363</p>
<p class='pln'>364</p>
<p class='pln'>365</p>
<p class='stm run hide'>366</p>
<p class='stm run hide'>367</p>
<p class='stm mis'>368</p>
<p class='stm mis'>369</p>
<p class='pln'>370</p>
<p class='stm run hide'>371</p>
<p class='stm run hide'>372</p>
<p class='pln'>373</p>
<p class='pln'>374</p>
<p class='pln'>375</p>
<p class='stm run hide'>376</p>
<p class='pln'>377</p>
<p class='pln'>378</p>
<p class='pln'>379</p>
<p class='pln'>380</p>
<p class='stm run hide'>381</p>
<p class='pln'>382</p>
<p class='stm run hide'>383</p>
<p class='stm run hide'>384</p>
<p class='pln'>385</p>
<p class='stm run hide'>386</p>
<p class='pln'>387</p>
<p class='stm run hide'>388</p>
<p class='stm run hide'>389</p>
<p class='stm run hide'>390</p>
<p class='pln'>391</p>
<p class='stm run hide'>392</p>
<p class='stm mis'>393</p>
<p class='pln'>394</p>
<p class='pln'>395</p>
<p class='pln'>396</p>
<p class='stm run hide'>397</p>
<p class='pln'>398</p>
<p class='pln'>399</p>
<p class='pln'>400</p>
<p class='pln'>401</p>
<p class='stm run hide'>402</p>
<p class='stm run hide'>403</p>
<p class='stm run hide'>404</p>
<p class='stm run hide'>405</p>
<p class='pln'>406</p>
<p class='stm run hide'>407</p>
<p class='pln'>408</p>
<p class='stm run hide'>409</p>
<p class='pln'>410</p>
<p class='stm run hide'>411</p>
<p class='stm run hide'>412</p>
<p class='stm run hide'>413</p>
<p class='stm run hide'>414</p>
<p class='pln'>415</p>
<p class='stm run hide'>416</p>
<p class='stm mis'>417</p>
<p class='pln'>418</p>
<p class='pln'>419</p>
<p class='stm run hide'>420</p>
<p class='pln'>421</p>
<p class='stm run hide'>422</p>
<p class='pln'>423</p>
<p class='stm run hide'>424</p>
<p class='stm run hide'>425</p>
<p class='stm run hide'>426</p>
<p class='stm run hide'>427</p>
<p class='pln'>428</p>
<p class='stm run hide'>429</p>
<p class='pln'>430</p>
<p class='stm mis'>431</p>
<p class='stm mis'>432</p>
<p class='pln'>433</p>
<p class='stm run hide'>434</p>
<p class='stm mis'>435</p>
<p class='pln'>436</p>
    
</td>
<td class='text' valign='top'>
<p class='pln'># -*- coding: utf-8 -*-</p>
<p class='stm run hide'>&quot;&quot;&quot;Django page CMS ``models``.&quot;&quot;&quot;</p>
<p class='stm run hide'>import mptt</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>from datetime import datetime</p>
<p class='stm run hide'>from django.db import models</p>
<p class='stm run hide'>from django.contrib.auth.models import User</p>
<p class='stm run hide'>from django.utils.translation import ugettext_lazy as _</p>
<p class='stm run hide'>from django.utils.safestring import mark_safe</p>
<p class='stm run hide'>from django.core.cache import cache</p>
<p class='stm run hide'>from django.core.urlresolvers import reverse</p>
<p class='stm run hide'>from django.contrib.sites.models import Site</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>from pages.utils import get_placeholders, normalize_url</p>
<p class='stm run hide'>from pages.managers import PageManager, ContentManager</p>
<p class='stm run hide'>from pages.managers import PagePermissionManager, PageAliasManager</p>
<p class='stm run hide'>from pages import settings</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class Page(models.Model):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; This model contain the status, dates, author, template.</p>
<p class='pln'>&nbsp; &nbsp; The real content of the page can be found in the</p>
<p class='pln'>&nbsp; &nbsp; :class:`Content &lt;pages.models.Content&gt;` model.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; .. attribute:: creation_date</p>
<p class='pln'>&nbsp; &nbsp; When the page has been created.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; .. attribute:: publication_date</p>
<p class='pln'>&nbsp; &nbsp; When the page should be visible.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; .. attribute:: publication_end_date</p>
<p class='pln'>&nbsp; &nbsp; When the publication of this page end.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; .. attribute:: last_modification_date</p>
<p class='pln'>&nbsp; &nbsp; Last time this page has been modified.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; .. attribute:: status</p>
<p class='pln'>&nbsp; &nbsp; The current status of the page. Could be DRAFT, PUBLISHED,</p>
<p class='pln'>&nbsp; &nbsp; EXPIRED or HIDDEN. You should the property :attr:`calculated_status` if</p>
<p class='pln'>&nbsp; &nbsp; you want that the dates are taken in account.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; .. attribute:: template</p>
<p class='pln'>&nbsp; &nbsp; A string containing the name of the template file for this page.</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; # some class constants to refer to, e.g. Page.DRAFT</p>
<p class='stm run hide'>&nbsp; &nbsp; DRAFT = 0</p>
<p class='stm run hide'>&nbsp; &nbsp; PUBLISHED = 1</p>
<p class='stm run hide'>&nbsp; &nbsp; EXPIRED = 2</p>
<p class='stm run hide'>&nbsp; &nbsp; HIDDEN = 3</p>
<p class='stm run hide'>&nbsp; &nbsp; STATUSES = (</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; (PUBLISHED, _(&#39;Published&#39;)),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; (HIDDEN, _(&#39;Hidden&#39;)),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; (DRAFT, _(&#39;Draft&#39;)),</p>
<p class='pln'>&nbsp; &nbsp; )</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; PAGE_LANGUAGES_KEY = &quot;page_%d_languages&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; PAGE_URL_KEY = &quot;page_%d_language_%s_url&quot;</p>
<p class='pln'>&nbsp; &nbsp; #PAGE_TEMPLATE_KEY = &quot;page_%d_template&quot;</p>
<p class='pln'>&nbsp; &nbsp; #PAGE_CHILDREN_KEY = &quot;page_children_%d_%d&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; PAGE_CONTENT_DICT_KEY = &quot;page_content_dict_%d_%s_%d&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; PAGE_BROKEN_LINK_KEY = &quot;page_broken_link_%s&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; author = models.ForeignKey(User, verbose_name=_(&#39;author&#39;))</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; parent = models.ForeignKey(&#39;self&#39;, null=True, blank=True,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; related_name=&#39;children&#39;, verbose_name=_(&#39;parent&#39;))</p>
<p class='stm run hide'>&nbsp; &nbsp; creation_date = models.DateTimeField(_(&#39;creation date&#39;), editable=False,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default=datetime.now)</p>
<p class='stm run hide'>&nbsp; &nbsp; publication_date = models.DateTimeField(_(&#39;publication date&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; null=True, blank=True, help_text=_(&#39;&#39;&#39;When the page should go</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; live. Status must be &quot;Published&quot; for page to go live.&#39;&#39;&#39;))</p>
<p class='stm run hide'>&nbsp; &nbsp; publication_end_date = models.DateTimeField(_(&#39;publication end date&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; null=True, blank=True, help_text=_(&#39;&#39;&#39;When to expire the page.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Leave empty to never expire.&#39;&#39;&#39;))</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; last_modification_date = models.DateTimeField(_(&#39;last modification date&#39;))</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; status = models.IntegerField(_(&#39;status&#39;), choices=STATUSES, default=DRAFT)</p>
<p class='stm run hide'>&nbsp; &nbsp; template = models.CharField(_(&#39;template&#39;), max_length=100, null=True,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blank=True)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; delegate_to = models.CharField(_(&#39;template&#39;), max_length=100, null=True,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blank=True)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; freeze_date = models.DateTimeField(_(&#39;freeze date&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; null=True, blank=True, help_text=_(&#39;&#39;&#39;Don&#39;t publish any content</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after this date.&#39;&#39;&#39;))</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; # Disable could make site tests fail</p>
<p class='stm run hide'>&nbsp; &nbsp; sites = models.ManyToManyField(Site, default=[settings.SITE_ID],</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; help_text=_(&#39;The site(s) the page is accessible at.&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; verbose_name=_(&#39;sites&#39;))</p>
<p class='stm run hide'>&nbsp; &nbsp; redirect_to_url = models.CharField(max_length=200, null=True, blank=True)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; redirect_to = models.ForeignKey(&#39;self&#39;, null=True, blank=True,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; related_name=&#39;redirected_pages&#39;)</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; # Managers</p>
<p class='stm run hide'>&nbsp; &nbsp; objects = PageManager()</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; if settings.PAGE_TAGGING:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; from tagging import fields</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; tags = fields.TagField(null=True)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; class Meta:</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Make sure the default page ordering is correct.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; ordering = [&#39;tree_id&#39;, &#39;lft&#39;]</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; verbose_name = _(&#39;page&#39;)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; verbose_name_plural = _(&#39;pages&#39;)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def save(self, *args, **kwargs):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Override the default ``save`` method.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if not self.status:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.status = self.DRAFT</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # Published pages should always have a publication date</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if self.publication_date is None and self.status == self.PUBLISHED:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.publication_date = datetime.now()</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # Drafts should not, unless they have been set to the future</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if self.status == self.DRAFT:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_SHOW_START_DATE:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (self.publication_date and</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.publication_date &lt;= datetime.now()):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.publication_date = None</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.publication_date = None</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; self.last_modification_date = datetime.now()</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # let&#39;s assume there is no more broken links after a save</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; cache.delete(self.PAGE_BROKEN_LINK_KEY % self.id)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; super(Page, self).save(*args, **kwargs)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def _get_calculated_status(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Get the calculated status of the page based on</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :attr:`Page.publication_date`,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :attr:`Page.publication_end_date`,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; and :attr:`Page.status`.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_SHOW_START_DATE and self.publication_date:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if self.publication_date &gt; datetime.now():</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return self.DRAFT</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_SHOW_END_DATE and self.publication_end_date:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if self.publication_end_date &lt; datetime.now():</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return self.EXPIRED</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return self.status</p>
<p class='stm run hide'>&nbsp; &nbsp; calculated_status = property(_get_calculated_status)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_children_for_frontend(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return a :class:`QuerySet` of published children page&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return Page.objects.filter_published(self.get_children())</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def invalidate(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Invalidate cached data for this page.&quot;&quot;&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; cache.delete(self.PAGE_LANGUAGES_KEY % (self.id))</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; #cache.delete(self.PAGE_TEMPLATE_KEY % (self.id))</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; p_names = [p.name for p in get_placeholders(self.get_template())]</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if &#39;slug&#39; not in p_names:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p_names.append(&#39;slug&#39;)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if &#39;title&#39; not in p_names:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p_names.append(&#39;title&#39;)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; #frozen = int(bool(self.freeze_date))</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # delete content cache, frozen or not</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; for name in p_names:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache.delete(self.PAGE_CONTENT_DICT_KEY %</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (self.id, name, 1))</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache.delete(self.PAGE_CONTENT_DICT_KEY %</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (self.id, name, 0))</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; for lang in settings.PAGE_LANGUAGES:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache.delete(self.PAGE_URL_KEY % (self.id, lang[0]))</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; cache.delete(self.PAGE_URL_KEY % (self.id, &quot;None&quot;))</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_languages(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Return a list of all used languages for this page.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; languages = cache.get(self.PAGE_LANGUAGES_KEY % (self.id))</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if languages:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return languages</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; languages = [c[&#39;language&#39;] for</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c in Content.objects.filter(page=self,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type=&quot;slug&quot;).values(&#39;language&#39;)]</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; languages = list(set(languages)) # remove duplicates</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; languages.sort()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; cache.set(self.PAGE_LANGUAGES_KEY % (self.id), languages)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return languages</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def is_first_root(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return ``True`` if the page is the first root page.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if self.parent:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return False</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return Page.objects.root()[0].id == self.id</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_url_path(self, language=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return the URL&#39;s path component. Add the language prefix if</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; ``PAGE_USE_LANGUAGE_PREFIX`` setting is set to ``True``.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param language: the wanted url language.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; url = reverse(&#39;pages-root&#39;)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_USE_LANGUAGE_PREFIX:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url += str(language) + &#39;/&#39;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return url + self.get_complete_slug(language)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_absolute_url(self, language=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Alias for `get_url_path`.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; This method is only there for backward compatibility and will be</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; removed in a near futur.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param language: the wanted url language.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return self.get_url_path(self, language=language)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_complete_slug(self, language=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return the complete slug of this page by concatenating</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; all parent&#39;s slugs.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param language: the wanted slug language.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; url = cache.get(self.PAGE_URL_KEY % (self.id, language))</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if url:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return url</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_HIDE_ROOT_SLUG and self.is_first_root():</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url = &#39;&#39;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url = u&#39;%s&#39; % self.slug(language)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; for ancestor in self.get_ancestors(ascending=True):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url = ancestor.slug(language) + u&#39;/&#39; + url</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; cache.set(self.PAGE_URL_KEY % (self.id, language), url)</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return url</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_url(self, language=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Alias for `get_complete_slug`.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; This method is only there for backward compatibility and will be</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; removed in a near futur.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param language: the wanted url language.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return self.get_complete_slug(self, language=language)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def slug(self, language=None, fallback=True):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Return the slug of the page depending on the given language.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param language: wanted language, if not defined default is used.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param fallback: if ``True``, the slug will also be searched in other \</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; languages.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; slug = Content.objects.get_content(self, language, &#39;slug&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; language_fallback=fallback)</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return slug</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def title(self, language=None, fallback=True):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Return the title of the page depending on the given language.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param language: wanted language, if not defined default is used.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param fallback: if ``True``, the slug will also be searched in other \</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; languages.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if not language:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; language = settings.PAGE_DEFAULT_LANGUAGE</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return Content.objects.get_content(self, language, &#39;title&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; language_fallback=fallback)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_template(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Get the :attr:`template &lt;Page.template&gt;` of this page if</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; defined or the closer parent&#39;s one if defined</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; or :attr:`pages.settings.DEFAULT_PAGE_TEMPLATE` otherwise.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if self.template:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return self.template</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; template = None</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; for p in self.get_ancestors(ascending=True):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if p.template:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; template = p.template</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if not template:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; template = settings.DEFAULT_PAGE_TEMPLATE</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return template</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_template_name(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Get the template name of this page if defined or if a closer</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; parent has a defined template or</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :data:`pages.settings.DEFAULT_PAGE_TEMPLATE` otherwise.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; template = self.get_template()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; page_templates = settings.get_page_templates()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; for t in page_templates:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if t[0] == template:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return t[1]</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return template</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def has_page_permission(self, request):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Return ``True`` if the current user has permission on the page.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Return the string &#39;All&#39; if the user has all rights.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if not settings.PAGE_PERMISSION:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return True</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; permission = PagePermission.objects.get_page_id_list(request.user)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if permission == &quot;All&quot;:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return True</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if self.id in permission:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return True</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return False</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def has_broken_link(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Return ``True`` if the page have broken links to other pages</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; into the content.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return cache.get(self.PAGE_BROKEN_LINK_KEY % self.id)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def valid_targets(self, perms=&quot;All&quot;):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return a :class:`QuerySet` of valid targets for moving a page</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; into the tree.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param perms: the level of permission of the concerned user.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; exclude_list = [self.id]</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; for p in self.get_descendants():</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exclude_list.append(p.id)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if perms != &quot;All&quot;:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return Page.objects.filter(id__in=perms).exclude(</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id__in=exclude_list)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return Page.objects.exclude(id__in=exclude_list)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def slug_with_level(self, language=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Display the slug of the page prepended with insecable</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; spaces equal to the level of page in the hierarchy.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; level = &#39;&#39;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if self.level:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for n in range(0, self.level):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level += &#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#39;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return mark_safe(level + self.slug(language))</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def margin_level(self):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return self.level * 2</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def __unicode__(self):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if self.id:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slug = self.slug()</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &quot;Page %s&quot; % self.id</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return slug</p>
<p class='pln'>&nbsp;</p>
<p class='pln'># Don&#39;t register the Page model twice.</p>
<p class='stm run hide'>try:</p>
<p class='stm run hide'>&nbsp; &nbsp; mptt.register(Page)</p>
<p class='stm mis'>except mptt.AlreadyRegistered:</p>
<p class='stm mis'>&nbsp; &nbsp; pass</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>if settings.PAGE_PERMISSION:</p>
<p class='stm run hide'>&nbsp; &nbsp; class PagePermission(models.Model):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :class:`Page &lt;pages.models.Page&gt;` permission object</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; TYPES = (</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (0, _(&#39;All&#39;)),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (1, _(&#39;This page only&#39;)),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (2, _(&#39;This page and all children&#39;)),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; )</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; page = models.ForeignKey(Page, null=True, blank=True,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; verbose_name=_(&#39;page&#39;))</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; user = models.ForeignKey(User, verbose_name=_(&#39;user&#39;))</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; type = models.IntegerField(_(&#39;type&#39;), choices=TYPES, default=0)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; objects = PagePermissionManager()</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; class Meta:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; verbose_name = _(&#39;page permission&#39;)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; verbose_name_plural = _(&#39;page permissions&#39;)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; def __unicode__(self):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &quot;%s :: %s&quot; % (self.user,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unicode(PagePermission.TYPES[self.type][1]))</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class Content(models.Model):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;A block of content, tied to a :class:`Page &lt;pages.models.Page&gt;`,</p>
<p class='pln'>&nbsp; &nbsp; for a particular language&quot;&quot;&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; # languages could have five characters : Brazilian Portuguese is pt-br</p>
<p class='stm run hide'>&nbsp; &nbsp; language = models.CharField(_(&#39;language&#39;), max_length=5, blank=False)</p>
<p class='stm run hide'>&nbsp; &nbsp; body = models.TextField(_(&#39;body&#39;))</p>
<p class='stm run hide'>&nbsp; &nbsp; type = models.CharField(_(&#39;type&#39;), max_length=100, blank=False)</p>
<p class='stm run hide'>&nbsp; &nbsp; page = models.ForeignKey(Page, verbose_name=_(&#39;page&#39;))</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; creation_date = models.DateTimeField(_(&#39;creation date&#39;), editable=False,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default=datetime.now)</p>
<p class='stm run hide'>&nbsp; &nbsp; objects = ContentManager()</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; class Meta:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; get_latest_by = &#39;creation_date&#39;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; verbose_name = _(&#39;content&#39;)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; verbose_name_plural = _(&#39;contents&#39;)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def __unicode__(self):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return &quot;%s :: %s&quot; % (self.page.slug(), self.body[0:15])</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class PageAlias(models.Model):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;URL alias for a :class:`Page &lt;pages.models.Page&gt;`&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; page = models.ForeignKey(Page, null=True, blank=True,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; verbose_name=_(&#39;page&#39;))</p>
<p class='stm run hide'>&nbsp; &nbsp; url = models.CharField(max_length=255, unique=True)</p>
<p class='stm run hide'>&nbsp; &nbsp; objects = PageAliasManager()</p>
<p class='stm run hide'>&nbsp; &nbsp; class Meta:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; verbose_name_plural = _(&#39;Aliases&#39;)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def save(self, *args, **kwargs):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # normalize url</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; self.url = normalize_url(self.url)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; super(PageAlias, self).save(*args, **kwargs)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def __unicode__(self):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return &quot;%s =&gt; %s&quot; % (self.url, self.page.get_complete_slug())</p>
<p class='pln'>&nbsp;</p>
    
</td>
</tr>
</table>
</div>

</body>
</html>
