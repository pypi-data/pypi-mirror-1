<!doctype html PUBLIC "-//W3C//DTD html 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>Coverage for pages.managers</title>
<link rel='stylesheet' href='style.css' type='text/css'>
<script src='jquery-1.3.2.min.js'></script>
<script>
function toggle_lines(btn, cls) {
    var btn = $(btn);
    if (btn.hasClass("hide")) {
        $("#source ."+cls).removeClass("hide");
        btn.removeClass("hide");
    }
    else {
        $("#source ."+cls).addClass("hide");
        btn.addClass("hide");
    }
}
</script>
</head>
<body>
<div id='header'>
    <div class='content'>
        <h1>Coverage for <b>pages.managers</b> :
            <span class='pc_cov'>25%</span>
        </h1>
        <h2 class='stats'>
            168 statements
            <span class='run hide' onclick='toggle_lines(this, "run")'>42 run</span>
            <span class='exc' onclick='toggle_lines(this, "exc")'>0 excluded</span>
            <span class='mis' onclick='toggle_lines(this, "mis")'>126 missing</span>
        </h2>
    </div>
</div>

<div id='source'>
<table cellspacing='0' cellpadding='0'>
<tr>
<td class='linenos' valign='top'>
<p class='pln'>1</p>
<p class='stm run hide'>2</p>
<p class='stm run hide'>3</p>
<p class='stm run hide'>4</p>
<p class='pln'>5</p>
<p class='stm run hide'>6</p>
<p class='stm run hide'>7</p>
<p class='stm run hide'>8</p>
<p class='stm run hide'>9</p>
<p class='stm run hide'>10</p>
<p class='pln'>11</p>
<p class='stm run hide'>12</p>
<p class='stm run hide'>13</p>
<p class='stm run hide'>14</p>
<p class='pln'>15</p>
<p class='stm run hide'>16</p>
<p class='pln'>17</p>
<p class='pln'>18</p>
<p class='pln'>19</p>
<p class='pln'>20</p>
<p class='pln'>21</p>
<p class='stm run hide'>22</p>
<p class='pln'>23</p>
<p class='stm mis'>24</p>
<p class='stm mis'>25</p>
<p class='stm mis'>26</p>
<p class='stm mis'>27</p>
<p class='stm mis'>28</p>
<p class='pln'>29</p>
<p class='stm mis'>30</p>
<p class='stm mis'>31</p>
<p class='pln'>32</p>
<p class='stm mis'>33</p>
<p class='pln'>34</p>
<p class='stm mis'>35</p>
<p class='stm mis'>36</p>
<p class='pln'>37</p>
<p class='stm run hide'>38</p>
<p class='pln'>39</p>
<p class='pln'>40</p>
<p class='pln'>41</p>
<p class='pln'>42</p>
<p class='pln'>43</p>
<p class='stm run hide'>44</p>
<p class='stm run hide'>45</p>
<p class='stm run hide'>46</p>
<p class='stm run hide'>47</p>
<p class='stm run hide'>48</p>
<p class='pln'>49</p>
<p class='stm run hide'>50</p>
<p class='pln'>51</p>
<p class='stm run hide'>52</p>
<p class='pln'>53</p>
<p class='stm run hide'>54</p>
<p class='pln'>55</p>
<p class='stm run hide'>56</p>
<p class='pln'>57</p>
<p class='pln'>58</p>
<p class='stm run hide'>59</p>
<p class='pln'>60</p>
<p class='stm mis'>61</p>
<p class='pln'>62</p>
<p class='stm run hide'>63</p>
<p class='pln'>64</p>
<p class='pln'>65</p>
<p class='stm mis'>66</p>
<p class='stm mis'>67</p>
<p class='pln'>68</p>
<p class='stm mis'>69</p>
<p class='pln'>70</p>
<p class='stm mis'>71</p>
<p class='stm mis'>72</p>
<p class='pln'>73</p>
<p class='stm mis'>74</p>
<p class='stm mis'>75</p>
<p class='pln'>76</p>
<p class='pln'>77</p>
<p class='pln'>78</p>
<p class='pln'>79</p>
<p class='stm mis'>80</p>
<p class='pln'>81</p>
<p class='stm run hide'>82</p>
<p class='pln'>83</p>
<p class='stm mis'>84</p>
<p class='pln'>85</p>
<p class='stm run hide'>86</p>
<p class='pln'>87</p>
<p class='pln'>88</p>
<p class='stm mis'>89</p>
<p class='stm mis'>90</p>
<p class='stm mis'>91</p>
<p class='stm mis'>92</p>
<p class='pln'>93</p>
<p class='stm run hide'>94</p>
<p class='pln'>95</p>
<p class='pln'>96</p>
<p class='stm mis'>97</p>
<p class='pln'>98</p>
<p class='pln'>99</p>
<p class='stm run hide'>100</p>
<p class='pln'>101</p>
<p class='pln'>102</p>
<p class='stm mis'>103</p>
<p class='stm mis'>104</p>
<p class='stm mis'>105</p>
<p class='stm mis'>106</p>
<p class='stm mis'>107</p>
<p class='stm mis'>108</p>
<p class='stm mis'>109</p>
<p class='stm mis'>110</p>
<p class='stm mis'>111</p>
<p class='pln'>112</p>
<p class='stm mis'>113</p>
<p class='stm mis'>114</p>
<p class='stm mis'>115</p>
<p class='stm mis'>116</p>
<p class='stm mis'>117</p>
<p class='pln'>118</p>
<p class='stm run hide'>119</p>
<p class='pln'>120</p>
<p class='pln'>121</p>
<p class='stm run hide'>122</p>
<p class='pln'>123</p>
<p class='pln'>124</p>
<p class='stm mis'>125</p>
<p class='stm mis'>126</p>
<p class='stm mis'>127</p>
<p class='pln'>128</p>
<p class='pln'>129</p>
<p class='stm mis'>130</p>
<p class='pln'>131</p>
<p class='stm run hide'>132</p>
<p class='pln'>133</p>
<p class='pln'>134</p>
<p class='pln'>135</p>
<p class='pln'>136</p>
<p class='pln'>137</p>
<p class='pln'>138</p>
<p class='pln'>139</p>
<p class='pln'>140</p>
<p class='stm mis'>141</p>
<p class='stm mis'>142</p>
<p class='stm mis'>143</p>
<p class='stm mis'>144</p>
<p class='pln'>145</p>
<p class='stm mis'>146</p>
<p class='stm mis'>147</p>
<p class='stm mis'>148</p>
<p class='pln'>149</p>
<p class='stm mis'>150</p>
<p class='stm mis'>151</p>
<p class='pln'>152</p>
<p class='stm run hide'>153</p>
<p class='pln'>154</p>
<p class='pln'>155</p>
<p class='pln'>156</p>
<p class='pln'>157</p>
<p class='pln'>158</p>
<p class='pln'>159</p>
<p class='pln'>160</p>
<p class='pln'>161</p>
<p class='pln'>162</p>
<p class='stm mis'>163</p>
<p class='stm mis'>164</p>
<p class='stm mis'>165</p>
<p class='stm mis'>166</p>
<p class='pln'>167</p>
<p class='stm mis'>168</p>
<p class='stm mis'>169</p>
<p class='stm mis'>170</p>
<p class='stm mis'>171</p>
<p class='stm mis'>172</p>
<p class='pln'>173</p>
<p class='pln'>174</p>
<p class='stm run hide'>175</p>
<p class='pln'>176</p>
<p class='pln'>177</p>
<p class='pln'>178</p>
<p class='pln'>179</p>
<p class='pln'>180</p>
<p class='pln'>181</p>
<p class='pln'>182</p>
<p class='pln'>183</p>
<p class='pln'>184</p>
<p class='stm mis'>185</p>
<p class='stm mis'>186</p>
<p class='stm mis'>187</p>
<p class='pln'>188</p>
<p class='stm mis'>189</p>
<p class='stm mis'>190</p>
<p class='pln'>191</p>
<p class='pln'>192</p>
<p class='stm mis'>193</p>
<p class='stm mis'>194</p>
<p class='stm mis'>195</p>
<p class='stm mis'>196</p>
<p class='pln'>197</p>
<p class='pln'>198</p>
<p class='pln'>199</p>
<p class='pln'>200</p>
<p class='stm mis'>201</p>
<p class='stm mis'>202</p>
<p class='stm mis'>203</p>
<p class='stm mis'>204</p>
<p class='stm mis'>205</p>
<p class='stm mis'>206</p>
<p class='stm mis'>207</p>
<p class='stm mis'>208</p>
<p class='stm mis'>209</p>
<p class='pln'>210</p>
<p class='pln'>211</p>
<p class='stm mis'>212</p>
<p class='stm mis'>213</p>
<p class='pln'>214</p>
<p class='stm mis'>215</p>
<p class='stm mis'>216</p>
<p class='stm mis'>217</p>
<p class='stm mis'>218</p>
<p class='pln'>219</p>
<p class='stm mis'>220</p>
<p class='pln'>221</p>
<p class='stm run hide'>222</p>
<p class='pln'>223</p>
<p class='pln'>224</p>
<p class='pln'>225</p>
<p class='pln'>226</p>
<p class='pln'>227</p>
<p class='stm mis'>228</p>
<p class='stm mis'>229</p>
<p class='stm mis'>230</p>
<p class='stm mis'>231</p>
<p class='stm mis'>232</p>
<p class='stm mis'>233</p>
<p class='stm mis'>234</p>
<p class='pln'>235</p>
<p class='stm mis'>236</p>
<p class='pln'>237</p>
<p class='stm run hide'>238</p>
<p class='pln'>239</p>
<p class='pln'>240</p>
<p class='pln'>241</p>
<p class='pln'>242</p>
<p class='stm mis'>243</p>
<p class='pln'>244</p>
<p class='pln'>245</p>
<p class='pln'>246</p>
<p class='pln'>247</p>
<p class='pln'>248</p>
<p class='stm mis'>249</p>
<p class='stm mis'>250</p>
<p class='stm mis'>251</p>
<p class='pln'>252</p>
<p class='stm run hide'>253</p>
<p class='pln'>254</p>
<p class='pln'>255</p>
<p class='stm run hide'>256</p>
<p class='pln'>257</p>
<p class='pln'>258</p>
<p class='pln'>259</p>
<p class='pln'>260</p>
<p class='pln'>261</p>
<p class='pln'>262</p>
<p class='stm run hide'>263</p>
<p class='stm run hide'>264</p>
<p class='stm mis'>265</p>
<p class='stm mis'>266</p>
<p class='stm mis'>267</p>
<p class='stm mis'>268</p>
<p class='stm mis'>269</p>
<p class='stm mis'>270</p>
<p class='stm mis'>271</p>
<p class='stm mis'>272</p>
<p class='stm mis'>273</p>
<p class='stm mis'>274</p>
<p class='stm mis'>275</p>
<p class='pln'>276</p>
<p class='stm run hide'>277</p>
<p class='pln'>278</p>
<p class='pln'>279</p>
<p class='stm run hide'>280</p>
<p class='pln'>281</p>
<p class='pln'>282</p>
<p class='pln'>283</p>
<p class='pln'>284</p>
<p class='pln'>285</p>
<p class='pln'>286</p>
<p class='pln'>287</p>
<p class='pln'>288</p>
<p class='pln'>289</p>
<p class='pln'>290</p>
<p class='pln'>291</p>
<p class='stm mis'>292</p>
<p class='pln'>293</p>
<p class='stm mis'>294</p>
<p class='pln'>295</p>
<p class='stm mis'>296</p>
<p class='stm mis'>297</p>
<p class='stm mis'>298</p>
<p class='stm mis'>299</p>
<p class='stm mis'>300</p>
<p class='stm mis'>301</p>
<p class='stm mis'>302</p>
<p class='stm mis'>303</p>
<p class='pln'>304</p>
<p class='stm mis'>305</p>
<p class='stm mis'>306</p>
<p class='stm mis'>307</p>
<p class='stm mis'>308</p>
<p class='stm mis'>309</p>
<p class='stm mis'>310</p>
<p class='pln'>311</p>
<p class='stm mis'>312</p>
    
</td>
<td class='text' valign='top'>
<p class='pln'># -*- coding: utf-8 -*-</p>
<p class='stm run hide'>&quot;&quot;&quot;Django page CMS ``managers``.&quot;&quot;&quot;</p>
<p class='stm run hide'>import itertools, re</p>
<p class='stm run hide'>from datetime import datetime</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>from django.db import models, connection</p>
<p class='stm run hide'>from django.contrib.sites.models import Site</p>
<p class='stm run hide'>from django.db.models import Q</p>
<p class='stm run hide'>from django.core.cache import cache</p>
<p class='stm run hide'>from django.contrib.auth.models import User</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>from pages import settings</p>
<p class='stm run hide'>from pages.utils import normalize_url, filter_link</p>
<p class='stm run hide'>from pages.http import get_slug_and_relative_path</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class PageManager(models.Manager):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; Page manager provide several filters to obtain pages :class:`QuerySet`</p>
<p class='pln'>&nbsp; &nbsp; that respect the page settings.</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def populate_pages(self, parent=None, child=5, depth=5):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Create a population of pages for testing purpose.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; from pages.models import Content</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; author = User.objects.all()[0]</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if depth==0:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; p = self.model(parent=parent, author=author,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status=self.model.PUBLISHED)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; p.save()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; Content(body=&#39;page-&#39;+str(p.id), type=&#39;title&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; language=&#39;en-us&#39;, page=p).save()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; Content(body=&#39;page-&#39;+str(p.id), type=&#39;slug&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; language=&#39;en-us&#39;, page=p).save()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; for child in range(1, child):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.populate_pages(parent=p, child=child, depth=(depth-1))</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def on_site(self, site_id=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return a :class:`QuerySet` of pages that are published on the site</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; defined by the ``SITE_ID`` setting.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param site_id: specify the id of the site object to filter with.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_USE_SITE_ID:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if not site_id:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; site_id = settings.SITE_ID</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return self.filter(sites=site_id)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return self</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def root(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return a :class:`QuerySet` of pages without parent.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return self.filter(parent__isnull=True)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def navigation(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Creates a :class:`QuerySet` of the published root pages.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return self.on_site().filter(</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status=self.model.PUBLISHED).filter(parent__isnull=True)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def hidden(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Creates a :class:`QuerySet` of the hidden pages.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return self.on_site().filter(status=self.model.HIDDEN)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def filter_published(self, queryset):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Filter the given pages :class:`QuerySet` to obtain only published</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; page.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_USE_SITE_ID:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; queryset = queryset.filter(sites=settings.SITE_ID)</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; queryset = queryset.filter(status=self.model.PUBLISHED)</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_SHOW_START_DATE:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; queryset = queryset.filter(publication_date__lte=datetime.now())</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_SHOW_END_DATE:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; queryset = queryset.filter(</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Q(publication_end_date__gt=datetime.now()) |</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Q(publication_end_date__isnull=True)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return queryset</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def published(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Creates a :class:`QuerySet` of published filter.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return self.filter_published(self)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def drafts(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Creates a :class:`QuerySet` of drafts using the page&#39;s</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :attr:`Page.publication_date`.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; pub = self.on_site().filter(status=self.model.DRAFT)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_SHOW_START_DATE:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pub = pub.filter(publication_date__gte=datetime.now())</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return pub</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def expired(self):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Creates a :class:`QuerySet` of expired using the page&#39;s</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :attr:`Page.publication_end_date`.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return self.on_site().filter(</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; publication_end_date__lte=datetime.now())</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def from_path(self, complete_path, lang, exclude_drafts=True):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return a :class:`Page &lt;pages.models.Page&gt;` according to</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; the page&#39;s path.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; from pages.models import Content, Page</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; slug, path, lang = get_slug_and_relative_path(complete_path, lang)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; page_ids = Content.objects.get_page_ids_by_slug(slug)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; pages_list = self.on_site().filter(id__in=page_ids)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if exclude_drafts:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pages_list = pages_list.exclude(status=Page.DRAFT)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; current_page = None</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if len(pages_list) == 1:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return pages_list[0]</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # more than one page matching the slug, let&#39;s use the full url</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if len(pages_list) &gt; 1:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for page in pages_list:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if page.get_complete_slug(lang) == complete_path:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return page</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return None</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class ContentManager(models.Manager):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;:class:`Content &lt;pages.models.Content&gt;` manager methods&quot;&quot;&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def sanitize(self, content):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Sanitize a string in order to avoid possible XSS using</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; ``html5lib``.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; import html5lib</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; from html5lib import sanitizer</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; p = html5lib.HTMLParser(tokenizer=sanitizer.HTMLSanitizer)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # TODO: that&#39;s a bit of a hack there</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # we need to remove &lt;html&gt;&lt;head/&gt;&lt;body&gt;...&lt;/body&gt;&lt;/html&gt;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return p.parse(content).toxml()[19:-14]</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def set_or_create_content(self, page, language, ctype, body):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Set or create a :class:`Content &lt;pages.models.Content&gt;` for a</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; particular page and language.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param page: the concerned page object.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param language: the wanted language.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param ctype: the content type.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param body: the content of the Content object.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_SANITIZE_USER_INPUT:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; body = self.sanitize(body)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content = self.filter(page=page, language=language,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type=ctype).latest(&#39;creation_date&#39;)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content.body = body</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; except self.model.DoesNotExist:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content = self.model(page=page, language=language, body=body,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type=ctype)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; content.save()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return content</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def create_content_if_changed(self, page, language, ctype, body):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Create a :class:`Content &lt;pages.models.Content&gt;` for a particular</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; page and language only if the content has changed from the last</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; time.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param page: the concerned page object.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param language: the wanted language.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param ctype: the content type.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param body: the content of the Content object.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_SANITIZE_USER_INPUT:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; body = self.sanitize(body)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content = self.filter(page=page, language=language,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type=ctype).latest(&#39;creation_date&#39;)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if content.body == body:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return content</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; except self.model.DoesNotExist:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; content = self.create(page=page, language=language, body=body,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type=ctype)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_content(self, page, language, ctype, language_fallback=False):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Gets the latest :class:`Content &lt;pages.models.Content&gt;`</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; for a particular page and language. Falls back to another</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; language if wanted.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param page: the concerned page object.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param language: the wanted language.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param ctype: the content type.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param language_fallback: fallback to another language if ``True``.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; PAGE_CONTENT_DICT_KEY = &quot;page_content_dict_%d_%s_%d&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if not language:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; language = settings.PAGE_DEFAULT_LANGUAGE</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; frozen = int(bool(page.freeze_date))</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; content_dict = cache.get(PAGE_CONTENT_DICT_KEY % (page.id, ctype, frozen))</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # fill a dict object for each language</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if not content_dict:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content_dict = {}</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for lang in settings.PAGE_LANGUAGES:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; params = {</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;language&#39;:lang[0],</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;type&#39;:ctype,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;page&#39;:page</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if page.freeze_date:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; params[&#39;creation_date__lte&#39;] = page.freeze_date</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; language=lang[0]</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content = self.filter(**params).latest()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content_dict[language] = content.body</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; except self.model.DoesNotExist:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content_dict[language] = &#39;&#39;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache.set(PAGE_CONTENT_DICT_KEY % (page.id, ctype, frozen),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content_dict)</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if language in content_dict and content_dict[language]:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return filter_link(content_dict[language], page, language, ctype)</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if language_fallback:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for lang in settings.PAGE_LANGUAGES:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if lang[0] in content_dict and content_dict[lang[0]]:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return filter_link(content_dict[lang[0]], page, lang[0],</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctype)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return &#39;&#39;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_content_slug_by_slug(self, slug):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Returns the latest :class:`Content &lt;pages.models.Content&gt;`</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; slug object that match the given slug for the current site domain.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param slug: the wanted slug.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; content = self.filter(type=&#39;slug&#39;, body=slug)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_USE_SITE_ID:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content = content.filter(page__sites__id=settings.SITE_ID)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; content = content.latest(&#39;creation_date&#39;)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; except self.model.DoesNotExist:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return None</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return content</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_page_ids_by_slug(self, slug):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return all page&#39;s id matching the given slug.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param slug: the wanted slug.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; sql = &#39;&#39;&#39;SELECT pages_content.page_id,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MAX(pages_content.creation_date)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM pages_content WHERE (pages_content.type = %s</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AND pages_content.body =%s)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GROUP BY pages_content.page_id&#39;&#39;&#39;</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; cursor = connection.cursor()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; cursor.execute(sql, (&#39;slug&#39;, slug, ))</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return [c[0] for c in cursor.fetchall()]</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class PagePermissionManager(models.Manager):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;Hierachic page permission manager.&quot;&quot;&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_page_id_list(self, user):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Give a list of :class:`Page &lt;pages.models.Page&gt;` ids where the</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; user has rights or the string</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;All&quot; if the user has all rights.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param user: the interested user.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if user.is_superuser:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;All&#39;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; id_list = []</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; for perm in self.filter(user=user):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if perm.type == 0:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &quot;All&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if perm.page.id not in id_list:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id_list.append(perm.page.id)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if perm.type == 2:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for page in perm.page.get_descendants():</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if page.id not in id_list:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id_list.append(page.id)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return id_list</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class PageAliasManager(models.Manager):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;:class:`PageAlias &lt;pages.models.PageAlias&gt;` manager.&quot;&quot;&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def from_path(self, request, path, lang):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Resolve a request to an alias. returns a</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :class:`PageAlias &lt;pages.models.PageAlias&gt;` if the url matches</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; no page at all. The aliasing system supports plain</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; aliases (``/foo/bar``) as well as aliases containing GET parameters</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; (like ``index.php?page=foo``).</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param request: the request object</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param path: the complete path to the page</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :param lang: not used</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; from pages.models import PageAlias</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; url = normalize_url(path)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # ยง1: try with complete query string</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; query = request.META.get(&#39;QUERY_STRING&#39;)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if query:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url = url + &#39;?&#39; + query</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; alias = PageAlias.objects.get(url=url)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return alias</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; except PageAlias.DoesNotExist:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # ยง2: try with path only</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; url = normalize_url(path)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; alias = PageAlias.objects.get(url=url)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return alias</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; except PageAlias.DoesNotExist:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # ยง3: not alias found, we give up</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return None</p>
    
</td>
</tr>
</table>
</div>

</body>
</html>
