<!doctype html PUBLIC "-//W3C//DTD html 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>Coverage for pages.admin.__init__</title>
<link rel='stylesheet' href='style.css' type='text/css'>
<script src='jquery-1.3.2.min.js'></script>
<script>
function toggle_lines(btn, cls) {
    var btn = $(btn);
    if (btn.hasClass("hide")) {
        $("#source ."+cls).removeClass("hide");
        btn.removeClass("hide");
    }
    else {
        $("#source ."+cls).addClass("hide");
        btn.addClass("hide");
    }
}
</script>
</head>
<body>
<div id='header'>
    <div class='content'>
        <h1>Coverage for <b>pages.admin.__init__</b> :
            <span class='pc_cov'>65%</span>
        </h1>
        <h2 class='stats'>
            201 statements
            <span class='run hide' onclick='toggle_lines(this, "run")'>131 run</span>
            <span class='exc' onclick='toggle_lines(this, "exc")'>0 excluded</span>
            <span class='mis' onclick='toggle_lines(this, "mis")'>70 missing</span>
        </h2>
    </div>
</div>

<div id='source'>
<table cellspacing='0' cellpadding='0'>
<tr>
<td class='linenos' valign='top'>
<p class='pln'>1</p>
<p class='stm run hide'>2</p>
<p class='stm run hide'>3</p>
<p class='pln'>4</p>
<p class='stm run hide'>5</p>
<p class='stm run hide'>6</p>
<p class='stm run hide'>7</p>
<p class='stm run hide'>8</p>
<p class='stm run hide'>9</p>
<p class='stm run hide'>10</p>
<p class='stm run hide'>11</p>
<p class='pln'>12</p>
<p class='stm run hide'>13</p>
<p class='stm run hide'>14</p>
<p class='stm run hide'>15</p>
<p class='pln'>16</p>
<p class='stm run hide'>17</p>
<p class='stm run hide'>18</p>
<p class='stm run hide'>19</p>
<p class='stm run hide'>20</p>
<p class='stm run hide'>21</p>
<p class='stm run hide'>22</p>
<p class='stm run hide'>23</p>
<p class='stm run hide'>24</p>
<p class='pln'>25</p>
<p class='stm run hide'>26</p>
<p class='pln'>27</p>
<p class='pln'>28</p>
<p class='stm run hide'>29</p>
<p class='stm run hide'>30</p>
<p class='pln'>31</p>
<p class='stm run hide'>32</p>
<p class='stm run hide'>33</p>
<p class='pln'>34</p>
<p class='pln'>35</p>
<p class='pln'>36</p>
<p class='stm run hide'>37</p>
<p class='stm run hide'>38</p>
<p class='pln'>39</p>
<p class='pln'>40</p>
<p class='pln'>41</p>
<p class='stm run hide'>42</p>
<p class='pln'>43</p>
<p class='stm run hide'>44</p>
<p class='stm run hide'>45</p>
<p class='pln'>46</p>
<p class='pln'>47</p>
<p class='stm run hide'>48</p>
<p class='stm mis'>49</p>
<p class='stm run hide'>50</p>
<p class='stm mis'>51</p>
<p class='pln'>52</p>
<p class='stm run hide'>53</p>
<p class='stm run hide'>54</p>
<p class='stm run hide'>55</p>
<p class='stm run hide'>56</p>
<p class='pln'>57</p>
<p class='stm run hide'>58</p>
<p class='stm run hide'>59</p>
<p class='stm run hide'>60</p>
<p class='stm run hide'>61</p>
<p class='stm run hide'>62</p>
<p class='stm run hide'>63</p>
<p class='stm run hide'>64</p>
<p class='pln'>65</p>
<p class='pln'>66</p>
<p class='pln'>67</p>
<p class='pln'>68</p>
<p class='pln'>69</p>
<p class='pln'>70</p>
<p class='pln'>71</p>
<p class='pln'>72</p>
<p class='pln'>73</p>
<p class='pln'>74</p>
<p class='stm run hide'>75</p>
<p class='stm run hide'>76</p>
<p class='pln'>77</p>
<p class='pln'>78</p>
<p class='pln'>79</p>
<p class='pln'>80</p>
<p class='pln'>81</p>
<p class='stm run hide'>82</p>
<p class='pln'>83</p>
<p class='pln'>84</p>
<p class='pln'>85</p>
<p class='pln'>86</p>
<p class='pln'>87</p>
<p class='pln'>88</p>
<p class='pln'>89</p>
<p class='stm run hide'>90</p>
<p class='stm run hide'>91</p>
<p class='pln'>92</p>
<p class='pln'>93</p>
<p class='stm run hide'>94</p>
<p class='pln'>95</p>
<p class='pln'>96</p>
<p class='pln'>97</p>
<p class='pln'>98</p>
<p class='pln'>99</p>
<p class='pln'>100</p>
<p class='pln'>101</p>
<p class='pln'>102</p>
<p class='pln'>103</p>
<p class='pln'>104</p>
<p class='pln'>105</p>
<p class='pln'>106</p>
<p class='pln'>107</p>
<p class='pln'>108</p>
<p class='pln'>109</p>
<p class='pln'>110</p>
<p class='stm run hide'>111</p>
<p class='pln'>112</p>
<p class='stm run hide'>113</p>
<p class='pln'>114</p>
<p class='stm run hide'>115</p>
<p class='pln'>116</p>
<p class='stm run hide'>117</p>
<p class='pln'>118</p>
<p class='pln'>119</p>
<p class='pln'>120</p>
<p class='pln'>121</p>
<p class='pln'>122</p>
<p class='pln'>123</p>
<p class='stm mis'>124</p>
<p class='stm mis'>125</p>
<p class='pln'>126</p>
<p class='stm mis'>127</p>
<p class='stm mis'>128</p>
<p class='pln'>129</p>
<p class='stm run hide'>130</p>
<p class='pln'>131</p>
<p class='pln'>132</p>
<p class='pln'>133</p>
<p class='pln'>134</p>
<p class='stm mis'>135</p>
<p class='stm mis'>136</p>
<p class='stm mis'>137</p>
<p class='stm mis'>138</p>
<p class='pln'>139</p>
<p class='pln'>140</p>
<p class='stm mis'>141</p>
<p class='stm mis'>142</p>
<p class='stm mis'>143</p>
<p class='stm mis'>144</p>
<p class='stm mis'>145</p>
<p class='pln'>146</p>
<p class='stm mis'>147</p>
<p class='stm mis'>148</p>
<p class='pln'>149</p>
<p class='stm mis'>150</p>
<p class='stm mis'>151</p>
<p class='stm mis'>152</p>
<p class='stm mis'>153</p>
<p class='pln'>154</p>
<p class='stm mis'>155</p>
<p class='stm mis'>156</p>
<p class='pln'>157</p>
<p class='stm mis'>158</p>
<p class='stm mis'>159</p>
<p class='pln'>160</p>
<p class='stm mis'>161</p>
<p class='pln'>162</p>
<p class='stm run hide'>163</p>
<p class='pln'>164</p>
<p class='pln'>165</p>
<p class='pln'>166</p>
<p class='pln'>167</p>
<p class='stm run hide'>168</p>
<p class='pln'>169</p>
<p class='stm run hide'>170</p>
<p class='stm run hide'>171</p>
<p class='stm run hide'>172</p>
<p class='stm run hide'>173</p>
<p class='stm run hide'>174</p>
<p class='pln'>175</p>
<p class='stm run hide'>176</p>
<p class='pln'>177</p>
<p class='pln'>178</p>
<p class='pln'>179</p>
<p class='pln'>180</p>
<p class='pln'>181</p>
<p class='pln'>182</p>
<p class='stm run hide'>183</p>
<p class='pln'>184</p>
<p class='stm run hide'>185</p>
<p class='pln'>186</p>
<p class='stm run hide'>187</p>
<p class='pln'>188</p>
<p class='pln'>189</p>
<p class='stm mis'>190</p>
<p class='stm mis'>191</p>
<p class='stm mis'>192</p>
<p class='stm mis'>193</p>
<p class='stm mis'>194</p>
<p class='pln'>195</p>
<p class='stm run hide'>196</p>
<p class='pln'>197</p>
<p class='pln'>198</p>
<p class='pln'>199</p>
<p class='stm run hide'>200</p>
<p class='pln'>201</p>
<p class='stm run hide'>202</p>
<p class='stm run hide'>203</p>
<p class='stm run hide'>204</p>
<p class='stm mis'>205</p>
<p class='stm mis'>206</p>
<p class='stm mis'>207</p>
<p class='stm mis'>208</p>
<p class='stm mis'>209</p>
<p class='pln'>210</p>
<p class='stm run hide'>211</p>
<p class='stm run hide'>212</p>
<p class='stm run hide'>213</p>
<p class='stm run hide'>214</p>
<p class='stm run hide'>215</p>
<p class='pln'>216</p>
<p class='stm run hide'>217</p>
<p class='stm run hide'>218</p>
<p class='pln'>219</p>
<p class='stm run hide'>220</p>
<p class='stm run hide'>221</p>
<p class='stm run hide'>222</p>
<p class='stm mis'>223</p>
<p class='pln'>224</p>
<p class='stm run hide'>225</p>
<p class='stm run hide'>226</p>
<p class='pln'>227</p>
<p class='stm run hide'>228</p>
<p class='pln'>229</p>
<p class='stm run hide'>230</p>
<p class='pln'>231</p>
<p class='pln'>232</p>
<p class='stm mis'>233</p>
<p class='stm mis'>234</p>
<p class='pln'>235</p>
<p class='pln'>236</p>
<p class='pln'>237</p>
<p class='pln'>238</p>
<p class='pln'>239</p>
<p class='stm mis'>240</p>
<p class='stm mis'>241</p>
<p class='stm mis'>242</p>
<p class='pln'>243</p>
<p class='pln'>244</p>
<p class='pln'>245</p>
<p class='stm mis'>246</p>
<p class='pln'>247</p>
<p class='stm mis'>248</p>
<p class='stm mis'>249</p>
<p class='stm mis'>250</p>
<p class='pln'>251</p>
<p class='pln'>252</p>
<p class='stm mis'>253</p>
<p class='stm mis'>254</p>
<p class='pln'>255</p>
<p class='pln'>256</p>
<p class='stm run hide'>257</p>
<p class='pln'>258</p>
<p class='stm run hide'>259</p>
<p class='pln'>260</p>
<p class='pln'>261</p>
<p class='pln'>262</p>
<p class='stm run hide'>263</p>
<p class='pln'>264</p>
<p class='stm run hide'>265</p>
<p class='pln'>266</p>
<p class='pln'>267</p>
<p class='stm run hide'>268</p>
<p class='pln'>269</p>
<p class='pln'>270</p>
<p class='stm run hide'>271</p>
<p class='stm mis'>272</p>
<p class='pln'>273</p>
<p class='stm run hide'>274</p>
<p class='pln'>275</p>
<p class='stm run hide'>276</p>
<p class='pln'>277</p>
<p class='pln'>278</p>
<p class='stm run hide'>279</p>
<p class='stm mis'>280</p>
<p class='stm run hide'>281</p>
<p class='pln'>282</p>
<p class='stm run hide'>283</p>
<p class='pln'>284</p>
<p class='pln'>285</p>
<p class='pln'>286</p>
<p class='stm run hide'>287</p>
<p class='stm mis'>288</p>
<p class='stm run hide'>289</p>
<p class='pln'>290</p>
<p class='stm run hide'>291</p>
<p class='pln'>292</p>
<p class='stm run hide'>293</p>
<p class='stm mis'>294</p>
<p class='pln'>295</p>
<p class='stm run hide'>296</p>
<p class='stm mis'>297</p>
<p class='stm run hide'>298</p>
<p class='pln'>299</p>
<p class='stm run hide'>300</p>
<p class='pln'>301</p>
<p class='stm run hide'>302</p>
<p class='stm mis'>303</p>
<p class='stm mis'>304</p>
<p class='pln'>305</p>
<p class='stm run hide'>306</p>
<p class='pln'>307</p>
<p class='stm run hide'>308</p>
<p class='pln'>309</p>
<p class='pln'>310</p>
<p class='pln'>311</p>
<p class='pln'>312</p>
<p class='pln'>313</p>
<p class='pln'>314</p>
<p class='pln'>315</p>
<p class='stm run hide'>316</p>
<p class='stm run hide'>317</p>
<p class='pln'>318</p>
<p class='stm mis'>319</p>
<p class='stm mis'>320</p>
<p class='pln'>321</p>
<p class='stm run hide'>322</p>
<p class='pln'>323</p>
<p class='pln'>324</p>
<p class='stm mis'>325</p>
<p class='pln'>326</p>
<p class='stm mis'>327</p>
<p class='stm mis'>328</p>
<p class='stm mis'>329</p>
<p class='stm mis'>330</p>
<p class='stm mis'>331</p>
<p class='stm mis'>332</p>
<p class='stm mis'>333</p>
<p class='pln'>334</p>
<p class='pln'>335</p>
<p class='pln'>336</p>
<p class='pln'>337</p>
<p class='stm mis'>338</p>
<p class='stm mis'>339</p>
<p class='stm mis'>340</p>
<p class='stm mis'>341</p>
<p class='pln'>342</p>
<p class='stm mis'>343</p>
<p class='pln'>344</p>
<p class='stm run hide'>345</p>
<p class='stm run hide'>346</p>
<p class='pln'>347</p>
<p class='stm run hide'>348</p>
<p class='stm run hide'>349</p>
<p class='stm run hide'>350</p>
<p class='stm run hide'>351</p>
<p class='pln'>352</p>
<p class='stm run hide'>353</p>
<p class='stm run hide'>354</p>
<p class='stm run hide'>355</p>
<p class='stm run hide'>356</p>
<p class='pln'>357</p>
<p class='pln'>358</p>
<p class='pln'>359</p>
<p class='stm run hide'>360</p>
<p class='stm run hide'>361</p>
<p class='stm run hide'>362</p>
<p class='stm run hide'>363</p>
<p class='stm run hide'>364</p>
<p class='stm run hide'>365</p>
<p class='pln'>366</p>
<p class='stm run hide'>367</p>
<p class='stm run hide'>368</p>
<p class='stm run hide'>369</p>
<p class='pln'>370</p>
<p class='stm run hide'>371</p>
<p class='stm run hide'>372</p>
<p class='stm run hide'>373</p>
<p class='stm run hide'>374</p>
<p class='pln'>375</p>
    
</td>
<td class='text' valign='top'>
<p class='pln'># -*- coding: utf-8 -*-</p>
<p class='stm run hide'>&quot;&quot;&quot;Page Admin module.&quot;&quot;&quot;</p>
<p class='stm run hide'>from os.path import join</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>from django.contrib import admin</p>
<p class='stm run hide'>from django.utils.translation import ugettext as _, ugettext_lazy</p>
<p class='stm run hide'>from django.utils.encoding import force_unicode</p>
<p class='stm run hide'>from django.conf import settings as global_settings</p>
<p class='stm run hide'>from django.http import HttpResponseRedirect</p>
<p class='stm run hide'>from django.contrib.admin.util import unquote</p>
<p class='stm run hide'>from django.contrib.admin.sites import AlreadyRegistered</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>from pages import settings</p>
<p class='stm run hide'>from pages.models import Page, Content, PageAlias</p>
<p class='stm run hide'>from pages.http import get_language_from_request, get_template_from_request</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>from pages.utils import get_placeholders</p>
<p class='stm run hide'>from pages.utils import has_page_add_permission, get_language_from_request</p>
<p class='stm run hide'>from pages.templatetags.pages_tags import PlaceholderNode</p>
<p class='stm run hide'>from pages.admin.utils import get_connected, make_inline_admin</p>
<p class='stm run hide'>from pages.admin.forms import PageForm</p>
<p class='stm run hide'>from pages.admin.views import traduction, get_content, sub_menu</p>
<p class='stm run hide'>from pages.admin.views import change_status, modify_content, delete_content</p>
<p class='stm run hide'>import pages.widgets</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class PageAdmin(admin.ModelAdmin):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;Page Admin class.&quot;&quot;&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; form = PageForm</p>
<p class='stm run hide'>&nbsp; &nbsp; exclude = [&#39;author&#39;, &#39;parent&#39;]</p>
<p class='pln'>&nbsp; &nbsp; # these mandatory fields are not versioned</p>
<p class='stm run hide'>&nbsp; &nbsp; mandatory_placeholders = (&#39;title&#39;, &#39;slug&#39;)</p>
<p class='stm run hide'>&nbsp; &nbsp; general_fields = [&#39;title&#39;, &#39;slug&#39;, &#39;status&#39;, &#39;target&#39;, &#39;position&#39;]</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; # TODO: find solution to do this dynamically</p>
<p class='pln'>&nbsp; &nbsp; #if getattr(settings, &#39;PAGE_USE_SITE_ID&#39;):</p>
<p class='stm run hide'>&nbsp; &nbsp; general_fields.append(&#39;sites&#39;)</p>
<p class='stm run hide'>&nbsp; &nbsp; insert_point = general_fields.index(&#39;status&#39;) + 1</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; # Strange django behavior. If not provided, django will try to find</p>
<p class='pln'>&nbsp; &nbsp; # &#39;page&#39; foreign key in all registered models</p>
<p class='stm run hide'>&nbsp; &nbsp; inlines = []</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; if settings.PAGE_TAGGING:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; general_fields.insert(insert_point, &#39;tags&#39;)</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; # Add support for future dating and expiration based on settings.</p>
<p class='stm run hide'>&nbsp; &nbsp; if settings.PAGE_SHOW_END_DATE:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; general_fields.insert(insert_point, &#39;publication_end_date&#39;)</p>
<p class='stm run hide'>&nbsp; &nbsp; if settings.PAGE_SHOW_START_DATE:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; general_fields.insert(insert_point, &#39;publication_date&#39;)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; from pages.urlconf_registry import registry</p>
<p class='stm run hide'>&nbsp; &nbsp; if(len(registry)):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; general_fields.append(&#39;delegate_to&#39;)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; insert_point = general_fields.index(&#39;status&#39;) + 1</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; normal_fields = [&#39;language&#39;]</p>
<p class='stm run hide'>&nbsp; &nbsp; page_templates = settings.get_page_templates()</p>
<p class='stm run hide'>&nbsp; &nbsp; if len(page_templates) &gt; 0:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; normal_fields.append(&#39;template&#39;)</p>
<p class='stm run hide'>&nbsp; &nbsp; normal_fields.append(&#39;redirect_to&#39;)</p>
<p class='stm run hide'>&nbsp; &nbsp; normal_fields.append(&#39;redirect_to_url&#39;)</p>
<p class='stm run hide'>&nbsp; &nbsp; fieldsets = (</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; (_(&#39;General&#39;), {</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;fields&#39;: general_fields,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;classes&#39;: (&#39;module-general&#39;,),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; }),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; (_(&#39;Options&#39;), {</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;fields&#39;: normal_fields,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;classes&#39;: (&#39;module-options&#39;,),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; }),</p>
<p class='pln'>&nbsp; &nbsp; )</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; class Media:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; css = {</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;all&#39;: [join(settings.PAGES_MEDIA_URL, path) for path in (</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;css/rte.css&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;css/pages.css&#39;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )]</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; js = [join(settings.PAGES_MEDIA_URL, path) for path in (</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;javascript/jquery.js&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;javascript/jquery.rte.js&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;javascript/jquery.query.js&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;javascript/pages.js&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;javascript/pages_form.js&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; )]</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def urls(self):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; from django.conf.urls.defaults import patterns, url, include</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # Admin-site-wide views.</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; urlpatterns = patterns(&#39;&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url(r&#39;^$&#39;, self.list_pages, name=&#39;page-index&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url(r&#39;^(?P&lt;page_id&gt;[0-9]+)/traduction/(?P&lt;language_id&gt;[-\w]+)/$&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; traduction, name=&#39;page-traduction&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url(r&#39;^(?P&lt;page_id&gt;[0-9]+)/get-content/(?P&lt;content_id&gt;[-\w]+)/$&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; get_content, name=&#39;page-traduction&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url(r&#39;^(?P&lt;page_id&gt;[0-9]+)/modify-content/(?P&lt;content_id&gt;[-\w]+)/(?P&lt;language_id&gt;[-\w]+)/$&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; modify_content, name=&#39;page-traduction&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url(r&#39;^(?P&lt;page_id&gt;[0-9]+)/delete-content/(?P&lt;language_id&gt;[-\w]+)/$&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; delete_content, name=&#39;page-delete_content&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url(r&#39;^(?P&lt;page_id&gt;[0-9]+)/sub-menu/$&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub_menu, name=&#39;page-sub-menu&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url(r&#39;^(?P&lt;page_id&gt;[0-9]+)/move-page/$&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.move_page, name=&#39;page-traduction&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url(r&#39;^(?P&lt;page_id&gt;[0-9]+)/change-status/$&#39;,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; change_status, name=&#39;page-change-status&#39;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; )</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; urlpatterns += super(PageAdmin, self).urls</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return urlpatterns</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; urls = property(urls)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def i18n_javascript(self, request):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Displays the i18n JavaScript that the Django admin</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; requires.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; This takes into account the ``USE_I18N`` setting. If it&#39;s set to False, the</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; generated JavaScript will be leaner and faster.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if global_settings.USE_I18N:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from django.views.i18n import javascript_catalog</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from django.views.i18n import null_javascript_catalog as javascript_catalog</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return javascript_catalog(request, packages=&#39;pages&#39;)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def save_model(self, request, page, form, change):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Move the page in the tree if necessary and save every</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; placeholder :class:`Content &lt;pages.models.Content&gt;`.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; language = form.cleaned_data[&#39;language&#39;]</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; target = form.data.get(&#39;target&#39;, None)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; position = form.data.get(&#39;position&#39;, None)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; page.save()</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # if True, we need to move the page</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if target and position:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; target = self.model.objects.get(pk=target)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; except self.model.DoesNotExist:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; target.invalidate()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page.move_to(target, position)</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; for name in self.mandatory_placeholders:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data = form.cleaned_data[name]</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; placeholder = PlaceholderNode(name)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; placeholder.save(page, language, data, change)</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; for placeholder in get_placeholders(page.get_template()):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(placeholder.name in form.cleaned_data and placeholder.name</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; not in self.mandatory_placeholders):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data = form.cleaned_data[placeholder.name]</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; placeholder.save(page, language, data, change)</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; page.invalidate()</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_fieldsets(self, request, obj=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Add fieldsets of placeholders to the list of already</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; existing fieldsets.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; additional_fieldsets = []</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; placeholder_fieldsets = []</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; template = get_template_from_request(request, obj)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; for placeholder in get_placeholders(template):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if placeholder.name not in self.mandatory_placeholders:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; placeholder_fieldsets.append(placeholder.name)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; additional_fieldsets.append((_(&#39;Content&#39;), {</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;fields&#39;: placeholder_fieldsets,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;classes&#39;: (&#39;module-content&#39;,),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; }))</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # deactived for now, create bugs with page with same slug title</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; given_fieldsets = list(self.declared_fieldsets)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return given_fieldsets + additional_fieldsets</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def save_form(self, request, form, change):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Given a ModelForm return an unsaved instance. ``change`` is True if</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; the object is being changed, and False if it&#39;s being added.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; instance = super(PageAdmin, self).save_form(request, form, change)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; instance.template = form.cleaned_data[&#39;template&#39;]</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if not change:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; instance.author = request.user</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return instance</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_form(self, request, obj=None, **kwargs):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Get a :class:`Page &lt;pages.admin.forms.PageForm&gt;` for the</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :class:`Page &lt;pages.models.Page&gt;` and modify its fields depending on</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; the request.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; form = super(PageAdmin, self).get_form(request, obj, **kwargs)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; language = get_language_from_request(request)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; form.base_fields[&#39;language&#39;].initial = language</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if obj:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; initial_slug = obj.slug(language=language, fallback=False)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; initial_title = obj.title(language=language, fallback=False)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; form.base_fields[&#39;slug&#39;].initial = initial_slug</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; form.base_fields[&#39;title&#39;].initial = initial_title</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; form.base_fields[&#39;slug&#39;].label = _(&#39;Slug&#39;)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; template = get_template_from_request(request, obj)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; page_templates = settings.get_page_templates()</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if len(page_templates) &gt; 0:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; template_choices = list(page_templates)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; template_choices.insert(0, (settings.DEFAULT_PAGE_TEMPLATE,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _(&#39;Default template&#39;)))</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; form.base_fields[&#39;template&#39;].choices = template_choices</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; form.base_fields[&#39;template&#39;].initial = force_unicode(template)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; for placeholder in get_placeholders(template):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name = placeholder.name</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if obj:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; initial = Content.objects.get_content(obj, language, name)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; initial = None</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; form.base_fields[name] = placeholder.get_field(obj, language, initial=initial)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return form</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def change_view(self, request, object_id, extra_context=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;The ``change`` admin view for the</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; :class:`Page &lt;pages.models.Page&gt;`.&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; language = get_language_from_request(request)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; extra_context = {</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;language&#39;: language,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # don&#39;t see where it&#39;s used</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&#39;lang&#39;: current_lang,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;page_languages&#39;: settings.PAGE_LANGUAGES,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; obj = self.model.objects.get(pk=object_id)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; except self.model.DoesNotExist:</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Don&#39;t raise Http404 just yet, because we haven&#39;t checked</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # permissions yet. We don&#39;t want an unauthenticated user to be able</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # to determine whether a given object exists.</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; obj = None</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; template = get_template_from_request(request, obj)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; extra_context[&#39;placeholders&#39;] = get_placeholders(template)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; extra_context[&#39;traduction_languages&#39;] = [l for l in</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; settings.PAGE_LANGUAGES if Content.objects.get_content(obj,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l[0], &quot;title&quot;) and l[0] != language]</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; extra_context[&#39;page&#39;] = obj</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return super(PageAdmin, self).change_view(request, object_id,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; extra_context)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def add_view(self, request, form_url=&#39;&#39;, extra_context=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;The ``add`` admin view for the :class:`Page &lt;pages.models.Page&gt;`.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; extra_context = {</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;language&#39;: get_language_from_request(request),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;page_languages&#39;: settings.PAGE_LANGUAGES,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; template = get_template_from_request(request)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; #extra_context[&#39;placeholders&#39;] = get_placeholders(template)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return super(PageAdmin, self).add_view(request, form_url,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; extra_context)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def has_add_permission(self, request):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return ``True`` if the current user has permission to add a new</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; page.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if not settings.PAGE_PERMISSION:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return super(PageAdmin, self).has_add_permission(request)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return has_page_add_permission(request)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def has_change_permission(self, request, obj=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return ``True`` if the current user has permission on the page.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Return the string ``All`` if the user has all rights.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_PERMISSION and obj is not None:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return obj.has_page_permission(request)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return super(PageAdmin, self).has_change_permission(request, obj)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def has_delete_permission(self, request, obj=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Return ``True``&nbsp; if the current user has permission on the page.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; Return the string ``All`` if the user has all rights.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if settings.PAGE_PERMISSION and obj is not None:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return obj.has_page_permission(request)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return super(PageAdmin, self).has_delete_permission(request, obj)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def list_pages(self, request, template_name=None, extra_context=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;List root pages&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if not admin.site.has_permission(request):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return admin.site.login(request)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # HACK: overrides the changelist template and later resets it to None</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if template_name:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.change_list_template = template_name</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; language = get_language_from_request(request)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; q=request.POST.get(&#39;q&#39;, &#39;&#39;).strip()</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if q:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page_ids = list(set([c.page.pk for c in Content.objects.filter(body__icontains=q)]))</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pages = Page.objects.filter(pk__in=page_ids)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pages = Page.objects.root()</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; context = {</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;language&#39;: language,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;name&#39;: _(&quot;page&quot;),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;pages&#39;: pages,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;opts&#39;: self.model._meta,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;q&#39;: q</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; context.update(extra_context or {})</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; change_list = self.changelist_view(request, context)</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; self.change_list_template = None</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return change_list</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def move_page(self, request, page_id, extra_context=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Move the page to the requested target, at the given</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; position&quot;&quot;&quot;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; page = Page.objects.get(pk=page_id)</p>
<p class='pln'>&nbsp;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; target = request.POST.get(&#39;target&#39;, None)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; position = request.POST.get(&#39;position&#39;, None)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if target is not None and position is not None:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; target = self.model.objects.get(pk=target)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; except self.model.DoesNotExist:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TODO: should use the django message system</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # to display this message</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # _(&#39;Page could not been moved.&#39;)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page.invalidate()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; target.invalidate()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page.move_to(target, position)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return self.list_pages(request,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; template_name=&#39;admin/pages/page/change_list_table.html&#39;)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return HttpResponseRedirect(&#39;../../&#39;)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>for model, options in get_connected():</p>
<p class='stm run hide'>&nbsp; &nbsp; PageAdmin.inlines.append(make_inline_admin(model, options))</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>try:</p>
<p class='stm run hide'>&nbsp; &nbsp; admin.site.register(Page, PageAdmin)</p>
<p class='stm run hide'>except AlreadyRegistered:</p>
<p class='stm run hide'>&nbsp; &nbsp; pass</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class ContentAdmin(admin.ModelAdmin):</p>
<p class='stm run hide'>&nbsp; &nbsp; list_display = (&#39;__unicode__&#39;, &#39;type&#39;, &#39;language&#39;, &#39;page&#39;)</p>
<p class='stm run hide'>&nbsp; &nbsp; list_filter = (&#39;page&#39;,)</p>
<p class='stm run hide'>&nbsp; &nbsp; search_fields = (&#39;body&#39;,)</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>#admin.site.register(Content, ContentAdmin)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>if settings.PAGE_PERMISSION:</p>
<p class='stm run hide'>&nbsp; &nbsp; from pages.models import PagePermission</p>
<p class='stm run hide'>&nbsp; &nbsp; try:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; admin.site.register(PagePermission)</p>
<p class='stm run hide'>&nbsp; &nbsp; except AlreadyRegistered:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; pass</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class AliasAdmin(admin.ModelAdmin):</p>
<p class='stm run hide'>&nbsp; &nbsp; list_display = (&#39;page&#39;, &#39;url&#39;,)</p>
<p class='stm run hide'>&nbsp; &nbsp; list_editable = (&#39;url&#39;, )</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>try:</p>
<p class='stm run hide'>&nbsp; &nbsp; admin.site.register(PageAlias, AliasAdmin)</p>
<p class='stm run hide'>except AlreadyRegistered:</p>
<p class='stm run hide'>&nbsp; &nbsp; pass</p>
<p class='pln'>&nbsp;</p>
    
</td>
</tr>
</table>
</div>

</body>
</html>
