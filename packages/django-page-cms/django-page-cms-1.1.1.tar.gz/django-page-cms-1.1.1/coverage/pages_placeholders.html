<!doctype html PUBLIC "-//W3C//DTD html 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>Coverage for pages.placeholders</title>
<link rel='stylesheet' href='style.css' type='text/css'>
<script src='jquery-1.3.2.min.js'></script>
<script>
function toggle_lines(btn, cls) {
    var btn = $(btn);
    if (btn.hasClass("hide")) {
        $("#source ."+cls).removeClass("hide");
        btn.removeClass("hide");
    }
    else {
        $("#source ."+cls).addClass("hide");
        btn.addClass("hide");
    }
}
</script>
</head>
<body>
<div id='header'>
    <div class='content'>
        <h1>Coverage for <b>pages.placeholders</b> :
            <span class='pc_cov'>77%</span>
        </h1>
        <h2 class='stats'>
            130 statements
            <span class='run hide' onclick='toggle_lines(this, "run")'>100 run</span>
            <span class='exc' onclick='toggle_lines(this, "exc")'>0 excluded</span>
            <span class='mis' onclick='toggle_lines(this, "mis")'>30 missing</span>
        </h2>
    </div>
</div>

<div id='source'>
<table cellspacing='0' cellpadding='0'>
<tr>
<td class='linenos' valign='top'>
<p class='stm run hide'>1</p>
<p class='stm run hide'>2</p>
<p class='stm run hide'>3</p>
<p class='stm run hide'>4</p>
<p class='stm run hide'>5</p>
<p class='stm run hide'>6</p>
<p class='stm run hide'>7</p>
<p class='stm run hide'>8</p>
<p class='stm run hide'>9</p>
<p class='pln'>10</p>
<p class='stm run hide'>11</p>
<p class='stm run hide'>12</p>
<p class='stm run hide'>13</p>
<p class='stm run hide'>14</p>
<p class='stm run hide'>15</p>
<p class='stm run hide'>16</p>
<p class='pln'>17</p>
<p class='stm run hide'>18</p>
<p class='pln'>19</p>
<p class='stm run hide'>20</p>
<p class='stm run hide'>21</p>
<p class='stm run hide'>22</p>
<p class='stm run hide'>23</p>
<p class='stm mis'>24</p>
<p class='stm run hide'>25</p>
<p class='stm run hide'>26</p>
<p class='stm run hide'>27</p>
<p class='stm run hide'>28</p>
<p class='stm run hide'>29</p>
<p class='stm run hide'>30</p>
<p class='stm mis'>31</p>
<p class='pln'>32</p>
<p class='stm run hide'>33</p>
<p class='stm run hide'>34</p>
<p class='stm mis'>35</p>
<p class='pln'>36</p>
<p class='stm run hide'>37</p>
<p class='stm run hide'>38</p>
<p class='stm run hide'>39</p>
<p class='stm run hide'>40</p>
<p class='stm run hide'>41</p>
<p class='stm run hide'>42</p>
<p class='stm run hide'>43</p>
<p class='pln'>44</p>
<p class='stm run hide'>45</p>
<p class='stm run hide'>46</p>
<p class='stm run hide'>47</p>
<p class='pln'>48</p>
<p class='pln'>49</p>
<p class='stm run hide'>50</p>
<p class='pln'>51</p>
<p class='pln'>52</p>
<p class='pln'>53</p>
<p class='pln'>54</p>
<p class='pln'>55</p>
<p class='pln'>56</p>
<p class='pln'>57</p>
<p class='pln'>58</p>
<p class='pln'>59</p>
<p class='pln'>60</p>
<p class='pln'>61</p>
<p class='pln'>62</p>
<p class='pln'>63</p>
<p class='pln'>64</p>
<p class='stm run hide'>65</p>
<p class='pln'>66</p>
<p class='stm run hide'>67</p>
<p class='stm run hide'>68</p>
<p class='stm run hide'>69</p>
<p class='stm run hide'>70</p>
<p class='stm run hide'>71</p>
<p class='stm run hide'>72</p>
<p class='stm run hide'>73</p>
<p class='pln'>74</p>
<p class='stm run hide'>75</p>
<p class='pln'>76</p>
<p class='pln'>77</p>
<p class='stm run hide'>78</p>
<p class='stm run hide'>79</p>
<p class='stm run hide'>80</p>
<p class='stm run hide'>81</p>
<p class='pln'>82</p>
<p class='stm run hide'>83</p>
<p class='stm run hide'>84</p>
<p class='stm run hide'>85</p>
<p class='stm run hide'>86</p>
<p class='stm run hide'>87</p>
<p class='stm run hide'>88</p>
<p class='pln'>89</p>
<p class='stm run hide'>90</p>
<p class='pln'>91</p>
<p class='stm run hide'>92</p>
<p class='stm run hide'>93</p>
<p class='pln'>94</p>
<p class='stm run hide'>95</p>
<p class='stm run hide'>96</p>
<p class='stm run hide'>97</p>
<p class='pln'>98</p>
<p class='pln'>99</p>
<p class='stm run hide'>100</p>
<p class='pln'>101</p>
<p class='pln'>102</p>
<p class='stm run hide'>103</p>
<p class='pln'>104</p>
<p class='stm run hide'>105</p>
<p class='pln'>106</p>
<p class='stm run hide'>107</p>
<p class='pln'>108</p>
<p class='pln'>109</p>
<p class='pln'>110</p>
<p class='pln'>111</p>
<p class='pln'>112</p>
<p class='pln'>113</p>
<p class='stm mis'>114</p>
<p class='pln'>115</p>
<p class='pln'>116</p>
<p class='pln'>117</p>
<p class='pln'>118</p>
<p class='pln'>119</p>
<p class='pln'>120</p>
<p class='pln'>121</p>
<p class='stm run hide'>122</p>
<p class='pln'>123</p>
<p class='pln'>124</p>
<p class='pln'>125</p>
<p class='pln'>126</p>
<p class='pln'>127</p>
<p class='pln'>128</p>
<p class='stm run hide'>129</p>
<p class='stm run hide'>130</p>
<p class='stm run hide'>131</p>
<p class='pln'>132</p>
<p class='stm run hide'>133</p>
<p class='stm run hide'>134</p>
<p class='pln'>135</p>
<p class='stm run hide'>136</p>
<p class='stm run hide'>137</p>
<p class='pln'>138</p>
<p class='stm run hide'>139</p>
<p class='pln'>140</p>
<p class='stm run hide'>141</p>
<p class='pln'>142</p>
<p class='stm run hide'>143</p>
<p class='stm run hide'>144</p>
<p class='stm run hide'>145</p>
<p class='stm run hide'>146</p>
<p class='stm run hide'>147</p>
<p class='stm run hide'>148</p>
<p class='stm run hide'>149</p>
<p class='stm mis'>150</p>
<p class='stm mis'>151</p>
<p class='stm mis'>152</p>
<p class='pln'>153</p>
<p class='pln'>154</p>
<p class='pln'>155</p>
<p class='stm mis'>156</p>
<p class='stm mis'>157</p>
<p class='stm mis'>158</p>
<p class='stm mis'>159</p>
<p class='pln'>160</p>
<p class='stm mis'>161</p>
<p class='stm run hide'>162</p>
<p class='stm run hide'>163</p>
<p class='stm mis'>164</p>
<p class='stm mis'>165</p>
<p class='pln'>166</p>
<p class='stm run hide'>167</p>
<p class='stm run hide'>168</p>
<p class='pln'>169</p>
<p class='pln'>170</p>
<p class='stm run hide'>171</p>
<p class='pln'>172</p>
<p class='stm run hide'>173</p>
<p class='pln'>174</p>
<p class='stm run hide'>175</p>
<p class='stm run hide'>176</p>
<p class='stm run hide'>177</p>
<p class='stm run hide'>178</p>
<p class='pln'>179</p>
<p class='pln'>180</p>
<p class='pln'>181</p>
<p class='pln'>182</p>
<p class='pln'>183</p>
<p class='pln'>184</p>
<p class='stm run hide'>185</p>
<p class='stm run hide'>186</p>
<p class='stm run hide'>187</p>
<p class='stm mis'>188</p>
<p class='stm mis'>189</p>
<p class='pln'>190</p>
<p class='stm mis'>191</p>
<p class='stm mis'>192</p>
<p class='pln'>193</p>
<p class='pln'>194</p>
<p class='pln'>195</p>
<p class='pln'>196</p>
<p class='pln'>197</p>
<p class='pln'>198</p>
<p class='stm run hide'>199</p>
<p class='pln'>200</p>
<p class='stm run hide'>201</p>
<p class='stm mis'>202</p>
<p class='stm mis'>203</p>
<p class='stm mis'>204</p>
<p class='stm mis'>205</p>
<p class='stm mis'>206</p>
<p class='stm mis'>207</p>
<p class='stm mis'>208</p>
<p class='stm mis'>209</p>
<p class='stm mis'>210</p>
<p class='stm mis'>211</p>
<p class='stm mis'>212</p>
<p class='stm mis'>213</p>
    
</td>
<td class='text' valign='top'>
<p class='stm run hide'>from django import template</p>
<p class='stm run hide'>from django.template import Template, TemplateSyntaxError</p>
<p class='stm run hide'>from django.core.files.storage import FileSystemStorage</p>
<p class='stm run hide'>from django.forms import Widget, Textarea, ImageField, CharField</p>
<p class='stm run hide'>from django.forms import TextInput</p>
<p class='stm run hide'>from django.conf import settings as global_settings</p>
<p class='stm run hide'>from django.utils.translation import ugettext_lazy as _</p>
<p class='stm run hide'>from django.utils.safestring import SafeUnicode, mark_safe</p>
<p class='stm run hide'>from django.template.loader import render_to_string</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>from pages.widgets_registry import get_widget</p>
<p class='stm run hide'>from pages import settings</p>
<p class='stm run hide'>from pages.models import Content, Page</p>
<p class='stm run hide'>import os</p>
<p class='stm run hide'>import time</p>
<p class='stm run hide'>import re</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>def parse_placeholder(parser, token):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;Parser that understand all the placeholder&#39;s parameters.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; bits = token.split_contents()</p>
<p class='stm run hide'>&nbsp; &nbsp; count = len(bits)</p>
<p class='stm run hide'>&nbsp; &nbsp; error_string = &#39;%r tag requires at least one argument&#39; % bits[0]</p>
<p class='stm run hide'>&nbsp; &nbsp; if count &lt;= 1:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; raise template.TemplateSyntaxError(error_string)</p>
<p class='stm run hide'>&nbsp; &nbsp; name = bits[1]</p>
<p class='stm run hide'>&nbsp; &nbsp; remaining = bits[2:]</p>
<p class='stm run hide'>&nbsp; &nbsp; params = {}</p>
<p class='stm run hide'>&nbsp; &nbsp; while remaining:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; bit = remaining[0]</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if bit not in (&#39;as&#39;, &#39;on&#39;, &#39;with&#39;, &#39;parsed&#39;):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raise template.TemplateSyntaxError(</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;%r is not an correct option for a placeholder&quot; % bit)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if bit in (&#39;as&#39;, &#39;on&#39;, &#39;with&#39;):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if len(remaining) &lt; 2:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raise template.TemplateSyntaxError(</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;Placeholder option &#39;%s&#39; need a parameter&quot; % bit)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if bit == &#39;as&#39;:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; params[&#39;as_varname&#39;] = remaining[1]</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if bit == &#39;with&#39;:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; params[&#39;widget&#39;] = remaining[1]</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if bit == &#39;on&#39;:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; params[&#39;page&#39;] = remaining[1]</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; remaining = remaining[2:]</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; params[&#39;parsed&#39;] = True</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; remaining = remaining[1:]</p>
<p class='stm run hide'>&nbsp; &nbsp; return name, params</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class PlaceholderNode(template.Node):</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;This template node is used to output page content and</p>
<p class='pln'>&nbsp; &nbsp; dynamically generate input fields in the admin.</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp; &nbsp; :param name: the name of the placeholder you want to show/create</p>
<p class='pln'>&nbsp; &nbsp; :param page: the optional page object</p>
<p class='pln'>&nbsp; &nbsp; :param widget: the widget you want to use in the admin interface. Take</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; a look into :mod:`pages.widgets` to see which widgets</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; are available.</p>
<p class='pln'>&nbsp; &nbsp; :param parsed: if the ``parsed`` word is given, the content of the</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; placeholder is evaluated as template code, within the current context.</p>
<p class='pln'>&nbsp; &nbsp; :param as_varname: if ``as_varname`` is defined, no value will be returned.</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; A variable will be created in the context with the defined name.</p>
<p class='pln'>&nbsp; &nbsp; &quot;&quot;&quot;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; field = CharField</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def __init__(self, name, page=None, widget=TextInput, parsed=False, as_varname=None):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; self.page = page or &#39;current_page&#39;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; self.name = name</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; self.widget = widget</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; self.parsed = parsed</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; self.as_varname = as_varname</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; self.found_in_block = None</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_widget(self, page, language, fallback=Textarea):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Given the name of a placeholder return a ``Widget`` subclass</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; like Textarea or TextInput.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; is_str = type(self.widget) == type(str())</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; is_unicode =&nbsp; type(self.widget) == type(unicode())</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if is_str or is_unicode:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; widget = get_widget(self.widget)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; widget = self.widget</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return widget(page=page, language=language)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; except:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return widget()</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_field(self, page, language, initial=None):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;The field that will be shown within the admin.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if self.parsed:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; help_text = _(&#39;Note: This field is evaluated as template code.&#39;)</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; help_text = &quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; widget = self.get_widget(page, language)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return self.field(widget=widget, initial=initial,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; help_text=help_text, required=False)</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def save(self, page, language, data, change):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Actually save the placeholder data into the Content object.&quot;&quot;&quot;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # the page is being changed</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if change:</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # we need create a new content if revision is enabled</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(settings.PAGE_CONTENT_REVISION and self.name</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; not in settings.PAGE_CONTENT_REVISION_EXCLUDE_LIST):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Content.objects.create_content_if_changed(</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; language,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.name,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Content.objects.set_or_create_content(</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; language,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.name,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # the page is being added</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Content.objects.set_or_create_content(</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; language,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.name,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_content(self, context):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if not self.page in context:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;&#39;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; # current_page can be set to None</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if not context[self.page]:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;&#39;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; lang = context.get(&#39;lang&#39;, settings.PAGE_DEFAULT_LANGUAGE)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; content = Content.objects.get_content(context[self.page], lang,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.name, True)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return content</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def render(self, context):</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Output the content of the node in the template.&quot;&quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; content = self.get_content(context)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if not content:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;&#39;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if self.parsed:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t = template.Template(content, name=self.name)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content = mark_safe(t.render(context))</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; except template.TemplateSyntaxError, error:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if global_settings.DEBUG:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error = PLACEHOLDER_ERROR % {</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;name&#39;: self.name,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;error&#39;: error,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if self.as_varname is None:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return error</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context[self.as_varname] = error</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;&#39;</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;&#39;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if self.as_varname is None:</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return content</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; context[self.as_varname] = content</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return &#39;&#39;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def __repr__(self):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return &quot;&lt;Placeholder Node: %s&gt;&quot; % self.name</p>
<p class='pln'>&nbsp;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class ImagePlaceholderNode(PlaceholderNode):</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; widget = &#39;ImageInput&#39;</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def get_field(self, page, language, initial=None):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; help_text = &quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; widget = self.get_widget(page, language)</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; return ImageField(</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; widget=widget,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; initial=initial,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; help_text=help_text,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; required=False</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; )</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def save(self, page, language, data, change):</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; filename = &quot;&quot;</p>
<p class='stm run hide'>&nbsp; &nbsp; &nbsp; &nbsp; if page and page.id and data:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; storage = FileSystemStorage()</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; filename = os.path.join(&#39;upload&#39;, &#39;page_&#39;+str(page.id),</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.name + &#39;-&#39; + str(time.time()))</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; filename = storage.save(filename, data)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; super(ImagePlaceholderNode, self).save(</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; language,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; filename,</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; change</p>
<p class='pln'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>class VideoPlaceholderNode(PlaceholderNode):</p>
<p class='pln'>&nbsp;</p>
<p class='stm run hide'>&nbsp; &nbsp; def render(self, context):</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; content = self.get_content(context)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if not content:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;&#39;</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; if content:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; video_url = content</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m = re.search(&#39;youtube\.com\/watch\?v=([^&amp;]+)&#39;, content)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if m:</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; video_url = &#39;http://www.youtube.com/v/&#39;+m.group(1)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context = {&#39;video_url&#39;: video_url}</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; renderer = render_to_string(&#39;pages/embed.html&#39;, context)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return mark_safe(renderer)</p>
<p class='stm mis'>&nbsp; &nbsp; &nbsp; &nbsp; return &#39;&#39;</p>
    
</td>
</tr>
</table>
</div>

</body>
</html>
