<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.2.3" />
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
}

strong {
  font-weight: bold;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.1em;
}
span#email {
}
span#revision {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble,
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-right: 10%;
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock {
  margin-right: 0%;
}
div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock > div.content {
  padding-left: 2.0em;
}

div.attribution {
  text-align: right;
}
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.verseblock div.content {
  white-space: pre;
}

div.imageblock div.content { padding-left: 0; }
div.imageblock img { border: 1px solid silver; }
span.image img { border-style: none; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: italic;
}
dd > *:first-child {
  margin-top: 0;
}

ul, ol {
    list-style-position: outside;
}
div.olist2 ol {
  list-style-type: lower-alpha;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}

div.hlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hlist td {
  padding-bottom: 5px;
}
td.hlist1 {
  vertical-align: top;
  font-style: italic;
  padding-right: 0.8em;
}
td.hlist2 {
  vertical-align: top;
}

@media print {
  div#footer-badges { display: none; }
}

div#toctitle {
  color: #527bbd;
  font-family: sans-serif;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-content {
  padding-left: 2.0em;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited { color: blue; }
</style>
<title>Internals</title>
</head>
<body>
<div id="header">
<h1>Internals</h1>
</div>
<h2 id="_web">Web</h2>
<div class="sectionbody">
<div class="para"><p>This is a Pylons application.  The template engine is Mako.</p></div>
</div>
<h2 id="_database">Database</h2>
<div class="sectionbody">
<div class="para"><p>The object relational mapper is SQL Alchemy and most database engines
should work though most testing was done with SQLite.</p></div>
</div>
<h2 id="_navigation">Navigation</h2>
<div class="sectionbody">
<div class="para"><p>There are three levels of navigation.  Level 1 is for user operations:
login, messages, profiles, and the like.  Level 2 is site wide
navigation: home, wiki, and who knows want other section there might
be.  Level 3 is in-section actions, for wiki that would be: edit,
history, diff, and stuff like that.  Levels 1 and 2 and rendered the
same all over the plate by <tt>base.mako</tt>, level 3 must be included
manually by the templates needing it.  Actions can be added by the
controller through <tt>c.navX_actions</tt> with <tt>X</tt> in {1, 2, 3}.  This is
just a list of <tt>(label, controller, action)</tt> tuples.  The url and
active tab highlighting is computed by Routes.</p></div>
<div class="para"><p>Beware, the Routes semantic holds: a leading slash in the controller
name is used to cancel the Routes memory.</p></div>
</div>
<h2 id="_flashed_messages">Flashed Messages</h2>
<div class="sectionbody">
<div class="para"><p>Messages are flashed all over the place to confirm success of actions
or to warn the user of critical conditions.  There are two queues with
two levels each.  Levels are <tt>info</tt> and <tt>warn</tt>.  The first queue is
for messages to be displayed on the page being rendered.  The second
queue for messages to be displayed on the next page visited; this
queue is typically used before a redirect, say after a successful
login or form processing.  The second queue uses sessions and will
silently fail if the user refuses cookies.  To append a message, use
<tt>h.m_info()</tt>, <tt>h.m_warn()</tt>, <tt>h.q_info()</tt>, or <tt>h.q_warn()</tt>.</p></div>
</div>
<h2 id="_wiki_storage">Wiki Storage</h2>
<div class="sectionbody">
<div class="para"><p>The wiki engine is inspired by distributed revision control systems,
mostly Git and Mercurial.  The storage is a directed acyclic graph
(DAG) of page revisions.  The idea is that we make a better job at
merging concurrent edits if we track where they come from without
forcing the page history into a linear successions of edits.  A page
can be forked and each branch can be saved into several intermediate
states before a merge.</p></div>
<div class="para"><p>See how it's done in
<a href="http://eagain.net/articles/git-for-computer-scientists/">Git internals</a>
and
<a href="http://www.selenic.com/mercurial/wiki/index.cgi/UnderstandingMercurial">Mercurial internals</a>
for more info on the storage.
We do basically the same thing using a database instead of the file
system.</p></div>
<div class="para"><p>A <strong>rev</strong> or <strong>RevNode</strong> is the content of a revision.  It is not tied to
a page.  Pages are pointer to specific nodes in the revision DAG.
When concurrent edits are detected, we find the most recent common
parent revision and we do a 3-way merge.  The code to find the
ancestor is taken verbatim from Mercurial and merge is done with GNU
<tt>diff3</tt>.  There is a Python implementation of 3-way merge in Mercurial
that we could also use.</p></div>
<div class="para"><p>What Mercurial refers to as the <strong>tip</strong> is the node that had the Page
pointer before a commit.  This is always <tt>rev.parents[-1]</tt>.</p></div>
</div>
<h2 id="_wiki_markup">Wiki Markup</h2>
<div class="sectionbody">
<div class="para"><p>Not much to say.  Markup cannot be nested so we use regexps to strip
the wiki specific markup from the page, we render the presentation
with the page renderer, then insert the rendered markup back into
place.</p></div>
<div class="para"><p>The default renderer is Markdown but the user can change that with a
macro.  It's easy to make a plugin for another renderer, see the
<tt>gazest_extra_macros</tt> package for examples.</p></div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2007-10-27 02:41:44 EDT
</div>
</div>
</body>
</html>
