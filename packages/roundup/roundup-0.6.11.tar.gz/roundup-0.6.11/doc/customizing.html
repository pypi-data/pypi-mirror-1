<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.2.9: http://docutils.sourceforge.net/" />
<title>Customising Roundup</title>
<link rel="stylesheet" href="default.css" type="text/css" />
</head>
<body>
<div class="document" id="customising-roundup">
<h1 class="title">Customising Roundup</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Version:</th>
<td>$Revision$</td></tr>
</tbody>
</table>
<!-- This document borrows from the ZopeBook section on ZPT. The original is at:
http://www.zope.org/Documentation/Books/ZopeBook/current/ZPT.stx -->
<div class="contents topic" id="contents">
<p class="topic-title"><a name="contents">Contents</a></p>
<ul class="simple">
<li><a class="reference" href="#what-you-can-do" id="id2" name="id2">What You Can Do</a></li>
<li><a class="reference" href="#trackers-in-a-nutshell" id="id3" name="id3">Trackers in a Nutshell</a></li>
<li><a class="reference" href="#tracker-configuration" id="id4" name="id4">Tracker Configuration</a></li>
<li><a class="reference" href="#tracker-schema" id="id5" name="id5">Tracker Schema</a></li>
<li><a class="reference" href="#detectors-adding-behaviour-to-your-tracker" id="id6" name="id6">Detectors - adding behaviour to your tracker</a></li>
<li><a class="reference" href="#database-content" id="id7" name="id7">Database Content</a></li>
<li><a class="reference" href="#access-controls" id="id8" name="id8">Access Controls</a></li>
<li><a class="reference" href="#web-interface" id="id9" name="id9">Web Interface</a></li>
<li><a class="reference" href="#examples" id="id10" name="id10">Examples</a></li>
</ul>
</div>
<div class="section" id="what-you-can-do">
<h1><a class="toc-backref" href="#id2" name="what-you-can-do">What You Can Do</a></h1>
<p>Before you get too far, it's probably worth having a quick read of the Roundup
<a class="reference" href="design.html">design documentation</a>.</p>
<p>Customisation of Roundup can take one of six forms:</p>
<ol class="arabic simple">
<li><a class="reference" href="#tracker-configuration">tracker configuration</a> file changes</li>
<li>database, or <a class="reference" href="#tracker-schema">tracker schema</a> changes</li>
<li>&quot;definition&quot; class <a class="reference" href="#database-content">database content</a> changes</li>
<li>behavioural changes, through <a class="reference" href="#detectors">detectors</a></li>
<li><a class="reference" href="#access-controls">access controls</a></li>
<li>change the <a class="reference" href="#web-interface">web interface</a></li>
</ol>
<p>The third case is special because it takes two distinctly different forms
depending upon whether the tracker has been initialised or not. The other two
may be done at any time, before or after tracker initialisation. Yes, this
includes adding or removing properties from classes.</p>
</div>
<div class="section" id="trackers-in-a-nutshell">
<h1><a class="toc-backref" href="#id3" name="trackers-in-a-nutshell">Trackers in a Nutshell</a></h1>
<p>Trackers have the following structure:</p>
<table class="table" frame="border" rules="all">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr><th>Tracker File</th>
<th>Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>config.py</td>
<td>Holds the basic <a class="reference" href="#tracker-configuration">tracker configuration</a></td>
</tr>
<tr><td>dbinit.py</td>
<td>Holds the <a class="reference" href="#tracker-schema">tracker schema</a></td>
</tr>
<tr><td>interfaces.py</td>
<td>Defines the Web and E-Mail interfaces for the tracker</td>
</tr>
<tr><td>select_db.py</td>
<td>Selects the database back-end for the tracker</td>
</tr>
<tr><td>db/</td>
<td>Holds the tracker's database</td>
</tr>
<tr><td>db/files/</td>
<td>Holds the tracker's upload files and messages</td>
</tr>
<tr><td>detectors/</td>
<td>Auditors and reactors for this tracker</td>
</tr>
<tr><td>html/</td>
<td>Web interface templates, images and style sheets</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="tracker-configuration">
<h1><a class="toc-backref" href="#id4" name="tracker-configuration">Tracker Configuration</a></h1>
<p>The <tt class="literal"><span class="pre">config.py</span></tt> located in your tracker home contains the basic
configuration for the web and e-mail components of roundup's interfaces.
As the name suggests, this file is a Python module. This means that any
valid python expression may be used in the file. Mostly though, you'll
be setting the configuration variables to string values. Python string
values must be quoted with either single or double quotes:</p>
<pre class="literal-block">
'this is a string'
&quot;this is also a string - use it when the value has 'single quotes'&quot;
this is not a string - it's not quoted
</pre>
<p>Python strings may use formatting that's almost identical to C string
formatting. The <tt class="literal"><span class="pre">%</span></tt> operator is used to perform the formatting, like
so:</p>
<pre class="literal-block">
'roundup-admin&#64;%s'%MAIL_DOMAIN
</pre>
<p>this will create a string <tt class="literal"><span class="pre">'roundup-admin&#64;tracker.domain.example'</span></tt> if
MAIL_DOMAIN is set to <tt class="literal"><span class="pre">'tracker.domain.example'</span></tt>.</p>
<p>You'll also note some values are set to:</p>
<pre class="literal-block">
os.path.join(TRACKER_HOME, 'db')
</pre>
<p>or similar. This creates a new string which holds the path to the
<tt class="literal"><span class="pre">'db'</span></tt> directory in the TRACKER_HOME directory. This is just a
convenience so if the TRACKER_HOME changes you don't have to edit
multiple valoues.</p>
<p>The configuration variables available are:</p>
<dl>
<dt><strong>TRACKER_HOME</strong> - <tt class="literal"><span class="pre">os.path.split(__file__)[0]</span></tt></dt>
<dd>The tracker home directory. The above default code will automatically
determine the tracker home for you, so you can just leave it alone.</dd>
<dt><strong>MAILHOST</strong> - <tt class="literal"><span class="pre">'localhost'</span></tt></dt>
<dd>The SMTP mail host that roundup will use to send e-mail.</dd>
<dt><strong>MAILUSER</strong> - <tt class="literal"><span class="pre">()</span></tt></dt>
<dd>If your SMTP mail host requires a username and password for access, then
specify them here. eg. <tt class="literal"><span class="pre">MAILUSER</span> <span class="pre">=</span> <span class="pre">('username',</span> <span class="pre">'password')</span></tt></dd>
<dt><strong>MAILHOST_TLS</strong> - <tt class="literal"><span class="pre">'no'</span></tt></dt>
<dd>If your SMTP mail host provides or requires TLS (Transport Layer
Security) then set <tt class="literal"><span class="pre">MAILHOST_TLS</span> <span class="pre">=</span> <span class="pre">'yes'</span></tt></dd>
<dt><strong>MAILHOST_TLS_KEYFILE</strong> - <tt class="literal"><span class="pre">''</span></tt></dt>
<dd>If you're using TLS, you may also set MAILHOST_TLS_KEYFILE to the name of
a PEM formatted file that contains your private key.</dd>
<dt><strong>MAILHOST_TLS_CERTFILE</strong> - <tt class="literal"><span class="pre">''</span></tt></dt>
<dd>If you're using TLS and have specified a MAILHOST_TLS_KEYFILE, you may
also set MAILHOST_TLS_CERTFILE to the name of a PEM formatted certificate
chain file.</dd>
<dt><strong>MAIL_DOMAIN</strong> - <tt class="literal"><span class="pre">'tracker.domain.example'</span></tt></dt>
<dd>The domain name used for email addresses.</dd>
<dt><strong>DATABASE</strong> - <tt class="literal"><span class="pre">os.path.join(TRACKER_HOME,</span> <span class="pre">'db')</span></tt></dt>
<dd>This is the directory that the database is going to be stored in. By default
it is in the tracker home.</dd>
<dt><strong>TEMPLATES</strong> - <tt class="literal"><span class="pre">os.path.join(TRACKER_HOME,</span> <span class="pre">'html')</span></tt></dt>
<dd>This is the directory that the HTML templates reside in. By default they are
in the tracker home.</dd>
<dt><strong>TRACKER_NAME</strong> - <tt class="literal"><span class="pre">'Roundup</span> <span class="pre">issue</span> <span class="pre">tracker'</span></tt></dt>
<dd>A descriptive name for your roundup tracker. This is sent out in e-mails and
appears in the heading of CGI pages.</dd>
<dt><strong>TRACKER_EMAIL</strong> - <tt class="literal"><span class="pre">'issue_tracker&#64;%s'%MAIL_DOMAIN</span></tt></dt>
<dd>The email address that e-mail sent to roundup should go to. Think of it as the
tracker's personal e-mail address.</dd>
<dt><strong>TRACKER_WEB</strong> - <tt class="literal"><span class="pre">'http://tracker.example/cgi-bin/roundup.cgi/bugs/'</span></tt></dt>
<dd>The web address that the tracker is viewable at. This will be included in
information sent to users of the tracker. The URL <strong>must</strong> include the
cgi-bin part or anything else that is required to get to the home page of
the tracker. You <strong>must</strong> include a trailing '/' in the URL.</dd>
<dt><strong>ADMIN_EMAIL</strong> - <tt class="literal"><span class="pre">'roundup-admin&#64;%s'%MAIL_DOMAIN</span></tt></dt>
<dd>The email address that roundup will complain to if it runs into trouble.</dd>
<dt><strong>EMAIL_FROM_TAG</strong> - <tt class="literal"><span class="pre">''</span></tt></dt>
<dd><p class="first">Additional text to include in the &quot;name&quot; part of the <tt class="literal"><span class="pre">From:</span></tt> address used
in nosy messages. If the sending user is &quot;Foo Bar&quot;, the <tt class="literal"><span class="pre">From:</span></tt> line is
usually:</p>
<pre class="literal-block">
&quot;Foo Bar&quot; &lt;issue_tracker&#64;tracker.example&gt;
</pre>
<p>The EMAIL_FROM_TAG goes inside the &quot;Foo Bar&quot; quotes like so:</p>
<pre class="last literal-block">
&quot;Foo Bar EMAIL_FROM_TAG&quot; &lt;issue_tracker&#64;tracker.example&gt;
</pre>
</dd>
<dt><strong>MESSAGES_TO_AUTHOR</strong> - <tt class="literal"><span class="pre">'new'</span></tt>, <tt class="literal"><span class="pre">'yes'</span></tt> or``'no'``</dt>
<dd>Send nosy messages to the author of the message?
If 'new' is used, then the author will only be sent the message when the
message creates a new issue. If 'yes' then the author will always be sent
a copy of the message they wrote.</dd>
<dt><strong>ADD_AUTHOR_TO_NOSY</strong> - <tt class="literal"><span class="pre">'new'</span></tt>, <tt class="literal"><span class="pre">'yes'</span></tt> or <tt class="literal"><span class="pre">'no'</span></tt></dt>
<dd>Does the author of a message get placed on the nosy list automatically?
If <tt class="literal"><span class="pre">'new'</span></tt> is used, then the author will only be added when a message
creates a new issue. If <tt class="literal"><span class="pre">'yes'</span></tt>, then the author will be added on followups
too. If <tt class="literal"><span class="pre">'no'</span></tt>, they're never added to the nosy.</dd>
<dt><strong>ADD_RECIPIENTS_TO_NOSY</strong> - <tt class="literal"><span class="pre">'new'</span></tt>, <tt class="literal"><span class="pre">'yes'</span></tt> or <tt class="literal"><span class="pre">'no'</span></tt></dt>
<dd>Do the recipients (To:, Cc:) of a message get placed on the nosy list?
If <tt class="literal"><span class="pre">'new'</span></tt> is used, then the recipients will only be added when a message
creates a new issue. If <tt class="literal"><span class="pre">'yes'</span></tt>, then the recipients will be added on
followups too. If <tt class="literal"><span class="pre">'no'</span></tt>, they're never added to the nosy.</dd>
<dt><strong>EMAIL_SIGNATURE_POSITION</strong> - <tt class="literal"><span class="pre">'top'</span></tt>, <tt class="literal"><span class="pre">'bottom'</span></tt> or <tt class="literal"><span class="pre">'none'</span></tt></dt>
<dd>Where to place the email signature in messages that Roundup generates.</dd>
<dt><strong>EMAIL_KEEP_QUOTED_TEXT</strong> - <tt class="literal"><span class="pre">'yes'</span></tt> or <tt class="literal"><span class="pre">'no'</span></tt></dt>
<dd>Keep email citations. Citations are the part of e-mail which the sender has
quoted in their reply to previous e-mail.</dd>
<dt><strong>EMAIL_LEAVE_BODY_UNCHANGED</strong> - <tt class="literal"><span class="pre">'no'</span></tt></dt>
<dd>Preserve the email body as is. Enabiling this will cause the entire message
body to be stored, including all citations and signatures. It should be
either <tt class="literal"><span class="pre">'yes'</span></tt> or <tt class="literal"><span class="pre">'no'</span></tt>.</dd>
<dt><strong>MAIL_DEFAULT_CLASS</strong> - <tt class="literal"><span class="pre">'issue'</span></tt> or <tt class="literal"><span class="pre">''</span></tt></dt>
<dd>Default class to use in the mailgw if one isn't supplied in email
subjects. To disable, comment out the variable below or leave it blank.</dd>
<dt><strong>EMAIL_CHARSET</strong> - <tt class="literal"><span class="pre">utf-8</span></tt> (or <tt class="literal"><span class="pre">iso-8859-1</span></tt> for Eudora users)</dt>
<dd>Character set to encode email headers with. We use utf-8 by default, as
it's the most flexible. Some mail readers (eg. Eudora) can't cope with
that, so you might need to specify a more limited character set (eg.
'iso-8859-1'.</dd>
</dl>
<p>The default config.py is given below - as you
can see, the MAIL_DOMAIN must be edited before any interaction with the
tracker is attempted.:</p>
<pre class="literal-block">
# roundup home is this package's directory
TRACKER_HOME=os.path.split(__file__)[0]

# The SMTP mail host that roundup will use to send mail
MAILHOST = 'localhost'

# The domain name used for email addresses.
MAIL_DOMAIN = 'your.tracker.email.domain.example'

# This is the directory that the database is going to be stored in
DATABASE = os.path.join(TRACKER_HOME, 'db')

# This is the directory that the HTML templates reside in
TEMPLATES = os.path.join(TRACKER_HOME, 'html')

# A descriptive name for your roundup tracker
TRACKER_NAME = 'Roundup issue tracker'

# The email address that mail to roundup should go to
TRACKER_EMAIL = 'issue_tracker&#64;%s'%MAIL_DOMAIN

# The web address that the tracker is viewable at. This will be
# included in information sent to users of the tracker. The URL MUST
# include the cgi-bin part or anything else that is required to get
# to the home page of the tracker. You MUST include a trailing '/'
# in the URL.
TRACKER_WEB = 'http://tracker.example/cgi-bin/roundup.cgi/bugs/'

# The email address that roundup will complain to if it runs into
# trouble
ADMIN_EMAIL = 'roundup-admin&#64;%s'%MAIL_DOMAIN

# Additional text to include in the &quot;name&quot; part of the From: address
# used in nosy messages. If the sending user is &quot;Foo Bar&quot;, the From:
# line is usually: &quot;Foo Bar&quot; &lt;issue_tracker&#64;tracker.example&gt;
# the EMAIL_FROM_TAG goes inside the &quot;Foo Bar&quot; quotes like so:
#    &quot;Foo Bar EMAIL_FROM_TAG&quot; &lt;issue_tracker&#64;tracker.example&gt;
EMAIL_FROM_TAG = &quot;&quot;

# Send nosy messages to the author of the message
MESSAGES_TO_AUTHOR = 'no'           # either 'yes' or 'no'

# Does the author of a message get placed on the nosy list
# automatically? If 'new' is used, then the author will only be
# added when a message creates a new issue. If 'yes', then the
# author will be added on followups too. If 'no', they're never
# added to the nosy.
ADD_AUTHOR_TO_NOSY = 'new'          # one of 'yes', 'no', 'new'

# Do the recipients (To:, Cc:) of a message get placed on the nosy
# list? If 'new' is used, then the recipients will only be added
# when a message creates a new issue. If 'yes', then the recipients
# will be added on followups too. If 'no', they're never added to
# the nosy.
ADD_RECIPIENTS_TO_NOSY = 'new'      # either 'yes', 'no', 'new'

# Where to place the email signature
EMAIL_SIGNATURE_POSITION = 'bottom' # one of 'top', 'bottom', 'none'

# Keep email citations
EMAIL_KEEP_QUOTED_TEXT = 'no'       # either 'yes' or 'no'

# Preserve the email body as is
EMAIL_LEAVE_BODY_UNCHANGED = 'no'   # either 'yes' or 'no'

# Default class to use in the mailgw if one isn't supplied in email
# subjects. To disable, comment out the variable below or leave it
# blank. Examples:
MAIL_DEFAULT_CLASS = 'issue'   # use &quot;issue&quot; class by default
#MAIL_DEFAULT_CLASS = ''        # disable (or just comment the var out)

# Character set to encode email headers with. We use utf-8 by default, as
# it's the most flexible. Some mail readers (eg. Eudora) can't cope with
# that, so you might need to specify a more limited character set (eg.
# 'iso-8859-1'.
EMAIL_CHARSET = 'utf-8'
#EMAIL_CHARSET = 'iso-8859-1'   # use this instead for Eudora users

# 
# SECURITY DEFINITIONS
#
# define the Roles that a user gets when they register with the
# tracker these are a comma-separated string of role names (e.g.
# 'Admin,User')
NEW_WEB_USER_ROLES = 'User'
NEW_EMAIL_USER_ROLES = 'User'
</pre>
</div>
<div class="section" id="tracker-schema">
<h1><a class="toc-backref" href="#id5" name="tracker-schema">Tracker Schema</a></h1>
<dl>
<dt>Note: if you modify the schema, you'll most likely need to edit the</dt>
<dd><a class="reference" href="#web-interface">web interface</a> HTML template files and <a class="reference" href="#detectors">detectors</a> to reflect
your changes.</dd>
</dl>
<p>A tracker schema defines what data is stored in the tracker's database.
Schemas are defined using Python code in the <tt class="literal"><span class="pre">dbinit.py</span></tt> module of your
tracker. The &quot;classic&quot; schema looks like this (see below for the meaning
of <tt class="literal"><span class="pre">'setkey'</span></tt>):</p>
<pre class="literal-block">
pri = Class(db, &quot;priority&quot;, name=String(), order=String())
pri.setkey(&quot;name&quot;)

stat = Class(db, &quot;status&quot;, name=String(), order=String())
stat.setkey(&quot;name&quot;)

keyword = Class(db, &quot;keyword&quot;, name=String())
keyword.setkey(&quot;name&quot;)

user = Class(db, &quot;user&quot;, username=String(), organisation=String(),
    password=String(), address=String(), realname=String(),
    phone=String())
user.setkey(&quot;username&quot;)

msg = FileClass(db, &quot;msg&quot;, author=Link(&quot;user&quot;), summary=String(),
    date=Date(), recipients=Multilink(&quot;user&quot;),
    files=Multilink(&quot;file&quot;))

file = FileClass(db, &quot;file&quot;, name=String(), type=String())

issue = IssueClass(db, &quot;issue&quot;, topic=Multilink(&quot;keyword&quot;),
    status=Link(&quot;status&quot;), assignedto=Link(&quot;user&quot;),
    priority=Link(&quot;priority&quot;))
issue.setkey('title')
</pre>
<div class="section" id="what-you-can-t-do-to-the-schema">
<h2><a name="what-you-can-t-do-to-the-schema">What you can't do to the schema</a></h2>
<p>You must never:</p>
<dl>
<dt><strong>Remove the users class</strong></dt>
<dd>This class is the only <em>required</em> class in Roundup. Similarly, its
username, password and address properties must never be removed.</dd>
<dt><strong>Change the type of a property</strong></dt>
<dd>Property types must <em>never</em> be changed - the database simply doesn't take
this kind of action into account. Note that you can't just remove a
property and re-add it as a new type either. If you wanted to make the
assignedto property a Multilink, you'd need to create a new property
assignedto_list and remove the old assignedto property.</dd>
</dl>
</div>
<div class="section" id="what-you-can-do-to-the-schema">
<h2><a name="what-you-can-do-to-the-schema">What you can do to the schema</a></h2>
<p>Your schema may be changed at any time before or after the tracker has been
initialised (or used). You may:</p>
<dl>
<dt><strong>Add new properties to classes, or add whole new classes</strong></dt>
<dd>This is painless and easy to do - there are generally no repurcussions
from adding new information to a tracker's schema.</dd>
<dt><strong>Remove properties</strong></dt>
<dd>Removing properties is a little more tricky - you need to make sure that
the property is no longer used in the <a class="reference" href="#web-interface">web interface</a> <em>or</em> by the
<a class="reference" href="#detectors">detectors</a>.</dd>
</dl>
</div>
<div class="section" id="classes-and-properties-creating-a-new-information-store">
<h2><a name="classes-and-properties-creating-a-new-information-store">Classes and Properties - creating a new information store</a></h2>
<p>In the tracker above, we've defined 7 classes of information:</p>
<blockquote>
<dl>
<dt>priority</dt>
<dd>Defines the possible levels of urgency for issues.</dd>
<dt>status</dt>
<dd>Defines the possible states of processing the issue may be in.</dd>
<dt>keyword</dt>
<dd>Initially empty, will hold keywords useful for searching issues.</dd>
<dt>user</dt>
<dd>Initially holding the &quot;admin&quot; user, will eventually have an entry
for all users using roundup.</dd>
<dt>msg</dt>
<dd>Initially empty, will hold all e-mail messages sent to or
generated by roundup.</dd>
<dt>file</dt>
<dd>Initially empty, will hold all files attached to issues.</dd>
<dt>issue</dt>
<dd>Initially empty, this is where the issue information is stored.</dd>
</dl>
</blockquote>
<p>We define the &quot;priority&quot; and &quot;status&quot; classes to allow two things:
reduction in the amount of information stored on the issue and more
powerful, accurate searching of issues by priority and status. By only
requiring a link on the issue (which is stored as a single number) we
reduce the chance that someone mis-types a priority or status - or
simply makes a new one up.</p>
<div class="section" id="class-and-items">
<h3><a name="class-and-items">Class and Items</a></h3>
<p>A Class defines a particular class (or type) of data that will be stored
in the database. A class comprises one or more properties, which gives
the information about the class items.</p>
<p>The actual data entered into the database, using <tt class="literal"><span class="pre">class.create()</span></tt>, are
called items. They have a special immutable property called <tt class="literal"><span class="pre">'id'</span></tt>. We
sometimes refer to this as the <em>itemid</em>.</p>
</div>
<div class="section" id="properties">
<h3><a name="properties">Properties</a></h3>
<p>A Class is comprised of one or more properties of the following types:</p>
<ul class="simple">
<li>String properties are for storing arbitrary-length strings.</li>
<li>Password properties are for storing encoded arbitrary-length strings.
The default encoding is defined on the <tt class="literal"><span class="pre">roundup.password.Password</span></tt>
class.</li>
<li>Date properties store date-and-time stamps. Their values are Timestamp
objects.</li>
<li>Number properties store numeric values.</li>
<li>Boolean properties store on/off, yes/no, true/false values.</li>
<li>A Link property refers to a single other item selected from a
specified class. The class is part of the property; the value is an
integer, the id of the chosen item.</li>
<li>A Multilink property refers to possibly many items in a specified
class. The value is a list of integers.</li>
</ul>
</div>
<div class="section" id="fileclass">
<h3><a name="fileclass">FileClass</a></h3>
<p>FileClasses save their &quot;content&quot; attribute off in a separate file from
the rest of the database. This reduces the number of large entries in
the database, which generally makes databases more efficient, and also
allows us to use command-line tools to operate on the files. They are
stored in the files sub-directory of the <tt class="literal"><span class="pre">'db'</span></tt> directory in your
tracker.</p>
</div>
<div class="section" id="issueclass">
<h3><a name="issueclass">IssueClass</a></h3>
<p>IssueClasses automatically include the &quot;messages&quot;, &quot;files&quot;, &quot;nosy&quot;, and
&quot;superseder&quot; properties.</p>
<p>The messages and files properties list the links to the messages and
files related to the issue. The nosy property is a list of links to
users who wish to be informed of changes to the issue - they get &quot;CC'ed&quot;
e-mails when messages are sent to or generated by the issue. The nosy
reactor (in the <tt class="literal"><span class="pre">'detectors'</span></tt> directory) handles this action. The
superseder link indicates an issue which has superseded this one.</p>
<p>They also have the dynamically generated &quot;creation&quot;, &quot;activity&quot; and
&quot;creator&quot; properties.</p>
<p>The value of the &quot;creation&quot; property is the date when an item was
created, and the value of the &quot;activity&quot; property is the date when any
property on the item was last edited (equivalently, these are the dates
on the first and last records in the item's journal). The &quot;creator&quot;
property holds a link to the user that created the issue.</p>
</div>
<div class="section" id="setkey-property">
<h3><a name="setkey-property">setkey(property)</a></h3>
<p>Select a String property of the class to be the key property. The key
property must be unique, and allows references to the items in the class
by the content of the key property. That is, we can refer to users by
their username: for example, let's say that there's an issue in roundup,
issue 23. There's also a user, richard, who happens to be user 2. To
assign an issue to him, we could do either of:</p>
<pre class="literal-block">
roundup-admin set issue23 assignedto=2
</pre>
<p>or:</p>
<pre class="literal-block">
roundup-admin set issue23 assignedto=richard
</pre>
<p>Note, the same thing can be done in the web and e-mail interfaces.</p>
<p>If a class does not have an &quot;order&quot; property, the key is also used to
sort instances of the class when it is rendered in the user interface.
(If a class has no &quot;order&quot; property, sorting is by the labelproperty of
the class. This is computed, in order of precedence, as the key, the
&quot;name&quot;, the &quot;title&quot;, or the first property alphabetically.)</p>
</div>
<div class="section" id="create-information">
<h3><a name="create-information">create(information)</a></h3>
<p>Create an item in the database. This is generally used to create items
in the &quot;definitional&quot; classes like &quot;priority&quot; and &quot;status&quot;.</p>
</div>
</div>
<div class="section" id="examples-of-adding-to-your-schema">
<h2><a name="examples-of-adding-to-your-schema">Examples of adding to your schema</a></h2>
<p>TODO</p>
</div>
</div>
<div class="section" id="detectors-adding-behaviour-to-your-tracker">
<h1><a class="toc-backref" href="#id6" name="detectors-adding-behaviour-to-your-tracker">Detectors - adding behaviour to your tracker</a></h1>
<a class="target" id="detectors" name="detectors"></a><p>Detectors are initialised every time you open your tracker database, so
you're free to add and remove them any time, even after the database is
initialised via the &quot;roundup-admin initialise&quot; command.</p>
<p>The detectors in your tracker fire <em>before</em> (<strong>auditors</strong>) and <em>after</em>
(<strong>reactors</strong>) changes to the contents of your database. They are Python
modules that sit in your tracker's <tt class="literal"><span class="pre">detectors</span></tt> directory. You will
have some installed by default - have a look. You can write new
detectors or modify the existing ones. The existing detectors installed
for you are:</p>
<dl>
<dt><strong>nosyreaction.py</strong></dt>
<dd>This provides the automatic nosy list maintenance and email sending.
The nosy reactor (<tt class="literal"><span class="pre">nosyreaction</span></tt>) fires when new messages are added
to issues. The nosy auditor (<tt class="literal"><span class="pre">updatenosy</span></tt>) fires when issues are
changed, and figures out what changes need to be made to the nosy list
(such as adding new authors, etc.)</dd>
<dt><strong>statusauditor.py</strong></dt>
<dd>This provides the <tt class="literal"><span class="pre">chatty</span></tt> auditor which changes the issue status
from <tt class="literal"><span class="pre">unread</span></tt> or <tt class="literal"><span class="pre">closed</span></tt> to <tt class="literal"><span class="pre">chatting</span></tt> if new messages appear.
It also provides the <tt class="literal"><span class="pre">presetunread</span></tt> auditor which pre-sets the
status to <tt class="literal"><span class="pre">unread</span></tt> on new items if the status isn't explicitly
defined.</dd>
<dt><strong>messagesummary.py</strong></dt>
<dd>Generates the <tt class="literal"><span class="pre">summary</span></tt> property for new messages based on the message
content.</dd>
<dt><strong>userauditor.py</strong></dt>
<dd>Verifies the content of some of the user fields (email addresses and
roles lists).</dd>
</dl>
<p>If you don't want this default behaviour, you're completely free to change
or remove these detectors.</p>
<p>See the detectors section in the <a class="reference" href="design.html">design document</a> for details of the
interface for detectors.</p>
<p>Sample additional detectors that have been found useful will appear in
the <tt class="literal"><span class="pre">'detectors'</span></tt> directory of the Roundup distribution. If you want
to use one, copy it to the <tt class="literal"><span class="pre">'detectors'</span></tt> of your tracker instance:</p>
<dl>
<dt><strong>newissuecopy.py</strong></dt>
<dd><p class="first">This detector sends an email to a team address whenever a new issue is
created. The address is hard-coded into the detector, so edit it
before you use it (look for the text <a class="reference" href="mailto:'team&#64;team.host">'team&#64;team.host</a>') or you'll get
email errors!</p>
<p>The detector code:</p>
<pre class="last literal-block">
from roundup import roundupdb

def newissuecopy(db, cl, nodeid, oldvalues):
    ''' Copy a message about new issues to a team address.
    '''
    # so use all the messages in the create
    change_note = cl.generateCreateNote(nodeid)

    # send a copy to the nosy list
    for msgid in cl.get(nodeid, 'messages'):
        try:
            # note: last arg must be a list
            cl.send_message(nodeid, msgid, change_note,
                ['team&#64;team.host'])
        except roundupdb.MessageSendError, message:
            raise roundupdb.DetectorError, message

def init(db):
    db.issue.react('create', newissuecopy)
</pre>
</dd>
</dl>
</div>
<div class="section" id="database-content">
<h1><a class="toc-backref" href="#id7" name="database-content">Database Content</a></h1>
<dl>
<dt>Note: if you modify the content of definitional classes, you'll most</dt>
<dd>likely need to edit the tracker <a class="reference" href="#detectors">detectors</a> to reflect your
changes.</dd>
</dl>
<p>Customisation of the special &quot;definitional&quot; classes (eg. status,
priority, resolution, ...) may be done either before or after the
tracker is initialised. The actual method of doing so is completely
different in each case though, so be careful to use the right one.</p>
<dl>
<dt><strong>Changing content before tracker initialisation</strong></dt>
<dd>Edit the dbinit module in your tracker to alter the items created in
using the <tt class="literal"><span class="pre">create()</span></tt> methods.</dd>
<dt><strong>Changing content after tracker initialisation</strong></dt>
<dd><p class="first">As the &quot;admin&quot; user, click on the &quot;class list&quot; link in the web
interface to bring up a list of all database classes. Click on the
name of the class you wish to change the content of.</p>
<p class="last">You may also use the <tt class="literal"><span class="pre">roundup-admin</span></tt> interface's create, set and
retire methods to add, alter or remove items from the classes in
question.</p>
</dd>
</dl>
<p>See &quot;<a class="reference" href="#adding-a-new-field-to-the-classic-schema">adding a new field to the classic schema</a>&quot; for an example that
requires database content changes.</p>
</div>
<div class="section" id="access-controls">
<h1><a class="toc-backref" href="#id8" name="access-controls">Access Controls</a></h1>
<p>A set of Permissions is built into the security module by default:</p>
<ul class="simple">
<li>Edit (everything)</li>
<li>View (everything)</li>
</ul>
<p>The default interfaces define:</p>
<ul class="simple">
<li>Web Registration</li>
<li>Web Access</li>
<li>Web Roles</li>
<li>Email Registration</li>
<li>Email Access</li>
</ul>
<p>These are hooked into the default Roles:</p>
<ul class="simple">
<li>Admin (Edit everything, View everything, Web Roles)</li>
<li>User (Web Access, Email Access)</li>
<li>Anonymous (Web Registration, Email Registration)</li>
</ul>
<p>And finally, the &quot;admin&quot; user gets the &quot;Admin&quot; Role, and the &quot;anonymous&quot;
user gets &quot;Anonymous&quot; assigned when the database is initialised on
installation. The two default schemas then define:</p>
<ul class="simple">
<li>Edit issue, View issue (both)</li>
<li>Edit file, View file (both)</li>
<li>Edit msg, View msg (both)</li>
<li>Edit support, View support (extended only)</li>
</ul>
<p>and assign those Permissions to the &quot;User&quot; Role. Put together, these
settings appear in the <tt class="literal"><span class="pre">open()</span></tt> function of the tracker <tt class="literal"><span class="pre">dbinit.py</span></tt>
(the following is taken from the &quot;minimal&quot; template's <tt class="literal"><span class="pre">dbinit.py</span></tt>):</p>
<pre class="literal-block">
#
# SECURITY SETTINGS
#
# new permissions for this schema
for cl in ('user', ):
    db.security.addPermission(name=&quot;Edit&quot;, klass=cl,
        description=&quot;User is allowed to edit &quot;+cl)
    db.security.addPermission(name=&quot;View&quot;, klass=cl,
        description=&quot;User is allowed to access &quot;+cl)

# and give the regular users access to the web and email interface
p = db.security.getPermission('Web Access')
db.security.addPermissionToRole('User', p)
p = db.security.getPermission('Email Access')
db.security.addPermissionToRole('User', p)

# May users view other user information? Comment these lines out
# if you don't want them to
p = db.security.getPermission('View', 'user')
db.security.addPermissionToRole('User', p)

# Assign the appropriate permissions to the anonymous user's
# Anonymous role. Choices here are:
# - Allow anonymous users to register through the web
p = db.security.getPermission('Web Registration')
db.security.addPermissionToRole('Anonymous', p)
# - Allow anonymous (new) users to register through the email
#   gateway
p = db.security.getPermission('Email Registration')
db.security.addPermissionToRole('Anonymous', p)
</pre>
<div class="section" id="new-user-roles">
<h2><a name="new-user-roles">New User Roles</a></h2>
<p>New users are assigned the Roles defined in the config file as:</p>
<ul class="simple">
<li>NEW_WEB_USER_ROLES</li>
<li>NEW_EMAIL_USER_ROLES</li>
</ul>
</div>
<div class="section" id="changing-access-controls">
<h2><a name="changing-access-controls">Changing Access Controls</a></h2>
<p>You may alter the configuration variables to change the Role that new
web or email users get, for example to not give them access to the web
interface if they register through email.</p>
<p>You may use the <tt class="literal"><span class="pre">roundup-admin</span></tt> &quot;<tt class="literal"><span class="pre">security</span></tt>&quot; command to display the
current Role and Permission configuration in your tracker.</p>
<div class="section" id="adding-a-new-permission">
<h3><a name="adding-a-new-permission">Adding a new Permission</a></h3>
<p>When adding a new Permission, you will need to:</p>
<ol class="arabic simple">
<li>add it to your tracker's dbinit so it is created</li>
<li>enable it for the Roles that should have it (verify with
&quot;<tt class="literal"><span class="pre">roundup-admin</span> <span class="pre">security</span></tt>&quot;)</li>
<li>add it to the relevant HTML interface templates</li>
<li>add it to the appropriate xxxPermission methods on in your tracker
interfaces module</li>
</ol>
</div>
<div class="section" id="example-scenarios">
<h3><a name="example-scenarios">Example Scenarios</a></h3>
<dl>
<dt><strong>automatic registration of users in the e-mail gateway</strong></dt>
<dd>By giving the &quot;anonymous&quot; user the &quot;Email Registration&quot; Role, any
unidentified user will automatically be registered with the tracker
(with no password, so they won't be able to log in through the web
until an admin sets their password). Note: this is the default
behaviour in the tracker templates that ship with Roundup.</dd>
<dt><strong>anonymous access through the e-mail gateway</strong></dt>
<dd>Give the &quot;anonymous&quot; user the &quot;Email Access&quot; and (&quot;Edit&quot;, &quot;issue&quot;)
Roles but do not not give them the &quot;Email Registration&quot; Role. This
means that when an unknown user sends email into the tracker, they're
automatically logged in as &quot;anonymous&quot;. Since they don't have the
&quot;Email Registration&quot; Role, they won't be automatically registered, but
since &quot;anonymous&quot; has permission to use the gateway, they'll still be
able to submit issues. Note that the Sender information - their email
address - will not be available - they're <em>anonymous</em>.</dd>
<dt><strong>only developers may be assigned issues</strong></dt>
<dd>Create a new Permission called &quot;Fixer&quot; for the &quot;issue&quot; class. Create a
new Role &quot;Developer&quot; which has that Permission, and assign that to the
appropriate users. Filter the list of users available in the assignedto
list to include only those users. Enforce the Permission with an
auditor. See the example 
<a class="reference" href="#restricting-the-list-of-users-that-are-assignable-to-a-task">restricting the list of users that are assignable to a task</a>.</dd>
<dt><strong>only managers may sign off issues as complete</strong></dt>
<dd><p class="first">Create a new Permission called &quot;Closer&quot; for the &quot;issue&quot; class. Create a
new Role &quot;Manager&quot; which has that Permission, and assign that to the
appropriate users. In your web interface, only display the &quot;resolved&quot;
issue state option when the user has the &quot;Closer&quot; Permissions. Enforce
the Permission with an auditor. This is very similar to the previous
example, except that the web interface check would look like:</p>
<pre class="last literal-block">
&lt;option tal:condition=&quot;python:request.user.hasPermission('Closer')&quot;
        value=&quot;resolved&quot;&gt;Resolved&lt;/option&gt;
</pre>
</dd>
<dt><strong>don't give web access to users who register through email</strong></dt>
<dd>Create a new Role called &quot;Email User&quot; which has all the Permissions of
the normal &quot;User&quot; Role minus the &quot;Web Access&quot; Permission. This will
allow users to send in emails to the tracker, but not access the web
interface.</dd>
<dt><strong>let some users edit the details of all users</strong></dt>
<dd><p class="first">Create a new Role called &quot;User Admin&quot; which has the Permission for
editing users:</p>
<pre class="literal-block">
db.security.addRole(name='User Admin', description='Managing users')
p = db.security.getPermission('Edit', 'user')
db.security.addPermissionToRole('User Admin', p)
</pre>
<p class="last">and assign the Role to the users who need the permission.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="section" id="web-interface">
<h1><a class="toc-backref" href="#id9" name="web-interface">Web Interface</a></h1>
<div class="contents topic" id="id11">
<ul class="simple">
<li><a class="reference" href="#repercussions-of-changing-the-tracker-schema" id="id12" name="id12">Repercussions of changing the tracker schema</a></li>
<li><a class="reference" href="#how-requests-are-processed" id="id13" name="id13">How requests are processed</a></li>
<li><a class="reference" href="#determining-web-context" id="id14" name="id14">Determining web context</a></li>
<li><a class="reference" href="#performing-actions-in-web-requests" id="id15" name="id15">Performing actions in web requests</a></li>
<li><a class="reference" href="#special-form-variables" id="id16" name="id16">Special form variables</a></li>
<li><a class="reference" href="#default-templates" id="id17" name="id17">Default templates</a></li>
<li><a class="reference" href="#how-the-templates-work" id="id18" name="id18">How the templates work</a></li>
<li><a class="reference" href="#information-available-to-templates" id="id19" name="id19">Information available to templates</a></li>
<li><a class="reference" href="#displaying-properties" id="id20" name="id20">Displaying Properties</a></li>
<li><a class="reference" href="#index-views" id="id21" name="id21">Index Views</a></li>
<li><a class="reference" href="#searching-views" id="id22" name="id22">Searching Views</a></li>
<li><a class="reference" href="#item-views" id="id23" name="id23">Item Views</a></li>
<li><a class="reference" href="#defining-new-web-actions" id="id24" name="id24">Defining new web actions</a></li>
</ul>
</div>
<p>The web interface is provided by the <tt class="literal"><span class="pre">roundup.cgi.client</span></tt> module and
is used by <tt class="literal"><span class="pre">roundup.cgi</span></tt>, <tt class="literal"><span class="pre">roundup-server</span></tt> and <tt class="literal"><span class="pre">ZRoundup</span></tt>
(<tt class="literal"><span class="pre">ZRoundup</span></tt>  is broken, until further notice). In all cases, we
determine which tracker is being accessed (the first part of the URL
path inside the scope of the CGI handler) and pass control on to the
tracker <tt class="literal"><span class="pre">interfaces.Client</span></tt> class - which uses the <tt class="literal"><span class="pre">Client</span></tt> class
from <tt class="literal"><span class="pre">roundup.cgi.client</span></tt> - which handles the rest of the access
through its <tt class="literal"><span class="pre">main()</span></tt> method. This means that you can do pretty much
anything you want as a web interface to your tracker.</p>
<div class="section" id="repercussions-of-changing-the-tracker-schema">
<h2><a class="toc-backref" href="#id12" name="repercussions-of-changing-the-tracker-schema">Repercussions of changing the tracker schema</a></h2>
<p>If you choose to change the <a class="reference" href="#tracker-schema">tracker schema</a> you will need to ensure
the web interface knows about it:</p>
<ol class="arabic simple">
<li>Index, item and search pages for the relevant classes may need to
have properties added or removed,</li>
<li>The &quot;page&quot; template may require links to be changed, as might the
&quot;home&quot; page's content arguments.</li>
</ol>
</div>
<div class="section" id="how-requests-are-processed">
<h2><a class="toc-backref" href="#id13" name="how-requests-are-processed">How requests are processed</a></h2>
<p>The basic processing of a web request proceeds as follows:</p>
<ol class="arabic simple">
<li>figure out who we are, defaulting to the &quot;anonymous&quot; user</li>
<li>figure out what the request is for - we call this the &quot;context&quot;</li>
<li>handle any requested action (item edit, search, ...)</li>
<li>render the template requested by the context, resulting in HTML
output</li>
</ol>
<p>In some situations, exceptions occur:</p>
<ul>
<li><p class="first">HTTP Redirect  (generally raised by an action)</p>
</li>
<li><dl class="first">
<dt>SendFile       (generally raised by <tt class="literal"><span class="pre">determine_context</span></tt>)</dt>
<dd><p class="first last">here we serve up a FileClass &quot;content&quot; property</p>
</dd>
</dl>
</li>
<li><dl class="first">
<dt>SendStaticFile (generally raised by <tt class="literal"><span class="pre">determine_context</span></tt>)</dt>
<dd><p class="first last">here we serve up a file from the tracker &quot;html&quot; directory</p>
</dd>
</dl>
</li>
<li><dl class="first">
<dt>Unauthorised   (generally raised by an action)</dt>
<dd><p class="first last">here the action is cancelled, the request is rendered and an error
message is displayed indicating that permission was not granted for
the action to take place</p>
</dd>
</dl>
</li>
<li><dl class="first">
<dt>NotFound       (raised wherever it needs to be)</dt>
<dd><p class="first last">this exception percolates up to the CGI interface that called the
client</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="determining-web-context">
<h2><a class="toc-backref" href="#id14" name="determining-web-context">Determining web context</a></h2>
<p>To determine the &quot;context&quot; of a request, we look at the URL and the
special request variable <tt class="literal"><span class="pre">&#64;template</span></tt>. The URL path after the tracker
identifier is examined. Typical URL paths look like:</p>
<ol class="arabic simple">
<li><tt class="literal"><span class="pre">/tracker/issue</span></tt></li>
<li><tt class="literal"><span class="pre">/tracker/issue1</span></tt></li>
<li><tt class="literal"><span class="pre">/tracker/_file/style.css</span></tt></li>
<li><tt class="literal"><span class="pre">/cgi-bin/roundup.cgi/tracker/file1</span></tt></li>
<li><tt class="literal"><span class="pre">/cgi-bin/roundup.cgi/tracker/file1/kitten.png</span></tt></li>
</ol>
<p>where the &quot;tracker identifier&quot; is &quot;tracker&quot; in the above cases. That means
we're looking at &quot;issue&quot;, &quot;issue1&quot;, &quot;_file/style.css&quot;, &quot;file1&quot; and
&quot;file1/kitten.png&quot; in the cases above. The path is generally only one
entry long - longer paths are handled differently.</p>
<ol class="loweralpha simple">
<li>if there is no path, then we are in the &quot;home&quot; context.</li>
<li>if the path starts with &quot;_file&quot; (as in example 3,
&quot;/tracker/_file/style.css&quot;), then the additional path entry,
&quot;style.css&quot; specifies the filename of a static file we're to serve up
from the tracker &quot;html&quot; directory. Raises a SendStaticFile exception.</li>
<li>if there is something in the path (as in example 1, &quot;issue&quot;), it
identifies the tracker class we're to display.</li>
<li>if the path is an item designator (as in examples 2 and 4, &quot;issue1&quot;
and &quot;file1&quot;), then we're to display a specific item.</li>
<li>if the path starts with an item designator and is longer than one
entry (as in example 5, &quot;file1/kitten.png&quot;), then we're assumed to be
handling an item of a <tt class="literal"><span class="pre">FileClass</span></tt>, and the extra path information
gives the filename that the client is going to label the download
with (i.e. &quot;file1/kitten.png&quot; is nicer to download than &quot;file1&quot;).
This raises a <tt class="literal"><span class="pre">SendFile</span></tt> exception.</li>
</ol>
<p>Both b. and e. stop before we bother to determine the template we're
going to use. That's because they don't actually use templates.</p>
<p>The template used is specified by the <tt class="literal"><span class="pre">&#64;template</span></tt> CGI variable, which
defaults to:</p>
<ul class="simple">
<li>only classname suplied:        &quot;index&quot;</li>
<li>full item designator supplied: &quot;item&quot;</li>
</ul>
</div>
<div class="section" id="performing-actions-in-web-requests">
<h2><a class="toc-backref" href="#id15" name="performing-actions-in-web-requests">Performing actions in web requests</a></h2>
<p>When a user requests a web page, they may optionally also request for an
action to take place. As described in <a class="reference" href="#how-requests-are-processed">how requests are processed</a>, the
action is performed before the requested page is generated. Actions are
triggered by using a <tt class="literal"><span class="pre">&#64;action</span></tt> CGI variable, where the value is one
of:</p>
<dl>
<dt><strong>login</strong></dt>
<dd>Attempt to log a user in.</dd>
<dt><strong>logout</strong></dt>
<dd>Log the user out - make them &quot;anonymous&quot;.</dd>
<dt><strong>register</strong></dt>
<dd>Attempt to create a new user based on the contents of the form and then
log them in.</dd>
<dt><strong>edit</strong></dt>
<dd>Perform an edit of an item in the database. There are some <a class="reference" href="#special-form-variables">special form
variables</a> you may use.</dd>
<dt><strong>new</strong></dt>
<dd>Add a new item to the database. You may use the same <a class="reference" href="#special-form-variables">special form
variables</a> as in the &quot;edit&quot; action.</dd>
<dt><strong>retire</strong></dt>
<dd>Retire the item in the database.</dd>
<dt><strong>editCSV</strong></dt>
<dd>Performs an edit of all of a class' items in one go. See also the
<em>class</em>.csv templating method which generates the CSV data to be
edited, and the <tt class="literal"><span class="pre">'_generic.index'</span></tt> template which uses both of these
features.</dd>
<dt><strong>search</strong></dt>
<dd><p class="first">Mangle some of the form variables:</p>
<ul class="last simple">
<li>Set the form &quot;:filter&quot; variable based on the values of the filter
variables - if they're set to anything other than &quot;dontcare&quot; then add
them to :filter.</li>
<li>Also handle the &quot;:queryname&quot; variable and save off the query to the
user's query list.</li>
</ul>
</dd>
</dl>
<p>Each of the actions is implemented by a corresponding <tt class="literal"><span class="pre">*actionAction*</span></tt>
(where &quot;action&quot; is the name of the action) method on the
<tt class="literal"><span class="pre">roundup.cgi.Client</span></tt> class, which also happens to be available in your
tracker instance as <tt class="literal"><span class="pre">interfaces.Client</span></tt>. So if you need to define new
actions, you may add them there (see <a class="reference" href="#defining-new-web-actions">defining new web actions</a>).</p>
<p>Each action also has a corresponding <tt class="literal"><span class="pre">*actionPermission*</span></tt> (where
&quot;action&quot; is the name of the action) method which determines whether the
action is permissible given the current user. The base permission checks
are:</p>
<dl>
<dt><strong>login</strong></dt>
<dd>Determine whether the user has permission to log in. Base behaviour is
to check the user has &quot;Web Access&quot;.</dd>
<dt><strong>logout</strong></dt>
<dd>No permission checks are made.</dd>
<dt><strong>register</strong></dt>
<dd>Determine whether the user has permission to register. Base behaviour
is to check the user has the &quot;Web Registration&quot; Permission.</dd>
<dt><strong>edit</strong></dt>
<dd>Determine whether the user has permission to edit this item. Base
behaviour is to check whether the user can edit this class. If we're
editing the &quot;user&quot; class, users are allowed to edit their own details -
unless they try to edit the &quot;roles&quot; property, which requires the
special Permission &quot;Web Roles&quot;.</dd>
<dt><strong>new</strong></dt>
<dd>Determine whether the user has permission to create (or edit) this
item. Base behaviour is to check the user can edit this class. No
additional property checks are made. Additionally, new user items may
be created if the user has the &quot;Web Registration&quot; Permission.</dd>
<dt><strong>editCSV</strong></dt>
<dd>Determine whether the user has permission to edit this class. Base
behaviour is to check whether the user may edit this class.</dd>
<dt><strong>search</strong></dt>
<dd>Determine whether the user has permission to search this class. Base
behaviour is to check whether the user may view this class.</dd>
</dl>
</div>
<div class="section" id="special-form-variables">
<h2><a class="toc-backref" href="#id16" name="special-form-variables">Special form variables</a></h2>
<p>Item properties and their values are edited with html FORM
variables and their values. You can:</p>
<ul class="simple">
<li>Change the value of some property of the current item.</li>
<li>Create a new item of any class, and edit the new item's
properties,</li>
<li>Attach newly created items to a multilink property of the
current item.</li>
<li>Remove items from a multilink property of the current item.</li>
<li>Specify that some properties are required for the edit
operation to be successful.</li>
</ul>
<p>In the following, &lt;bracketed&gt; values are variable, &quot;&#64;&quot; may be
either &quot;:&quot; or &quot;&#64;&quot;, and other text &quot;required&quot; is fixed.</p>
<p>Most properties are specified as form variables:</p>
<dl>
<dt><tt class="literal"><span class="pre">&lt;propname&gt;</span></tt></dt>
<dd>property on the current context item</dd>
<dt><tt class="literal"><span class="pre">&lt;designator&gt;&quot;&#64;&quot;&lt;propname&gt;</span></tt></dt>
<dd>property on the indicated item (for editing related information)</dd>
</dl>
<p>Designators name a specific item of a class.</p>
<dl>
<dt><tt class="literal"><span class="pre">&lt;classname&gt;&lt;N&gt;</span></tt></dt>
<dd>Name an existing item of class &lt;classname&gt;.</dd>
<dt><tt class="literal"><span class="pre">&lt;classname&gt;&quot;-&quot;&lt;N&gt;</span></tt></dt>
<dd>Name the &lt;N&gt;th new item of class &lt;classname&gt;. If the form
submission is successful, a new item of &lt;classname&gt; is
created. Within the submitted form, a particular
designator of this form always refers to the same new
item.</dd>
</dl>
<p>Once we have determined the &quot;propname&quot;, we look at it to see
if it's special:</p>
<dl>
<dt><tt class="literal"><span class="pre">&#64;required</span></tt></dt>
<dd><p class="first">The associated form value is a comma-separated list of
property names that must be specified when the form is
submitted for the edit operation to succeed.</p>
<p>When the &lt;designator&gt; is missing, the properties are
for the current context item.  When &lt;designator&gt; is
present, they are for the item specified by
&lt;designator&gt;.</p>
<p class="last">The &quot;&#64;required&quot; specifier must come before any of the
properties it refers to are assigned in the form.</p>
</dd>
<dt><tt class="literal"><span class="pre">&#64;remove&#64;&lt;propname&gt;=id(s)</span></tt> or <tt class="literal"><span class="pre">&#64;add&#64;&lt;propname&gt;=id(s)</span></tt></dt>
<dd>The &quot;&#64;add&#64;&quot; and &quot;&#64;remove&#64;&quot; edit actions apply only to
Multilink properties.  The form value must be a
comma-separate list of keys for the class specified by
the simple form variable.  The listed items are added
to (respectively, removed from) the specified
property.</dd>
<dt><tt class="literal"><span class="pre">&#64;link&#64;&lt;propname&gt;=&lt;designator&gt;</span></tt></dt>
<dd>If the edit action is &quot;&#64;link&#64;&quot;, the simple form
variable must specify a Link or Multilink property.
The form value is a comma-separated list of
designators.  The item corresponding to each
designator is linked to the property given by simple
form variable.</dd>
<dt>None of the above (ie. just a simple form value)</dt>
<dd><p class="first">The value of the form variable is converted
appropriately, depending on the type of the property.</p>
<p>For a Link('klass') property, the form value is a
single key for 'klass', where the key field is
specified in dbinit.py.</p>
<p>For a Multilink('klass') property, the form value is a
comma-separated list of keys for 'klass', where the
key field is specified in dbinit.py.</p>
<p>Note that for simple-form-variables specifiying Link
and Multilink properties, the linked-to class must
have a key field.</p>
<p>For a String() property specifying a filename, the
file named by the form value is uploaded. This means we
try to set additional properties &quot;filename&quot; and &quot;type&quot; (if
they are valid for the class).  Otherwise, the property
is set to the form value.</p>
<p class="last">For Date(), Interval(), Boolean(), and Number()
properties, the form value is converted to the
appropriate</p>
</dd>
</dl>
<p>Any of the form variables may be prefixed with a classname or
designator.</p>
<p>Two special form values are supported for backwards compatibility:</p>
<dl>
<dt>&#64;note</dt>
<dd><p class="first">This is equivalent to:</p>
<pre class="literal-block">
&#64;link&#64;messages=msg-1
&#64;msg-1&#64;content=value
</pre>
<p class="last">except that in addition, the &quot;author&quot; and &quot;date&quot; properties of
&quot;msg-1&quot; are set to the userid of the submitter, and the current
time, respectively.</p>
</dd>
<dt>&#64;file</dt>
<dd><p class="first">This is equivalent to:</p>
<pre class="literal-block">
&#64;link&#64;files=file-1
&#64;file-1&#64;content=value
</pre>
<p class="last">The String content value is handled as described above for file
uploads.</p>
</dd>
</dl>
<p>If both the &quot;&#64;note&quot; and &quot;&#64;file&quot; form variables are
specified, the action:</p>
<pre class="literal-block">
&#64;link&#64;msg-1&#64;files=file-1
</pre>
<p>is also performed.</p>
<p>We also check that FileClass items have a &quot;content&quot; property with
actual content, otherwise we remove them from all_props before
returning.</p>
</div>
<div class="section" id="default-templates">
<h2><a class="toc-backref" href="#id17" name="default-templates">Default templates</a></h2>
<p>Most customisation of the web view can be done by modifying the
templates in the tracker <tt class="literal"><span class="pre">'html'</span></tt> directory. There are several types
of files in there. The <em>minimal</em> template includes:</p>
<dl>
<dt><strong>page.html</strong></dt>
<dd>This template usually defines the overall look of your tracker. When
you view an issue, it appears inside this template. When you view an
index, it also appears inside this template. This template defines a
macro called &quot;icing&quot; which is used by almost all other templates as a
coating for their content, using its &quot;content&quot; slot. It also defines
the &quot;head_title&quot; and &quot;body_title&quot; slots to allow setting of the page
title.</dd>
<dt><strong>home.html</strong></dt>
<dd>the default page displayed when no other page is indicated by the user</dd>
<dt><strong>home.classlist.html</strong></dt>
<dd>a special version of the default page that lists the classes in the
tracker</dd>
<dt><strong>classname.item.html</strong></dt>
<dd>displays an item of the <em>classname</em> class</dd>
<dt><strong>classname.index.html</strong></dt>
<dd>displays a list of <em>classname</em> items</dd>
<dt><strong>classname.search.html</strong></dt>
<dd>displays a search page for <em>classname</em> items</dd>
<dt><strong>_generic.index.html</strong></dt>
<dd>used to display a list of items where there is no
<tt class="literal"><span class="pre">*classname*.index</span></tt> available</dd>
<dt><strong>_generic.help.html</strong></dt>
<dd>used to display a &quot;class help&quot; page where there is no
<tt class="literal"><span class="pre">*classname*.help</span></tt></dd>
<dt><strong>user.register.html</strong></dt>
<dd>a special page just for the user class, that renders the registration
page</dd>
<dt><strong>style.css.html</strong></dt>
<dd>a static file that is served up as-is</dd>
</dl>
<p>The <em>classic</em> template has a number of additional templates.</p>
<p>Note: Remember that you can create any template extension you want to,
so if you just want to play around with the templating for new issues,
you can copy the current &quot;issue.item&quot; template to &quot;issue.test&quot;, and then
access the test template using the &quot;&#64;template&quot; URL argument:</p>
<pre class="literal-block">
http://your.tracker.example/tracker/issue?&#64;template=test
</pre>
<p>and it won't affect your users using the &quot;issue.item&quot; template.</p>
</div>
<div class="section" id="how-the-templates-work">
<h2><a class="toc-backref" href="#id18" name="how-the-templates-work">How the templates work</a></h2>
<div class="section" id="basic-templating-actions">
<h3><a name="basic-templating-actions">Basic Templating Actions</a></h3>
<p>Roundup's templates consist of special attributes on the HTML tags.
These attributes form the Template Attribute Language, or TAL. The basic
TAL commands are:</p>
<dl>
<dt><strong>tal:define=&quot;variable expression; variable expression; ...&quot;</strong></dt>
<dd><p class="first">Define a new variable that is local to this tag and its contents. For
example:</p>
<pre class="literal-block">
&lt;html tal:define=&quot;title request/description&quot;&gt;
 &lt;head&gt;&lt;title tal:content=&quot;title&quot;&gt;&lt;/title&gt;&lt;/head&gt;
&lt;/html&gt;
</pre>
<p class="last">In this example, the variable &quot;title&quot; is defined as the result of the
expression &quot;request/description&quot;. The &quot;tal:content&quot; command inside the
&lt;html&gt; tag may then use the &quot;title&quot; variable.</p>
</dd>
<dt><strong>tal:condition=&quot;expression&quot;</strong></dt>
<dd><p class="first">Only keep this tag and its contents if the expression is true. For
example:</p>
<pre class="literal-block">
&lt;p tal:condition=&quot;python:request.user.hasPermission('View', 'issue')&quot;&gt;
 Display some issue information.
&lt;/p&gt;
</pre>
<p class="last">In the example, the &lt;p&gt; tag and its contents are only displayed if
the user has the &quot;View&quot; permission for issues. We consider the number
zero, a blank string, an empty list, and the built-in variable
nothing to be false values. Nearly every other value is true,
including non-zero numbers, and strings with anything in them (even
spaces!).</p>
</dd>
<dt><strong>tal:repeat=&quot;variable expression&quot;</strong></dt>
<dd><p class="first">Repeat this tag and its contents for each element of the sequence
that the expression returns, defining a new local variable and a
special &quot;repeat&quot; variable for each element. For example:</p>
<pre class="literal-block">
&lt;tr tal:repeat=&quot;u user/list&quot;&gt;
 &lt;td tal:content=&quot;u/id&quot;&gt;&lt;/td&gt;
 &lt;td tal:content=&quot;u/username&quot;&gt;&lt;/td&gt;
 &lt;td tal:content=&quot;u/realname&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p class="last">The example would iterate over the sequence of users returned by
&quot;user/list&quot; and define the local variable &quot;u&quot; for each entry.</p>
</dd>
<dt><strong>tal:replace=&quot;expression&quot;</strong></dt>
<dd><p class="first">Replace this tag with the result of the expression. For example:</p>
<pre class="literal-block">
&lt;span tal:replace=&quot;request/user/realname&quot; /&gt;
</pre>
<p class="last">The example would replace the &lt;span&gt; tag and its contents with the
user's realname. If the user's realname was &quot;Bruce&quot;, then the
resultant output would be &quot;Bruce&quot;.</p>
</dd>
<dt><strong>tal:content=&quot;expression&quot;</strong></dt>
<dd><p class="first">Replace the contents of this tag with the result of the expression.
For example:</p>
<pre class="literal-block">
&lt;span tal:content=&quot;request/user/realname&quot;&gt;user's name appears here
&lt;/span&gt;
</pre>
<p class="last">The example would replace the contents of the &lt;span&gt; tag with the
user's realname. If the user's realname was &quot;Bruce&quot; then the
resultant output would be &quot;&lt;span&gt;Bruce&lt;/span&gt;&quot;.</p>
</dd>
<dt><strong>tal:attributes=&quot;attribute expression; attribute expression; ...&quot;</strong></dt>
<dd><p class="first">Set attributes on this tag to the results of expressions. For
example:</p>
<pre class="literal-block">
&lt;a tal:attributes=&quot;href string:user${request/user/id}&quot;&gt;My Details&lt;/a&gt;
</pre>
<p class="last">In the example, the &quot;href&quot; attribute of the &lt;a&gt; tag is set to the
value of the &quot;string:user${request/user/id}&quot; expression, which will
be something like &quot;user123&quot;.</p>
</dd>
<dt><strong>tal:omit-tag=&quot;expression&quot;</strong></dt>
<dd><p class="first">Remove this tag (but not its contents) if the expression is true. For
example:</p>
<pre class="literal-block">
&lt;span tal:omit-tag=&quot;python:1&quot;&gt;Hello, world!&lt;/span&gt;
</pre>
<p>would result in output of:</p>
<pre class="last literal-block">
Hello, world!
</pre>
</dd>
</dl>
<p>Note that the commands on a given tag are evaulated in the order above,
so <em>define</em> comes before <em>condition</em>, and so on.</p>
<p>Additionally, you may include tags such as &lt;tal:block&gt;, which are
removed from output. Its content is kept, but the tag itself is not (so
don't go using any &quot;tal:attributes&quot; commands on it). This is useful for
making arbitrary blocks of HTML conditional or repeatable (very handy
for repeating multiple table rows, which would othewise require an
illegal tag placement to effect the repeat).</p>
</div>
<div class="section" id="templating-expressions">
<h3><a name="templating-expressions">Templating Expressions</a></h3>
<p>The expressions you may use in the attribute values may be one of the
following forms:</p>
<dl>
<dt><strong>Path Expressions</strong> - eg. <tt class="literal"><span class="pre">item/status/checklist</span></tt></dt>
<dd><p class="first">These are object attribute / item accesses. Roughly speaking, the
path <tt class="literal"><span class="pre">item/status/checklist</span></tt> is broken into parts <tt class="literal"><span class="pre">item</span></tt>,
<tt class="literal"><span class="pre">status</span></tt> and <tt class="literal"><span class="pre">checklist</span></tt>. The <tt class="literal"><span class="pre">item</span></tt> part is the root of the
expression. We then look for a <tt class="literal"><span class="pre">status</span></tt> attribute on <tt class="literal"><span class="pre">item</span></tt>, or
failing that, a <tt class="literal"><span class="pre">status</span></tt> item (as in <tt class="literal"><span class="pre">item['status']</span></tt>). If that
fails, the path expression fails. When we get to the end, the object
we're left with is evaluated to get a string - if it is a method, it
is called; if it is an object, it is stringified. Path expressions
may have an optional <tt class="literal"><span class="pre">path:</span></tt> prefix, but they are the default
expression type, so it's not necessary.</p>
<p>If an expression evaluates to <tt class="literal"><span class="pre">default</span></tt>, then the expression is
&quot;cancelled&quot; - whatever HTML already exists in the template will
remain (tag content in the case of <tt class="literal"><span class="pre">tal:content</span></tt>, attributes in the
case of <tt class="literal"><span class="pre">tal:attributes</span></tt>).</p>
<p>If an expression evaluates to <tt class="literal"><span class="pre">nothing</span></tt> then the target of the
expression is removed (tag content in the case of <tt class="literal"><span class="pre">tal:content</span></tt>,
attributes in the case of <tt class="literal"><span class="pre">tal:attributes</span></tt> and the tag itself in
the case of <tt class="literal"><span class="pre">tal:replace</span></tt>).</p>
<p>If an element in the path may not exist, then you can use the <tt class="literal"><span class="pre">|</span></tt>
operator in the expression to provide an alternative. So, the
expression <tt class="literal"><span class="pre">request/form/foo/value</span> <span class="pre">|</span> <span class="pre">default</span></tt> would simply leave
the current HTML in place if the &quot;foo&quot; form variable doesn't exist.</p>
<p class="last">You may use the python function <tt class="literal"><span class="pre">path</span></tt>, as in
<tt class="literal"><span class="pre">path(&quot;item/status&quot;)</span></tt>, to embed path expressions in Python
expressions.</p>
</dd>
<dt><strong>String Expressions</strong> - eg. <tt class="literal"><span class="pre">string:hello</span> <span class="pre">${user/name}</span></tt> </dt>
<dd>These expressions are simple string interpolations - though they can
be just plain strings with no interpolation if you want. The
expression in the <tt class="literal"><span class="pre">${</span> <span class="pre">...</span> <span class="pre">}</span></tt> is just a path expression as above.</dd>
<dt><strong>Python Expressions</strong> - eg. <tt class="literal"><span class="pre">python:</span> <span class="pre">1+1</span></tt> </dt>
<dd>These expressions give the full power of Python. All the &quot;root level&quot;
variables are available, so <tt class="literal"><span class="pre">python:item.status.checklist()</span></tt> would
be equivalent to <tt class="literal"><span class="pre">item/status/checklist</span></tt>, assuming that
<tt class="literal"><span class="pre">checklist</span></tt> is a method.</dd>
</dl>
<p>Modifiers:</p>
<dl>
<dt><strong>structure</strong> - eg. <tt class="literal"><span class="pre">structure</span> <span class="pre">python:msg.content.plain(hyperlink=1)</span></tt></dt>
<dd>The result of expressions are normally <em>escaped</em> to be safe for HTML
display (all &quot;&lt;&quot;, &quot;&gt;&quot; and &quot;&amp;&quot; are turned into special entities). The
<tt class="literal"><span class="pre">structure</span></tt> expression modifier turns off this escaping - the
result of the expression is now assumed to be HTML, which is passed
to the web browser for rendering.</dd>
<dt><strong>not:</strong> - eg. <tt class="literal"><span class="pre">not:python:1=1</span></tt></dt>
<dd>This simply inverts the logical true/false value of another
expression.</dd>
</dl>
</div>
<div class="section" id="template-macros">
<h3><a name="template-macros">Template Macros</a></h3>
<p>Macros are used in Roundup to save us from repeating the same common
page stuctures over and over. The most common (and probably only) macro
you'll use is the &quot;icing&quot; macro defined in the &quot;page&quot; template.</p>
<p>Macros are generated and used inside your templates using special
attributes similar to the <a class="reference" href="#basic-templating-actions">basic templating actions</a>. In this case,
though, the attributes belong to the Macro Expansion Template Attribute
Language, or METAL. The macro commands are:</p>
<dl>
<dt><strong>metal:define-macro=&quot;macro name&quot;</strong></dt>
<dd><p class="first">Define that the tag and its contents are now a macro that may be
inserted into other templates using the <em>use-macro</em> command. For
example:</p>
<pre class="literal-block">
&lt;html metal:define-macro=&quot;page&quot;&gt;
 ...
&lt;/html&gt;
</pre>
<p class="last">defines a macro called &quot;page&quot; using the <tt class="literal"><span class="pre">&lt;html&gt;</span></tt> tag and its
contents. Once defined, macros are stored on the template they're
defined on in the <tt class="literal"><span class="pre">macros</span></tt> attribute. You can access them later on
through the <tt class="literal"><span class="pre">templates</span></tt> variable, eg. the most common
<tt class="literal"><span class="pre">templates/page/macros/icing</span></tt> to access the &quot;page&quot; macro of the
&quot;page&quot; template.</p>
</dd>
<dt><strong>metal:use-macro=&quot;path expression&quot;</strong></dt>
<dd><p class="first">Use a macro, which is identified by the path expression (see above).
This will replace the current tag with the identified macro contents.
For example:</p>
<pre class="last literal-block">
&lt;tal:block metal:use-macro=&quot;templates/page/macros/icing&quot;&gt;
 ...
&lt;/tal:block&gt;

will replace the tag and its contents with the &quot;page&quot; macro of the
&quot;page&quot; template.
</pre>
</dd>
<dt><strong>metal:define-slot=&quot;slot name&quot;</strong> and <strong>metal:fill-slot=&quot;slot name&quot;</strong></dt>
<dd><p class="first">To define <em>dynamic</em> parts of the macro, you define &quot;slots&quot; which may
be filled when the macro is used with a <em>use-macro</em> command. For
example, the <tt class="literal"><span class="pre">templates/page/macros/icing</span></tt> macro defines a slot like
so:</p>
<pre class="literal-block">
&lt;title metal:define-slot=&quot;head_title&quot;&gt;title goes here&lt;/title&gt;
</pre>
<p>In your <em>use-macro</em> command, you may now use a <em>fill-slot</em> command
like this:</p>
<pre class="literal-block">
&lt;title metal:fill-slot=&quot;head_title&quot;&gt;My Title&lt;/title&gt;
</pre>
<p class="last">where the tag that fills the slot completely replaces the one defined
as the slot in the macro.</p>
</dd>
</dl>
<p>Note that you may not mix METAL and TAL commands on the same tag, but
TAL commands may be used freely inside METAL-using tags (so your
<em>fill-slots</em> tags may have all manner of TAL inside them).</p>
</div>
</div>
<div class="section" id="information-available-to-templates">
<h2><a class="toc-backref" href="#id19" name="information-available-to-templates">Information available to templates</a></h2>
<p>Note: this is implemented by
<tt class="literal"><span class="pre">roundup.cgi.templating.RoundupPageTemplate</span></tt></p>
<p>The following variables are available to templates.</p>
<dl>
<dt><strong>context</strong></dt>
<dd>The current context. This is either None, a <a class="reference" href="#hyperdb-class-wrapper">hyperdb class wrapper</a>
or a <a class="reference" href="#hyperdb-item-wrapper">hyperdb item wrapper</a></dd>
<dt><strong>request</strong></dt>
<dd><dl class="first last">
<dt>Includes information about the current request, including:</dt>
<dd><ul class="first last simple">
<li>the current index information (<tt class="literal"><span class="pre">filterspec</span></tt>, <tt class="literal"><span class="pre">filter</span></tt> args,
<tt class="literal"><span class="pre">properties</span></tt>, etc) parsed out of the form.</li>
<li>methods for easy filterspec link generation</li>
<li><em>user</em>, the current user item as an HTMLItem instance</li>
<li><em>form</em>
The current CGI form information as a mapping of form argument name
to value</li>
</ul>
</dd>
</dl>
</dd>
<dt><strong>config</strong></dt>
<dd>This variable holds all the values defined in the tracker config.py
file (eg. TRACKER_NAME, etc.)</dd>
<dt><strong>db</strong></dt>
<dd>The current database, used to access arbitrary database items.</dd>
<dt><strong>templates</strong></dt>
<dd>Access to all the tracker templates by name. Used mainly in
<em>use-macro</em> commands.</dd>
<dt><strong>utils</strong></dt>
<dd>This variable makes available some utility functions like batching.</dd>
<dt><strong>nothing</strong></dt>
<dd><p class="first">This is a special variable - if an expression evaluates to this, then
the tag (in the case of a <tt class="literal"><span class="pre">tal:replace</span></tt>), its contents (in the case
of <tt class="literal"><span class="pre">tal:content</span></tt>) or some attributes (in the case of
<tt class="literal"><span class="pre">tal:attributes</span></tt>) will not appear in the the output. So, for
example:</p>
<pre class="literal-block">
&lt;span tal:attributes=&quot;class nothing&quot;&gt;Hello, World!&lt;/span&gt;
</pre>
<p>would result in:</p>
<pre class="last literal-block">
&lt;span&gt;Hello, World!&lt;/span&gt;
</pre>
</dd>
<dt><strong>default</strong></dt>
<dd><p class="first">Also a special variable - if an expression evaluates to this, then the
existing HTML in the template will not be replaced or removed, it will
remain. So:</p>
<pre class="literal-block">
&lt;span tal:replace=&quot;default&quot;&gt;Hello, World!&lt;/span&gt;
</pre>
<p>would result in:</p>
<pre class="last literal-block">
&lt;span&gt;Hello, World!&lt;/span&gt;
</pre>
</dd>
</dl>
<div class="section" id="the-context-variable">
<h3><a name="the-context-variable">The context variable</a></h3>
<p>The <em>context</em> variable is one of three things based on the current
context (see <a class="reference" href="#determining-web-context">determining web context</a> for how we figure this out):</p>
<ol class="arabic simple">
<li>if we're looking at a &quot;home&quot; page, then it's None</li>
<li>if we're looking at a specific hyperdb class, it's a
<a class="reference" href="#hyperdb-class-wrapper">hyperdb class wrapper</a>.</li>
<li>if we're looking at a specific hyperdb item, it's a
<a class="reference" href="#hyperdb-item-wrapper">hyperdb item wrapper</a>.</li>
</ol>
<p>If the context is not None, we can access the properties of the class or
item. The only real difference between cases 2 and 3 above are:</p>
<ol class="arabic simple">
<li>the properties may have a real value behind them, and this will
appear if the property is displayed through <tt class="literal"><span class="pre">context/property</span></tt> or
<tt class="literal"><span class="pre">context/property/field</span></tt>.</li>
<li>the context's &quot;id&quot; property will be a false value in the second case,
but a real, or true value in the third. Thus we can determine whether
we're looking at a real item from the hyperdb by testing
&quot;context/id&quot;.</li>
</ol>
<div class="section" id="hyperdb-class-wrapper">
<h4><a name="hyperdb-class-wrapper">Hyperdb class wrapper</a></h4>
<p>Note: this is implemented by the <tt class="literal"><span class="pre">roundup.cgi.templating.HTMLClass</span></tt>
class.</p>
<p>This wrapper object provides access to a hyperb class. It is used
primarily in both index view and new item views, but it's also usable
anywhere else that you wish to access information about a class, or the
items of a class, when you don't have a specific item of that class in
mind.</p>
<p>We allow access to properties. There will be no &quot;id&quot; property. The value
accessed through the property will be the current value of the same name
from the CGI form.</p>
<p>There are several methods available on these wrapper objects:</p>
<table class="table" frame="border" rules="all">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr><th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>properties</td>
<td>return a <a class="reference" href="#hyperdb-property-wrapper">hyperdb property wrapper</a> for all of this class's
properties.</td>
</tr>
<tr><td>list</td>
<td>lists all of the active (not retired) items in the class.</td>
</tr>
<tr><td>csv</td>
<td>return the items of this class as a chunk of CSV text.</td>
</tr>
<tr><td>propnames</td>
<td>lists the names of the properties of this class.</td>
</tr>
<tr><td>filter</td>
<td>lists of items from this class, filtered and sorted by the
current <em>request</em> filterspec/filter/sort/group args</td>
</tr>
<tr><td>classhelp</td>
<td>display a link to a javascript popup containing this class'
&quot;help&quot; template.</td>
</tr>
<tr><td>submit</td>
<td>generate a submit button (and action hidden element)</td>
</tr>
<tr><td>renderWith</td>
<td>render this class with the given template.</td>
</tr>
<tr><td>history</td>
<td>returns 'New node - no history' :)</td>
</tr>
<tr><td>is_edit_ok</td>
<td>is the user allowed to Edit the current class?</td>
</tr>
<tr><td>is_view_ok</td>
<td>is the user allowed to View the current class?</td>
</tr>
</tbody>
</table>
<p>Note that if you have a property of the same name as one of the above
methods, you'll need to access it using a python &quot;item access&quot;
expression. For example:</p>
<pre class="literal-block">
python:context['list']
</pre>
<p>will access the &quot;list&quot; property, rather than the list method.</p>
</div>
<div class="section" id="hyperdb-item-wrapper">
<h4><a name="hyperdb-item-wrapper">Hyperdb item wrapper</a></h4>
<p>Note: this is implemented by the <tt class="literal"><span class="pre">roundup.cgi.templating.HTMLItem</span></tt>
class.</p>
<p>This wrapper object provides access to a hyperb item.</p>
<p>We allow access to properties. There will be no &quot;id&quot; property. The value
accessed through the property will be the current value of the same name
from the CGI form.</p>
<p>There are several methods available on these wrapper objects:</p>
<table class="table" frame="border" rules="all">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<thead valign="bottom">
<tr><th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>submit</td>
<td>generate a submit button (and action hidden element)</td>
</tr>
<tr><td>journal</td>
<td>return the journal of the current item (<strong>not
implemented</strong>)</td>
</tr>
<tr><td>history</td>
<td>render the journal of the current item as HTML</td>
</tr>
<tr><td>renderQueryForm</td>
<td>specific to the &quot;query&quot; class - render the search form
for the query</td>
</tr>
<tr><td>hasPermission</td>
<td>specific to the &quot;user&quot; class - determine whether the
user has a Permission</td>
</tr>
<tr><td>is_edit_ok</td>
<td>is the user allowed to Edit the current item?</td>
</tr>
<tr><td>is_view_ok</td>
<td>is the user allowed to View the current item?</td>
</tr>
</tbody>
</table>
<p>Note that if you have a property of the same name as one of the above
methods, you'll need to access it using a python &quot;item access&quot;
expression. For example:</p>
<pre class="literal-block">
python:context['journal']
</pre>
<p>will access the &quot;journal&quot; property, rather than the journal method.</p>
</div>
<div class="section" id="hyperdb-property-wrapper">
<h4><a name="hyperdb-property-wrapper">Hyperdb property wrapper</a></h4>
<p>Note: this is implemented by subclasses of the
<tt class="literal"><span class="pre">roundup.cgi.templating.HTMLProperty</span></tt> class (<tt class="literal"><span class="pre">HTMLStringProperty</span></tt>,
<tt class="literal"><span class="pre">HTMLNumberProperty</span></tt>, and so on).</p>
<p>This wrapper object provides access to a single property of a class. Its
value may be either:</p>
<ol class="arabic simple">
<li>if accessed through a <a class="reference" href="#hyperdb-item-wrapper">hyperdb item wrapper</a>, then it's a value from
the hyperdb</li>
<li>if access through a <a class="reference" href="#hyperdb-class-wrapper">hyperdb class wrapper</a>, then it's a value from
the CGI form</li>
</ol>
<p>The property wrapper has some useful attributes:</p>
<table class="table" frame="border" rules="all">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<thead valign="bottom">
<tr><th>Attribute</th>
<th>Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>_name</td>
<td>the name of the property</td>
</tr>
<tr><td>_value</td>
<td>the value of the property if any - this is the actual
value retrieved from the hyperdb for this property</td>
</tr>
</tbody>
</table>
<p>There are several methods available on these wrapper objects:</p>
<table class="table" frame="border" rules="all">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr><th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>plain</td>
<td><p class="first">render a &quot;plain&quot; representation of the property. This method
may take two arguments:</p>
<dl class="last">
<dt>escape</dt>
<dd><p class="first">If true, escape the text so it is HTML safe (default: no). The
reason this defaults to off is that text is usually escaped
at a later stage by the TAL commands, unless the &quot;structure&quot;
option is used in the template. The following <tt class="literal"><span class="pre">tal:content</span></tt>
expressions are all equivalent:</p>
<pre class="literal-block">
&quot;structure python:msg.content.plain(escape=1)&quot;
&quot;python:msg.content.plain()&quot;
&quot;msg/content/plain&quot;
&quot;msg/content&quot;
</pre>
<p class="last">Usually you'll only want to use the escape option in a
complex expression.</p>
</dd>
<dt>hyperlink</dt>
<dd><p class="first">If true, turn URLs, email addresses and hyperdb item
designators in the text into hyperlinks (default: no). Note
that you'll need to use the &quot;structure&quot; TAL option if you
want to use this <tt class="literal"><span class="pre">tal:content</span></tt> expression:</p>
<pre class="literal-block">
&quot;structure python:msg.content.plain(hyperlink=1)&quot;
</pre>
<p class="last">Note also that the text is automatically HTML-escaped before
the hyperlinking transformation.</p>
</dd>
</dl>
</td>
</tr>
<tr><td>hyperlinked</td>
<td><p class="first">The same as msg.content.plain(hyperlink=1), but nicer:</p>
<pre class="last literal-block">
&quot;structure msg/content/hyperlinked&quot;
</pre>
</td>
</tr>
<tr><td>field</td>
<td>render an appropriate form edit field for the property - for
most types this is a text entry box, but for Booleans it's a
tri-state yes/no/neither selection.</td>
</tr>
<tr><td>stext</td>
<td>only on String properties - render the value of the property
as StructuredText (requires the StructureText module to be
installed separately)</td>
</tr>
<tr><td>multiline</td>
<td>only on String properties - render a multiline form edit
field for the property</td>
</tr>
<tr><td>email</td>
<td>only on String properties - render the value of the property
as an obscured email address</td>
</tr>
<tr><td>confirm</td>
<td>only on Password properties - render a second form edit field
for the property, used for confirmation that the user typed
the password correctly. Generates a field with name
&quot;name:confirm&quot;.</td>
</tr>
<tr><td>now</td>
<td>only on Date properties - return the current date as a new
property</td>
</tr>
<tr><td>reldate</td>
<td>only on Date properties - render the interval between the date
and now</td>
</tr>
<tr><td>local</td>
<td><p class="first">only on Date properties - return this date as a new property
with some timezone offset, for example:</p>
<pre class="literal-block">
python:context.creation.local(10)
</pre>
<p class="last">will render the date with a +10 hour offset.</p>
</td>
</tr>
<tr><td>pretty</td>
<td><p class="first">Date properties - render the date as &quot;dd Mon YYYY&quot; (eg. &quot;19
Mar 2004&quot;). Takes an optional format argument, for example:</p>
<pre class="literal-block">
python:context.activity.pretty('%Y-%m-%d')
</pre>
<p>Will format as &quot;2004-03-19&quot; instead.</p>
<p class="last">Interval properties - render the interval in a pretty
format (eg. &quot;yesterday&quot;)</p>
</td>
</tr>
<tr><td>menu</td>
<td>only on Link and Multilink properties - render a form select
list for this property</td>
</tr>
<tr><td>reverse</td>
<td>only on Multilink properties - produce a list of the linked
items in reverse order</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="the-request-variable">
<h3><a name="the-request-variable">The request variable</a></h3>
<p>Note: this is implemented by the <tt class="literal"><span class="pre">roundup.cgi.templating.HTMLRequest</span></tt>
class.</p>
<p>The request variable is packed with information about the current
request.</p>
<!-- taken from ``roundup.cgi.templating.HTMLRequest`` docstring -->
<table class="table" frame="border" rules="all">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr><th>Variable</th>
<th>Holds</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>form</td>
<td>the CGI form as a cgi.FieldStorage</td>
</tr>
<tr><td>env</td>
<td>the CGI environment variables</td>
</tr>
<tr><td>base</td>
<td>the base URL for this tracker</td>
</tr>
<tr><td>user</td>
<td>a HTMLUser instance for this user</td>
</tr>
<tr><td>classname</td>
<td>the current classname (possibly None)</td>
</tr>
<tr><td>template</td>
<td>the current template (suffix, also possibly None)</td>
</tr>
<tr><td>form</td>
<td>the current CGI form variables in a FieldStorage</td>
</tr>
</tbody>
</table>
<p><strong>Index page specific variables (indexing arguments)</strong></p>
<table class="table" frame="border" rules="all">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr><th>Variable</th>
<th>Holds</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>columns</td>
<td>dictionary of the columns to display in an index page</td>
</tr>
<tr><td>show</td>
<td>a convenience access to columns - request/show/colname will
be true if the columns should be displayed, false otherwise</td>
</tr>
<tr><td>sort</td>
<td>index sort column (direction, column name)</td>
</tr>
<tr><td>group</td>
<td>index grouping property (direction, column name)</td>
</tr>
<tr><td>filter</td>
<td>properties to filter the index on</td>
</tr>
<tr><td>filterspec</td>
<td>values to filter the index on</td>
</tr>
<tr><td>search_text</td>
<td>text to perform a full-text search on for an index</td>
</tr>
</tbody>
</table>
<p>There are several methods available on the request variable:</p>
<table class="table" frame="border" rules="all">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<thead valign="bottom">
<tr><th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>description</td>
<td>render a description of the request - handle for the
page title</td>
</tr>
<tr><td>indexargs_form</td>
<td>render the current index args as form elements</td>
</tr>
<tr><td>indexargs_url</td>
<td>render the current index args as a URL</td>
</tr>
<tr><td>base_javascript</td>
<td>render some javascript that is used by other components
of the templating</td>
</tr>
<tr><td>batch</td>
<td>run the current index args through a filter and return a
list of items (see <a class="reference" href="#hyperdb-item-wrapper">hyperdb item wrapper</a>, and
<a class="reference" href="#batching">batching</a>)</td>
</tr>
</tbody>
</table>
<div class="section" id="the-form-variable">
<h4><a name="the-form-variable">The form variable</a></h4>
<p>The form variable is a bit special because it's actually a python
FieldStorage object. That means that you have two ways to access its
contents. For example, to look up the CGI form value for the variable
&quot;name&quot;, use the path expression:</p>
<pre class="literal-block">
request/form/name/value
</pre>
<p>or the python expression:</p>
<pre class="literal-block">
python:request.form['name'].value
</pre>
<p>Note the &quot;item&quot; access used in the python case, and also note the
explicit &quot;value&quot; attribute we have to access. That's because the form
variables are stored as MiniFieldStorages. If there's more than one
&quot;name&quot; value in the form, then the above will break since
<tt class="literal"><span class="pre">request/form/name</span></tt> is actually a <em>list</em> of MiniFieldStorages. So it's
best to know beforehand what you're dealing with.</p>
</div>
</div>
<div class="section" id="the-db-variable">
<h3><a name="the-db-variable">The db variable</a></h3>
<p>Note: this is implemented by the <tt class="literal"><span class="pre">roundup.cgi.templating.HTMLDatabase</span></tt>
class.</p>
<p>Allows access to all hyperdb classes as attributes of this variable. If
you want access to the &quot;user&quot; class, for example, you would use:</p>
<pre class="literal-block">
db/user
python:db.user
</pre>
<p>Also, the current id of the current user is available as
<tt class="literal"><span class="pre">db.curuserid</span></tt>. This isn't so useful in templates (where you have
<tt class="literal"><span class="pre">request/user</span></tt>), but it can be useful in detectors or interfaces.</p>
<p>The access results in a <a class="reference" href="#hyperdb-class-wrapper">hyperdb class wrapper</a>.</p>
</div>
<div class="section" id="the-templates-variable">
<h3><a name="the-templates-variable">The templates variable</a></h3>
<p>Note: this is implemented by the <tt class="literal"><span class="pre">roundup.cgi.templating.Templates</span></tt>
class.</p>
<p>This variable doesn't have any useful methods defined. It supports being
used in expressions to access the templates, and consequently the
template macros. You may access the templates using the following path
expression:</p>
<pre class="literal-block">
templates/name
</pre>
<p>or the python expression:</p>
<pre class="literal-block">
templates[name]
</pre>
<p>where &quot;name&quot; is the name of the template you wish to access. The
template has one useful attribute, namely &quot;macros&quot;. To access a specific
macro (called &quot;macro_name&quot;), use the path expression:</p>
<pre class="literal-block">
templates/name/macros/macro_name
</pre>
<p>or the python expression:</p>
<pre class="literal-block">
templates[name].macros[macro_name]
</pre>
</div>
<div class="section" id="the-utils-variable">
<h3><a name="the-utils-variable">The utils variable</a></h3>
<p>Note: this is implemented by the
<tt class="literal"><span class="pre">roundup.cgi.templating.TemplatingUtils</span></tt> class, but it may be extended
as described below.</p>
<table class="table" frame="border" rules="all">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<thead valign="bottom">
<tr><th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Batch</td>
<td>return a batch object using the supplied list</td>
</tr>
</tbody>
</table>
<p>You may add additional utility methods by writing them in your tracker
<tt class="literal"><span class="pre">interfaces.py</span></tt> module's <tt class="literal"><span class="pre">TemplatingUtils</span></tt> class. See <a class="reference" href="#adding-a-time-log-to-your-issues">adding a time
log to your issues</a> for an example. The TemplatingUtils class itself
will have a single attribute, <tt class="literal"><span class="pre">client</span></tt>, which may be used to access
the <tt class="literal"><span class="pre">client.db</span></tt> when you need to perform arbitrary database queries.</p>
<div class="section" id="batching">
<h4><a name="batching">Batching</a></h4>
<p>Use Batch to turn a list of items, or item ids of a given class, into a
series of batches. Its usage is:</p>
<pre class="literal-block">
python:utils.Batch(sequence, size, start, end=0, orphan=0,
overlap=0)
</pre>
<p>or, to get the current index batch:</p>
<pre class="literal-block">
request/batch
</pre>
<p>The parameters are:</p>
<table class="table" frame="border" rules="all">
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr><th>Parameter</th>
<th>Usage</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sequence</td>
<td>a list of HTMLItems</td>
</tr>
<tr><td>size</td>
<td>how big to make the sequence.</td>
</tr>
<tr><td>start</td>
<td>where to start (0-indexed) in the sequence.</td>
</tr>
<tr><td>end</td>
<td>where to end (0-indexed) in the sequence.</td>
</tr>
<tr><td>orphan</td>
<td>if the next batch would contain less items than this value,
then it is combined with this batch</td>
</tr>
<tr><td>overlap</td>
<td>the number of items shared between adjacent batches</td>
</tr>
</tbody>
</table>
<p>All of the parameters are assigned as attributes on the batch object. In
addition, it has several more attributes:</p>
<table class="table" frame="border" rules="all">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<thead valign="bottom">
<tr><th>Attribute</th>
<th>Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>start</td>
<td>indicates the start index of the batch. <em>Note: unlike
the argument, is a 1-based index (I know, lame)</em></td>
</tr>
<tr><td>first</td>
<td>indicates the start index of the batch <em>as a 0-based
index</em></td>
</tr>
<tr><td>length</td>
<td>the actual number of elements in the batch</td>
</tr>
<tr><td>sequence_length</td>
<td>the length of the original, unbatched, sequence.</td>
</tr>
</tbody>
</table>
<p>And several methods:</p>
<table class="table" frame="border" rules="all">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<thead valign="bottom">
<tr><th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>previous</td>
<td>returns a new Batch with the previous batch settings</td>
</tr>
<tr><td>next</td>
<td>returns a new Batch with the next batch settings</td>
</tr>
<tr><td>propchanged</td>
<td>detect if the named property changed on the current item
when compared to the last item</td>
</tr>
</tbody>
</table>
<p>An example of batching:</p>
<pre class="literal-block">
&lt;table class=&quot;otherinfo&quot;&gt;
 &lt;tr&gt;&lt;th colspan=&quot;4&quot; class=&quot;header&quot;&gt;Existing Keywords&lt;/th&gt;&lt;/tr&gt;
 &lt;tr tal:define=&quot;keywords db/keyword/list&quot;
     tal:repeat=&quot;start python:range(0, len(keywords), 4)&quot;&gt;
  &lt;td tal:define=&quot;batch python:utils.Batch(keywords, 4, start)&quot;
      tal:repeat=&quot;keyword batch&quot; tal:content=&quot;keyword/name&quot;&gt;
      keyword here&lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;
</pre>
<p>... which will produce a table with four columns containing the items of
the &quot;keyword&quot; class (well, their &quot;name&quot; anyway).</p>
</div>
</div>
</div>
<div class="section" id="displaying-properties">
<h2><a class="toc-backref" href="#id20" name="displaying-properties">Displaying Properties</a></h2>
<p>Properties appear in the user interface in three contexts: in indices,
in editors, and as search arguments. For each type of property, there
are several display possibilities. For example, in an index view, a
string property may just be printed as a plain string, but in an editor
view, that property may be displayed in an editable field.</p>
</div>
<div class="section" id="index-views">
<h2><a class="toc-backref" href="#id21" name="index-views">Index Views</a></h2>
<p>This is one of the class context views. It is also the default view for
classes. The template used is &quot;<em>classname</em>.index&quot;.</p>
<div class="section" id="index-view-specifiers">
<h3><a name="index-view-specifiers">Index View Specifiers</a></h3>
<p>An index view specifier (URL fragment) looks like this (whitespace has
been added for clarity):</p>
<pre class="literal-block">
/issue?status=unread,in-progress,resolved&amp;
       topic=security,ui&amp;
       :group=+priority&amp;
       :sort==activity&amp;
       :filters=status,topic&amp;
       :columns=title,status,fixer
</pre>
<p>The index view is determined by two parts of the specifier: the layout
part and the filter part. The layout part consists of the query
parameters that begin with colons, and it determines the way that the
properties of selected items are displayed. The filter part consists of
all the other query parameters, and it determines the criteria by which
items are selected for display. The filter part is interactively
manipulated with the form widgets displayed in the filter section. The
layout part is interactively manipulated by clicking on the column
headings in the table.</p>
<p>The filter part selects the union of the sets of items with values
matching any specified Link properties and the intersection of the sets
of items with values matching any specified Multilink properties.</p>
<p>The example specifies an index of &quot;issue&quot; items. Only items with a
&quot;status&quot; of either &quot;unread&quot; or &quot;in-progress&quot; or &quot;resolved&quot; are
displayed, and only items with &quot;topic&quot; values including both &quot;security&quot;
and &quot;ui&quot; are displayed. The items are grouped by priority, arranged in
ascending order; and within groups, sorted by activity, arranged in
descending order. The filter section shows filters for the &quot;status&quot; and
&quot;topic&quot; properties, and the table includes columns for the &quot;title&quot;,
&quot;status&quot;, and &quot;fixer&quot; properties.</p>
</div>
</div>
<div class="section" id="searching-views">
<h2><a class="toc-backref" href="#id22" name="searching-views">Searching Views</a></h2>
<dl>
<dt>Note: if you add a new column to the <tt class="literal"><span class="pre">:columns</span></tt> form variable</dt>
<dd>potentials then you will need to add the column to the appropriate
<a class="reference" href="#index-views">index views</a> template so that it is actually displayed.</dd>
</dl>
<p>This is one of the class context views. The template used is typically
&quot;<em>classname</em>.search&quot;. The form on this page should have &quot;search&quot; as its
<tt class="literal"><span class="pre">&#64;action</span></tt> variable. The &quot;search&quot; action:</p>
<ul class="simple">
<li>sets up additional filtering, as well as performing indexed text
searching</li>
<li>sets the <tt class="literal"><span class="pre">:filter</span></tt> variable correctly</li>
<li>saves the query off if <tt class="literal"><span class="pre">:query_name</span></tt> is set.</li>
</ul>
<p>The search page should lay out any fields that you wish to allow the
user to search on. If your schema contains a large number of properties,
you should be wary of making all of those properties available for
searching, as this can cause confusion. If the additional properties are
Strings, consider having their value indexed, and then they will be
searchable using the full text indexed search. This is both faster, and
more useful for the end user.</p>
<p>The two special form values on search pages which are handled by the
&quot;search&quot; action are:</p>
<dl>
<dt>:search_text</dt>
<dd>Text with which to perform a search of the text index. Results from
that search will be used to limit the results of other filters (using
an intersection operation)</dd>
<dt>:query_name</dt>
<dd>If supplied, the search parameters (including :search_text) will be
saved off as a the query item and registered against the user's
queries property. Note that the <em>classic</em> template schema has this
ability, but the <em>minimal</em> template schema does not.</dd>
</dl>
</div>
<div class="section" id="item-views">
<h2><a class="toc-backref" href="#id23" name="item-views">Item Views</a></h2>
<p>The basic view of a hyperdb item is provided by the &quot;<em>classname</em>.item&quot;
template. It generally has three sections; an &quot;editor&quot;, a &quot;spool&quot; and a
&quot;history&quot; section.</p>
<div class="section" id="editor-section">
<h3><a name="editor-section">Editor Section</a></h3>
<p>The editor section is used to manipulate the item - it may be a static
display if the user doesn't have permission to edit the item.</p>
<p>Here's an example of a basic editor template (this is the default
&quot;classic&quot; template issue item edit form - from the &quot;issue.item.html&quot;
template):</p>
<pre class="literal-block">
&lt;table class=&quot;form&quot;&gt;
&lt;tr&gt;
 &lt;th nowrap&gt;Title&lt;/th&gt;
 &lt;td colspan=&quot;3&quot; tal:content=&quot;structure python:context.title.field(size=60)&quot;&gt;title&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
 &lt;th nowrap&gt;Priority&lt;/th&gt;
 &lt;td tal:content=&quot;structure context/priority/menu&quot;&gt;priority&lt;/td&gt;
 &lt;th nowrap&gt;Status&lt;/th&gt;
 &lt;td tal:content=&quot;structure context/status/menu&quot;&gt;status&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
 &lt;th nowrap&gt;Superseder&lt;/th&gt;
 &lt;td&gt;
  &lt;span tal:replace=&quot;structure python:context.superseder.field(showid=1, size=20)&quot; /&gt;
  &lt;span tal:replace=&quot;structure python:db.issue.classhelp('id,title')&quot; /&gt;
  &lt;span tal:condition=&quot;context/superseder&quot;&gt;
   &lt;br&gt;View: &lt;span tal:replace=&quot;structure python:context.superseder.link(showid=1)&quot; /&gt;
  &lt;/span&gt;
 &lt;/td&gt;
 &lt;th nowrap&gt;Nosy List&lt;/th&gt;
 &lt;td&gt;
  &lt;span tal:replace=&quot;structure context/nosy/field&quot; /&gt;
  &lt;span tal:replace=&quot;structure python:db.user.classhelp('username,realname,address,phone')&quot; /&gt;
 &lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
 &lt;th nowrap&gt;Assigned To&lt;/th&gt;
 &lt;td tal:content=&quot;structure context/assignedto/menu&quot;&gt;
  assignedto menu
 &lt;/td&gt;
 &lt;td&gt;&amp;nbsp;&lt;/td&gt;
 &lt;td&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
 &lt;th nowrap&gt;Change Note&lt;/th&gt;
 &lt;td colspan=&quot;3&quot;&gt;
  &lt;textarea name=&quot;:note&quot; wrap=&quot;hard&quot; rows=&quot;5&quot; cols=&quot;60&quot;&gt;&lt;/textarea&gt;
 &lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
 &lt;th nowrap&gt;File&lt;/th&gt;
 &lt;td colspan=&quot;3&quot;&gt;&lt;input type=&quot;file&quot; name=&quot;:file&quot; size=&quot;40&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
 &lt;td&gt;&amp;nbsp;&lt;/td&gt;
 &lt;td colspan=&quot;3&quot; tal:content=&quot;structure context/submit&quot;&gt;
  submit button will go here
 &lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
</pre>
<p>When a change is submitted, the system automatically generates a message
describing the changed properties. As shown in the example, the editor
template can use the &quot;:note&quot; and &quot;:file&quot; fields, which are added to the
standard changenote message generated by Roundup.</p>
<div class="section" id="form-values">
<h4><a name="form-values">Form values</a></h4>
<p>We have a number of ways to pull properties out of the form in order to
meet the various needs of:</p>
<ol class="arabic simple">
<li>editing the current item (perhaps an issue item)</li>
<li>editing information related to the current item (eg. messages or
attached files)</li>
<li>creating new information to be linked to the current item (eg. time
spent on an issue)</li>
</ol>
<p>In the following, <tt class="literal"><span class="pre">&lt;bracketed&gt;</span></tt> values are variable, &quot;:&quot; may be one of
&quot;:&quot; or &quot;&#64;&quot;, and other text (&quot;required&quot;) is fixed.</p>
<p>Properties are specified as form variables:</p>
<dl>
<dt><tt class="literal"><span class="pre">&lt;propname&gt;</span></tt></dt>
<dd>property on the current context item</dd>
<dt><tt class="literal"><span class="pre">&lt;designator&gt;:&lt;propname&gt;</span></tt></dt>
<dd>property on the indicated item (for editing related information)</dd>
<dt><tt class="literal"><span class="pre">&lt;classname&gt;-&lt;N&gt;:&lt;propname&gt;</span></tt></dt>
<dd>property on the Nth new item of classname (generally for creating new
items to attach to the current item)</dd>
</dl>
<p>Once we have determined the &quot;propname&quot;, we check to see if it is one of
the special form values:</p>
<dl>
<dt><tt class="literal"><span class="pre">&#64;required</span></tt></dt>
<dd>The named property values must be supplied or a ValueError will be
raised.</dd>
<dt><tt class="literal"><span class="pre">&#64;remove&#64;&lt;propname&gt;=id(s)</span></tt></dt>
<dd>The ids will be removed from the multilink property.</dd>
<dt><tt class="literal"><span class="pre">:add:&lt;propname&gt;=id(s)</span></tt></dt>
<dd>The ids will be added to the multilink property.</dd>
<dt><tt class="literal"><span class="pre">:link:&lt;propname&gt;=&lt;designator&gt;</span></tt></dt>
<dd>Used to add a link to new items created during edit. These are
collected and returned in <tt class="literal"><span class="pre">all_links</span></tt>. This will result in an
additional linking operation (either Link set or Multilink append)
after the edit/create is done using <tt class="literal"><span class="pre">all_props</span></tt> in <tt class="literal"><span class="pre">_editnodes</span></tt>.
The &lt;propname&gt; on the current item will be set/appended the id of the
newly created item of class &lt;designator&gt; (where &lt;designator&gt; must be
&lt;classname&gt;-&lt;N&gt;).</dd>
</dl>
<p>Any of the form variables may be prefixed with a classname or
designator.</p>
<p>Two special form values are supported for backwards compatibility:</p>
<dl>
<dt><tt class="literal"><span class="pre">:note</span></tt></dt>
<dd>create a message (with content, author and date), linked to the
context item. This is ALWAYS designated &quot;msg-1&quot;.</dd>
<dt><tt class="literal"><span class="pre">:file</span></tt></dt>
<dd>create a file, attached to the current item and any message created by
:note. This is ALWAYS designated &quot;file-1&quot;.</dd>
</dl>
</div>
</div>
<div class="section" id="spool-section">
<h3><a name="spool-section">Spool Section</a></h3>
<p>The spool section lists related information like the messages and files
of an issue.</p>
<p>TODO</p>
</div>
<div class="section" id="history-section">
<h3><a name="history-section">History Section</a></h3>
<p>The final section displayed is the history of the item - its database
journal. This is generally generated with the template:</p>
<pre class="literal-block">
&lt;tal:block tal:replace=&quot;structure context/history&quot; /&gt;
</pre>
<p><em>To be done:</em></p>
<p><em>The actual history entries of the item may be accessed for manual
templating through the &quot;journal&quot; method of the item</em>:</p>
<pre class="literal-block">
&lt;tal:block tal:repeat=&quot;entry context/journal&quot;&gt;
 a journal entry
&lt;/tal:block&gt;
</pre>
<p><em>where each journal entry is an HTMLJournalEntry.</em></p>
</div>
</div>
<div class="section" id="defining-new-web-actions">
<h2><a class="toc-backref" href="#id24" name="defining-new-web-actions">Defining new web actions</a></h2>
<p>You may define new actions to be triggered by the <tt class="literal"><span class="pre">&#64;action</span></tt> form
variable. These are added to the tracker <tt class="literal"><span class="pre">interfaces.py</span></tt> as methods on
the <tt class="literal"><span class="pre">Client</span></tt> class.</p>
<p>Adding action methods takes three steps; first you <a class="reference" href="#define-the-new-action-method">define the new
action method</a>, then you <a class="reference" href="#register-the-action-method">register the action method</a> with the cgi
interface so it may be triggered by the <tt class="literal"><span class="pre">&#64;action</span></tt> form variable.
Finally you <a class="reference" href="#use-the-new-action">use the new action</a> in your HTML form.</p>
<p>See &quot;<a class="reference" href="#setting-up-a-wizard-or-druid-for-controlled-adding-of-issues">setting up a &quot;wizard&quot; (or &quot;druid&quot;) for controlled adding of
issues</a>&quot; for an example.</p>
<div class="section" id="define-the-new-action-method">
<h3><a name="define-the-new-action-method">Define the new action method</a></h3>
<p>The action methods have the following interface:</p>
<pre class="literal-block">
def myActionMethod(self):
    ''' Perform some action. No return value is required.
    '''
</pre>
<p>The <em>self</em> argument is an instance of your tracker <tt class="literal"><span class="pre">instance.Client</span></tt>
class - thus it's mostly implemented by <tt class="literal"><span class="pre">roundup.cgi.Client</span></tt>. See the
docstring of that class for details of what it can do.</p>
<p>The method will typically check the <tt class="literal"><span class="pre">self.form</span></tt> variable's contents.
It may then:</p>
<ul class="simple">
<li>add information to <tt class="literal"><span class="pre">self.ok_message</span></tt> or <tt class="literal"><span class="pre">self.error_message</span></tt></li>
<li>change the <tt class="literal"><span class="pre">self.template</span></tt> variable to alter what the user will see
next</li>
<li>raise Unauthorised, SendStaticFile, SendFile, NotFound or Redirect
exceptions</li>
</ul>
</div>
<div class="section" id="register-the-action-method">
<h3><a name="register-the-action-method">Register the action method</a></h3>
<p>The method is now written, but isn't available to the user until you add
it to the <cite>instance.Client`</cite> class <tt class="literal"><span class="pre">actions</span></tt> variable, like so:</p>
<pre class="literal-block">
actions = client.Class.actions + (
    ('myaction', 'myActionMethod'),
)
</pre>
<p>This maps the action name &quot;myaction&quot; to the action method we defined.</p>
</div>
<div class="section" id="use-the-new-action">
<h3><a name="use-the-new-action">Use the new action</a></h3>
<p>In your HTML form, add a hidden form element like so:</p>
<pre class="literal-block">
&lt;input type=&quot;hidden&quot; name=&quot;&#64;action&quot; value=&quot;myaction&quot;&gt;
</pre>
<p>where &quot;myaction&quot; is the name you registered in the previous step.</p>
</div>
<div class="section" id="actions-may-return-content-to-the-user">
<h3><a name="actions-may-return-content-to-the-user">Actions may return content to the user</a></h3>
<p>Actions generally perform some database manipulation and then pass control
on to the rendering of a template in the current context (see <a class="reference" href="#determining-web-context">Determining
web context</a> for how that works.) Some actions will want to generate the
actual content returned to the user. Action methods may return their own
content string to be displayed to the user, overriding the templating step.
In this situation, we assume that the content is HTML by default. You may
override the content type indicated to the user by calling <tt class="literal"><span class="pre">setHeader</span></tt>:</p>
<pre class="literal-block">
self.setHeader('Content-Type', 'text/csv')
</pre>
<p>This example indicates that the value sent back to the user is actually
comma-separated value content (eg. something to be loaded into a
spreadsheet or database).</p>
</div>
</div>
</div>
<div class="section" id="examples">
<h1><a class="toc-backref" href="#id10" name="examples">Examples</a></h1>
<div class="contents topic" id="id25">
<ul class="simple">
<li><a class="reference" href="#adding-a-new-field-to-the-classic-schema" id="id26" name="id26">Adding a new field to the classic schema</a></li>
<li><a class="reference" href="#adding-in-state-transition-control" id="id27" name="id27">Adding in state transition control</a></li>
<li><a class="reference" href="#displaying-only-message-summaries-in-the-issue-display" id="id28" name="id28">Displaying only message summaries in the issue display</a></li>
<li><a class="reference" href="#restricting-the-list-of-users-that-are-assignable-to-a-task" id="id29" name="id29">Restricting the list of users that are assignable to a task</a></li>
<li><a class="reference" href="#setting-up-a-wizard-or-druid-for-controlled-adding-of-issues" id="id30" name="id30">Setting up a &quot;wizard&quot; (or &quot;druid&quot;) for controlled adding of issues</a></li>
<li><a class="reference" href="#using-an-external-password-validation-source" id="id31" name="id31">Using an external password validation source</a></li>
<li><a class="reference" href="#adding-a-vacation-flag-to-users-for-stopping-nosy-messages" id="id32" name="id32">Adding a &quot;vacation&quot; flag to users for stopping nosy messages</a></li>
<li><a class="reference" href="#adding-a-time-log-to-your-issues" id="id33" name="id33">Adding a time log to your issues</a></li>
<li><a class="reference" href="#using-a-un-x-passwd-file-as-the-user-database" id="id34" name="id34">Using a UN*X passwd file as the user database</a></li>
<li><a class="reference" href="#using-an-ldap-database-for-user-information" id="id35" name="id35">Using an LDAP database for user information</a></li>
<li><a class="reference" href="#enabling-display-of-either-message-summaries-or-the-entire-messages" id="id36" name="id36">Enabling display of either message summaries or the entire messages</a></li>
<li><a class="reference" href="#blocking-issues-that-depend-on-other-issues" id="id37" name="id37">Blocking issues that depend on other issues</a></li>
</ul>
</div>
<div class="section" id="adding-a-new-field-to-the-classic-schema">
<h2><a class="toc-backref" href="#id26" name="adding-a-new-field-to-the-classic-schema">Adding a new field to the classic schema</a></h2>
<p>This example shows how to add a new constrained property (i.e. a
selection of distinct values) to your tracker.</p>
<div class="section" id="introduction">
<h3><a name="introduction">Introduction</a></h3>
<p>To make the classic schema of roundup useful as a TODO tracking system
for a group of systems administrators, it needed an extra data field per
issue: a category.</p>
<p>This would let sysadmins quickly list all TODOs in their particular area
of interest without having to do complex queries, and without relying on
the spelling capabilities of other sysadmins (a losing proposition at
best).</p>
</div>
<div class="section" id="adding-a-field-to-the-database">
<h3><a name="adding-a-field-to-the-database">Adding a field to the database</a></h3>
<p>This is the easiest part of the change. The category would just be a
plain string, nothing fancy. To change what is in the database you need
to add some lines to the <tt class="literal"><span class="pre">open()</span></tt> function in <tt class="literal"><span class="pre">dbinit.py</span></tt>. Under the
comment:</p>
<pre class="literal-block">
# add any additional database schema configuration here
</pre>
<p>add:</p>
<pre class="literal-block">
category = Class(db, &quot;category&quot;, name=String())
category.setkey(&quot;name&quot;)
</pre>
<p>Here we are setting up a chunk of the database which we are calling
&quot;category&quot;. It contains a string, which we are refering to as &quot;name&quot; for
lack of a more imaginative title. (Since &quot;name&quot; is one of the properties
that Roundup looks for on items if you do not set a key for them, it's
probably a good idea to stick with it for new classes if at all
appropriate.) Then we are setting the key of this chunk of the database
to be that &quot;name&quot;. This is equivalent to an index for database types.
This also means that there can only be one category with a given name.</p>
<p>Adding the above lines allows us to create categories, but they're not
tied to the issues that we are going to be creating. It's just a list of
categories off on its own, which isn't much use. We need to link it in
with the issues. To do that, find the lines in the <tt class="literal"><span class="pre">open()</span></tt> function
in <tt class="literal"><span class="pre">dbinit.py</span></tt> which set up the &quot;issue&quot; class, and then add a link to
the category:</p>
<pre class="literal-block">
issue = IssueClass(db, &quot;issue&quot;, ... ,
    category=Multilink(&quot;category&quot;), ... )
</pre>
<p>The <tt class="literal"><span class="pre">Multilink()</span></tt> means that each issue can have many categories. If
you were adding something with a one-to-one relationship to issues (such
as the &quot;assignedto&quot; property), use <tt class="literal"><span class="pre">Link()</span></tt> instead.</p>
<p>That is all you need to do to change the schema. The rest of the effort
is fiddling around so you can actually use the new category.</p>
</div>
<div class="section" id="populating-the-new-category-class">
<h3><a name="populating-the-new-category-class">Populating the new category class</a></h3>
<p>If you haven't initialised the database with the roundup-admin
&quot;initialise&quot; command, then you can add the following to the tracker
<tt class="literal"><span class="pre">dbinit.py</span></tt> in the <tt class="literal"><span class="pre">init()</span></tt> function under the comment:</p>
<pre class="literal-block">
# add any additional database create steps here - but only if you
# haven't initialised the database with the admin &quot;initialise&quot; command
</pre>
<p>Add:</p>
<pre class="literal-block">
category = db.getclass('category')
category.create(name=&quot;scipy&quot;, order=&quot;1&quot;)
category.create(name=&quot;chaco&quot;, order=&quot;2&quot;)
category.create(name=&quot;weave&quot;, order=&quot;3&quot;)
</pre>
<p>If the database has already been initalised, then you need to use the
<tt class="literal"><span class="pre">roundup-admin</span></tt> tool:</p>
<pre class="literal-block">
% roundup-admin -i &lt;tracker home&gt;
Roundup &lt;version&gt; ready for input.
Type &quot;help&quot; for help.
roundup&gt; create category name=scipy order=1
1
roundup&gt; create category name=chaco order=1
2
roundup&gt; create category name=weave order=1
3
roundup&gt; exit...
There are unsaved changes. Commit them (y/N)? y
</pre>
<p>TODO: explain why order=1 in each case. Also, does key get set to &quot;name&quot;
automatically when added via roundup-admin?</p>
</div>
<div class="section" id="setting-up-security-on-the-new-objects">
<h3><a name="setting-up-security-on-the-new-objects">Setting up security on the new objects</a></h3>
<p>By default only the admin user can look at and change objects. This
doesn't suit us, as we want any user to be able to create new categories
as required, and obviously everyone needs to be able to view the
categories of issues for it to be useful.</p>
<p>We therefore need to change the security of the category objects. This
is also done in the <tt class="literal"><span class="pre">open()</span></tt> function of <tt class="literal"><span class="pre">dbinit.py</span></tt>.</p>
<p>There are currently two loops which set up permissions and then assign
them to various roles. Simply add the new &quot;category&quot; to both lists:</p>
<pre class="literal-block">
# new permissions for this schema
for cl in 'issue', 'file', 'msg', 'user', 'category':
    db.security.addPermission(name=&quot;Edit&quot;, klass=cl,
        description=&quot;User is allowed to edit &quot;+cl)
    db.security.addPermission(name=&quot;View&quot;, klass=cl,
        description=&quot;User is allowed to access &quot;+cl)

# Assign the access and edit permissions for issue, file and message
# to regular users now
for cl in 'issue', 'file', 'msg', 'category':
    p = db.security.getPermission('View', cl)
    db.security.addPermissionToRole('User', p)
    p = db.security.getPermission('Edit', cl)
    db.security.addPermissionToRole('User', p)
</pre>
<p>So you are in effect doing the following (with 'cl' substituted by its
value):</p>
<pre class="literal-block">
db.security.addPermission(name=&quot;Edit&quot;, klass='category',
    description=&quot;User is allowed to edit &quot;+'category')
db.security.addPermission(name=&quot;View&quot;, klass='category',
    description=&quot;User is allowed to access &quot;+'category')
</pre>
<p>which is creating two permission types; that of editing and viewing
&quot;category&quot; objects respectively. Then the following lines assign those
new permissions to the &quot;User&quot; role, so that normal users can view and
edit &quot;category&quot; objects:</p>
<pre class="literal-block">
p = db.security.getPermission('View', 'category')
db.security.addPermissionToRole('User', p)

p = db.security.getPermission('Edit', 'category')
db.security.addPermissionToRole('User', p)
</pre>
<p>This is all the work that needs to be done for the database. It will
store categories, and let users view and edit them. Now on to the
interface stuff.</p>
</div>
<div class="section" id="changing-the-web-left-hand-frame">
<h3><a name="changing-the-web-left-hand-frame">Changing the web left hand frame</a></h3>
<p>We need to give the users the ability to create new categories, and the
place to put the link to this functionality is in the left hand function
bar, under the &quot;Issues&quot; area. The file that defines how this area looks
is <tt class="literal"><span class="pre">html/page</span></tt>, which is what we are going to be editing next.</p>
<p>If you look at this file you can see that it contains a lot of
&quot;classblock&quot; sections which are chunks of HTML that will be included or
excluded in the output depending on whether the condition in the
classblock is met. Under the end of the classblock for issue is where we
are going to add the category code:</p>
<pre class="literal-block">
&lt;p class=&quot;classblock&quot;
   tal:condition=&quot;python:request.user.hasPermission('View', 'category')&quot;&gt;
 &lt;b&gt;Categories&lt;/b&gt;&lt;br&gt;
 &lt;a tal:condition=&quot;python:request.user.hasPermission('Edit', 'category')&quot;
    href=&quot;category?&#64;template=item&quot;&gt;New Category&lt;br&gt;&lt;/a&gt;
&lt;/p&gt;
</pre>
<p>The first two lines is the classblock definition, which sets up a
condition that only users who have &quot;View&quot; permission for the &quot;category&quot;
object will have this section included in their output. Next comes a
plain &quot;Categories&quot; header in bold. Everyone who can view categories will
get that.</p>
<p>Next comes the link to the editing area of categories. This link will
only appear if the condition - that the user has &quot;Edit&quot; permissions for
the &quot;category&quot; objects - is matched. If they do have permission then
they will get a link to another page which will let the user add new
categories.</p>
<p>Note that if you have permission to <em>view</em> but not to <em>edit</em> categories,
then all you will see is a &quot;Categories&quot; header with nothing underneath
it. This is obviously not very good interface design, but will do for
now. I just claim that it is so I can add more links in this section
later on. However to fix the problem you could change the condition in
the classblock statement, so that only users with &quot;Edit&quot; permission
would see the &quot;Categories&quot; stuff.</p>
</div>
<div class="section" id="setting-up-a-page-to-edit-categories">
<h3><a name="setting-up-a-page-to-edit-categories">Setting up a page to edit categories</a></h3>
<p>We defined code in the previous section which let users with the
appropriate permissions see a link to a page which would let them edit
conditions. Now we have to write that page.</p>
<p>The link was for the <em>item</em> template of the <em>category</em> object. This
translates into Roundup looking for a file called <tt class="literal"><span class="pre">category.item.html</span></tt>
in the <tt class="literal"><span class="pre">html</span></tt> tracker directory. This is the file that we are going to
write now.</p>
<p>First we add an info tag in a comment which doesn't affect the outcome
of the code at all, but is useful for debugging. If you load a page in a
browser and look at the page source, you can see which sections come
from which files by looking for these comments:</p>
<pre class="literal-block">
&lt;!-- category.item --&gt;
</pre>
<p>Next we need to add in the METAL macro stuff so we get the normal page
trappings:</p>
<pre class="literal-block">
&lt;tal:block metal:use-macro=&quot;templates/page/macros/icing&quot;&gt;
 &lt;title metal:fill-slot=&quot;head_title&quot;&gt;Category editing&lt;/title&gt;
 &lt;td class=&quot;page-header-top&quot; metal:fill-slot=&quot;body_title&quot;&gt;
  &lt;h2&gt;Category editing&lt;/h2&gt;
 &lt;/td&gt;
 &lt;td class=&quot;content&quot; metal:fill-slot=&quot;content&quot;&gt;
</pre>
<p>Next we need to setup up a standard HTML form, which is the whole
purpose of this file. We link to some handy javascript which sends the
form through only once. This is to stop users hitting the send button
multiple times when they are impatient and thus having the form sent
multiple times:</p>
<pre class="literal-block">
&lt;form method=&quot;POST&quot; onSubmit=&quot;return submit_once()&quot;
      enctype=&quot;multipart/form-data&quot;&gt;
</pre>
<p>Next we define some code which sets up the minimum list of fields that
we require the user to enter. There will be only one field - &quot;name&quot; - so
they better put something in it, otherwise the whole form is pointless:</p>
<pre class="literal-block">
&lt;input type=&quot;hidden&quot; name=&quot;&#64;required&quot; value=&quot;name&quot;&gt;
</pre>
<p>To get everything to line up properly we will put everything in a table,
and put a nice big header on it so the user has an idea what is
happening:</p>
<pre class="literal-block">
&lt;table class=&quot;form&quot;&gt;
 &lt;tr&gt;&lt;th class=&quot;header&quot; colspan=&quot;2&quot;&gt;Category&lt;/th&gt;&lt;/tr&gt;
</pre>
<p>Next, we need the field into which the user is going to enter the new
category. The &quot;context.name.field(size=60)&quot; bit tells Roundup to
generate a normal HTML field of size 60, and the contents of that field
will be the &quot;name&quot; variable of the current context (which is
&quot;category&quot;). The upshot of this is that when the user types something in
to the form, a new category will be created with that name:</p>
<pre class="literal-block">
&lt;tr&gt;
 &lt;th nowrap&gt;Name&lt;/th&gt;
 &lt;td tal:content=&quot;structure python:context.name.field(size=60)&quot;&gt;
 name&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>Then a submit button so that the user can submit the new category:</p>
<pre class="literal-block">
&lt;tr&gt;
 &lt;td&gt;&amp;nbsp;&lt;/td&gt;
 &lt;td colspan=&quot;3&quot; tal:content=&quot;structure context/submit&quot;&gt;
  submit button will go here
 &lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>Finally we finish off the tags we used at the start to do the METAL
stuff:</p>
<pre class="literal-block">
 &lt;/td&gt;
&lt;/tal:block&gt;
</pre>
<p>So putting it all together, and closing the table and form we get:</p>
<pre class="literal-block">
&lt;!-- category.item --&gt;
&lt;tal:block metal:use-macro=&quot;templates/page/macros/icing&quot;&gt;
 &lt;title metal:fill-slot=&quot;head_title&quot;&gt;Category editing&lt;/title&gt;
 &lt;td class=&quot;page-header-top&quot; metal:fill-slot=&quot;body_title&quot;&gt;
  &lt;h2&gt;Category editing&lt;/h2&gt;
 &lt;/td&gt;
 &lt;td class=&quot;content&quot; metal:fill-slot=&quot;content&quot;&gt;
  &lt;form method=&quot;POST&quot; onSubmit=&quot;return submit_once()&quot;
        enctype=&quot;multipart/form-data&quot;&gt;

   &lt;input type=&quot;hidden&quot; name=&quot;&#64;required&quot; value=&quot;name&quot;&gt;

   &lt;table class=&quot;form&quot;&gt;
    &lt;tr&gt;&lt;th class=&quot;header&quot; colspan=&quot;2&quot;&gt;Category&lt;/th&gt;&lt;/tr&gt;

    &lt;tr&gt;
     &lt;th nowrap&gt;Name&lt;/th&gt;
     &lt;td tal:content=&quot;structure python:context.name.field(size=60)&quot;&gt;
     name&lt;/td&gt;
    &lt;/tr&gt;

    &lt;tr&gt;
     &lt;td&gt;&amp;nbsp;&lt;/td&gt;
     &lt;td colspan=&quot;3&quot; tal:content=&quot;structure context/submit&quot;&gt;
      submit button will go here
     &lt;/td&gt;
    &lt;/tr&gt;
   &lt;/table&gt;
  &lt;/form&gt;
 &lt;/td&gt;
&lt;/tal:block&gt;
</pre>
<p>This is quite a lot to just ask the user one simple question, but there
is a lot of setup for basically one line (the form line) to do its work.
To add another field to &quot;category&quot; would involve one more line (well,
maybe a few extra to get the formatting correct).</p>
</div>
<div class="section" id="adding-the-category-to-the-issue">
<h3><a name="adding-the-category-to-the-issue">Adding the category to the issue</a></h3>
<p>We now have the ability to create issues to our heart's content, but
that is pointless unless we can assign categories to issues.  Just like
the <tt class="literal"><span class="pre">html/category.item.html</span></tt> file was used to define how to add a new
category, the <tt class="literal"><span class="pre">html/issue.item.html</span></tt> is used to define how a new issue
is created.</p>
<p>Just like <tt class="literal"><span class="pre">category.issue.html</span></tt> this file defines a form which has a
table to lay things out. It doesn't matter where in the table we add new
stuff, it is entirely up to your sense of aesthetics:</p>
<pre class="literal-block">
&lt;th nowrap&gt;Category&lt;/th&gt;
&lt;td&gt;&lt;span tal:replace=&quot;structure context/category/field&quot; /&gt;
    &lt;span tal:replace=&quot;structure db/category/classhelp&quot; /&gt;
&lt;/td&gt;
</pre>
<p>First, we define a nice header so that the user knows what the next
section is, then the middle line does what we are most interested in.
This <tt class="literal"><span class="pre">context/category/field</span></tt> gets replaced by a field which contains
the category in the current context (the current context being the new
issue).</p>
<p>The classhelp lines generate a link (labelled &quot;list&quot;) to a popup window
which contains the list of currently known categories.</p>
</div>
<div class="section" id="searching-on-categories">
<h3><a name="searching-on-categories">Searching on categories</a></h3>
<p>We can add categories, and create issues with categories. The next
obvious thing that we would like to be able to do, would be to search
for issues based on their category, so that, for example, anyone working
on the web server could look at all issues in the category &quot;Web&quot;.</p>
<p>If you look for &quot;Search Issues&quot; in the 'html/page.html' file, you will
find that it looks something like 
<tt class="literal"><span class="pre">&lt;a</span> <span class="pre">href=&quot;issue?&#64;template=search&quot;&gt;Search</span> <span class="pre">Issues&lt;/a&gt;</span></tt>. This shows us
that when you click on &quot;Search Issues&quot; it will be looking for a
<tt class="literal"><span class="pre">issue.search.html</span></tt> file to display. So that is the file that we will
change.</p>
<p>If you look at this file it should be starting to seem familiar, although it
does use some new macros. You can add the new category search code anywhere you
like within that form:</p>
<pre class="literal-block">
&lt;tr tal:define=&quot;name string:category;
                db_klass string:category;
                db_content string:name;&quot;&gt;
  &lt;th&gt;Priority:&lt;/th&gt;
  &lt;td metal:use-macro=&quot;search_select&quot;&gt;&lt;/td&gt;
  &lt;td metal:use-macro=&quot;column_input&quot;&gt;&lt;/td&gt;
  &lt;td metal:use-macro=&quot;sort_input&quot;&gt;&lt;/td&gt;
  &lt;td metal:use-macro=&quot;group_input&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>The definitions in the &lt;tr&gt; opening tag are used by the macros:</p>
<ul class="simple">
<li>search_select expands to a drop-down box with all categories using db_klass
and db_content.</li>
<li>column_input expands to a checkbox for selecting what columns should be
displayed.</li>
<li>sort_input expands to a radio button for selecting what property should be
sorted on.</li>
<li>group_input expands to a radio button for selecting what property should be
group on.</li>
</ul>
<p>The category search code above would expand to the following:</p>
<pre class="literal-block">
&lt;tr&gt;
  &lt;th&gt;Category:&lt;/th&gt;
  &lt;td&gt;
    &lt;select name=&quot;category&quot;&gt;
      &lt;option value=&quot;&quot;&gt;don't care&lt;/option&gt;
      &lt;option value=&quot;&quot;&gt;------------&lt;/option&gt;      
      &lt;option value=&quot;1&quot;&gt;scipy&lt;/option&gt;
      &lt;option value=&quot;2&quot;&gt;chaco&lt;/option&gt;
      &lt;option value=&quot;3&quot;&gt;weave&lt;/option&gt;
    &lt;/select&gt;
  &lt;/td&gt;
  &lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;:columns&quot; value=&quot;category&quot;&gt;&lt;/td&gt;
  &lt;td&gt;&lt;input type=&quot;radio&quot; name=&quot;:sort&quot; value=&quot;category&quot;&gt;&lt;/td&gt;
  &lt;td&gt;&lt;input type=&quot;radio&quot; name=&quot;:group&quot; value=&quot;category&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
</pre>
</div>
<div class="section" id="adding-category-to-the-default-view">
<h3><a name="adding-category-to-the-default-view">Adding category to the default view</a></h3>
<p>We can now add categories, add issues with categories, and search for
issues based on categories. This is everything that we need to do;
however, there is some more icing that we would like. I think the
category of an issue is important enough that it should be displayed by
default when listing all the issues.</p>
<p>Unfortunately, this is a bit less obvious than the previous steps. The
code defining how the issues look is in <tt class="literal"><span class="pre">html/issue.index.html</span></tt>. This
is a large table with a form down at the bottom for redisplaying and so
forth.</p>
<p>Firstly we need to add an appropriate header to the start of the table:</p>
<pre class="literal-block">
&lt;th tal:condition=&quot;request/show/category&quot;&gt;Category&lt;/th&gt;
</pre>
<p>The <em>condition</em> part of this statement is to avoid displaying the
Category column if the user has selected not to see it.</p>
<p>The rest of the table is a loop which will go through every issue that
matches the display criteria. The loop variable is &quot;i&quot; - which means
that every issue gets assigned to &quot;i&quot; in turn.</p>
<p>The new part of code to display the category will look like this:</p>
<pre class="literal-block">
&lt;td tal:condition=&quot;request/show/category&quot;
    tal:content=&quot;i/category&quot;&gt;&lt;/td&gt;
</pre>
<p>The condition is the same as above: only display the condition when the
user hasn't asked for it to be hidden. The next part is to set the
content of the cell to be the category part of &quot;i&quot; - the current issue.</p>
<p>Finally we have to edit <tt class="literal"><span class="pre">html/page.html</span></tt> again. This time, we need to
tell it that when the user clicks on &quot;Unasigned Issues&quot; or &quot;All Issues&quot;,
the category column should be included in the resulting list. If you
scroll down the page file, you can see the links with lots of options.
The option that we are interested in is the <tt class="literal"><span class="pre">:columns=</span></tt> one which
tells roundup which fields of the issue to display. Simply add
&quot;category&quot; to that list and it all should work.</p>
</div>
</div>
<div class="section" id="adding-in-state-transition-control">
<h2><a class="toc-backref" href="#id27" name="adding-in-state-transition-control">Adding in state transition control</a></h2>
<p>Sometimes tracker admins want to control the states that users may move
issues to. You can do this by following these steps:</p>
<ol class="arabic">
<li><p class="first">make &quot;status&quot; a required variable. This is achieved by adding the
following to the top of the form in the <tt class="literal"><span class="pre">issue.item.html</span></tt>
template:</p>
<pre class="literal-block">
&lt;input type=&quot;hidden&quot; name=&quot;&#64;required&quot; value=&quot;status&quot;&gt;
</pre>
<p>this will force users to select a status.</p>
</li>
<li><p class="first">add a Multilink property to the status class:</p>
<pre class="literal-block">
stat = Class(db, &quot;status&quot;, ... , transitions=Multilink('status'),
             ...)
</pre>
<p>and then edit the statuses already created, either:</p>
<ol class="loweralpha simple">
<li>through the web using the class list -&gt; status class editor, or</li>
<li>using the roundup-admin &quot;set&quot; command.</li>
</ol>
</li>
<li><p class="first">add an auditor module <tt class="literal"><span class="pre">checktransition.py</span></tt> in your tracker's
<tt class="literal"><span class="pre">detectors</span></tt> directory, for example:</p>
<pre class="literal-block">
def checktransition(db, cl, nodeid, newvalues):
    ''' Check that the desired transition is valid for the &quot;status&quot;
        property.
    '''
    if not newvalues.has_key('status'):
        return
    current = cl.get(nodeid, 'status')
    new = newvalues['status']
    if new == current:
        return
    ok = db.status.get(current, 'transitions')
    if new not in ok:
        raise ValueError, 'Status not allowed to move from &quot;%s&quot; to &quot;%s&quot;'%(
            db.status.get(current, 'name'), db.status.get(new, 'name'))

def init(db):
    db.issue.audit('set', checktransition)
</pre>
</li>
<li><p class="first">in the <tt class="literal"><span class="pre">issue.item.html</span></tt> template, change the status editing bit
from:</p>
<pre class="literal-block">
&lt;th nowrap&gt;Status&lt;/th&gt;
&lt;td tal:content=&quot;structure context/status/menu&quot;&gt;status&lt;/td&gt;
</pre>
<p>to:</p>
<pre class="literal-block">
&lt;th nowrap&gt;Status&lt;/th&gt;
&lt;td&gt;
 &lt;select tal:condition=&quot;context/id&quot; name=&quot;status&quot;&gt;
  &lt;tal:block tal:define=&quot;ok context/status/transitions&quot;
             tal:repeat=&quot;state db/status/list&quot;&gt;
   &lt;option tal:condition=&quot;python:state.id in ok&quot;
           tal:attributes=&quot;
                value state/id;
                selected python:state.id == context.status.id&quot;
           tal:content=&quot;state/name&quot;&gt;&lt;/option&gt;
  &lt;/tal:block&gt;
 &lt;/select&gt;
 &lt;tal:block tal:condition=&quot;not:context/id&quot;
            tal:replace=&quot;structure context/status/menu&quot; /&gt;
&lt;/td&gt;
</pre>
<p>which displays only the allowed status to transition to.</p>
</li>
</ol>
</div>
<div class="section" id="displaying-only-message-summaries-in-the-issue-display">
<h2><a class="toc-backref" href="#id28" name="displaying-only-message-summaries-in-the-issue-display">Displaying only message summaries in the issue display</a></h2>
<p>Alter the issue.item template section for messages to:</p>
<pre class="literal-block">
&lt;table class=&quot;messages&quot; tal:condition=&quot;context/messages&quot;&gt;
 &lt;tr&gt;&lt;th colspan=&quot;5&quot; class=&quot;header&quot;&gt;Messages&lt;/th&gt;&lt;/tr&gt;
 &lt;tr tal:repeat=&quot;msg context/messages&quot;&gt;
  &lt;td&gt;&lt;a tal:attributes=&quot;href string:msg${msg/id}&quot;
         tal:content=&quot;string:msg${msg/id}&quot;&gt;&lt;/a&gt;&lt;/td&gt;
  &lt;td tal:content=&quot;msg/author&quot;&gt;author&lt;/td&gt;
  &lt;td nowrap tal:content=&quot;msg/date/pretty&quot;&gt;date&lt;/td&gt;
  &lt;td tal:content=&quot;msg/summary&quot;&gt;summary&lt;/td&gt;
  &lt;td&gt;
   &lt;a tal:attributes=&quot;href string:?&#64;remove&#64;messages=${msg/id}&amp;&#64;action=edit&quot;&gt;
   remove&lt;/a&gt;
  &lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;
</pre>
</div>
<div class="section" id="restricting-the-list-of-users-that-are-assignable-to-a-task">
<h2><a class="toc-backref" href="#id29" name="restricting-the-list-of-users-that-are-assignable-to-a-task">Restricting the list of users that are assignable to a task</a></h2>
<ol class="arabic">
<li><p class="first">In your tracker's &quot;dbinit.py&quot;, create a new Role, say &quot;Developer&quot;:</p>
<pre class="literal-block">
db.security.addRole(name='Developer', description='A developer')
</pre>
</li>
<li><p class="first">Just after that, create a new Permission, say &quot;Fixer&quot;, specific to
&quot;issue&quot;:</p>
<pre class="literal-block">
p = db.security.addPermission(name='Fixer', klass='issue',
    description='User is allowed to be assigned to fix issues')
</pre>
</li>
<li><p class="first">Then assign the new Permission to your &quot;Developer&quot; Role:</p>
<pre class="literal-block">
db.security.addPermissionToRole('Developer', p)
</pre>
</li>
<li><p class="first">In the issue item edit page (&quot;html/issue.item.html&quot; in your tracker
directory), use the new Permission in restricting the &quot;assignedto&quot;
list:</p>
<pre class="literal-block">
&lt;select name=&quot;assignedto&quot;&gt;
 &lt;option value=&quot;-1&quot;&gt;- no selection -&lt;/option&gt;
 &lt;tal:block tal:repeat=&quot;user db/user/list&quot;&gt;
 &lt;option tal:condition=&quot;python:user.hasPermission(
                            'Fixer', context._classname)&quot;
         tal:attributes=&quot;
            value user/id;
            selected python:user.id == context.assignedto&quot;
         tal:content=&quot;user/realname&quot;&gt;&lt;/option&gt;
 &lt;/tal:block&gt;
&lt;/select&gt;
</pre>
</li>
</ol>
<p>For extra security, you may wish to setup an auditor to enforce the
Permission requirement (install this as &quot;assignedtoFixer.py&quot; in your
tracker &quot;detectors&quot; directory):</p>
<pre class="literal-block">
def assignedtoMustBeFixer(db, cl, nodeid, newvalues):
    ''' Ensure the assignedto value in newvalues is a used with the
        Fixer Permission
    '''
    if not newvalues.has_key('assignedto'):
        # don't care
        return

    # get the userid
    userid = newvalues['assignedto']
    if not db.security.hasPermission('Fixer', userid, cl.classname):
        raise ValueError, 'You do not have permission to edit %s'%cl.classname

def init(db):
    db.issue.audit('set', assignedtoMustBeFixer)
    db.issue.audit('create', assignedtoMustBeFixer)
</pre>
<p>So now, if an edit action attempts to set &quot;assignedto&quot; to a user that
doesn't have the &quot;Fixer&quot; Permission, the error will be raised.</p>
</div>
<div class="section" id="setting-up-a-wizard-or-druid-for-controlled-adding-of-issues">
<h2><a class="toc-backref" href="#id30" name="setting-up-a-wizard-or-druid-for-controlled-adding-of-issues">Setting up a &quot;wizard&quot; (or &quot;druid&quot;) for controlled adding of issues</a></h2>
<ol class="arabic">
<li><p class="first">Set up the page templates you wish to use for data input. My wizard
is going to be a two-step process: first figuring out what category
of issue the user is submitting, and then getting details specific to
that category. The first page includes a table of help, explaining
what the category names mean, and then the core of the form:</p>
<pre class="literal-block">
&lt;form method=&quot;POST&quot; onSubmit=&quot;return submit_once()&quot;
      enctype=&quot;multipart/form-data&quot;&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;&#64;template&quot; value=&quot;add_page1&quot;&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;&#64;action&quot; value=&quot;page1submit&quot;&gt;

  &lt;strong&gt;Category:&lt;/strong&gt;
  &lt;tal:block tal:replace=&quot;structure context/category/menu&quot; /&gt;
  &lt;input type=&quot;submit&quot; value=&quot;Continue&quot;&gt;
&lt;/form&gt;
</pre>
<p>The next page has the usual issue entry information, with the
addition of the following form fragments:</p>
<pre class="literal-block">
&lt;form method=&quot;POST&quot; onSubmit=&quot;return submit_once()&quot;
      enctype=&quot;multipart/form-data&quot;
      tal:condition=&quot;context/is_edit_ok&quot;
      tal:define=&quot;cat request/form/category/value&quot;&gt;

  &lt;input type=&quot;hidden&quot; name=&quot;&#64;template&quot; value=&quot;add_page2&quot;&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;&#64;required&quot; value=&quot;title&quot;&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;category&quot; tal:attributes=&quot;value cat&quot;&gt;
   .
   .
   .
&lt;/form&gt;
</pre>
<p>Note that later in the form, I test the value of &quot;cat&quot; include form
elements that are appropriate. For example:</p>
<pre class="literal-block">
&lt;tal:block tal:condition=&quot;python:cat in '6 10 13 14 15 16 17'.split()&quot;&gt;
 &lt;tr&gt;
  &lt;th nowrap&gt;Operating System&lt;/th&gt;
  &lt;td tal:content=&quot;structure context/os/field&quot;&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
  &lt;th nowrap&gt;Web Browser&lt;/th&gt;
  &lt;td tal:content=&quot;structure context/browser/field&quot;&gt;&lt;/td&gt;
 &lt;/tr&gt;
&lt;/tal:block&gt;
</pre>
<p>... the above section will only be displayed if the category is one
of 6, 10, 13, 14, 15, 16 or 17.</p>
</li>
</ol>
<ol class="arabic" start="3">
<li><p class="first">Determine what actions need to be taken between the pages - these are
usually to validate user choices and determine what page is next. Now
encode those actions in methods on the <tt class="literal"><span class="pre">interfaces.Client</span></tt> class
and insert hooks to those actions in the &quot;actions&quot; attribute on that
class, like so:</p>
<pre class="literal-block">
actions = client.Client.actions + (
    ('page1_submit', 'page1SubmitAction'),
)

def page1SubmitAction(self):
    ''' Verify that the user has selected a category, and then move
        on to page 2.
    '''
    category = self.form['category'].value
    if category == '-1':
        self.error_message.append('You must select a category of report')
        return
    # everything's ok, move on to the next page
    self.template = 'add_page2'
</pre>
</li>
<li><p class="first">Use the usual &quot;new&quot; action as the <tt class="literal"><span class="pre">&#64;action</span></tt> on the final page, and
you're done (the standard context/submit method can do this for you).</p>
</li>
</ol>
</div>
<div class="section" id="using-an-external-password-validation-source">
<h2><a class="toc-backref" href="#id31" name="using-an-external-password-validation-source">Using an external password validation source</a></h2>
<p>We have a centrally-managed password changing system for our users. This
results in a UN*X passwd-style file that we use for verification of
users. Entries in the file consist of <tt class="literal"><span class="pre">name:password</span></tt> where the
password is encrypted using the standard UN*X <tt class="literal"><span class="pre">crypt()</span></tt> function (see
the <tt class="literal"><span class="pre">crypt</span></tt> module in your Python distribution). An example entry
would be:</p>
<pre class="literal-block">
admin:aamrgyQfDFSHw
</pre>
<p>Each user of Roundup must still have their information stored in the
Roundup database - we just use the passwd file to check their password.
To do this, we add the following code to our <tt class="literal"><span class="pre">Client</span></tt> class in the
tracker home <tt class="literal"><span class="pre">interfaces.py</span></tt> module:</p>
<pre class="literal-block">
def verifyPassword(self, userid, password):
    # get the user's username
    username = self.db.user.get(userid, 'username')

    # the passwords are stored in the &quot;passwd.txt&quot; file in the
    # tracker home
    file = os.path.join(self.db.config.TRACKER_HOME, 'passwd.txt')

    # see if we can find a match
    for ent in [line.strip().split(':') for line in
                                        open(file).readlines()]:
        if ent[0] == username:
            return crypt.crypt(password, ent[1][:2]) == ent[1]

    # user doesn't exist in the file
    return 0
</pre>
<p>What this does is look through the file, line by line, looking for a
name that matches.</p>
<p>We also remove the redundant password fields from the <tt class="literal"><span class="pre">user.item</span></tt>
template.</p>
</div>
<div class="section" id="adding-a-vacation-flag-to-users-for-stopping-nosy-messages">
<h2><a class="toc-backref" href="#id32" name="adding-a-vacation-flag-to-users-for-stopping-nosy-messages">Adding a &quot;vacation&quot; flag to users for stopping nosy messages</a></h2>
<p>When users go on vacation and set up vacation email bouncing, you'll
start to see a lot of messages come back through Roundup &quot;Fred is on
vacation&quot;. Not very useful, and relatively easy to stop.</p>
<ol class="arabic">
<li><p class="first">add a &quot;vacation&quot; flag to your users:</p>
<pre class="literal-block">
user = Class(db, &quot;user&quot;,
           username=String(),   password=Password(),
           address=String(),    realname=String(),
           phone=String(),      organisation=String(),
           alternate_addresses=String(),
           roles=String(), queries=Multilink(&quot;query&quot;),
           vacation=Boolean())
</pre>
</li>
<li><p class="first">So that users may edit the vacation flags, add something like the
following to your <tt class="literal"><span class="pre">user.item</span></tt> template:</p>
<pre class="literal-block">
&lt;tr&gt;
 &lt;th&gt;On Vacation&lt;/th&gt; 
 &lt;td tal:content=&quot;structure context/vacation/field&quot;&gt;vacation&lt;/td&gt; 
&lt;/tr&gt; 
</pre>
</li>
<li><p class="first">edit your detector <tt class="literal"><span class="pre">nosyreactor.py</span></tt> so that the <tt class="literal"><span class="pre">nosyreaction()</span></tt>
consists of:</p>
<pre class="literal-block">
def nosyreaction(db, cl, nodeid, oldvalues):
    # send a copy of all new messages to the nosy list
    for msgid in determineNewMessages(cl, nodeid, oldvalues):
        try:
            users = db.user
            messages = db.msg

            # figure the recipient ids
            sendto = []
            r = {}
            recipients = messages.get(msgid, 'recipients')
            for recipid in messages.get(msgid, 'recipients'):
                r[recipid] = 1

            # figure the author's id, and indicate they've received
            # the message
            authid = messages.get(msgid, 'author')

            # possibly send the message to the author, as long as
            # they aren't anonymous
            if (db.config.MESSAGES_TO_AUTHOR == 'yes' and
                    users.get(authid, 'username') != 'anonymous'):
                sendto.append(authid)
            r[authid] = 1

            # now figure the nosy people who weren't recipients
            nosy = cl.get(nodeid, 'nosy')
            for nosyid in nosy:
                # Don't send nosy mail to the anonymous user (that
                # user shouldn't appear in the nosy list, but just
                # in case they do...)
                if users.get(nosyid, 'username') == 'anonymous':
                    continue
                # make sure they haven't seen the message already
                if not r.has_key(nosyid):
                    # send it to them
                    sendto.append(nosyid)
                    recipients.append(nosyid)

            # generate a change note
            if oldvalues:
                note = cl.generateChangeNote(nodeid, oldvalues)
            else:
                note = cl.generateCreateNote(nodeid)

            # we have new recipients
            if sendto:
                # filter out the people on vacation
                sendto = [i for i in sendto 
                          if not users.get(i, 'vacation', 0)]

                # map userids to addresses
                sendto = [users.get(i, 'address') for i in sendto]

                # update the message's recipients list
                messages.set(msgid, recipients=recipients)

                # send the message
                cl.send_message(nodeid, msgid, note, sendto)
        except roundupdb.MessageSendError, message:
            raise roundupdb.DetectorError, message
</pre>
<p>Note that this is the standard nosy reaction code, with the small
addition of:</p>
<pre class="literal-block">
# filter out the people on vacation
sendto = [i for i in sendto if not users.get(i, 'vacation', 0)]
</pre>
<p>which filters out the users that have the vacation flag set to true.</p>
</li>
</ol>
</div>
<div class="section" id="adding-a-time-log-to-your-issues">
<h2><a class="toc-backref" href="#id33" name="adding-a-time-log-to-your-issues">Adding a time log to your issues</a></h2>
<p>We want to log the dates and amount of time spent working on issues, and
be able to give a summary of the total time spent on a particular issue.</p>
<ol class="arabic">
<li><p class="first">Add a new class to your tracker <tt class="literal"><span class="pre">dbinit.py</span></tt>:</p>
<pre class="literal-block">
# storage for time logging
timelog = Class(db, &quot;timelog&quot;, period=Interval())
</pre>
<p>Note that we automatically get the date of the time log entry
creation through the standard property &quot;creation&quot;.</p>
</li>
<li><p class="first">Link to the new class from your issue class (again, in
<tt class="literal"><span class="pre">dbinit.py</span></tt>):</p>
<pre class="literal-block">
issue = IssueClass(db, &quot;issue&quot;, 
                assignedto=Link(&quot;user&quot;), topic=Multilink(&quot;keyword&quot;),
                priority=Link(&quot;priority&quot;), status=Link(&quot;status&quot;),
                times=Multilink(&quot;timelog&quot;))
</pre>
<p>the &quot;times&quot; property is the new link to the &quot;timelog&quot; class.</p>
</li>
<li><p class="first">We'll need to let people add in times to the issue, so in the web
interface we'll have a new entry field. This is a special field
because unlike the other fields in the issue.item template, it
affects a different item (a timelog item) and not the template's
item, an issue. We have a special syntax for form fields that affect
items other than the template default item (see the cgi 
documentation on <a class="reference" href="#special-form-variables">special form variables</a>). In particular, we add a
field to capture a new timelog item's perdiod:</p>
<pre class="literal-block">
&lt;tr&gt; 
 &lt;th nowrap&gt;Time Log&lt;/th&gt; 
 &lt;td colspan=3&gt;&lt;input type=&quot;text&quot; name=&quot;timelog-1&#64;period&quot; /&gt; 
  &lt;br /&gt;(enter as '3y 1m 4d 2:40:02' or parts thereof) 
 &lt;/td&gt; 
&lt;/tr&gt; 
</pre>
<p>and another hidden field that links that new timelog item (new
because it's marked as having id &quot;-1&quot;) to the issue item. It looks
like this:</p>
<pre class="literal-block">
&lt;input type=&quot;hidden&quot; name=&quot;&#64;link&#64;times&quot; value=&quot;timelog-1&quot; /&gt;
</pre>
<p>On submission, the &quot;-1&quot; timelog item will be created and assigned a
real item id. The &quot;times&quot; property of the issue will have the new id
added to it.</p>
</li>
<li><p class="first">We want to display a total of the time log times that have been
accumulated for an issue. To do this, we'll need to actually write
some Python code, since it's beyond the scope of PageTemplates to
perform such calculations. We do this by adding a method to the
TemplatingUtils class in our tracker <tt class="literal"><span class="pre">interfaces.py</span></tt> module:</p>
<pre class="literal-block">
class TemplatingUtils:
    ''' Methods implemented on this class will be available to HTML
        templates through the 'utils' variable.
    '''
    def totalTimeSpent(self, times):
        ''' Call me with a list of timelog items (which have an
            Interval &quot;period&quot; property)
        '''
        total = Interval('')
        for time in times:
            total += time.period._value
        return total
</pre>
<p>Replace the <tt class="literal"><span class="pre">pass</span></tt> line as we did in step 4 above with the Client
class. As indicated in the docstrings, we will be able to access the
<tt class="literal"><span class="pre">totalTimeSpent</span></tt> method via the <tt class="literal"><span class="pre">utils</span></tt> variable in our
templates.</p>
</li>
<li><p class="first">Display the time log for an issue:</p>
<pre class="literal-block">
&lt;table class=&quot;otherinfo&quot; tal:condition=&quot;context/times&quot;&gt;
 &lt;tr&gt;&lt;th colspan=&quot;3&quot; class=&quot;header&quot;&gt;Time Log
  &lt;tal:block
       tal:replace=&quot;python:utils.totalTimeSpent(context.times)&quot; /&gt;
 &lt;/th&gt;&lt;/tr&gt;
 &lt;tr&gt;&lt;th&gt;Date&lt;/th&gt;&lt;th&gt;Period&lt;/th&gt;&lt;th&gt;Logged By&lt;/th&gt;&lt;/tr&gt;
 &lt;tr tal:repeat=&quot;time context/times&quot;&gt;
  &lt;td tal:content=&quot;time/creation&quot;&gt;&lt;/td&gt;
  &lt;td tal:content=&quot;time/period&quot;&gt;&lt;/td&gt;
  &lt;td tal:content=&quot;time/creator&quot;&gt;&lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;
</pre>
<p>I put this just above the Messages log in my issue display. Note our
use of the <tt class="literal"><span class="pre">totalTimeSpent</span></tt> method which will total up the times
for the issue and return a new Interval. That will be automatically
displayed in the template as text like &quot;+ 1y 2:40&quot; (1 year, 2 hours
and 40 minutes).</p>
</li>
</ol>
<ol class="arabic simple" start="8">
<li>If you're using a persistent web server - roundup-server or
mod_python for example - then you'll need to restart that to pick up
the code changes. When that's done, you'll be able to use the new
time logging interface.</li>
</ol>
</div>
<div class="section" id="using-a-un-x-passwd-file-as-the-user-database">
<h2><a class="toc-backref" href="#id34" name="using-a-un-x-passwd-file-as-the-user-database">Using a UN*X passwd file as the user database</a></h2>
<p>On some systems the primary store of users is the UN*X passwd file. It
holds information on users such as their username, real name, password
and primary user group.</p>
<p>Roundup can use this store as its primary source of user information,
but it needs additional information too - email address(es), roundup
Roles, vacation flags, roundup hyperdb item ids, etc. Also, &quot;retired&quot;
users must still exist in the user database, unlike some passwd files in
which the users are removed when they no longer have access to a system.</p>
<p>To make use of the passwd file, we therefore synchronise between the two
user stores. We also use the passwd file to validate the user logins, as
described in the previous example, <a class="reference" href="#using-an-external-password-validation-source">using an external password
validation source</a>. We keep the users lists in sync using a fairly
simple script that runs once a day, or several times an hour if more
immediate access is needed. In short, it:</p>
<ol class="arabic simple">
<li>parses the passwd file, finding usernames, passwords and real names,</li>
<li>compares that list to the current roundup user list:<ol class="loweralpha">
<li>entries no longer in the passwd file are <em>retired</em></li>
<li>entries with mismatching real names are <em>updated</em></li>
<li>entries only exist in the passwd file are <em>created</em></li>
</ol>
</li>
<li>send an email to administrators to let them know what's been done.</li>
</ol>
<p>The retiring and updating are simple operations, requiring only a call
to <tt class="literal"><span class="pre">retire()</span></tt> or <tt class="literal"><span class="pre">set()</span></tt>. The creation operation requires more
information though - the user's email address and their roundup Roles.
We're going to assume that the user's email address is the same as their
login name, so we just append the domain name to that. The Roles are
determined using the passwd group identifier - mapping their UN*X group
to an appropriate set of Roles.</p>
<p>The script to perform all this, broken up into its main components, is
as follows. Firstly, we import the necessary modules and open the
tracker we're to work on:</p>
<pre class="literal-block">
import sys, os, smtplib
from roundup import instance, date

# open the tracker
tracker_home = sys.argv[1]
tracker = instance.open(tracker_home)
</pre>
<p>Next we read in the <em>passwd</em> file from the tracker home:</p>
<pre class="literal-block">
# read in the users
file = os.path.join(tracker_home, 'users.passwd')
users = [x.strip().split(':') for x in open(file).readlines()]
</pre>
<p>Handle special users (those to ignore in the file, and those who don't
appear in the file):</p>
<pre class="literal-block">
# users to not keep ever, pre-load with the users I know aren't
# &quot;real&quot; users
ignore = ['ekmmon', 'bfast', 'csrmail']

# users to keep - pre-load with the roundup-specific users
keep = ['comment_pool', 'network_pool', 'admin', 'dev-team',
        'cs_pool', 'anonymous', 'system_pool', 'automated']
</pre>
<p>Now we map the UN*X group numbers to the Roles that users should have:</p>
<pre class="literal-block">
roles = {
 '501': 'User,Tech',  # tech
 '502': 'User',       # finance
 '503': 'User,CSR',   # customer service reps
 '504': 'User',       # sales
 '505': 'User',       # marketing
}
</pre>
<p>Now we do all the work. Note that the body of the script (where we have
the tracker database open) is wrapped in a <tt class="literal"><span class="pre">try</span></tt> / <tt class="literal"><span class="pre">finally</span></tt> clause,
so that we always close the database cleanly when we're finished. So, we
now do all the work:</p>
<pre class="literal-block">
# open the database
db = tracker.open('admin')
try:
    # store away messages to send to the tracker admins
    msg = []

    # loop over the users list read in from the passwd file
    for user,passw,uid,gid,real,home,shell in users:
        if user in ignore:
            # this user shouldn't appear in our tracker
            continue
        keep.append(user)
        try:
            # see if the user exists in the tracker
            uid = db.user.lookup(user)

            # yes, they do - now check the real name for correctness
            if real != db.user.get(uid, 'realname'):
                db.user.set(uid, realname=real)
                msg.append('FIX %s - %s'%(user, real))
        except KeyError:
            # nope, the user doesn't exist
            db.user.create(username=user, realname=real,
                address='%s&#64;ekit-inc.com'%user, roles=roles[gid])
            msg.append('ADD %s - %s (%s)'%(user, real, roles[gid]))

    # now check that all the users in the tracker are also in our
    # &quot;keep&quot; list - retire those who aren't
    for uid in db.user.list():
        user = db.user.get(uid, 'username')
        if user not in keep:
            db.user.retire(uid)
            msg.append('RET %s'%user)

    # if we did work, then send email to the tracker admins
    if msg:
        # create the email
        msg = '''Subject: %s user database maintenance

        %s
        '''%(db.config.TRACKER_NAME, '\n'.join(msg))

        # send the email
        smtp = smtplib.SMTP(db.config.MAILHOST)
        addr = db.config.ADMIN_EMAIL
        smtp.sendmail(addr, addr, msg)

    # now we're done - commit the changes
    db.commit()
finally:
    # always close the database cleanly
    db.close()
</pre>
<p>And that's it!</p>
</div>
<div class="section" id="using-an-ldap-database-for-user-information">
<h2><a class="toc-backref" href="#id35" name="using-an-ldap-database-for-user-information">Using an LDAP database for user information</a></h2>
<p>A script that reads users from an LDAP store using
<a class="reference" href="http://python-ldap.sf.net/">http://python-ldap.sf.net/</a> and then compares the list to the users in the
roundup user database would be pretty easy to write. You'd then have it run
once an hour / day (or on demand if you can work that into your LDAP store
workflow). See the example <a class="reference" href="#using-a-un-x-passwd-file-as-the-user-database">Using a UN*X passwd file as the user database</a>
for more information about doing this.</p>
<p>To authenticate off the LDAP store (rather than using the passwords in the
roundup user database) you'd use the same python-ldap module inside an
extension to the cgi interface. You'd do this by adding a method called
&quot;verifyPassword&quot; to the Client class in your tracker's interfaces.py
module. The method is implemented by default as:</p>
<pre class="literal-block">
def verifyPassword(self, userid, password):
    ''' Verify the password that the user has supplied
    '''
    stored = self.db.user.get(self.userid, 'password')
    if password == stored:
        return 1
    if not password and not stored:
        return 1
    return 0
</pre>
<p>So you could reimplement this as something like:</p>
<pre class="literal-block">
def verifyPassword(self, userid, password):
    ''' Verify the password that the user has supplied
    '''
    # look up some unique LDAP information about the user
    username = self.db.user.get(self.userid, 'username')
    # now verify the password supplied against the LDAP store
</pre>
</div>
<div class="section" id="enabling-display-of-either-message-summaries-or-the-entire-messages">
<h2><a class="toc-backref" href="#id36" name="enabling-display-of-either-message-summaries-or-the-entire-messages">Enabling display of either message summaries or the entire messages</a></h2>
<p>This is pretty simple - all we need to do is copy the code from the
example <a class="reference" href="#displaying-only-message-summaries-in-the-issue-display">displaying only message summaries in the issue display</a> into
our template alongside the summary display, and then introduce a switch
that shows either one or the other. We'll use a new form variable,
<tt class="literal"><span class="pre">&#64;whole_messages</span></tt> to achieve this:</p>
<pre class="literal-block">
&lt;table class=&quot;messages&quot; tal:condition=&quot;context/messages&quot;&gt;
 &lt;tal:block tal:condition=&quot;not:request/form/&#64;whole_messages/value | python:0&quot;&gt;
  &lt;tr&gt;&lt;th colspan=&quot;3&quot; class=&quot;header&quot;&gt;Messages&lt;/th&gt;
      &lt;th colspan=&quot;2&quot; class=&quot;header&quot;&gt;
        &lt;a href=&quot;?&#64;whole_messages=yes&quot;&gt;show entire messages&lt;/a&gt;
      &lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr tal:repeat=&quot;msg context/messages&quot;&gt;
   &lt;td&gt;&lt;a tal:attributes=&quot;href string:msg${msg/id}&quot;
          tal:content=&quot;string:msg${msg/id}&quot;&gt;&lt;/a&gt;&lt;/td&gt;
   &lt;td tal:content=&quot;msg/author&quot;&gt;author&lt;/td&gt;
   &lt;td nowrap tal:content=&quot;msg/date/pretty&quot;&gt;date&lt;/td&gt;
   &lt;td tal:content=&quot;msg/summary&quot;&gt;summary&lt;/td&gt;
   &lt;td&gt;
    &lt;a tal:attributes=&quot;href string:?&#64;remove&#64;messages=${msg/id}&amp;&#64;action=edit&quot;&gt;remove&lt;/a&gt;
   &lt;/td&gt;
  &lt;/tr&gt;
 &lt;/tal:block&gt;

 &lt;tal:block tal:condition=&quot;request/form/&#64;whole_messages/value | python:0&quot;&gt;
  &lt;tr&gt;&lt;th colspan=&quot;2&quot; class=&quot;header&quot;&gt;Messages&lt;/th&gt;
      &lt;th class=&quot;header&quot;&gt;
        &lt;a href=&quot;?&#64;whole_messages=&quot;&gt;show only summaries&lt;/a&gt;
      &lt;/th&gt;
  &lt;/tr&gt;
  &lt;tal:block tal:repeat=&quot;msg context/messages&quot;&gt;
   &lt;tr&gt;
    &lt;th tal:content=&quot;msg/author&quot;&gt;author&lt;/th&gt;
    &lt;th nowrap tal:content=&quot;msg/date/pretty&quot;&gt;date&lt;/th&gt;
    &lt;th style=&quot;text-align: right&quot;&gt;
     (&lt;a tal:attributes=&quot;href string:?&#64;remove&#64;messages=${msg/id}&amp;&#64;action=edit&quot;&gt;remove&lt;/a&gt;)
    &lt;/th&gt;
   &lt;/tr&gt;
   &lt;tr&gt;&lt;td colspan=&quot;3&quot; tal:content=&quot;msg/content&quot;&gt;&lt;/td&gt;&lt;/tr&gt;
  &lt;/tal:block&gt;
 &lt;/tal:block&gt;
&lt;/table&gt;
</pre>
</div>
<div class="section" id="blocking-issues-that-depend-on-other-issues">
<h2><a class="toc-backref" href="#id37" name="blocking-issues-that-depend-on-other-issues">Blocking issues that depend on other issues</a></h2>
<p>We needed the ability to mark certain issues as &quot;blockers&quot; - that is,
they can't be resolved until another issue (the blocker) they rely on is
resolved. To achieve this:</p>
<ol class="arabic">
<li><p class="first">Create a new property on the issue Class,
<tt class="literal"><span class="pre">blockers=Multilink(&quot;issue&quot;)</span></tt>. Edit your tracker's dbinit.py file.
Where the &quot;issue&quot; class is defined, something like:</p>
<pre class="literal-block">
issue = IssueClass(db, &quot;issue&quot;, 
                assignedto=Link(&quot;user&quot;), topic=Multilink(&quot;keyword&quot;),
                priority=Link(&quot;priority&quot;), status=Link(&quot;status&quot;))
</pre>
<p>add the blockers entry like so:</p>
<pre class="literal-block">
issue = IssueClass(db, &quot;issue&quot;, 
                blockers=Multilink(&quot;issue&quot;),
                assignedto=Link(&quot;user&quot;), topic=Multilink(&quot;keyword&quot;),
                priority=Link(&quot;priority&quot;), status=Link(&quot;status&quot;))
</pre>
</li>
<li><p class="first">Add the new &quot;blockers&quot; property to the issue.item edit page, using
something like:</p>
<pre class="literal-block">
&lt;th nowrap&gt;Waiting On&lt;/th&gt;
&lt;td&gt;
 &lt;span tal:replace=&quot;structure python:context.blockers.field(showid=1,
                              size=20)&quot; /&gt;
 &lt;span tal:replace=&quot;structure python:db.issue.classhelp('id,title')&quot; /&gt;
 &lt;span tal:condition=&quot;context/blockers&quot;
       tal:repeat=&quot;blk context/blockers&quot;&gt;
  &lt;br&gt;View: &lt;a tal:attributes=&quot;href string:issue${blk/id}&quot;
               tal:content=&quot;blk/id&quot;&gt;&lt;/a&gt;
 &lt;/span&gt;
</pre>
<p>You'll need to fiddle with your item page layout to find an
appropriate place to put it - I'll leave that fun part up to you.
Just make sure it appears in the first table, possibly somewhere near
the &quot;superseders&quot; field.</p>
</li>
<li><p class="first">Create a new detector module (attached) which enforces the rules:</p>
<ul class="simple">
<li>issues may not be resolved if they have blockers</li>
<li>when a blocker is resolved, it's removed from issues it blocks</li>
</ul>
<p>The contents of the detector should be something like this:</p>
<pre class="literal-block">
def blockresolution(db, cl, nodeid, newvalues):
    ''' If the issue has blockers, don't allow it to be resolved.
    '''
    if nodeid is None:
        blockers = []
    else:
        blockers = cl.get(nodeid, 'blockers')
    blockers = newvalues.get('blockers', blockers)

    # don't do anything if there's no blockers or the status hasn't
    # changed
    if not blockers or not newvalues.has_key('status'):
        return

    # get the resolved state ID
    resolved_id = db.status.lookup('resolved')

    # format the info
    u = db.config.TRACKER_WEB
    s = ', '.join(['&lt;a href=&quot;%sissue%s&quot;&gt;%s&lt;/a&gt;'%(
                    u,id,id) for id in blockers])
    if len(blockers) == 1:
        s = 'issue %s is'%s
    else:
        s = 'issues %s are'%s

    # ok, see if we're trying to resolve
    if newvalues['status'] == resolved_id:
        raise ValueError, &quot;This issue can't be resolved until %s resolved.&quot;%s

def resolveblockers(db, cl, nodeid, newvalues):
    ''' When we resolve an issue that's a blocker, remove it from the
        blockers list of the issue(s) it blocks.
    '''
    if not newvalues.has_key('status'):
        return

    # get the resolved state ID
    resolved_id = db.status.lookup('resolved')

    # interesting?
    if newvalues['status'] != resolved_id:
        return

    # yes - find all the blocked issues, if any, and remove me from
    # their blockers list
    issues = cl.find(blockers=nodeid)
    for issueid in issues:
        blockers = cl.get(issueid, 'blockers')
        if nodeid in blockers:
            blockers.remove(nodeid)
            cl.set(issueid, blockers=blockers)


def init(db):
    # might, in an obscure situation, happen in a create
    db.issue.audit('create', blockresolution)
    db.issue.audit('set', blockresolution)

    # can only happen on a set
    db.issue.react('set', resolveblockers)
</pre>
<p>Put the above code in a file called &quot;blockers.py&quot; in your tracker's
&quot;detectors&quot; directory.</p>
</li>
<li><p class="first">Finally, and this is an optional step, modify the tracker web page
URLs so they filter out issues with any blockers. You do this by
adding an additional filter on &quot;blockers&quot; for the value &quot;-1&quot;. For
example, the existing &quot;Show All&quot; link in the &quot;page&quot; template (in the
tracker's &quot;html&quot; directory) looks like this:</p>
<pre class="literal-block">
&lt;a href=&quot;issue?:sort=-activity&amp;:group=priority&amp;:filter=status&amp;:columns=id,activity,title,creator,assignedto,status&amp;status=-1,1,2,3,4,5,6,7&quot;&gt;Show All&lt;/a&gt;&lt;br&gt;
</pre>
<p>modify it to add the &quot;blockers&quot; info to the URL (note, both the
&quot;:filter&quot; <em>and</em> &quot;blockers&quot; values must be specified):</p>
<pre class="literal-block">
&lt;a href=&quot;issue?:sort=-activity&amp;:group=priority&amp;:filter=status,blockers&amp;blockers=-1&amp;:columns=id,activity,title,creator,assignedto,status&amp;status=-1,1,2,3,4,5,6,7&quot;&gt;Show All&lt;/a&gt;&lt;br&gt;
</pre>
</li>
</ol>
<p>That's it. You should now be able to set blockers on your issues. Note
that if you want to know whether an issue has any other issues dependent
on it (i.e. it's in their blockers list) you can look at the journal
history at the bottom of the issue page - look for a &quot;link&quot; event to
another issue's &quot;blockers&quot; property.</p>
<hr />
<p>Back to <a class="reference" href="index.html">Table of Contents</a></p>
</div>
</div>
</div>
<hr class="footer"/>
<div class="footer">
Generated on: 2004-03-18.
</div>
</body>
</html>
