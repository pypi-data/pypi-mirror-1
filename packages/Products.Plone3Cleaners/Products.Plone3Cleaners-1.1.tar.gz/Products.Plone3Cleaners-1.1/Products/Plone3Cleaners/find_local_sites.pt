<html>
  <head>
    <title>Update local sites</title>
  </head>
  <body>
    <h1>Update local sites from Plone 2.5 to Plone 3</h1>
    <p>
      This finds old local sites from Products.Five and replaces them
      with new style local sites.  For a good explanation, see
      Products/Five/doc/localsite.txt.
    </p>
    <p>
      This template intentionally does NOT use the main template as
      this is likely broken; biggest problem: Plone 3 wants to get
      some portlet managers but the old style local site prevents it
      from finding them, which means the browser will only show an
      error.
    </p>
    <p>
      It would be nice to call a script from the command line with
      something like <code>bin/zeoclient run myscript.py</code> but
      that somehow gives pickling errors.
    </p>

    <h2>Find sites</h2>
    <p>
      Look for local sites.  This does not change anything yet.  This
      goes through the entire zope Data.fs, waking up every object.
      <em>This may take long and timeout without telling you
      anything.</em>
    </p>
    <form action="" method="post">
      <input type="submit" name="submit" value="submit" />
   </form>

   <div tal:condition="view/found_sites">
     <h2>Sites have been found</h2>
     <p>
       Go to a form for each site by following the link.  You may want
       to open them in a new tab.  Then click on <em>Migrate to
       Five.component</em> if that is available.  If it is not
       available, everything is fine.
     </p>
     <p>
       Note that with PDBDebugMode enabled, you may get in a traceback
       because of a BeforeTraverse error; just continue: that is
       <em>exactly</em> what you are about to fix. :-)
     </p>
     <p>
       Note also that you need to fix these sites from top to bottom.
       At least: if a local site has another local site in its path,
       you need to fix that one first.
     </p>
     <div tal:repeat="site nocall:view/found_sites">
       <a tal:attributes="href string:${site/absolute_url}/@@update_local_site"
          tal:content="site/title_or_id"
          target="_blank"/>
     </div>
   </div>

  </body>
</html>