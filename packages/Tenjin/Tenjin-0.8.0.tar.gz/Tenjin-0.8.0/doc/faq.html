<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>pyTenjin FAQ</title>
  <meta name="generator" content="kwaser">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <link rel="stylesheet" href="docstyle.css" type="text/css">
</head>

<body>
  <blockquote>
    <div class="mainbody">
      <div align="left">
        <h1>pyTenjin FAQ</h1>
      </div>

      <div align="left">
        release: 0.8.0<br>
        last update: $Date$<br>
      </div>

      <p>Table of contents:</p>

      <ul>
        <li>
          <a href="#faq-basic">Basic</a>

          <ul>
            <li><a href="#faq-syntax-error">I got an SyntaxError exception.</a></li>

            <li><a href="#faq-escape-newline">Is there any way to 'escape' or 'remove' newline at the end of line?</a></li>

            <li><a href="#faq-delete-newline">'#{_content}' includes extra newline at end. Can I delete it?</a></li>

            <li><a href="#faq-change-funcname">Can I change 'escape()' and 'to_str()' function name?</a></li>

            <li><a href="#faq-change-bufname">Can I change '_buf' variable name?</a></li>

            <li><a href="#faq-default-value">Is it able to specify default value if a variable is not set?</a></li>

            <li><a href="#faq-google-appengine">Is pyTenjin ready for Google App Engine?</a></li>
          </ul>
        </li>

        <li>
          <a href="#faq-template">Template</a>

          <ul>
            <li><a href="#faq-template-args">Is it able to specify variables passed to template?</a></li>

            <li><a href="#faq-optional-args">It is hard to specify all template arguments. Any good idea?</a></li>

            <li><a href="#faq-exprpat">Is it able to change embedded expression pattern?</a></li>

            <li><a href="#faq-m17n">Does pyTenjin support M17N?</a></li>

            <li><a href="#faq-m17n-cache">Is it possible to create separated template chaches for each language?</a></li>
          </ul>
        </li>

        <li>
          <a href="#faq-layout">Layout Template</a>

          <ul>
            <li><a href="#faq-change-layout-template">Can I change layout template name in a template file?</a></li>

            <li><a href="#faq-nested-layout-template">Can I nest layout templates for any depth?</a></li>

            <li><a href="#faq-diable-layout">Can I disable default layout template for a certain template?</a></li>

            <li><a href="#faq-template-inheritance">Is Django-like "Template Inheritance" supported?</a></li>
          </ul>
        </li>

        <li>
          <a href="#faq-encoding">Encoding</a>

          <ul>
            <li><a href="#faq-template-encoding">How to specify template encoding?</a></li>

            <li><a href="#faq-encoding-decl">Can I specify encoding name in template file?</a></li>

            <li><a href="#faq-encoding-syntaxerr">I got 'SyntaxError: encoding declaration in Unicode string'</a></li>

            <li><a href="#faq-encoding-unicodedecodeerror">I got UnicodeDecodeError, but I can't find what is wrong</a></li>
          </ul>
        </li>

        <li>
          <a href="#faq-preprocessing">Preprocessing</a>

          <ul>
            <li><a href="#faq-what-is-pp">What is preprocessing?</a></li>

            <li><a href="#faq-pp-merit">What is the merit of preprocessing?</a></li>

            <li>
              <a href="#faq-pp-examples">Is there any examples of preprocessing?</a>

              <ul>
                <li><a href="#Loop%20expantion">Loop expantion</a></li>

                <li><a href="#faq-pp-helpers">Helper methods execution in advance</a></li>

                <li><a href="#faq-pp-m18n">M17N (Multilingualization)</a></li>
              </ul>
            </li>
          </ul>
        </li>

        <li>
          <a href="#faq-performance">Performance</a>

          <ul>
            <li><a href="#faq-how-fast">How fast is pyTenjin compared with other solutions?</a></li>

            <li><a href="#faq-why-so-fast">Why pyTenjin is so fast?</a></li>

            <li><a href="#faq-performance-tuning">Is there any way to get more speed?</a></li>
          </ul>
        </li>
      </ul><a name="faq-basic" id="faq-basic"></a>

      <h2 class="section1">Basic</h2><a name="faq-syntax-error" id="faq-syntax-error"></a>

      <h3 class="section2">I got an SyntaxError exception.</h3>

      <p>Command-line option '-z' checks syntax of template file. You should check template by it.</p><a name="ex1.pyhtml" id="ex1.pyhtml"></a>

      <div class="program_caption">
        File 'ex1.pyhtml':
      </div>
      <pre class="program">
&lt;?py for i in range(0, 10): ?&gt;
&lt;?py     if i % 2 == 0: ?&gt;
#{i} is even.
&lt;?py     else ?&gt;
#{i} is odd.
&lt;?py     #end ?&gt;
&lt;?py #end ?&gt;
</pre><a name="ex1_chksyntax.result" id="ex1_chksyntax.result"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ pytenjin <strong>-z</strong> ex1.pyhtml
ex1.pyhtml:4:9: invalid syntax
  4:     else
             ^
</pre><br>
      <a name="faq-escape-newline" id="faq-escape-newline"></a>

      <h3 class="section2">Is there any way to 'escape' or 'remove' newline at the end of line?</h3>

      <p>Yes, but it is not beautiful very much.</p>

      <p>Assume that you want to generate CSV file. The following is a wrong example.</p><a name="ex2a.pycsv" id="ex2a.pycsv"></a>

      <div class="program_caption">
        File 'ex2a.pycsv': (wrong)
      </div>
      <pre class="program">
&lt;?py 
table = [
  ( "A",  10,  20,  30, ),
  ( "B",  11,  21,  31, ),
  ( "C",  12,  22,  23, ),
]
?&gt;
&lt;?py for line in table: ?&gt;
&lt;?py     sep = '' ?&gt;
&lt;?py     for cell in line: ?&gt;
#{sep}#{cell}
&lt;?py         sep = ', ' ?&gt;
&lt;?py     #end ?&gt;
&lt;?py #end ?&gt;
</pre><a name="ex2a_pycsv.result" id="ex2a_pycsv.result"></a>

      <div class="terminal_caption">
        Result: (wrong)
      </div>
      <pre class="terminal">
$ pytenjin ex2a.pycsv
A
, 10
, 20
, 30
B
, 11
, 21
, 31
C
, 12
, 22
, 23
</pre>

      <p>The following is corrected template.</p><a name="ex2b.pycsv" id="ex2b.pycsv"></a>

      <div class="program_caption">
        File 'ex2b.pycsv':
      </div>
      <pre class="program">
&lt;?py 
table = [
  ( "A",  10,  20,  30, ),
  ( "B",  11,  21,  31, ),
  ( "C",  12,  22,  23, ),
]
?&gt;
&lt;?py
for line in table:
    sep = ''
    for cell in line:
?&gt;#{sep}#{cell}&lt;?py
        sep = ', '
    #end
?&gt;

&lt;?py
#end
?&gt;
</pre><a name="ex2b_pycsv.result" id="ex2b_pycsv.result"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ pytenjin ex2b.pycsv
A, 10, 20, 30
B, 11, 21, 31
C, 12, 22, 23
</pre>

      <p>But it is a little complex and not beautiful. In this case, you may prefer to use '_buf' variable directly.</p><a name="ex2c.pycsv" id="ex2c.pycsv"></a>

      <div class="program_caption">
        File 'ex2c.pycsv':
      </div>
      <pre class="program">
&lt;?py 
table = [
  ( "A",  10,  20,  30),
  ( "B",  11,  21,  31),
  ( "C",  12,  22,  23),
]
?&gt;
&lt;?py
for line in table:
    sep = ''
    for cell in line:
        if sep: _buf.append(sep)
        _buf.append(to_str(cell))
        sep = ', '
    #end
    _buf.append("\n")
#end
?&gt;
</pre><a name="ex2c_pycsv.result" id="ex2c_pycsv.result"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ pytenjin ex2c.pycsv
A, 10, 20, 30
B, 11, 21, 31
C, 12, 22, 23
</pre><br>
      <a name="faq-delete-newline" id="faq-delete-newline"></a>

      <h3 class="section2">'#{_content}' includes extra newline at end. Can I delete it?</h3>

      <p>Yes. You can use '<code>&lt;?py echo(_content) ?&gt;</code>' or '<code>&lt;?py _buf.append(_content)</code> ?&gt;' instead of '<code>#{_content}</code>'.</p><a name="ex3-layout.pyhtml" id="ex3-layout.pyhtml"></a>

      <div class="program_caption">
        File 'ex3-layout.pyhtml':
      </div>
      <pre class="program">
&lt;!-- --&gt;
<strong>#{_content}</strong>
&lt;!-- --&gt;

&lt;!-- --&gt;
<strong>&lt;?py echo(_content) ?&gt;</strong>
&lt;!-- --&gt;

&lt;!-- --&gt;
<strong>&lt;?py _buf.append(_content) ?&gt;</strong>
&lt;!-- --&gt;
</pre><a name="ex3-content.pyhtml" id="ex3-content.pyhtml"></a>

      <div class="program_caption">
        File 'ex3-content.pyhtml':
      </div>
      <pre class="program">
foo
bar
baz
</pre><a name="ex3_removenl.result" id="ex3_removenl.result"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ pytenjin --layout=ex3-layout.pyhtml ex3-content.pyhtml
&lt;!-- --&gt;
foo
bar
baz

&lt;!-- --&gt;

&lt;!-- --&gt;
foo
bar
baz
&lt;!-- --&gt;

&lt;!-- --&gt;
foo
bar
baz
&lt;!-- --&gt;
</pre>

      <p>[experimental] If you pass 'smarttrim=True' option to tenjin.Template() or tenjin.Engine(), "\n#{expr}\n" will be trimmed into "\n#{expr}". And command-line option '--smarttrim' is the same as 'smarttrim=True' option.</p>

      <p>The following example shows that an empty line is not appread when '--smarttrim' is specified.</p><a name="ex3_smarttrim.result" id="ex3_smarttrim.result"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ pytenjin <strong>--smarttrim</strong> --layout=ex3-layout.pyhtml ex3-content.pyhtml
&lt;!-- --&gt;
foo
bar
baz
&lt;!-- --&gt;

&lt;!-- --&gt;
foo
bar
baz
&lt;!-- --&gt;

&lt;!-- --&gt;
foo
bar
baz
&lt;!-- --&gt;
</pre><br>
      <a name="faq-change-funcname" id="faq-change-funcname"></a>

      <h3 class="section2">Can I change 'escape()' and 'to_str()' function name?</h3>

      <p>Yes. You can change them by setting 'escapefunc' and 'tostrfunc' options for tenjin.Template() or tenjin.Engine().</p><a name="ex4.py" id="ex4.py"></a>

      <div class="program_caption">
        File 'ex4.py':
      </div>
      <pre class="program">
import tenjin
engine = tenjin.Engine(<strong>escapefunc='cgi.escape'</strong>, <strong>tostrfunc='str'</strong>)
template = engine.get_template('ex4.pyhtml')
print template.script,
</pre><a name="ex4.pyhtml" id="ex4.pyhtml"></a>

      <div class="program_caption">
        File 'ex4.pyhtml':
      </div>
      <pre class="program">
Hello ${name}!
&lt;?py for item in items: ?&gt;
#{item}
&lt;?py #end ?&gt;
</pre><a name="ex4_escapefunc1.result" id="ex4_escapefunc1.result"></a>

      <div class="program_caption">
        Result:
      </div>
      <pre class="program">
$ python ex4.py
_buf.extend(('''Hello ''', <strong>cgi.escape</strong>(<strong>str</strong>(name)), '''!\n''', ));
for item in items:
    _buf.extend((<strong>str</strong>(item), '''\n''', ));
#end
</pre>

      <p>Command-line option '--escapefunc=<em>name</em>' and '--tostrfunc=<em>name</em>' is equivarent to the above.</p><a name="ex4_escapefunc2.result" id="ex4_escapefunc2.result"></a>

      <div class="program_caption">
        Result:
      </div>
      <pre class="program">
$ pytenjin -sb <strong>--escapefunc=cgi.escape</strong> <strong>--tostrfunc=str</strong> ex4.pyhtml
_buf.extend(('''Hello ''', <strong>cgi.escape</strong>(<strong>str</strong>(name)), '''!\n''', ));
for item in items:
    _buf.extend((<strong>str</strong>(item), '''\n''', ));
#end
</pre><br>
      <a name="faq-change-bufname" id="faq-change-bufname"></a>

      <h3 class="section2">Can I change '_buf' variable name?</h3>

      <p>No. Variable name '_buf' should not and will never be changed.</p><br>
      <a name="faq-default-value" id="faq-default-value"></a>

      <h3 class="section2">Is it able to specify default value if a variable is not set?</h3>

      <p>Yes. It is able to specify default value by <code>_context.get('<em>varname</em>', <em>defaultvalue</em>)</code>.</p><a name="ex5.pyhtml" id="ex5.pyhtml"></a>

      <div class="program_caption">
        File 'ex5.pyhtml':
      </div>
      <pre class="program">
Hello ${<strong>_context.get('username', 'Guest')</strong>}!
</pre>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ pytenjin -c 'username="Tenjin"' ex5.pyhtml
Hello Tenjin!
$ pytenjin ex5.pyhtml
Hello Guest!
</pre><br>
      <a name="faq-google-appengine" id="faq-google-appengine"></a>

      <h3 class="section2">Is pyTenjin ready for Google App Engine?</h3>

      <p>Yes. You can use pyTenjin in Google App Engine (GAE).</p>

      <p>Compared to Django template engine, there are some merits to use pyTenjin in Google AppEngine:</p>

      <ul type="disc">
        <li>pyTenjin runs much faster than Django template engine. If you are facing with CPU quota, you should try pyTenjin.</li>
      </ul>

      <ul type="disc">
        <li>pyTenjin library is consist of only one file. If you are facing with number of files quota, you should try pyTenjin.</li>
      </ul>

      <p>The following is an example to use Tenjin in Google AppEngine with memcache.</p><a name="gae-example1.py" id="gae-example1.py"></a>

      <div class="program_caption">
        gae-example1.py
      </div>
      <pre class="program">
from google.appengine.ext import webapp
from google.appengine.ext.webapp.util import run_wsgi_app

<strong>import tenjin</strong>
<strong>from tenjin.helpers import *</strong>
<strong>shared_cache = tenjin.GaeMemcacheCacheStorage()</strong>
<strong>engine = tenjin.Engine(cache=shared_cache)</strong>

## it is recommended to configure logging
import logging
logging.basicConfig(level=logging.DEBUG)
<strong>tenjin.logger = logging</strong>

class MainPage(webapp.RequestHandler):
  def get(self):
    context = {'title': 'Tenjin Example',
               'items': ['&lt;AAA&gt;','B&amp;B','"CCC"'] }
    <strong>html = engine.render("index.pyhtml", context)</strong>
    self.response.out.write(html)

application = webapp.WSGIApplication([('/', MainPage)], debug=True)

def main():
  run_wsgi_app(application)

if __name__ == "__main__":
  main()
</pre><br>
      <br>
      <a name="faq-template" id="faq-template"></a>

      <h2 class="section1">Template</h2><a name="faq-template-args" id="faq-template-args"></a>

      <h3 class="section2">Is it able to specify variables passed to template?</h3>

      <p>Yes. You can specify template arguments by '<code>&lt;?py #@ARGS arg1, arg2, arg3 ?&gt;</code>'.</p><a name="ex6.pyhtml" id="ex6.pyhtml"></a>

      <div class="program_caption">
        File 'ex6-layout.pyhtml'
      </div>
      <pre class="program">
&lt;?xml version="1.0 ?&gt;
<strong>&lt;?py #@ARGS x, y ?&gt;</strong>
&lt;p&gt;
  x = #{x}
  y = #{y}
  z = #{z}
&lt;/p&gt;
</pre>

      <p>Template arguments line is converted into local variable assignment statements.</p><a name="ex6_template_args.source" id="ex6_template_args.source"></a>

      <div class="terminal_caption">
        Source code
      </div>
      <pre class="terminal">
$ pytenjin -s ex6.pyhtml
_buf = []; _buf.extend(('''&lt;?xml version="1.0 ?&gt;\n''', ));
<strong>x = _context.get('x'); y = _context.get('y'); </strong>
_buf.extend(('''&lt;p&gt;
  x = ''', to_str(x), '''
  y = ''', to_str(y), '''
  z = ''', to_str(z), '''
&lt;/p&gt;\n''', ));
print ''.join(_buf)
</pre>

      <p>Undeclared arguments are not available even when they are passed via context object.</p>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ pytenjin -c 'x=10; y=20; z=30' ex6.pyhtml
  File "ex6.pyhtml", line 6, in &lt;module&gt;
    z = #{z}
NameError: name 'z' is not defined
</pre><br>
      <a name="faq-optional-args" id="faq-optional-args"></a>

      <h3 class="section2">It is hard to specify all template arguments. Any good idea?</h3>

      <p>There may be some cases that it is hard to specify all template arguments. But <code>_context.get('varname', None)</code> is much hard and pain.</p>

      <p>One idea is to expand <code>@varname</code> into <code>_context.get('varname', None)</code> automaticaly.</p><a name="ex7-expandargs.py" id="ex7-expandargs.py"></a>

      <div class="program_caption">
        File 'ex7-expandargs.py':
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *
import re

def _expand(code):
    """expand '@var' into '_context.get("var", None)'"""
    return re.sub(r"@(\w+)", r"_context.get('\1', None)", code)

class MyTemplate(tenjin.Template):

    def add_stmt(self, buf, code):
        tenjin.Template.add_stmt(self, buf, _expand(code))

    def add_expr(self, buf, code, flag_escape=None):
        tenjin.Template.add_expr(self, buf, _expand(code), flag_escape)

print("----- script -----")
print(MyTemplate('ex7-expandargs.pyhtml').script)

print("----- result -----")
tenjin.Engine.templateclass = MyTemplate
engine = tenjin.Engine()
html = engine.render('ex7-expandargs.pyhtml')
print(html)
</pre><a name="ex7-expandargs.pyhtml" id="ex7-expandargs.pyhtml"></a>

      <div class="program_caption">
        File 'ex7-expandargs.pyhtml':
      </div>
      <pre class="program">
&lt;p&gt;Hello #{<strong>@user</strong> or 'guest'}!&lt;p&gt;
&lt;?py if <strong>@message</strong>: ?&gt;
&lt;p&gt;#{@message}&lt;/p&gt;
&lt;?py #endif ?&gt;
</pre><a name="ex7-expandargs.result" id="ex7-expandargs.result"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ python ex7-expandargs.py
----- script -----
_buf.extend(('''&lt;p&gt;Hello ''', to_str(<strong>_context.get('user', None)</strong> or 'guest'), '''!&lt;p&gt;\n''', ));
if <strong>_context.get('message', None)</strong>:
    _buf.extend(('''&lt;p&gt;''', to_str(<strong>_context.get('message', None)</strong>), '''&lt;/p&gt;\n''', ));
#endif

----- result -----
&lt;p&gt;Hello guest!&lt;p&gt;

</pre><br>
      <a name="faq-exprpat" id="faq-exprpat"></a>

      <h3 class="section2">Is it able to change embedded expression pattern?</h3>

      <p>Yes, you can create subclass of Template class and override embedded expression pattern.</p><a name="ex8-expr-pattern.pyhtml" id="ex8-expr-pattern.pyhtml"></a>

      <div class="program_caption">
        ex8-expr-pattern.pyhtml:
      </div>
      <pre class="program">
&lt;p&gt;HTML escaped: <strong>[|value|]</strong>&lt;/p&gt;
&lt;p&gt;not escaped:  <strong>[:value:]</strong>&lt;/p&gt;
</pre><a name="ex8-expr-pattern.py" id="ex8-expr-pattern.py"></a>

      <div class="program_caption">
        ex8-expr-pattern.py:
      </div>
      <pre class="program">
import tenjin, re
from tenjin.helpers import *

class MyTemplate(tenjin.Template):

    ## '[|expr|]' escapes HTML and '[:expr:]' doesn't
    EXPR_PATTERN = re.compile('\[(\|(.*?)\||:(.*?):)\]', re.S);

    ## return pattern object for embedded expressions
    def <strong>expr_pattern(self)</strong>:
        return MyTemplate.EXPR_PATTERN

    ## return expression string and flag whether escape or not from matched object
    def <strong>get_expr_and_escapeflag(self, match)</strong>:
        expr = match.group(2) or match.group(3)
        escapeflag = match.group(2) and True or False
        return expr, escapeflag

if __name__ == '__main__':
    context = {'value': 'AAA&amp;BBB'}
    engine = tenjin.Engine(<strong>templateclass=MyTemplate</strong>)
    output = engine.render('ex8-expr-pattern.pyhtml', context)
    print output,
</pre><a name="ex8_expr_pattern.result" id="ex8_expr_pattern.result"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ python ex8-expr-pattern.py
&lt;p&gt;HTML escaped: AAA&amp;amp;BBB&lt;/p&gt;
&lt;p&gt;not escaped:  AAA&amp;BBB&lt;/p&gt;
</pre><br>
      <a name="faq-m17n" id="faq-m17n"></a>

      <h3 class="section2">Does pyTenjin support M17N?</h3>

      <p>No. pyTenjin doesn't provide M17 feature.</p>

      <p>pyTenjin doesn't provide M17N feature directly because requirements for M17N are different for each applications or frameworks. Some applications or frameworks adapt GetText library and others use their original M17N library. What pyTenjin should do is not to provide M17N feature but to show an example to support M17N.</p>

      <p>But using preprocessing, you can make your M17N template files much faster. See the next section for details.</p><br>
      <a name="faq-m17n-cache" id="faq-m17n-cache"></a>

      <h3 class="section2">Is it possible to create separated template chaches for each language?</h3>

      <p>Yes.</p>

      <p>The point is:</p>

      <ul type="disc">
        <li>Change cache filename according to language. For example, create cache file 'file.pyhtml.en.cache', 'file.pyhtml.fr.cache', 'file.pyhtml.it.cache', and so on from template file 'file.pyhtml'. This can be done by overriding CacheStorage#_cachename().</li>

        <li>Create CacheStorage and Engine object for each language.</li>

        <li>Use preprocessing to create different cache content for each language.</li>
      </ul>

      <p>The following is an example to generate M17N pages from a template file.</p><a name="ex9-m18n.pyhtml" id="ex9-m18n.pyhtml"></a>

      <div class="program_caption">
        ex9-m18n.pyhtml:
      </div>
      <pre class="program">
&lt;div&gt;
&lt;?PY ## '_()' represents translator method ?&gt;
 &lt;p&gt;<strong>${{_('Hello')}}</strong> ${username}!&lt;/p&gt;
&lt;/div&gt;
</pre><a name="ex9-m18n.py" id="ex9-m18n.py"></a>

      <div class="program_caption">
        ex9-m18n.py:
      </div>
      <pre class="program">
# -*- coding: utf-8 -*-
import tenjin
from tenjin.helpers import *
import re

##
## message catalog to translate message
##
MESSAGE_CATALOG = {
    'en': { 'Hello': 'Hello',
            'Good bye': 'Good bye',
          },
    'fr': { 'Hello': 'Bonjour',
            'Good bye': 'Au revoir',
          },
}

##
## create translation function and return it.
## ex.
##    _ = create_translation_func('fr')
##    print _('Hello')   #=&gt; 'Bonjour'
##
def create_translation_func(lang):
    dict = MESSAGE_CATALOG.get(lang)
    if not dict:
        raise ValueError("%s: unknown lang." % lang)
    def func(message_key):
        return dict.get(message_key)
    return func
    
##
## cache storage class to cache template object for each language
##
class M17nCacheStorage(tenjin.MarshalCacheStorage):

    lang = 'en'       # default language

    def __init__(self, *args, **kwargs):
        if 'lang' in kwargs:
            lang = kwargs.pop('lang')
            if lang: 
                self.lang = lang
        tenjin.MarshalCacheStorage.__init__(self, *args, **kwargs)

    ## change cache filename to 'file.pyhtml.lang.cache'
    <strong>def _cachename(self, fullpath):</strong>
        <strong>return "%s.%s.cache" % (fullpath, self.lang)</strong>

##
## test program
##
if __name__ == '__main__':

    template_name = 'ex9-m18n.pyhtml'
    common_context = { 'username': 'World' }

    ## create cache storage and engine for English
    <strong>m17ncache = M17nCacheStorage(lang='en')</strong>
    engine = tenjin.Engine(preprocess=True, <strong>cache=m17ncache</strong>)

    ## render html for English
    context = common_context.copy()
    context['_'] = create_translation_func('en')
    html = engine.render(template_name, context)
    print("--- lang: en ---")
    print(html)
    
    ## create cache storage and engine for French
    <strong>m17ncache = M17nCacheStorage(lang='fr')</strong>
    engine = tenjin.Engine(preprocess=True, <strong>cache=m17ncache</strong>)

    ## render html for French
    context = common_context.copy()
    context['_'] = create_translation_func('fr')
    html = engine.render(template_name, context)
    print("--- lang: fr ---")
    print(html)
</pre><a name="ex9_m18n.result" id="ex9_m18n.result"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ python ex9-m18n.py
--- lang: en ---
&lt;div&gt;
 &lt;p&gt;<strong>Hello</strong> World!&lt;/p&gt;
&lt;/div&gt;

--- lang: fr ---
&lt;div&gt;
 &lt;p&gt;<strong>Bonjour</strong> World!&lt;/p&gt;
&lt;/div&gt;

</pre>

      <p>After that, you can find two cache files are created.</p>
      <pre class="terminal">
$ ls ex9-m18n.pyhtml*
ex9-m18n.pyhtml  ex9-m18n.pyhtml.<strong>en</strong>.cache  ex9-m18n.pyhtml.<strong>fr</strong>.cache
</pre>

      <p>And each cache files have different content.</p>
      <pre class="terminal">
### "_('Hello')" is translated into "Hello" in Engilish cache file
$ pytenjin -a dump ex9-m18n.pyhtml.en.cache
_buf.extend(('''&lt;div&gt;
 &lt;p&gt;<strong>Hello</strong> ''', escape(to_str(username)), '''!&lt;/p&gt;
&lt;/div&gt;\n''', ));

### "_('Hello')" is translated into "Bonjour" in French cache file
$ pytenjin -a dump ex9-m18n.pyhtml.fr.cache
_buf.extend(('''&lt;div&gt;
 &lt;p&gt;<strong>Bonjour</strong> ''', escape(to_str(username)), '''!&lt;/p&gt;
&lt;/div&gt;\n''', ));
</pre><br>
      <br>
      <a name="faq-layout" id="faq-layout"></a>

      <h2 class="section1">Layout Template</h2><a name="faq-change-layout-template" id="faq-change-layout-template"></a>

      <h3 class="section2">Can I change layout template name in a template file?</h3>

      <p>Yes. If you set <code>_context['_layout']</code>, its value is regarded as layout template name.</p>

      <ul type="disc">
        <li>You can specify template file name (ex. 'user_list.pyhtml') or template short name (ex. ':list').</li>

        <li>If you set True to '_context['_layout']', default layout template name is used instead.</li>

        <li>It is able to N-th level nested template.</li>
      </ul>

      <p>See the next section for details.</p><br>
      <a name="faq-nested-layout-template" id="faq-nested-layout-template"></a>

      <h3 class="section2">Can I nest layout templates for any depth?</h3>

      <p>Yes. If you set <code>_context['_layout']</code>, you can nest layout templates in any depth.</p>

      <p>The following example shows that:</p>

      <ul type="disc">
        <li>'ex9-content.pyhtml' uses 'ex9-mylayout.pyhtml' as layout template.</li>

        <li>'ex9-mylayout.pyhtml' uses 'ex9-baselayout.pyhtml' as layout template.</li>
      </ul><a name="ex10-content.pyhtml" id="ex10-content.pyhtml"></a>

      <div class="program_caption">
        File 'ex10-content.pyhtml':
      </div>
      <pre class="program">
&lt;?py _context['title'] = 'Changing Layout Template Test' ?&gt;
&lt;?py ## specify layout template name ?&gt;
<strong>&lt;?py _context['_layout'] = 'ex10-mylayout.pyhtml' ?&gt;</strong>
foo
bar
baz
</pre><a name="ex10-mylayout.pyhtml" id="ex10-mylayout.pyhtml"></a>

      <div class="program_caption">
        File 'ex10-mylayout.pyhtml':
      </div>
      <pre class="program">
&lt;?py ## use default layout template name ?&gt;
<strong>&lt;?py _context['_layout'] = True ?&gt;</strong>
&lt;div id="content"&gt;
<strong>&lt;?py _buf.append(_content) ?&gt;</strong>
&lt;/div&gt;
</pre><a name="ex10-baselayout.pyhtml" id="ex10-baselayout.pyhtml"></a>

      <div class="program_caption">
        File 'ex10-baselayout.pyhtml':
      </div>
      <pre class="program">
&lt;html&gt;
  &lt;body&gt;
&lt;?py if 'title' in locals(): ?&gt;
    &lt;h1&gt;${title}&lt;/h1&gt;
&lt;?py #end ?&gt;
<strong>&lt;?py _buf.append(_content) ?&gt;</strong>
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="ex10_changelayout.result" id="ex10_changelayout.result"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ pytenjin --layout=ex10-baselayout.pyhtml ex10-content.pyhtml
&lt;html&gt;
  &lt;body&gt;
    &lt;h1&gt;Changing Layout Template Test&lt;/h1&gt;
&lt;div id="content"&gt;
foo
bar
baz
&lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre><br>
      <a name="faq-diable-layout" id="faq-diable-layout"></a>

      <h3 class="section2">Can I disable default layout template for a certain template?</h3>

      <p>Yes. If you set False to _context['_layout'], default layout template will not be applied.</p><br>
      <a name="faq-template-inheritance" id="faq-template-inheritance"></a>

      <h3 class="section2">Is Django-like "Template Inheritance" supported?</h3>

      <p>No, but you can emulate it partially by combination of template capturing and '_context['_layout']'.</p><a name="ex11-baselayout.pyhtml" id="ex11-baselayout.pyhtml"></a>

      <div class="program_caption">
        File 'ex11-baselayout.pyhtml':
      </div>
      <pre class="program">
&lt;html&gt;
 &lt;body&gt;

&lt;?py ## if variable 'header_part' is defined then print it, ?&gt;
&lt;?py ## else print default header part. ?&gt;
  &lt;div id="header"&gt;
<strong>&lt;?py if not captured_as('header_part'): ?&gt;</strong>
   &lt;img src="img/logo.png" alt="logo" ?&gt;
<strong>&lt;?py #end ?&gt;</strong>
  &lt;/div&gt;

&lt;?py ## main content part ?&gt;
  &lt;div id="content"&gt;
&lt;?py _buf.append(content_part) ?&gt;
  &lt;/div&gt;

&lt;?py ## if variable 'footer_part' is defined then print it, ?&gt;
&lt;?py ## else print default footer part. ?&gt;
  &lt;div id="footer"&gt;
<strong>&lt;?py if not captured_as('footer_part'): ?&gt;</strong>
   &lt;hr /&gt;
   &lt;em&gt;webmaster@example.com&lt;/em&gt;
<strong>&lt;?py #end ?&gt;</strong>
  &lt;/div&gt;
  
 &lt;/body&gt;
&lt;/html&gt;
</pre><a name="ex11-customlayout.pyhtml" id="ex11-customlayout.pyhtml"></a>

      <div class="program_caption">
        File 'ex11-customlayout.pyhtml':
      </div>
      <pre class="program">
&lt;?py ## '_context["_layout"]' is equivarent to '{% extends "foobar.html" %}' ?&gt;
&lt;?py ## in Django template engine. ?&gt;
<strong>&lt;?py _context['_layout'] = 'ex11-baselayout.pyhtml' ?&gt;</strong>

&lt;?py ## you can override header or footer by capturing. ?&gt;
<strong>&lt;?py start_capture('footer_part') ?&gt;</strong>
&lt;address style="text-align:right"&gt;
  copyright&amp;copy; 2007 kuwata-lab all rights reserved&lt;br /&gt;
  &lt;a href="webmaster&amp;#64;kuwata-lab.com"&gt;webmaster&amp;#64;kuwata-lab.com&lt;/a&gt;
&lt;/address&gt;
<strong>&lt;?py stop_capture() ?&gt;</strong>
</pre><a name="ex11-content.pyhtml" id="ex11-content.pyhtml"></a>

      <div class="program_caption">
        File 'ex11-content.pyhtml':
      </div>
      <pre class="program">
&lt;?py ## '_context["_layout"]' is equivarent to '{% extends "foobar.html" %}' ?&gt;
&lt;?py ## in Django template engine. ?&gt;
<strong>&lt;?py _context['_layout'] = 'ex11-customlayout.pyhtml' ?&gt;</strong>

&lt;?py ## main content part ?&gt;
<strong>&lt;?py start_capture('content_part') ?&gt;</strong>
&lt;ul&gt;
&lt;?py for item in items: ?&gt;
  &lt;li&gt;${item}&lt;/li&gt;
&lt;?py #end ?&gt;
&lt;/ul&gt;
<strong>&lt;?py stop_capture() ?&gt;</strong>
</pre>

      <p>'<code>captured_as()</code>' is a pre-defined helper function. For example,</p>
      <pre class="program">
&lt;?py <strong>if not captured_as('header_part'):</strong> ?&gt;
   &lt;img src="img/logo.png" alt="logo" ?&gt;
&lt;?py <strong>#end</strong> ?&gt;
</pre>

      <p>is equivarent to the following.</p>
      <pre class="program">
&lt;?py <strong>if 'header_part' in _context:</strong> ?&gt;
&lt;?py     <strong>_buf.append(_context['header_part'])</strong> ?&gt;
&lt;?py <strong>else:</strong> ?&gt;
   &lt;img src="img/logo.png" alt="logo" ?&gt;
&lt;?py <strong>#end</strong> ?&gt;
</pre>

      <p>The following is the result. It shows that footer part in baselayout is overrided by other templates.</p><a name="ex11_inherit.result" id="ex11_inherit.result"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ pytenjin -c "items=['AAA', 'BBB', 'CCC']" ex11-content.pyhtml
&lt;html&gt;
 &lt;body&gt;

  &lt;div id="header"&gt;
   &lt;img src="img/logo.png" alt="logo" ?&gt;
  &lt;/div&gt;

  &lt;div id="content"&gt;
&lt;ul&gt;
  &lt;li&gt;AAA&lt;/li&gt;
  &lt;li&gt;BBB&lt;/li&gt;
  &lt;li&gt;CCC&lt;/li&gt;
&lt;/ul&gt;
  &lt;/div&gt;

  &lt;div id="footer"&gt;
&lt;address style="text-align:right"&gt;
  copyright&amp;copy; 2007 kuwata-lab all rights reserved&lt;br /&gt;
  &lt;a href="webmaster&amp;#64;kuwata-lab.com"&gt;webmaster&amp;#64;kuwata-lab.com&lt;/a&gt;
&lt;/address&gt;
  &lt;/div&gt;
  
 &lt;/body&gt;
&lt;/html&gt;
</pre><br>
      <br>
      <a name="faq-encoding" id="faq-encoding"></a>

      <h2 class="section1">Encoding</h2><a name="faq-template-encoding" id="faq-template-encoding"></a>

      <h3 class="section2">How to specify template encoding?</h3>

      <p>pyTenjin supports two approaches to handle template encoding.</p>

      <p>One approach is binary(=str)-based: to handle template content as string (byte sequence). In this approach, you must decode unicode object to str in 'to_str()' function. Command-line option '-k <em>encoding</em>' is equivarent to this.</p>

      <p>The other one is unicode-based: to convert template content into unicode object. In this approach, you must decode binary(=str) data into unicode object in 'to_str()' function. Command-line option '--encoding=<em>encoding</em>' is equivarent the second way.</p>

      <p>See <a href="users-guide.html#dev-encoding">User's Guide</a> for details.</p>

      <p>In Python 3.0, pyTenjin supports only unicode-based approach because str object represents unicode.</p><br>
      <a name="faq-encoding-decl" id="faq-encoding-decl"></a>

      <h3 class="section2">Can I specify encoding name in template file?</h3>

      <p>Yes. You can contain encoding declaration in template.</p><a name="ex12.pyhtml" id="ex12.pyhtml"></a>

      <div class="program_caption">
        File 'ex12.pyhtml':
      </div>
      <pre class="program">
<strong>&lt;?py # -*- coding: utf-8 -*- ?&gt;</strong>
&lt;?py s1 = '..non-ascii characters..' ?&gt;
&lt;?py s2 = u'..non-ascii characters..' ?&gt;
s1 = ${s1}  # OK
s2 = ${s2}  # OK
</pre><br>
      <a name="faq-encoding-syntaxerr" id="faq-encoding-syntaxerr"></a>

      <h3 class="section2">I got 'SyntaxError: encoding declaration in Unicode string'</h3>

      <p>This is because you added encoding declaration in template file AND you specified encoding option to tenjin.Engine() or tenjin.Template().</p>

      <p>Solution:</p>

      <ul type="disc">
        <li>If you specify encoding option to tenjin.Engine() or tenjin.Template(), remove encoding declaration from your template file.</li>

        <li>If you want to add encoding declaration into your template file, don't specify encoding option to tenjin.Engine() or tenjin.Template().</li>
      </ul><br>
      <a name="faq-encoding-unicodedecodeerror" id="faq-encoding-unicodedecodeerror"></a>

      <h3 class="section2">I got UnicodeDecodeError, but I can't find what is wrong</h3>

      <p>If you got UnicodeDecodeError, you should do the following solutions.</p>

      <ul type="disc">
        <li>Set logger to <code>tenjin.logger</code>. If you set, pyTenjin will report the content of <code>_buf</code>.
          <pre class="program">
<strong>import logging</strong>
<strong>logging.basicConfig(level=logging.DEBUG)</strong>
<strong>tenjin.logger = logging</strong>
</pre>
        </li>
      </ul>

      <ul type="disc">
        <li>Render tempalte with specifying <code>_buf</code> and check it directly.
          <pre class="program">
<strong>_buf = []</strong>
try:
    engine.get_template("index.pyhtml").render(context, <strong>_buf=_buf</strong>)
    print(''.join(_buf))
except UnicodeDecodeError:
    for item in _buf:
        if isinstance(item, str):
            try:
                str.decode('ascii')
            except UnicodeDecodeError:
                print("*** failed to decode: %s" % repr(item))
</pre>
        </li>
      </ul><br>
      <br>
      <a name="faq-preprocessing" id="faq-preprocessing"></a>

      <h2 class="section1">Preprocessing</h2><a name="faq-what-is-pp" id="faq-what-is-pp"></a>

      <h3 class="section2">What is preprocessing?</h3>

      <p>Preprocessing is a feature to evaluate a part of logics embedded in template files at when template is loaded.</p>

      <p>Tenjin has two stages for rendering:</p>

      <dl class="dl1">
        <dt class="dt1">Convertion stage</dt>

        <dd class="dd1">Convert template into Python script. This stage is invoked only once for each template files.</dd>

        <dt class="dt1">Evaluation stage</dt>

        <dd class="dd1">Evaluate converted script with given context data. This stage is invoked every time when template is rendered.</dd>
      </dl>

      <p>Normally, embedded logics in template files are evaluated at Evaluation stage. pyTenjin can also evaluate a part of logics at convertion stage. It is called preprocessing.</p>

      <p>Preprocessed logics are evaluated only once because it is evaluated at convertion stage. It means that preprocessed logics are not evaluated at rendering template.</p>

      <div align="center">
        <table class="table2" border="1" cellspacing="0">
          <tr class="tr2">
            <th class="th2">kind</th>

            <th class="th2">non-preprocessing</th>

            <th class="th2">preprocessing</th>
          </tr>

          <tr class="tr2">
            <td class="td2">statements</td>

            <td class="td2">&lt;?py ... ?&gt;</td>

            <td class="td2">&lt;?PY ... ?&gt;</td>
          </tr>

          <tr class="tr2">
            <td class="td2">expression (with escape)</td>

            <td class="td2">${...}</td>

            <td class="td2">${{...}}</td>
          </tr>

          <tr class="tr2">
            <td class="td2">expression (without escape)</td>

            <td class="td2">#{...}</td>

            <td class="td2">#{{...}}</td>
          </tr>
        </table>
      </div><br>
      <a name="faq-pp-merit" id="faq-pp-merit"></a>

      <h3 class="section2">What is the merit of preprocessing?</h3>

      <p>The merit of preprocessing is the speed of rendering templates.</p>

      <p>Preprocessed logics are evaluated only once because it is evaluated at convertion stage and not evaluated at rendering templates. It means that preprocessed logics are no-weight when rendering time.</p>

      <p>For example, assume an helper function 'link_to()' which generates &lt;a&gt;&lt;/a&gt; tag. If you embed it to your template file such as '#{link_to("Create", action="new")}', this function will be evaluated whenever template is rendered.</p>

      <div class="program_caption">
        Without preprocessing
      </div>
      <pre class="program">
template file:
  #{link_to("Create", action="new")}

converted script:
  _buf.extend((<strong>to_str(link_to("Create", action="new"))</strong>, ))

output:
  &lt;a href="/new"&gt;Create&lt;/a&gt;
</pre>

      <p>However, if you use preprocessing such as '#{{link_to("Create", action="new")}}', this function will be evaluated only once when template is loaded.</p>

      <div class="program_caption">
        With preprocessing
      </div>
      <pre class="program">
template file:
  <strong>#{{</strong>link_to('Create', action='new')<strong>}}</strong>

converted script:
  _buf.extend((<strong>'''&lt;a href="/new"&gt;Create&lt;/a&gt;'''</strong>, ))

output:
  &lt;a href="/new"&gt;Create&lt;/a&gt;
</pre>

      <p>In the result, rendering template will be much faster because function evaluation is eliminated when rendering.</p><br>
      <a name="faq-pp-examples" id="faq-pp-examples"></a>

      <h3 class="section2">Is there any examples of preprocessing?</h3><a name="Loop expantion"></a>

      <h4 class="section3">Loop expantion</h4>

      <p>Using preprocessing, it is able to expand loop in advance. It makes rendering speed much faster.</p><a name="weekday1.pyhtml" id="weekday1.pyhtml"></a>

      <div class="program_caption">
        weekday1.pyhtml:
      </div>
      <pre class="program">
<strong>&lt;?PY</strong> WEEKDAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'] ?&gt;
&lt;select name="weekday"&gt;
  &lt;option&gt;-&lt;/option&gt;
<strong>&lt;?PY</strong> i = 0 ?&gt;
<strong>&lt;?PY</strong> for wday in WEEKDAYS: ?&gt;
<strong>&lt;?PY</strong>     i += 1?&gt;
  &lt;option value="<strong>#{{</strong>i<strong>}}</strong>"&gt;<strong>#{{</strong>wday<strong>}}</strong>&lt;/option&gt;
<strong>&lt;?PY</strong> #end ?&gt;
&lt;/select&gt;
</pre><a name="weekday1.py" id="weekday1.py"></a>

      <div class="program_caption">
        weekday1.py:
      </div>
      <pre class="program">
## import all helper methods
import tenjin
<strong>from tenjin.helpers import *</strong>
## render with preprocessing
engine = tenjin.Engine(<strong>preprocess=True</strong>)
print '***** preprocessed *****'
print engine.get_template('weekday1.pyhtml').script,
print '***** output *****'
print engine.render('weekday1.pyhtml'),
</pre><a name="weekday1.result" id="weekday1.result"></a>

      <div class="terminal_caption">
        result:
      </div>
      <pre class="terminal">
$ python weekday1.py
***** preprocessed *****
_buf.extend(('''&lt;select name="weekday"&gt;
  &lt;option&gt;-&lt;/option&gt;
  &lt;option value="1"&gt;Sun&lt;/option&gt;
  &lt;option value="2"&gt;Mon&lt;/option&gt;
  &lt;option value="3"&gt;Tue&lt;/option&gt;
  &lt;option value="4"&gt;Wed&lt;/option&gt;
  &lt;option value="5"&gt;Thu&lt;/option&gt;
  &lt;option value="6"&gt;Fri&lt;/option&gt;
  &lt;option value="7"&gt;Sat&lt;/option&gt;
&lt;/select&gt;\n''', ));
***** output *****
&lt;select name="weekday"&gt;
  &lt;option&gt;-&lt;/option&gt;
  &lt;option value="1"&gt;Sun&lt;/option&gt;
  &lt;option value="2"&gt;Mon&lt;/option&gt;
  &lt;option value="3"&gt;Tue&lt;/option&gt;
  &lt;option value="4"&gt;Wed&lt;/option&gt;
  &lt;option value="5"&gt;Thu&lt;/option&gt;
  &lt;option value="6"&gt;Fri&lt;/option&gt;
  &lt;option value="7"&gt;Sat&lt;/option&gt;
&lt;/select&gt;
</pre>

      <p>If you want to add selected attribute (' selected="selected"') dinamically, see the following.</p><a name="weekday2.pyhtml" id="weekday2.pyhtml"></a>

      <div class="program_caption">
        weekday2.pyhtml:
      </div>
      <pre class="program">
&lt;?PY WEEKDAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'] ?&gt;
&lt;select name="weekday"&gt;
<strong>&lt;?py selected = { str(params.get('weekday')): ' selected="selected"' } ?&gt;</strong>
  &lt;option&gt;-&lt;/option&gt;
&lt;?PY i = 0 ?&gt;
&lt;?PY for wday in WEEKDAYS: ?&gt;
&lt;?PY     i += 1?&gt;
  &lt;option value="#{{i}}"<strong>#{selected.get('#{{i}}')}</strong>&gt;#{{wday}}&lt;/option&gt;
&lt;?PY #end ?&gt;
&lt;/select&gt;
</pre><a name="weekday2.py" id="weekday2.py"></a>

      <div class="program_caption">
        weekday2.py:
      </div>
      <pre class="program">
## import all helper methods
import tenjin
from tenjin.helpers import *
## render with preprocessing
engine = tenjin.Engine(preprocess=True)
<strong>context = { 'params': { 'weekday': 3, 'day': 19 } }</strong>
print('***** preprocessed *****')
print(engine.get_template('weekday2.pyhtml').script)
print('***** output *****')
print(engine.render('weekday2.pyhtml'<strong>, context</strong>))
</pre>

      <p>result:</p><a name="weekday2.result" id="weekday2.result"></a>
      <pre class="terminal">
$ python weekday2.py
***** preprocessed *****
_buf.extend(('''&lt;select name="weekday"&gt;\n''', ));
selected = { str(params.get('weekday')): ' selected="selected"' }
_buf.extend(('''  &lt;option&gt;-&lt;/option&gt;
  &lt;option value="1"''', to_str(selected.get('1')), '''&gt;Sun&lt;/option&gt;
  &lt;option value="2"''', to_str(selected.get('2')), '''&gt;Mon&lt;/option&gt;
  &lt;option value="3"''', to_str(selected.get('3')), '''&gt;Tue&lt;/option&gt;
  &lt;option value="4"''', to_str(selected.get('4')), '''&gt;Wed&lt;/option&gt;
  &lt;option value="5"''', to_str(selected.get('5')), '''&gt;Thu&lt;/option&gt;
  &lt;option value="6"''', to_str(selected.get('6')), '''&gt;Fri&lt;/option&gt;
  &lt;option value="7"''', to_str(selected.get('7')), '''&gt;Sat&lt;/option&gt;
&lt;/select&gt;\n''', ));

***** output *****
&lt;select name="weekday"&gt;
  &lt;option&gt;-&lt;/option&gt;
  &lt;option value="1"&gt;Sun&lt;/option&gt;
  &lt;option value="2"&gt;Mon&lt;/option&gt;
  &lt;option value="3"<strong> selected="selected"</strong>&gt;Tue&lt;/option&gt;
  &lt;option value="4"&gt;Wed&lt;/option&gt;
  &lt;option value="5"&gt;Thu&lt;/option&gt;
  &lt;option value="6"&gt;Fri&lt;/option&gt;
  &lt;option value="7"&gt;Sat&lt;/option&gt;
&lt;/select&gt;

</pre>

      <p>It is possible to make helper function to generate &lt;select&gt; and &lt;option&gt; tags.</p><a name="weekday3.pyhtml" id="weekday3.pyhtml"></a>

      <div class="program_caption">
        weekday3.pyhtml:
      </div>
      <pre class="program">
&lt;form&gt;
<strong>#{{pp_select_weekday_tag("params.get('weekday')", name='weekday')}}</strong>
&lt;/form&gt;
</pre><a name="weekday3.py" id="weekday3.py"></a>

      <div class="program_caption">
        weekday3.py:
      </div>
      <pre class="program">
## helper function
WEEKDAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
def pp_select_weekday_tag(expr_str, name='weekday', indent=''):
    buf = []
    buf.append('&lt;select name="%s"&gt;' % name)
    attr = 'selected="selected"'
    buf.append('%s&lt;?py _selected = { str(%s): \' %s\' } ?&gt;' % \
                      (indent, expr_str, attr))
    buf.append('  &lt;option&gt;-&lt;/option&gt;')
    i = 0
    for wday in WEEKDAYS:
        i += 1
        expr = '_selected.get("%s")' % i
        buf.append('  &lt;option value="%s"#{%s}&gt;%s&lt;/option&gt;' % \
                      (i, expr, wday))
    buf.append('&lt;/select&gt;')
    return "\n".join(buf)

## import all helper methods
import tenjin
from tenjin.helpers import *

## 
engine = tenjin.Engine(preprocess=True)
<strong>context = { 'params': { 'weekday': 3, 'day': 19 } }</strong>
print '***** preprocessed *****'
print engine.get_template('weekday3.pyhtml').script,
print '***** output *****'
print engine.render('weekday3.pyhtml'<strong>, context</strong>),
</pre><a name="weekday3.result" id="weekday3.result"></a>

      <div class="terminal_caption">
        result:
      </div>
      <pre class="terminal">
$ python weekday3.py
***** preprocessed *****
_buf.extend(('''&lt;form&gt;
&lt;select name="weekday"&gt;\n''', ));
_selected = { str(params.get('weekday')): ' selected="selected"' }
_buf.extend(('''  &lt;option&gt;-&lt;/option&gt;
  &lt;option value="1"''', to_str(_selected.get("1")), '''&gt;Sun&lt;/option&gt;
  &lt;option value="2"''', to_str(_selected.get("2")), '''&gt;Mon&lt;/option&gt;
  &lt;option value="3"''', to_str(_selected.get("3")), '''&gt;Tue&lt;/option&gt;
  &lt;option value="4"''', to_str(_selected.get("4")), '''&gt;Wed&lt;/option&gt;
  &lt;option value="5"''', to_str(_selected.get("5")), '''&gt;Thu&lt;/option&gt;
  &lt;option value="6"''', to_str(_selected.get("6")), '''&gt;Fri&lt;/option&gt;
  &lt;option value="7"''', to_str(_selected.get("7")), '''&gt;Sat&lt;/option&gt;
&lt;/select&gt;
&lt;/form&gt;\n''', ));
***** output *****
&lt;form&gt;
&lt;select name="weekday"&gt;
  &lt;option&gt;-&lt;/option&gt;
  &lt;option value="1"&gt;Sun&lt;/option&gt;
  &lt;option value="2"&gt;Mon&lt;/option&gt;
  &lt;option value="3"<strong> selected="selected"</strong>&gt;Tue&lt;/option&gt;
  &lt;option value="4"&gt;Wed&lt;/option&gt;
  &lt;option value="5"&gt;Thu&lt;/option&gt;
  &lt;option value="6"&gt;Fri&lt;/option&gt;
  &lt;option value="7"&gt;Sat&lt;/option&gt;
&lt;/select&gt;
&lt;/form&gt;
</pre><br>
      <a name="faq-pp-helpers" id="faq-pp-helpers"></a>

      <h4 class="section3">Helper methods execution in advance</h4>

      <p>Many web frameworks provides their own helper functions for view layer. Some of them can be executed in advance. Using preprocessing, it is able to execute these helper functions in advance, and view layer will be much faster in the result.</p><a name="helpers1.pyhtml" id="helpers1.pyhtml"></a>

      <div class="program_caption">
        helpers1.pyhtml:
      </div>
      <pre class="program">
&lt;p&gt;
#{link_to('Create', action='new')}
#{{link_to('Create', action='new')}}
&lt;/p&gt;
</pre><a name="helpers1.py" id="helpers1.py"></a>

      <div class="program_caption">
        helpers1.py:
      </div>
      <pre class="program">
## define helper method
def link_to(label, href=None, action=None):
    if not href and action:
        href = "/%s/%s" % (controller_name, action)
    return '&lt;a href="%s"&gt;%s&lt;/a&gt;' % (href, label)

## import all helper methods to use preprocessing
import tenjin
from tenjin.helpers import *

## 
controller_name = 'user'
engine = tenjin.Engine(preprocess=True)
print '***** preprocessed *****'
print engine.get_template('helpers1.pyhtml').script,
print '***** output *****'
print engine.render('helpers1.pyhtml'),
</pre><a name="helpers1.result" id="helpers1.result"></a>

      <div class="terminal_caption">
        result:
      </div>
      <pre class="terminal">
$ python helpers1.py
***** preprocessed *****
_buf.extend(('''&lt;p&gt;
''', to_str(link_to('Create', action='new')), '''
&lt;a href="/user/new"&gt;Create&lt;/a&gt;
&lt;/p&gt;\n''', ));
***** output *****
&lt;p&gt;
&lt;a href="/user/new"&gt;Create&lt;/a&gt;
&lt;a href="/user/new"&gt;Create&lt;/a&gt;
&lt;/p&gt;
</pre>

      <p>It is able to embed expression which should be evaluated at rendering stage.</p>

      <ul type="disc">
        <li><code>_p("...")</code> is equivarent to <code>#{...}</code></li>

        <li><code>_P("...")</code> is equivarent to <code>${...}</code></li>
      </ul><a name="helpers2.pyhtml" id="helpers2.pyhtml"></a>

      <div class="program_caption">
        helpers2.pyhtml:
      </div>
      <pre class="program">
&lt;p&gt;
#{link_to(escape(user['name']), action='show', id=user['id'])}
#{{link_to(<strong>_P("user['name']")</strong>, action='show', id=<strong>_p("user['id']")</strong>)}}
&lt;/p&gt;
</pre><a name="helpers2.py" id="helpers2.py"></a>

      <div class="program_caption">
        helpers2.py:
      </div>
      <pre class="program">
## define helper method
def link_to(label, href=None, action=None, id=None):
    if not href and action:
        if id:
            href = "/%s/%s/%s" % (controller_name, action, id)
        else:
            href = "/%s/%s" % (controller_name, action)
    return '&lt;a href="%s"&gt;%s&lt;/a&gt;' % (href, label)

## import all helper methods to use preprocessing
import tenjin
from tenjin.helpers import *

## 
controller_name = 'user'
<strong>context = { 'user': {'id': 123, 'name': 'Tom&amp;Jerry'} }</strong>
engine = tenjin.Engine(preprocess=True)
print '***** preprocessed *****'
print engine.get_template('helpers2.pyhtml'<strong>, context</strong>).script,
print '***** output *****'
print engine.render('helpers2.pyhtml'<strong>, context</strong>),
</pre><a name="helpers2.result" id="helpers2.result"></a>

      <div class="terminal_caption">
        result:
      </div>
      <pre class="terminal">
$ python helpers2.py
***** preprocessed *****
_buf.extend(('''&lt;p&gt;
''', to_str(link_to(escape(user['name']), action='show', id=user['id'])), '''
&lt;a href="/user/show/''', <strong>to_str(user['id'])</strong>, '''"&gt;''', <strong>escape(to_str(user['name']))</strong>, '''&lt;/a&gt;
&lt;/p&gt;\n''', ));
***** output *****
&lt;p&gt;
&lt;a href="/user/show/123"&gt;Tom&amp;amp;Jerry&lt;/a&gt;
&lt;a href="/user/show/123"&gt;Tom&amp;amp;Jerry&lt;/a&gt;
&lt;/p&gt;
</pre><br>
      <a name="faq-pp-m18n" id="faq-pp-m18n"></a>

      <h4 class="section3">M17N (Multilingualization)</h4>

      <p>Preprocessing is also effective for M17N (Multilingualization), because the runtime cost of M17N can be almost zero by preprocessing.</p>

      <p>See <a href="#faq-m17n-cache">this section</a> for M17N example using preprocessing.</p><br>
      <br>
      <br>
      <a name="faq-performance" id="faq-performance"></a>

      <h2 class="section1">Performance</h2><a name="faq-how-fast" id="faq-how-fast"></a>

      <h3 class="section2">How fast is pyTenjin compared with other solutions?</h3>

      <p>pyTenjin contains benchmark script. This shows that pyTenjin works much faster than other solutions.</p>

      <div class="terminal_caption">
        MacOS X 10.4 Tiger, Intel CoreDuo 1.83GHz, Memory 2GB
      </div>
      <pre class="terminal">
$ cd pyTenjin-X.X.X/benchmark
$ python -V
Python 2.5.1
$ python bench.py -q -n 10000
Compiling bench_cheetah.tmpl -&gt; bench_cheetah.py (backup bench_cheetah.py.bak)
*** ntimes=10000
                           utime      stime      total       real
tenjin                   6.47000    0.49000    6.96000    6.98909
tenjin-reuse             5.54000    0.06000    5.61000    5.63055
tenjin-nocache          20.14000    0.41000   20.55000   20.60475
django                  69.99000    1.34000   71.33000   71.57211
django-reuse            58.92000    0.88000   59.80000   59.94480
cheetah                 20.33000    0.03000   20.36000   20.41416
cheetah-reuse           19.80000    0.02000   19.82000   19.86858
myghty                 106.25000    1.63000  107.88000  108.16097
myghty-reuse            18.70000    0.60000   19.30000   19.35395
kid                    379.64000    0.60000  380.24000  381.11728
kid-reuse              378.52000    0.44000  378.96000  379.64911
genshi                 557.29000    3.00000  560.30000  561.71955
genshi-reuse           270.47000    1.22000  271.69000  272.26885
mako                    16.82000    0.96000   17.78000   18.36388
mako-reuse              13.47000    0.02000   13.49000   13.51232
mako-nocache           236.10000    1.67000  237.77000  238.38705
templetor              424.03000    4.15000  428.19000  429.59667
templetor-reuse         61.46000    0.07000   61.53000   61.68483
</pre>

      <p>Versions:</p>

      <ul type="disc">
        <li>Python 2.5.1</li>

        <li>Tenjin 0.6.1</li>

        <li>Django 0.95</li>

        <li>Cheetah 2.0</li>

        <li>Myghty 1.1</li>

        <li>Kid 0.9.6</li>

        <li>Genshi 0.4.4</li>

        <li>Mako 0.1.9</li>

        <li>Templetor (web.py) 0.22</li>
      </ul>

      <p>In addition, module size of pyTenjin is small, and it is very light-weight to import it. This is important for CGI program. Other solutions may be very heavy to import the module and suitable only for apache module or FastCGI.</p><br>
      <a name="faq-why-so-fast" id="faq-why-so-fast"></a>

      <h3 class="section2">Why pyTenjin is so fast?</h3>

      <p>Because it doesn't use template engine original language.</p>

      <p>Other template engines, such as Template-Toolkit(perl), Django(python), or Smarty(php), has their original languages. This is not good idea for script language because:</p>

      <ul type="disc">
        <li>They are slow.</li>

        <li>Implementation will be complex.</li>

        <li>Learning cost is high.</li>
      </ul>

      <p>In addition, pyTenjin is faster than Jakarta Velocity which is a very popular template engine in Java. (It means that <strong>dynamic Java is slower than script languages</strong>!)</p>

      <p>Template engine should use their host language directly unless there are some kind of reasons.</p><br>
      <a name="faq-performance-tuning" id="faq-performance-tuning"></a>

      <h3 class="section2">Is there any way to get more speed?</h3>

      <p>You can get more speed by including 'escape()' and 'to_str()' functions to context data.</p><a name="ex13a.py" id="ex13a.py"></a>

      <div class="program_caption">
        File 'ex13a.py':
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *

## include 'escape()' and 'to_str()' functions to context data
context = { 'title': 'Example', 'items': ['A', 'B', 'C'] }
<strong>context['escape'] = escape</strong>
<strong>context['to_str'] = to_str</strong>

engine = tenjin.Engine()
output = engine.render('ex13a.pyhtml', context)
</pre>

      <p>You can get more and more speed by deleting implicit call of 'to_str()' function. Of course, you have to call it properly in your templates.</p><a name="ex13b.py" id="ex13b.py"></a>

      <div class="program_caption">
        File 'ex13b.py':
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *

## include 'escape()' and 'to_str()' functions to context data
context = { 'title': 'Example', 'items': ['A', 'B', 'C'] }
context['escape'] = escape
context['to_str'] = to_str

## delete implicit call of 'to_str()' function
engine = tenjin.Engine(<strong>tostrfunc=''</strong>)

## show python code and output
filename = 'ex13b.pyhtml'
template = engine.get_template(filename)
output = engine.render(filename, context)
print "--- python code ---"
print template.script
print "--- output ---"
print output,
</pre><a name="ex13b.pyhtml" id="ex13b.pyhtml"></a>

      <div class="program_caption">
        File 'ex13b.pyhtml':
      </div>
      <pre class="program">
&lt;h1&gt;${title}&lt;/h1&gt;
&lt;ul&gt;
&lt;?py for i, item in enumerate(items): ?&gt;
  &lt;li&gt;#{<strong>to_str(i)</strong>}: #{item}&lt;/li&gt;
&lt;?py #end ?&gt;
&lt;/ul&gt;
</pre><a name="ex13b_deltostr.result" id="ex13b_deltostr.result"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ python ex13b.py
--- python code ---
_buf.extend(('''&lt;h1&gt;''', <strong>escape((title))</strong>, '''&lt;/h1&gt;
&lt;ul&gt;\n''', ));
for i, item in enumerate(items):
    _buf.extend(('''  &lt;li&gt;''', <strong>(to_str(i))</strong>, ''': ''', <strong>(item)</strong>, '''&lt;/li&gt;\n''', ));
#end
_buf.extend(('''&lt;/ul&gt;\n''', ));

--- output ---
&lt;h1&gt;Example&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;0: A&lt;/li&gt;
  &lt;li&gt;1: B&lt;/li&gt;
  &lt;li&gt;2: C&lt;/li&gt;
&lt;/ul&gt;
</pre><br>
      <br>
    </div>
  </blockquote>
</body>
</html>
