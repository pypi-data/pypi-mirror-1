source file: <b>/opt/devel/celery/celery/registry.py</b><br>


file stats: <b>46 lines, 46 executed: 100.0% covered</b>
<pre>
<font color="green">   1. from celery import discovery</font>
<font color="green">   2. from UserDict import UserDict</font>
<font color="black">   3. </font>
<font color="black">   4. </font>
<font color="green">   5. class NotRegistered(Exception):</font>
<font color="green">   6.     &quot;&quot;&quot;The task is not registered.&quot;&quot;&quot;</font>
<font color="black">   7. </font>
<font color="black">   8. </font>
<font color="green">   9. class AlreadyRegistered(Exception):</font>
<font color="green">  10.     &quot;&quot;&quot;The task is already registered.&quot;&quot;&quot;</font>
<font color="black">  11. </font>
<font color="black">  12. </font>
<font color="green">  13. class TaskRegistry(UserDict):</font>
<font color="green">  14.     &quot;&quot;&quot;Site registry for tasks.&quot;&quot;&quot;</font>
<font color="black">  15. </font>
<font color="green">  16.     AlreadyRegistered = AlreadyRegistered</font>
<font color="green">  17.     NotRegistered = NotRegistered</font>
<font color="black">  18. </font>
<font color="green">  19.     def __init__(self):</font>
<font color="green">  20.         self.data = {}</font>
<font color="black">  21. </font>
<font color="green">  22.     def autodiscover(self):</font>
<font color="green">  23.         discovery.autodiscover()</font>
<font color="black">  24. </font>
<font color="green">  25.     def register(self, task, task_name=None):</font>
<font color="green">  26.         is_class = False</font>
<font color="green">  27.         if hasattr(task, &quot;run&quot;):</font>
<font color="green">  28.             is_class = True</font>
<font color="green">  29.             task_name = task.name</font>
<font color="green">  30.         if task_name in self.data:</font>
<font color="green">  31.             raise self.AlreadyRegistered(</font>
<font color="green">  32.                     &quot;Task with name %s is already registered.&quot; % task_name)</font>
<font color="black">  33. </font>
<font color="green">  34.         if is_class:</font>
<font color="green">  35.             self.data[task_name] = task() # instantiate Task class</font>
<font color="black">  36.         else:</font>
<font color="green">  37.             task.type = &quot;regular&quot;</font>
<font color="green">  38.             self.data[task_name] = task</font>
<font color="black">  39. </font>
<font color="green">  40.     def unregister(self, task_name):</font>
<font color="green">  41.         if hasattr(task_name, &quot;run&quot;):</font>
<font color="green">  42.             task_name = task_name.name</font>
<font color="green">  43.         if task_name not in self.data:</font>
<font color="green">  44.             raise self.NotRegistered(</font>
<font color="green">  45.                     &quot;Task with name %s is not registered.&quot; % task_name)</font>
<font color="green">  46.         del self.data[task_name]</font>
<font color="black">  47. </font>
<font color="green">  48.     def get_all(self):</font>
<font color="black">  49.         &quot;&quot;&quot;Get all task types.&quot;&quot;&quot;</font>
<font color="green">  50.         return self.data</font>
<font color="black">  51. </font>
<font color="green">  52.     def filter_types(self, type):</font>
<font color="black">  53.         &quot;&quot;&quot;Return all tasks of a specific type.&quot;&quot;&quot;</font>
<font color="green">  54.         return dict([(task_name, task)</font>
<font color="green">  55.                         for task_name, task in self.data.items()</font>
<font color="green">  56.                             if task.type == type])</font>
<font color="black">  57. </font>
<font color="green">  58.     def get_all_regular(self):</font>
<font color="black">  59.         &quot;&quot;&quot;Get all regular task types.&quot;&quot;&quot;</font>
<font color="green">  60.         return self.filter_types(type=&quot;regular&quot;)</font>
<font color="black">  61. </font>
<font color="green">  62.     def get_all_periodic(self):</font>
<font color="black">  63.         &quot;&quot;&quot;Get all periodic task types.&quot;&quot;&quot;</font>
<font color="green">  64.         return self.filter_types(type=&quot;periodic&quot;)</font>
<font color="black">  65. </font>
<font color="green">  66.     def get_task(self, task_name):</font>
<font color="black">  67.         &quot;&quot;&quot;Get task by name.&quot;&quot;&quot;</font>
<font color="green">  68.         return self.data[task_name]</font>
<font color="black">  69. </font>
<font color="black">  70. &quot;&quot;&quot;This is the global task registry.&quot;&quot;&quot;</font>
<font color="green">  71. tasks = TaskRegistry()</font>
</pre>

