source file: <b>/opt/devel/celery/testproj/../celery/tests/test_task.py</b><br>


file stats: <b>143 lines, 143 executed: 100.0% covered</b>
<pre>
<font color="green">   1. import unittest</font>
<font color="green">   2. import uuid</font>
<font color="green">   3. import logging</font>
<font color="green">   4. from StringIO import StringIO</font>
<font color="green">   5. </font>
<font color="green">   6. from celery import task</font>
<font color="green">   7. from celery import registry</font>
<font color="green">   8. from celery.log import setup_logger</font>
<font color="green">   9. from celery import messaging</font>
<font color="green">  10. </font>
<font color="green">  11. </font>
<font color="green">  12. # Task run functions can't be closures/lambdas, as they're pickled.</font>
<font color="green">  13. def return_True(self, **kwargs):</font>
<font color="green">  14.     return True</font>
<font color="green">  15. </font>
<font color="green">  16. </font>
<font color="green">  17. def raise_exception(self, **kwargs):</font>
<font color="green">  18.     raise Exception(&quot;%s error&quot; % self.__class__)</font>
<font color="green">  19. </font>
<font color="green">  20. </font>
<font color="green">  21. class IncrementCounterTask(task.Task):</font>
<font color="green">  22.     name = &quot;c.unittest.increment_counter_task&quot;</font>
<font color="green">  23.     count = 0</font>
<font color="green">  24. </font>
<font color="green">  25.     def run(self, increment_by, **kwargs):</font>
<font color="green">  26.         increment_by = increment_by or 1</font>
<font color="green">  27.         self.__class__.count += increment_by</font>
<font color="green">  28. </font>
<font color="green">  29. </font>
<font color="green">  30. class TestCeleryTasks(unittest.TestCase):</font>
<font color="green">  31. </font>
<font color="green">  32.     def createTaskCls(self, cls_name, task_name=None):</font>
<font color="green">  33.         attrs = {}</font>
<font color="green">  34.         if task_name:</font>
<font color="green">  35.             attrs[&quot;name&quot;] = task_name</font>
<font color="green">  36.         cls = type(cls_name, (task.Task, ), attrs)</font>
<font color="green">  37.         cls.run = return_True</font>
<font color="green">  38.         return cls</font>
<font color="green">  39. </font>
<font color="green">  40.     def assertNextTaskDataEquals(self, consumer, task_id, task_name,</font>
<font color="green">  41.             **kwargs):</font>
<font color="green">  42.         next_task = consumer.fetch()</font>
<font color="green">  43.         task_data = consumer.decoder(next_task.body)</font>
<font color="green">  44.         self.assertEquals(task_data[&quot;celeryID&quot;], task_id)</font>
<font color="green">  45.         self.assertEquals(task_data[&quot;celeryTASK&quot;], task_name)</font>
<font color="green">  46.         for arg_name, arg_value in kwargs.items():</font>
<font color="green">  47.             self.assertEquals(task_data.get(arg_name), arg_value)</font>
<font color="green">  48. </font>
<font color="green">  49.     def test_raising_task(self):</font>
<font color="green">  50.         rtask = self.createTaskCls(&quot;RaisingTask&quot;, &quot;c.unittest.t.rtask&quot;)</font>
<font color="green">  51.         rtask.run = raise_exception</font>
<font color="green">  52.         sio = StringIO()</font>
<font color="green">  53. </font>
<font color="green">  54.         taskinstance = rtask()</font>
<font color="green">  55.         taskinstance(loglevel=logging.INFO, logfile=sio)</font>
<font color="green">  56.         self.assertTrue(sio.getvalue().find(&quot;Task got exception&quot;) != -1)</font>
<font color="green">  57. </font>
<font color="green">  58.     def test_incomplete_task_cls(self):</font>
<font color="green">  59.         class IncompleteTask(task.Task):</font>
<font color="green">  60.             name = &quot;c.unittest.t.itask&quot;</font>
<font color="green">  61. </font>
<font color="green">  62.         self.assertRaises(NotImplementedError, IncompleteTask().run)</font>
<font color="green">  63. </font>
<font color="green">  64.     def test_regular_task(self):</font>
<font color="green">  65.         T1 = self.createTaskCls(&quot;T1&quot;, &quot;c.unittest.t.t1&quot;)</font>
<font color="green">  66.         self.assertTrue(isinstance(T1(), T1))</font>
<font color="green">  67.         self.assertTrue(T1().run())</font>
<font color="green">  68.         self.assertTrue(callable(T1()),</font>
<font color="green">  69.                 &quot;Task class is callable()&quot;)</font>
<font color="green">  70.         self.assertTrue(T1()(),</font>
<font color="green">  71.                 &quot;Task class runs run() when called&quot;)</font>
<font color="green">  72. </font>
<font color="green">  73.         # task without name raises NotImplementedError</font>
<font color="green">  74.         T2 = self.createTaskCls(&quot;T2&quot;)</font>
<font color="green">  75.         self.assertRaises(NotImplementedError, T2)</font>
<font color="green">  76. </font>
<font color="green">  77.         registry.tasks.register(T1)</font>
<font color="green">  78.         t1 = T1()</font>
<font color="green">  79.         consumer = t1.get_consumer()</font>
<font color="green">  80.         self.assertRaises(NotImplementedError, consumer.receive, &quot;foo&quot;, &quot;foo&quot;)</font>
<font color="green">  81.         consumer.discard_all()</font>
<font color="green">  82.         self.assertTrue(consumer.fetch() is None)</font>
<font color="green">  83. </font>
<font color="green">  84.         # Without arguments.</font>
<font color="green">  85.         tid = t1.delay()</font>
<font color="green">  86.         self.assertNextTaskDataEquals(consumer, tid, t1.name)</font>
<font color="green">  87. </font>
<font color="green">  88.         # With arguments.</font>
<font color="green">  89.         tid2 = task.delay_task(t1.name, name=&quot;George Constanza&quot;)</font>
<font color="green">  90.         self.assertNextTaskDataEquals(consumer, tid2, t1.name,</font>
<font color="green">  91.                 name=&quot;George Constanza&quot;)</font>
<font color="green">  92. </font>
<font color="green">  93.         self.assertRaises(registry.tasks.NotRegistered, task.delay_task,</font>
<font color="green">  94.                 &quot;some.task.that.should.never.exist.X.X.X.X.X&quot;)</font>
<font color="green">  95. </font>
<font color="green">  96.         # Discarding all tasks.</font>
<font color="green">  97.         task.discard_all()</font>
<font color="green">  98.         tid3 = task.delay_task(t1.name)</font>
<font color="green">  99.         self.assertEquals(task.discard_all(), 1)</font>
<font color="green"> 100.         self.assertTrue(consumer.fetch() is None)</font>
<font color="green"> 101. </font>
<font color="green"> 102.         self.assertFalse(task.is_done(tid))</font>
<font color="green"> 103.         task.mark_as_done(tid, result=None)</font>
<font color="green"> 104.         self.assertTrue(task.is_done(tid))</font>
<font color="green"> 105. </font>
<font color="green"> 106. </font>
<font color="green"> 107.         publisher = t1.get_publisher()</font>
<font color="green"> 108.         self.assertTrue(isinstance(publisher, messaging.TaskPublisher))</font>
<font color="green"> 109. </font>
<font color="green"> 110.     def test_taskmeta_cache(self):</font>
<font color="green"> 111.         # TODO Needs to test task meta without TASK_META_USE_DB.</font>
<font color="green"> 112.         tid = str(uuid.uuid4())</font>
<font color="green"> 113.         ckey = task.gen_task_done_cache_key(tid)</font>
<font color="green"> 114.         self.assertTrue(ckey.rfind(tid) != -1)</font>
<font color="green"> 115. </font>
<font color="green"> 116. </font>
<font color="green"> 117. class TestTaskSet(unittest.TestCase):</font>
<font color="green"> 118. </font>
<font color="green"> 119.     def test_counter_taskset(self):</font>
<font color="green"> 120.         ts = task.TaskSet(IncrementCounterTask, [</font>
<font color="green"> 121.             {},</font>
<font color="green"> 122.             {&quot;increment_by&quot;: 2},</font>
<font color="green"> 123.             {&quot;increment_by&quot;: 3},</font>
<font color="green"> 124.             {&quot;increment_by&quot;: 4},</font>
<font color="green"> 125.             {&quot;increment_by&quot;: 5},</font>
<font color="green"> 126.             {&quot;increment_by&quot;: 6},</font>
<font color="green"> 127.             {&quot;increment_by&quot;: 7},</font>
<font color="green"> 128.             {&quot;increment_by&quot;: 8},</font>
<font color="green"> 129.             {&quot;increment_by&quot;: 9},</font>
<font color="green"> 130.         ])</font>
<font color="green"> 131.         self.assertEquals(ts.task_name, IncrementCounterTask.name)</font>
<font color="green"> 132.         self.assertEquals(ts.total, 9)</font>
<font color="green"> 133. </font>
<font color="green"> 134.         taskset_id, subtask_ids = ts.run()</font>
<font color="green"> 135. </font>
<font color="green"> 136.         consumer = IncrementCounterTask().get_consumer()</font>
<font color="green"> 137.         for subtask_id in subtask_ids:</font>
<font color="green"> 138.             m = consumer.decoder(consumer.fetch().body)</font>
<font color="green"> 139.             self.assertEquals(m.get(&quot;celeryTASKSET&quot;), taskset_id)</font>
<font color="green"> 140.             self.assertEquals(m.get(&quot;celeryTASK&quot;), IncrementCounterTask.name)</font>
<font color="green"> 141.             self.assertEquals(m.get(&quot;celeryID&quot;), subtask_id)</font>
<font color="green"> 142.             IncrementCounterTask().run(increment_by=m.get(&quot;increment_by&quot;))</font>
<font color="green"> 143.         self.assertEquals(IncrementCounterTask.count, sum(xrange(1, 10)))</font>
</pre>

