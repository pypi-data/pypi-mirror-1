source file: <b>/opt/devel/celery/celery/managers.py</b><br>


file stats: <b>30 lines, 30 executed: 100.0% covered</b>
<pre>
<font color="green">   1. from django.db import models</font>
<font color="green">   2. from celery.registry import tasks</font>
<font color="green">   3. from datetime import datetime, timedelta</font>
<font color="black">   4. </font>
<font color="black">   5. </font>
<font color="green">   6. class TaskManager(models.Manager):</font>
<font color="black">   7. </font>
<font color="green">   8.     def get_task(self, task_id):</font>
<font color="green">   9.         task, created = self.get_or_create(task_id=task_id)</font>
<font color="green">  10.         return task</font>
<font color="black">  11. </font>
<font color="green">  12.     def is_done(self, task_id):</font>
<font color="green">  13.         return self.get_task(task_id).is_done</font>
<font color="black">  14. </font>
<font color="green">  15.     def get_all_expired(self):</font>
<font color="green">  16.         return self.filter(date_done__lt=datetime.now() - timedelta(days=5),</font>
<font color="green">  17.                            is_done=True)</font>
<font color="black">  18. </font>
<font color="green">  19.     def delete_expired(self):</font>
<font color="green">  20.         self.get_all_expired().delete()</font>
<font color="black">  21. </font>
<font color="green">  22.     def mark_as_done(self, task_id):</font>
<font color="green">  23.         task, created = self.get_or_create(task_id=task_id, defaults={</font>
<font color="green">  24.                                             &quot;is_done&quot;: True})</font>
<font color="green">  25.         if not created:</font>
<font color="green">  26.             task.is_done = True</font>
<font color="green">  27.             task.save()</font>
<font color="black">  28. </font>
<font color="black">  29. </font>
<font color="green">  30. class PeriodicTaskManager(models.Manager):</font>
<font color="black">  31. </font>
<font color="green">  32.     def get_waiting_tasks(self):</font>
<font color="green">  33.         periodic_tasks = tasks.get_all_periodic()</font>
<font color="green">  34.         waiting = []</font>
<font color="green">  35.         for task_name, task in periodic_tasks.items():</font>
<font color="green">  36.             task_meta, created = self.get_or_create(name=task_name)</font>
<font color="black">  37.             # task_run.every must be a timedelta object.</font>
<font color="green">  38.             run_at = task_meta.last_run_at + task.run_every</font>
<font color="green">  39.             if datetime.now() &gt; run_at:</font>
<font color="green">  40.                 waiting.append(task_meta)</font>
<font color="green">  41.         return waiting</font>
</pre>

