source file: <b>/opt/devel/celery/celery/log.py</b><br>


file stats: <b>33 lines, 31 executed: 93.9% covered</b>
<pre>
<font color="green">   1. import multiprocessing</font>
<font color="green">   2. import os</font>
<font color="green">   3. import time</font>
<font color="green">   4. import logging</font>
<font color="green">   5. from celery.conf import LOG_FORMAT, DAEMON_LOG_LEVEL</font>
<font color="black">   6. </font>
<font color="black">   7. </font>
<font color="green">   8. def setup_logger(loglevel=DAEMON_LOG_LEVEL, logfile=None, format=LOG_FORMAT,</font>
<font color="black">   9.         **kwargs):</font>
<font color="black">  10.     &quot;&quot;&quot;Setup the ``multiprocessing`` logger. If ``logfile`` is not specified,</font>
<font color="black">  11.     ``stderr`` is used.</font>
<font color="black">  12. </font>
<font color="black">  13.     Returns logger object.</font>
<font color="black">  14.     &quot;&quot;&quot;</font>
<font color="green">  15.     logger = multiprocessing.get_logger()</font>
<font color="green">  16.     if logfile:</font>
<font color="green">  17.         if hasattr(logfile, &quot;write&quot;):</font>
<font color="green">  18.             log_file_handler = logging.StreamHandler(logfile)</font>
<font color="black">  19.         else:</font>
<font color="red">  20.             log_file_handler = logging.FileHandler(logfile)</font>
<font color="green">  21.         formatter = logging.Formatter(format)</font>
<font color="green">  22.         log_file_handler.setFormatter(formatter)</font>
<font color="green">  23.         logger.addHandler(log_file_handler)</font>
<font color="black">  24.     else:</font>
<font color="green">  25.         multiprocessing.log_to_stderr()</font>
<font color="green">  26.     logger.setLevel(loglevel)</font>
<font color="green">  27.     return logger</font>
<font color="black">  28. </font>
<font color="black">  29. </font>
<font color="green">  30. def emergency_error(logfile, message):</font>
<font color="green">  31.     &quot;&quot;&quot;Emergency error logging, for when there's no standard file</font>
<font color="green">  32.     descriptors open because the process has been daemonized or for</font>
<font color="green">  33.     some other reason.&quot;&quot;&quot;</font>
<font color="green">  34.     logfh_needs_to_close = False</font>
<font color="green">  35.     if hasattr(logfile, &quot;write&quot;):</font>
<font color="green">  36.         logfh = logfile</font>
<font color="green">  37.     else:</font>
<font color="green">  38.         logfh = open(logfile, &quot;a&quot;)</font>
<font color="green">  39.         logfh_needs_to_close = True</font>
<font color="green">  40.     logfh.write(&quot;[%(asctime)s: FATAL/%(pid)d]: %(message)s\n&quot; % {</font>
<font color="green">  41.                     &quot;asctime&quot;: time.asctime(),</font>
<font color="green">  42.                     &quot;pid&quot;: os.getpid(),</font>
<font color="green">  43.                     &quot;message&quot;: message})</font>
<font color="green">  44.     if logfh_needs_to_close:</font>
<font color="red">  45.         logfh.close()</font>
</pre>

