source file: <b>/opt/devel/celery/testproj/../celery/models.py</b><br>


file stats: <b>33 lines, 33 executed: 100.0% covered</b>
<pre>
<font color="green">   1. from django.db import models</font>
<font color="green">   2. from celery.registry import tasks</font>
<font color="green">   3. from celery.managers import TaskManager, PeriodicTaskManager</font>
<font color="green">   4. from django.utils.translation import ugettext_lazy as _</font>
<font color="black">   5. </font>
<font color="black">   6. </font>
<font color="green">   7. class TaskMeta(models.Model):</font>
<font color="green">   8.     task_id = models.CharField(_(u&quot;task id&quot;), max_length=255, unique=True)</font>
<font color="green">   9.     is_done = models.BooleanField(_(u&quot;is done&quot;), default=False)</font>
<font color="green">  10.     date_done = models.DateTimeField(_(u&quot;done at&quot;), auto_now=True)</font>
<font color="black">  11. </font>
<font color="green">  12.     objects = TaskManager()</font>
<font color="black">  13. </font>
<font color="green">  14.     class Meta:</font>
<font color="green">  15.         verbose_name = _(u&quot;task meta&quot;)</font>
<font color="green">  16.         verbose_name_plural = _(u&quot;task meta&quot;)</font>
<font color="black">  17. </font>
<font color="green">  18.     def __unicode__(self):</font>
<font color="green">  19.         return u&quot;&lt;Task: %s done:%s&gt;&quot; % (self.task_id, self.is_done)</font>
<font color="black">  20. </font>
<font color="black">  21. </font>
<font color="green">  22. class PeriodicTaskMeta(models.Model):</font>
<font color="green">  23.     name = models.CharField(_(u&quot;name&quot;), max_length=255, unique=True)</font>
<font color="green">  24.     last_run_at = models.DateTimeField(_(u&quot;last time run&quot;),</font>
<font color="green">  25.                                        auto_now=True, blank=True)</font>
<font color="green">  26.     total_run_count = models.PositiveIntegerField(_(u&quot;total run count&quot;),</font>
<font color="green">  27.                                                   default=0)</font>
<font color="black">  28. </font>
<font color="green">  29.     objects = PeriodicTaskManager()</font>
<font color="black">  30. </font>
<font color="green">  31.     class Meta:</font>
<font color="green">  32.         verbose_name = _(u&quot;periodic task&quot;)</font>
<font color="green">  33.         verbose_name_plural = _(u&quot;periodic tasks&quot;)</font>
<font color="black">  34. </font>
<font color="green">  35.     def __unicode__(self):</font>
<font color="green">  36.         return u&quot;&lt;PeriodicTask: %s [last-run:%s, total-run:%d]&gt;&quot; % (</font>
<font color="green">  37.                 self.name, self.last_run_at, self.total_run_count)</font>
<font color="black">  38. </font>
<font color="green">  39.     def delay(self, **kwargs):</font>
<font color="green">  40.         self.task.delay()</font>
<font color="green">  41.         self.total_run_count = self.total_run_count + 1</font>
<font color="green">  42.         self.save()</font>
<font color="black">  43. </font>
<font color="green">  44.     @property</font>
<font color="black">  45.     def task(self):</font>
<font color="green">  46.         return tasks[self.name]</font>
</pre>

