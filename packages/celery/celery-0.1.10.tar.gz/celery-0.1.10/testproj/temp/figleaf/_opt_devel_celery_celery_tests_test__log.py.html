source file: <b>/opt/devel/celery/testproj/../celery/tests/test_log.py</b><br>


file stats: <b>40 lines, 40 executed: 100.0% covered</b>
<pre>
<font color="green">   1. import unittest</font>
<font color="black">   2. </font>
<font color="green">   3. import sys</font>
<font color="green">   4. import logging</font>
<font color="green">   5. import multiprocessing</font>
<font color="green">   6. from StringIO import StringIO</font>
<font color="green">   7. from celery.log import setup_logger, emergency_error</font>
<font color="black">   8. </font>
<font color="black">   9. </font>
<font color="green">  10. class TestLog(unittest.TestCase):</font>
<font color="black">  11. </font>
<font color="green">  12.     def _assertLog(self, logger, logmsg, loglevel=logging.ERROR):</font>
<font color="black">  13.         # Save old handlers</font>
<font color="green">  14.         old_handler = logger.handlers[0]</font>
<font color="green">  15.         logger.removeHandler(old_handler)</font>
<font color="green">  16.         sio = StringIO()</font>
<font color="green">  17.         siohandler = logging.StreamHandler(sio)</font>
<font color="green">  18.         logger.addHandler(siohandler)</font>
<font color="green">  19.         logger.log(loglevel, logmsg)</font>
<font color="green">  20.         logger.removeHandler(siohandler)</font>
<font color="black">  21.         # Reset original handlers</font>
<font color="green">  22.         logger.addHandler(old_handler)</font>
<font color="green">  23.         return sio.getvalue().strip()</font>
<font color="black">  24. </font>
<font color="green">  25.     def assertDidLogTrue(self, logger, logmsg, reason, loglevel=None):</font>
<font color="green">  26.         val = self._assertLog(logger, logmsg, loglevel=loglevel)</font>
<font color="green">  27.         return self.assertEqual(val, logmsg, reason)</font>
<font color="black">  28. </font>
<font color="green">  29.     def assertDidLogFalse(self, logger, logmsg, reason, loglevel=None):</font>
<font color="green">  30.         val = self._assertLog(logger, logmsg, loglevel=loglevel)</font>
<font color="green">  31.         return self.assertFalse(val, reason)</font>
<font color="black">  32. </font>
<font color="green">  33.     def test_setup_logger(self):</font>
<font color="green">  34.         logger = setup_logger(loglevel=logging.ERROR, logfile=None)</font>
<font color="green">  35.         self.assertTrue(logger.handlers[0].stream is sys.stderr,</font>
<font color="green">  36.                 &quot;setup_logger logs to stderr without logfile argument.&quot;)</font>
<font color="green">  37.         self.assertTrue(logger._process_aware,</font>
<font color="green">  38.                 &quot;setup_logger() returns process aware logger.&quot;)</font>
<font color="green">  39.         self.assertDidLogTrue(logger, &quot;Logging something&quot;,</font>
<font color="green">  40.                 &quot;Logger logs error when loglevel is ERROR&quot;,</font>
<font color="green">  41.                 loglevel=logging.ERROR)</font>
<font color="green">  42.         self.assertDidLogFalse(logger, &quot;Logging something&quot;,</font>
<font color="green">  43.                 &quot;Logger doesn't info when loglevel is ERROR&quot;,</font>
<font color="green">  44.                 loglevel=logging.INFO)</font>
<font color="black">  45. </font>
<font color="green">  46.     def test_emergency_error(self):</font>
<font color="green">  47.         sio = StringIO()</font>
<font color="green">  48.         emergency_error(sio, &quot;Testing emergency error facility&quot;)</font>
<font color="green">  49.         self.assertEquals(sio.getvalue().rpartition(&quot;:&quot;)[2].strip(),</font>
<font color="green">  50.                              &quot;Testing emergency error facility&quot;)</font>
<font color="black">  51. </font>
<font color="black">  52. </font>
<font color="black">  53. </font>
<font color="black">  54. </font>
<font color="black">  55. </font>
<font color="black">  56. </font>
</pre>

