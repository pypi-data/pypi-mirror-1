source file: <b>/opt/devel/celery/celery/messaging.py</b><br>


file stats: <b>28 lines, 27 executed: 96.4% covered</b>
<pre>
<font color="green">   1. from carrot.messaging import Publisher, Consumer</font>
<font color="green">   2. from celery import conf</font>
<font color="green">   3. import uuid</font>
<font color="black">   4. </font>
<font color="black">   5. </font>
<font color="green">   6. class NoProcessConsumer(Consumer):</font>
<font color="black">   7. </font>
<font color="green">   8.     def receive(self, message_data, message):</font>
<font color="red">   9.         raise NotImplementedError(</font>
<font color="black">  10.                 &quot;Don't use process_next() or wait() with the TaskConsumer!&quot;)</font>
<font color="black">  11. </font>
<font color="black">  12. </font>
<font color="green">  13. class TaskPublisher(Publisher):</font>
<font color="green">  14.     exchange = conf.AMQP_EXCHANGE</font>
<font color="green">  15.     routing_key = conf.AMQP_ROUTING_KEY</font>
<font color="black">  16. </font>
<font color="green">  17.     def delay_task(self, task_name, **task_kwargs):</font>
<font color="green">  18.         return self._delay_task(task_name=task_name, extra_data=task_kwargs)</font>
<font color="black">  19. </font>
<font color="green">  20.     def delay_task_in_set(self, task_name, taskset_id, task_kwargs):</font>
<font color="green">  21.         return self._delay_task(task_name=task_name, part_of_set=taskset_id,</font>
<font color="green">  22.                                 extra_data=task_kwargs)</font>
<font color="black">  23. </font>
<font color="green">  24.     def _delay_task(self, task_name, part_of_set=None, extra_data=None):</font>
<font color="green">  25.         extra_data = extra_data or {}</font>
<font color="green">  26.         task_id = str(uuid.uuid4())</font>
<font color="green">  27.         message_data = dict(extra_data)</font>
<font color="green">  28.         message_data[&quot;celeryTASK&quot;] = task_name</font>
<font color="green">  29.         message_data[&quot;celeryID&quot;] = task_id</font>
<font color="green">  30.         if part_of_set:</font>
<font color="green">  31.             message_data[&quot;celeryTASKSET&quot;] = part_of_set</font>
<font color="green">  32.         self.send(message_data)</font>
<font color="green">  33.         return task_id</font>
<font color="black">  34. </font>
<font color="black">  35. </font>
<font color="green">  36. class TaskConsumer(NoProcessConsumer):</font>
<font color="green">  37.     queue = conf.AMQP_CONSUMER_QUEUE</font>
<font color="green">  38.     exchange = conf.AMQP_EXCHANGE</font>
<font color="green">  39.     routing_key = conf.AMQP_ROUTING_KEY</font>
</pre>

