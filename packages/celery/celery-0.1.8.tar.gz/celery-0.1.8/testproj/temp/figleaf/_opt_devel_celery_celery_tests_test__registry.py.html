source file: <b>/opt/devel/celery/testproj/../celery/tests/test_registry.py</b><br>


file stats: <b>56 lines, 53 executed: 94.6% covered</b>
<pre>
<font color="green">   1. import unittest</font>
<font color="green">   2. from celery import registry</font>
<font color="green">   3. from celery.task import Task, PeriodicTask</font>
<font color="black">   4. </font>
<font color="green">   5. FUNC_TASK_NAME = &quot;celery.unittest.func_task&quot;</font>
<font color="black">   6. </font>
<font color="black">   7. </font>
<font color="green">   8. class TestTask(Task):</font>
<font color="green">   9.     name = &quot;celery.unittest.test_task&quot;</font>
<font color="black">  10. </font>
<font color="green">  11.     def run(self, **kwargs):</font>
<font color="red">  12.         return True</font>
<font color="black">  13. </font>
<font color="black">  14. </font>
<font color="green">  15. class TestPeriodicTask(PeriodicTask):</font>
<font color="green">  16.     name = &quot;celery.unittest.test_periodic_task&quot;</font>
<font color="green">  17.     run_every = 10</font>
<font color="black">  18. </font>
<font color="green">  19.     def run(self, **kwargs):</font>
<font color="red">  20.         return True</font>
<font color="black">  21. </font>
<font color="black">  22. </font>
<font color="green">  23. def func_task(**kwargs):</font>
<font color="red">  24.     return True</font>
<font color="black">  25. </font>
<font color="black">  26. </font>
<font color="green">  27. class TestTaskRegistry(unittest.TestCase):</font>
<font color="black">  28. </font>
<font color="green">  29.     def assertRegisterUnregisterCls(self, r, task):</font>
<font color="green">  30.         self.assertRaises(r.NotRegistered, r.unregister, task)</font>
<font color="green">  31.         r.register(task)</font>
<font color="green">  32.         self.assertTrue(task.name in r)</font>
<font color="green">  33.         self.assertRaises(r.AlreadyRegistered, r.register, task)</font>
<font color="black">  34. </font>
<font color="green">  35.     def assertRegisterUnregisterFunc(self, r, task, task_name):</font>
<font color="green">  36.         self.assertRaises(r.NotRegistered, r.unregister, task_name)</font>
<font color="green">  37.         r.register(task, task_name)</font>
<font color="green">  38.         self.assertTrue(task_name in r)</font>
<font color="green">  39.         self.assertRaises(r.AlreadyRegistered, r.register, task, task_name)</font>
<font color="black">  40. </font>
<font color="green">  41.     def test_task_registry(self):</font>
<font color="green">  42.         r = registry.TaskRegistry()</font>
<font color="green">  43.         self.assertTrue(isinstance(r.data, dict),</font>
<font color="green">  44.                 &quot;TaskRegistry has composited dict&quot;)</font>
<font color="black">  45. </font>
<font color="green">  46.         self.assertRegisterUnregisterCls(r, TestTask)</font>
<font color="green">  47.         self.assertRegisterUnregisterFunc(r, func_task, FUNC_TASK_NAME)</font>
<font color="green">  48.         self.assertRegisterUnregisterCls(r, TestPeriodicTask)</font>
<font color="black">  49. </font>
<font color="green">  50.         tasks = r.get_all()</font>
<font color="green">  51.         self.assertTrue(isinstance(tasks.get(TestTask.name), TestTask))</font>
<font color="green">  52.         self.assertTrue(isinstance(tasks.get(TestPeriodicTask.name),</font>
<font color="green">  53.                                    TestPeriodicTask))</font>
<font color="green">  54.         self.assertEquals(tasks.get(FUNC_TASK_NAME), func_task)</font>
<font color="black">  55. </font>
<font color="green">  56.         regular = r.get_all_regular()</font>
<font color="green">  57.         self.assertTrue(TestTask.name in regular)</font>
<font color="green">  58.         self.assertFalse(TestPeriodicTask.name in regular)</font>
<font color="green">  59.         self.assertTrue(FUNC_TASK_NAME in regular)</font>
<font color="black">  60. </font>
<font color="green">  61.         periodic = r.get_all_periodic()</font>
<font color="green">  62.         self.assertFalse(TestTask.name in periodic)</font>
<font color="green">  63.         self.assertTrue(TestPeriodicTask.name in periodic)</font>
<font color="green">  64.         self.assertFalse(FUNC_TASK_NAME in periodic)</font>
<font color="black">  65. </font>
<font color="green">  66.         self.assertTrue(isinstance(r.get_task(TestTask.name), TestTask))</font>
<font color="green">  67.         self.assertTrue(isinstance(r.get_task(TestPeriodicTask.name),</font>
<font color="green">  68.                                    TestPeriodicTask))</font>
<font color="green">  69.         self.assertEquals(r.get_task(FUNC_TASK_NAME), func_task)</font>
<font color="black">  70. </font>
<font color="green">  71.         r.unregister(TestTask)</font>
<font color="green">  72.         self.assertFalse(TestTask.name in r)</font>
<font color="green">  73.         r.unregister(TestPeriodicTask)</font>
<font color="green">  74.         self.assertFalse(TestPeriodicTask.name in r)</font>
<font color="green">  75.         r.unregister(FUNC_TASK_NAME)</font>
<font color="green">  76.         self.assertFalse(FUNC_TASK_NAME in r)</font>
</pre>

