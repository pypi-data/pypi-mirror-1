source file: <b>/opt/devel/celery/testproj/../celery/tests/test_models.py</b><br>


file stats: <b>46 lines, 46 executed: 100.0% covered</b>
<pre>
<font color="green">   1. import unittest</font>
<font color="green">   2. import uuid</font>
<font color="green">   3. from datetime import datetime, timedelta</font>
<font color="green">   4. from celery.models import TaskMeta, PeriodicTaskMeta</font>
<font color="green">   5. from celery.task import PeriodicTask</font>
<font color="green">   6. from celery.registry import tasks</font>
<font color="black">   7. </font>
<font color="black">   8. </font>
<font color="green">   9. class TestPeriodicTask(PeriodicTask):</font>
<font color="green">  10.     name = &quot;celery.unittest.test_models.test_periodic_task&quot;</font>
<font color="green">  11.     run_every = timedelta(days=1)</font>
<font color="black">  12. </font>
<font color="black">  13. </font>
<font color="green">  14. class TestModels(unittest.TestCase):</font>
<font color="black">  15. </font>
<font color="green">  16.     def createTaskMeta(self):</font>
<font color="green">  17.         id = str(uuid.uuid4())</font>
<font color="green">  18.         taskmeta, created = TaskMeta.objects.get_or_create(task_id=id)</font>
<font color="green">  19.         return taskmeta</font>
<font color="black">  20. </font>
<font color="green">  21.     def createPeriodicTaskMeta(self, name):</font>
<font color="green">  22.         ptaskmeta, created = PeriodicTaskMeta.objects.get_or_create(name=name)</font>
<font color="green">  23.         return ptaskmeta</font>
<font color="black">  24. </font>
<font color="green">  25.     def test_taskmeta(self):</font>
<font color="green">  26.         m1 = self.createTaskMeta()</font>
<font color="green">  27.         m2 = self.createTaskMeta()</font>
<font color="green">  28.         m3 = self.createTaskMeta()</font>
<font color="green">  29.         self.assertTrue(m1.task_id)</font>
<font color="green">  30.         self.assertTrue(isinstance(m1.date_done, datetime))</font>
<font color="black">  31. </font>
<font color="green">  32.         self.assertEquals(TaskMeta.objects.get_task(m1.task_id).task_id,</font>
<font color="green">  33.                 m1.task_id)</font>
<font color="green">  34.         self.assertFalse(TaskMeta.objects.is_done(m1.task_id))</font>
<font color="green">  35.         TaskMeta.objects.mark_as_done(m1.task_id)</font>
<font color="green">  36.         TaskMeta.objects.mark_as_done(m2.task_id)</font>
<font color="green">  37.         self.assertTrue(TaskMeta.objects.is_done(m1.task_id))</font>
<font color="green">  38.         self.assertTrue(TaskMeta.objects.is_done(m2.task_id))</font>
<font color="black">  39. </font>
<font color="black">  40.         # Have to avoid save() because it applies the auto_now=True.</font>
<font color="green">  41.         TaskMeta.objects.filter(task_id=m1.task_id).update(</font>
<font color="green">  42.                 date_done=datetime.now() - timedelta(days=10))</font>
<font color="black">  43. </font>
<font color="green">  44.         expired = TaskMeta.objects.get_all_expired()</font>
<font color="green">  45.         self.assertTrue(m1 in expired)</font>
<font color="green">  46.         self.assertFalse(m2 in expired)</font>
<font color="green">  47.         self.assertFalse(m3 in expired)</font>
<font color="black">  48. </font>
<font color="green">  49.         TaskMeta.objects.delete_expired()</font>
<font color="green">  50.         self.assertFalse(m1 in TaskMeta.objects.all())</font>
<font color="black">  51. </font>
<font color="green">  52.     def test_periodic_taskmeta(self):</font>
<font color="green">  53.         tasks.register(TestPeriodicTask)</font>
<font color="green">  54.         p = self.createPeriodicTaskMeta(TestPeriodicTask.name)</font>
<font color="green">  55.         self.assertFalse(p in PeriodicTaskMeta.objects.get_waiting_tasks())</font>
<font color="black">  56.         # Have to avoid save() because it applies the auto_now=True.</font>
<font color="green">  57.         PeriodicTaskMeta.objects.filter(name=p.name).update(</font>
<font color="green">  58.                 last_run_at=datetime.now() - TestPeriodicTask.run_every)</font>
<font color="green">  59.         self.assertTrue(p in PeriodicTaskMeta.objects.get_waiting_tasks())</font>
<font color="green">  60.         self.assertTrue(isinstance(p.task, TestPeriodicTask))</font>
<font color="black">  61. </font>
<font color="black">  62. </font>
</pre>

