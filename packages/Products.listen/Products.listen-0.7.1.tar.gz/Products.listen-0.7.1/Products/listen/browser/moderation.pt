<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">

  <body>
    <div metal:fill-slot="main">
      <div metal:define-macro="body">

        <div i18n:domain="listen" tal:define="is_post_moderated view/is_post_moderated;
					      is_membership_moderated view/is_membership_moderated;
	                                      pending_list view/get_pending_lists">

        <div id="listen-actions" class="selfclear">
            <form name="search" method="get"
                  id="search-form"
                  tal:attributes="action string:${context/absolute_url}/search">
              <input type="text" name="search_text"
                     tal:attributes="value request/search_text|nothing" />
              <input class="context" type="submit" name="submit" value="Search" />
            </form>
        </div>
	
        <div id="navigation">

	  <h3 i18n:translate="" >Posts awaiting moderation</h3>

	  <fieldset tal:condition="pending_list">
          <form name="moderate-post-form"
		method="post"
                id="moderate-post-form"
		tal:attributes="action request/ACTUAL_URL"
                tal:define="errors view/errors|nothing">

            <table id="membership-listing" tal:condition="pending_list">
	      <tr>
		<th i18n:translate="" >By</th>
		<th i18n:translate="" >Post</th>
		<th>Date</th>
		<th>Approve</th>
		<th>Deny</th>
	      </tr>
	      
	      <span tal:omit-tag 
		    tal:repeat="member pending_list">
		    
	      <span tal:omit-tag
		    tal:define="singular python:len(pending_list[member]) == 1">

	      <!-- row for members and post only if singular -->
              <tr>
		<td tal:attributes="rowspan python:singular and 1 or len(pending_list[member]) + 1">
		    
		  <span tal:replace="python:view.user_name(member)">User Name</span> 
		  <a tal:attributes="href python:'mailto:' + member">&lt; <span tal:content="member">Email</span> &gt;</a>
		</td>  
		<td> 
		  <dl class="collapsible inline collapsedOnLoad"
		      tal:condition="singular"
		      tal:define="post python:pending_list[member][0]">
		    <dt class="collapsibleHeader"
			tal:content="post/subject">
		      Subject
		    </dt>
		    <dd class="collapsibleContent">
		      <pre tal:content="post/body">
			Post Body
		      </pre>
		    </dd>
		  </dl>
		</td>
		<td></td>
		<td>
<!-- not yet!  see http://trac.openplans.org/listen/ticket/57#comment:4 
		  <input type="radio" 
			 value="approve"
			 tal:attributes="name 
					 python:'moderate-user-' + member"/>
-->
<input type="radio" 
       tal:condition="singular"
       value="approve"
       title="approve correspondence from this post"
       tal:define="postid python:pending_list[member][0]['postid']"
       tal:attributes="name 
		       python:'moderate-post-%s-%s' % ( member, postid)"/>

		</td>
		<td>
<!-- not yet!  see http://trac.openplans.org/listen/ticket/57#comment:4 
		  <input type="radio" 
			 value="deny"
			 title="approve correspondence from this author"
			 tal:attributes="name 
					 python:'moderate-user-' + member"/>
-->
<input type="radio" 
       tal:condition="singular"
       value="deny"
       title="deny correspondence from this post"
       tal:define="postid python:pending_list[member][0]['postid']"
       tal:attributes="name 
		       python:'moderate-post-%s-%s' % ( member, postid)"/>

		</td>
              </tr>

	      <!-- rows for posts if more than one -->
	      <tr tal:condition="not:singular"
		  tal:repeat="post python:pending_list[member]">
		<td>
		  <dl class="collapsible inline collapsedOnLoad">
		    
		    <dt class="collapsibleHeader"
			tal:content="post/subject">
		      Subject
		    </dt>
		    <dd class="collapsibleContent">
		      <pre tal:content="post/body">
			Post Body
		      </pre>
		    </dd>
		  </dl>
		</td>
		<td>TBD</td>
		<td>		  
		  <input type="radio" 
			 value="approve"
			 title="approve correspondence from this post"
			 tal:attributes="name 
					 python:'moderate-post-' + member + '-' + str(post['postid'])"/>
</td>
		<td>
		  <input type="radio" 
			 value="deny"
			 title="approve correspondence from this post"
			 tal:attributes="name 
					 python:'moderate-post-' + member + '-' + str(post['postid'])"/>
		</td>
	      </tr>
	      </span>
	      </span>
	  </table>
	  <input class="context" type="submit" name="save_changes" value="save changes"/>
	  </form>
	  </fieldset>


	  <p tal:condition="python: not pending_list">No posts pending moderation</p>

	  </div>

	  <p tal:content="view/errors|nothing" />
	</div>
      </div>
    </div>
  </body>
</html>
