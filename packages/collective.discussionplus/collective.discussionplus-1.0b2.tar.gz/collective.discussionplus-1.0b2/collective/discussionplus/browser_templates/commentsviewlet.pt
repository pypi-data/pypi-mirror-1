<tal:block define="userHasReplyPermission viewlet/can_reply;
                   isDiscussionAllowed viewlet/is_discussion_allowed;
                   replies viewlet/get_replies;
                   isAnon viewlet/is_anonymous"
           i18n:domain="collective.discussionplus">
    <div class="discussion"
         tal:condition="python:replies or (userHasReplyPermission and isDiscussionAllowed) or (isAnon and not userHasReplyPermission and isDiscussionAllowed)">
        <form name="reply"
              action=""
              method="post"
              tal:condition="python:userHasReplyPermission and isDiscussionAllowed"
              tal:attributes="action string:${context/absolute_url}/discussion_reply_form">

              <input class="standalone"
                     style="margin-bottom: 1.25em;"
                     type="submit"
                     value="Add Comment"
                     i18n:attributes="value label_add_comment;"
                     />
        </form>
        <form tal:condition="python:isAnon and not userHasReplyPermission and isDiscussionAllowed"
              tal:attributes="action viewlet/login_action">
            <input class="standalone"
                   style="margin-bottom: 1.25em;"
                   type="submit"
                   value="Log in to add comments"
                   i18n:attributes="value label_login_to_add_comments;"
                   />
        </form>

        <tal:getreplies repeat="reply_dict replies">
            <div class="comment" style=""
                tal:define="indent python:reply_dict['depth']*2;
                            reply python:reply_dict['object'];
                            reply_state reply_dict/state;
                            userHasReplyPermission python:viewlet.can_reply(reply)"
                tal:attributes="style string:margin-left:${indent}em;
                                class string:comment state-${reply_dict/state}">
                
                <h3>
                    <a name="comments" tal:attributes="name reply/id">
                    <span tal:replace="reply/pretty_title_or_id">Comment title</span>
                    </a>
                    <span tal:condition="reply_dict/actions | nothing"
                          tal:attributes="class string:state-${reply_state}">
                        (<span tal:replace="reply_state" i18n:translate="" />)
                    </span>
                </h3>
                <div class="documentByLine"
                     tal:define="creator reply/Creator;
                                 anonymous_creator python:creator in ('Anonymous User', '');
                                 mi python:not anonymous_creator and viewlet.member_info(creator);
                                 fullname python: mi and mi['fullname'] or creator;" >
                    <span i18n:translate="label_comment_by">Posted by</span>
                    <span tal:content="fullname"
                          tal:condition="not:anonymous_creator">Poster Name</span>
                    <span i18n:translate="label_anonymous_user"
                          tal:condition="anonymous_creator">Anonymous User</span>
                    <span i18n:translate="label_commented_at">at</span> 
                    <span tal:replace="python:viewlet.format_time(reply.CreationDate())">8/23/2001 12:40:44 PM</span>
                </div>
                <div class="commentBody"
                     tal:content="structure reply/CookedBody">
                     This is the body text of the comment.
                </div>
                <form name="reply"
                      action="discussion_reply_form"
                      method="post"
                      style="display: inline;"
                      tal:attributes="action string:${reply/absolute_url}/discussion_reply_form"
                      tal:condition="python:userHasReplyPermission and isDiscussionAllowed">
                    <input type="hidden"
                           name="subject"
                           tal:attributes="value reply/pretty_title_or_id" />
                    <input class="standalone"
                           type="submit"
                           value="Reply"
                           i18n:attributes="value label_reply;"
                           />
                </form>
                <form name="delete"
                      action=""
                      method="post"
                      style="display: inline;"
                      tal:condition="viewlet/can_manage"
                      tal:attributes="action string:${reply/absolute_url}/deleteDiscussion">
                    <input class="destructive"
                           type="submit"
                           value="Remove"
                           i18n:attributes="value label_remove;"
                           />
                </form>
                
                <!-- Workflow actions (e.g. 'publish') -->
                <form name=""
                      action=""
                      method="get"
                      style="display: inline;"
                      tal:repeat="action reply_dict/actions"
                      tal:attributes="action string:${reply/absolute_url}/content_status_modify;
                                      name action/id">
                    <input type="hidden" name="workflow_action" tal:attributes="value action/id" />
                    <input class="context"
                           type="submit"
                           tal:attributes="value action/title"
                           />
                </form>
            </div>
        </tal:getreplies>
    </div>
</tal:block>
