<tal:storylist
    define="stories python: view.realstories;
            iteration_object nocall:view/iteration_object;
            iteration_dict view/iteration_dict;
            iteration_number view/iteration_number;
            iteration_icon view/iteration_icon;
            show_iteration view/show_iteration;
            show_task_count view/show_task_count;
            show_progress view/show_progress;
            show_totals view/show_totals;"
    condition="stories">

  <table class="listing"
         width="100%"
         border="1"
         cellpadding="0"
         cellspacing="0">

    <tal:extraheader condition="show_iteration">
      <tr>
        <th colspan="1"
            width="60%"
            height="30"
            align="left"
            class="header_iteration">
          <a class="header_iteration_project_overview"
             tal:attributes="href string:${iteration_object/absolute_url}">
            <img tal:attributes="src string:${here/portal_url}/${iteration_icon};
                                 alt string:Iteration overview"/>
            <span tal:replace="iteration_dict/title">Title</span>
          </a>
        </th>
        <th colspan="1"
            tal:attributes="colspan python: show_task_count and 3 or 1"
            width="20%"
            class="iteration-state">
          <span i18n:translate="status">status</span>:
          <span tal:content="structure iteration_dict/review_state"/>
          <img tal:attributes="src string:${iteration_dict/review_state}.gif;
                               alt iteration_dict/review_state" />
        </th>
        <th colspan="3"
            width="20%"
            height="30"
            align="left"
            class="header_iteration">
          <span tal:replace="iteration_dict/man_hours" /> <span i18n:translate="hours">hours</span>
          ( <span tal:replace="iteration_dict/actual" /> <span i18n:translate="actual">actual</span>)
        </th>
      </tr>
      <tr>
        <td colspan="7"
            class="iteration-description"
            tal:content="iteration_dict/description" />
      </tr>
    </tal:extraheader>

    <tr>
      <th i18n:translate="listingheader_story">Story</th>
      <th i18n:translate="listingheader_state">Status</th>
      <tal:task_count tal:condition="show_task_count">
        <th i18n:translate="listingheader_tasks_open">Tasks open</th>
        <th i18n:translate="listingheader_tasks_completed">Tasks completed</th>
      </tal:task_count>
      <th i18n:translate="listingheader_initial_estimate">Initial estimate (days)</th>
      <th i18n:translate="listingheader_tasks_estimate">Tasks estimate (hours)</th>
      <th i18n:translate="listingheader_actual_hours">Actual (hours)</th>
    </tr>

    <tal:repeat repeat="story stories">
      <tr class="list-in-iteration toggle-story"
          tal:attributes="class string:list-in-iteration toggle-story kssattr-uid-${story/uid};">
        <td class="td-story-title"
            tal:attributes="id string:story-title-${story/uid}">
          <div>
            [ &darr; ]&nbsp;
            <a class="storyTitle_iteration_overview"
               tal:attributes="href string:${story/url}"
               tal:content="story/title" />
          </div>
        </td>
        <td tal:define="review_state story/review_state"
            tal:content="story/review_state_title"
            tal:condition="not:show_progress"
            i18n:domain="plone"
            i18n:translate=""
            class=""
            tal:attributes="class python:'td-center state-'+ review_state" />
        <!-- Use normalizeString on the review state ? -->

        <td class="progress_details"
            tal:condition="show_progress"
            width="150">
          <span class="progress_percentage">
            (<span i18n:domain="plone"
            i18n:translate="" tal:content="story/review_state_title" />)
            <tal:percentage tal:content="story/progress" />%&nbsp;
          </span>
          <br />
          <div class="progress_bar">
            <img tal:condition="story/is_completed"
                 src="progress-complete.gif"
                 height="10"
                 tal:attributes="width story/progress"
                 alt="progress bar"
                 i18n:attributes="alt progress_bar" />
            <img tal:condition="not:story/is_completed"
                 src="progress.gif"
                 height="10"
                 tal:attributes="width story/progress"
                 alt="progress bar"
                 i18n:attributes="alt progress_bar" />
          </div>
        </td>

        <tal:task_count tal:condition="show_task_count">
          <td tal:content="story/open_tasks" />
          <td tal:content="story/completed_tasks" />
        </tal:task_count>
        <td tal:content="story/size_estimate" />
        <td tal:condition="story/raw_estimate"
            tal:content="story/estimate" />
        <td tal:condition="not:story/raw_estimate"
            i18n:translate="no_tasks_defined">
          No tasks defined yet.
        </td>
        <td tal:content="story/actual" />
      </tr>
      <tr class="story-details-empty"
          tal:attributes="id string:story-details-${story/uid};">
        <td colspan="5"
            tal:attributes="colspan python:view.show_task_count and 7 or 5;">
          <span
              tal:attributes="id string:story-details-target-${story/uid};">
            Target for KSS to place the story details.
          </span>
        </td>
      </tr>
    </tal:repeat>

    <tr id="totalTasks"
        tal:condition="show_totals">
      <th class="td-story-title"
          colspan="2"
          tal:attributes="colspan python:show_task_count and 4 or 2"
          i18n:translate="total">Total</th>
      <th tal:content="iteration_dict/size_estimate" />
      <th tal:content="iteration_dict/estimate" />
      <th tal:content="iteration_dict/actual" />
    </tr>
  </table>
  <p class="discreet" i18n:translate="help_stories_table">
    The Initial estimate of the story is a rough estimate in
    days.  The Tasks estimate is the total estimate in hours
    for all tasks.  If there is a big difference there could
    be a logical explanation.  You should investigate that to
    be sure.
  </p>
</tal:storylist>
