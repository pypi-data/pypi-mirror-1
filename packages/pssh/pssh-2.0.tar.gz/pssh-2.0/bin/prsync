#!/usr/bin/env python
# -*- Mode: python -*-

# Copyright (c) 2009, Andrew McNabb
# Copyright (c) 2003-2008, Brent N. Chun

"""Parallel rsync to the set of nodes in hosts.txt.

For each node, we essentially do a rsync -rv -e ssh local user@host:remote.
Note that remote must be an absolute path.
"""

import os
import re
import sys

basedir, bin = os.path.split(os.path.dirname(os.path.abspath(sys.argv[0])))
sys.path.append("%s" % basedir)

from psshlib import psshutil
from psshlib.task import Task
from psshlib.manager import Manager
from psshlib.cli import common_parser, common_defaults

def option_parser():
    parser = common_parser()
    parser.usage = "%prog [OPTIONS] -h hosts.txt local remote"
    parser.epilog = ("Example: prsync -r -h hosts.txt -l irb2 foo " +
          "/home/irb2/foo")

    parser.add_option('-r', '--recursive', dest='recursive',
            action='store_true', help='recusively copy directories (OPTIONAL)')
    parser.add_option('-a', '--archive', dest='archive', action='store_true',
            help='use rsync -a (archive mode) (OPTIONAL)')
    parser.add_option('-z', '--compress', dest='compress', action='store_true',
            help='use rsync compression (OPTIONAL)')

    return parser

def parse_args():
    parser = option_parser()
    defaults = common_defaults()
    parser.set_defaults(**defaults)
    opts, args = parser.parse_args()

    if len(args) < 1:
        parser.error('Paths not specified.')

    if len(args) < 2:
        parser.error('Remote path not specified.')

    if len(args) > 2:
        parser.error('Extra arguments given after the remote path.')

    if not opts.host_files:
        parser.error('Hosts not specified.')

    return opts, args

def do_prsync(hosts, local, remote, opts):
    if opts.outdir and not os.path.exists(opts.outdir):
        os.makedirs(opts.outdir)
    if opts.errdir and not os.path.exists(opts.errdir):
        os.makedirs(opts.errdir)
    manager = Manager(opts)
    for host, port, user in hosts:
        cmd = ['rsync']
        if opts.verbose:
            cmd.append('-v')
        if port:
            cmd += ['--port', port]
        if opts.options:
            cmd += ['-e', 'ssh -o %s' % opts.options]
        else:
            cmd += ['-e', 'ssh']
        if opts.recursive:
            cmd.append('-r')
        if opts.archive:
            cmd.append('-a')
        if opts.compress:
            cmd.append('-z')
        cmd.append(local)
        if user:
            cmd.append('%s@%s:%s' % (user, host, remote))
        else:
            cmd.append('%s:%s' % (host, remote))
        t = Task(host, port, cmd, opts)
        manager.add_task(t)
    manager.run()

if __name__ == "__main__":
    opts, args = parse_args()
    local = args[0]
    remote = args[1]
    if not re.match("^/", remote):
        print "Remote path %s must be an absolute path" % remote
        sys.exit(3)
    hosts = psshutil.read_hosts(opts.host_files, default_user=opts.user)
    do_prsync(hosts, local, remote, opts)
