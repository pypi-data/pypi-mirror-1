<div metal:define-macro="threads"
     tal:omit-tag=""
     tal:define="userHasReplyPermission python:checkPermission('Reply to item', entry);
                 portal_discussion portal/portal_discussion;
                 isDiscussionAllowed python:portal_discussion.isDiscussionAllowedFor(entry);
                 ">

  <tal:allowed tal:define="replies python:context.getReplyReplies(entry);
                           threadid entry/UID">
    
    <div tal:content="python: '%s Comments' % len(replies)"
         class="replytitle commentsopen"
         id=""
         onclick=""
         tal:attributes="onclick string:javascript:toggleComments('${threadid}');
                         id string:${threadid}_headline"
         tal:condition="isDiscussionAllowed">1 Comments</div>
  
    <div class="discussion"
         id=""
         tal:attributes="id threadid"
         tal:condition="python:replies or (userHasReplyPermission and isDiscussionAllowed) or (isAnon and not userHasReplyPermission and isDiscussionAllowed)">
      
      <form name="reply"
            action=""
            method="post"
            tal:condition="python:userHasReplyPermission and isDiscussionAllowed"
            tal:attributes="action string:${entry/absolute_url}/discussion_reply_form">
        
        <input type="hidden"
               name="reply_come_from"
               value=""
               tal:attributes="value context/REQUEST/reply_come_from | context/absolute_url" />
        
        <input type="hidden"
               name="blogbatch.b_page"
               value=""
               tal:define="b_page context/REQUEST/blogbatch.b_page|nothing"
               tal:condition="b_page"
               tal:attributes="value b_page" />

        <input class="standalone"
               style="margin-bottom: 1.25em;"
               type="submit"
               value="Add Comment"
               i18n:attributes="value label_add_comment;"
               />
      </form>
      
      <form tal:condition="python:isAnon and not userHasReplyPermission and isDiscussionAllowed"
            tal:define="pss modules/Products/PythonScripts/standard"
            tal:attributes="action python:'%s/login_form?came_from=%s' %
                                          (here.portal_url(),
                                          pss.url_quote(request['URL']))">
        <input class="standalone"
               style="margin-bottom: 1.25em;"
               type="submit"
               value="Log in to add comments"
               i18n:attributes="value label_login_to_add_comments;"
               />
      </form>

      <tal:getreplies repeat="reply_dict replies">
      
        <div class="comment" style=""
             tal:define="indent python:reply_dict['depth']*15;
                         reply python:reply_dict['object']"
             tal:attributes="style string:margin-left:${indent}px;">
          
          <div class=""
               tal:define="creator reply/Creator;
                           anonymous_creator python:creator=='Anonymous User';
                           mi python:not anonymous_creator and mtool.getMemberInfo(creator);
                           fullname python: mi and mi['fullname'] or creator;
                           cssadd python: indent > 0 and 'reply' or 'base';
                           cssclass python: 'documentByLine ' + cssadd"
               tal:attributes="class cssclass" >
            <span tal:replace="python:toLocalizedTime(reply.ModificationDate(),
                               long_format=1)">8/23/2001 12:40:44 PM</span>
            <span>-</span>
            <span tal:content="fullname"
                  tal:condition="not:anonymous_creator">Poster Name</span>
            <span i18n:translate="label_anonymous_user"
                  tal:condition="anonymous_creator">Anonymous User</span>
            <span>wrote</span> 
          </div>
          
          <h3>
              <a name="comments" tal:attributes="name reply/id">
              <span tal:replace="reply/pretty_title_or_id">Comment title</span>
              </a>
          </h3>
          
          <div class="commentBody"
               tal:content="structure reply/CookedBody">
               This is the body text of the comment.
          </div>
          
          <form name="reply"
                action="discussion_reply_form"
                method="post"
                style="display: inline;"
                tal:attributes="action string:${reply/absolute_url}/discussion_reply_form"
                tal:condition="python:userHasReplyPermission and isDiscussionAllowed">
            
            <input type="hidden"
                   name="reply_come_from"
                   value=""
                   tal:attributes="value context/REQUEST/reply_come_from | context/absolute_url" />
            
            <input type="hidden"
                   name="blogbatch.b_page"
                   value=""
                   tal:define="b_page context/REQUEST/blogbatch.b_page|nothing"
                   tal:condition="b_page"
                   tal:attributes="value b_page" />
                
            <input class="standalone"
                   type="submit"
                   value="Reply"
                   i18n:attributes="value label_reply;"
                   />
                   
          </form>
          
          <form name="delete"
                action=""
                method="post"
                style="display: inline;"
                tal:condition="python:checkPermission('Manage portal', here)"
                tal:attributes="action string:${reply/absolute_url}/deleteDiscussion">
            
            <input type="hidden"
                   name="reply_come_from"
                   value=""
                   tal:attributes="value context/REQUEST/reply_come_from | context/absolute_url" />
            
            <input type="hidden"
                   name="blogbatch.b_page"
                   value=""
                   tal:define="b_page context/REQUEST/blogbatch.b_page|nothing"
                   tal:condition="b_page"
                   tal:attributes="value b_page" />
            
            <input class="destructive"
                   type="submit"
                   value="Remove"
                   i18n:attributes="value label_remove;"
                   />
                   
          </form>
          
        </div>
      </tal:getreplies>
    </div>
  </tal:allowed>
</div>