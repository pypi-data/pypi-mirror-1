<div i18n:domain="contract"
     tal:define="mtool context/portal_membership"
     tal:omit-tag=""
     tal:condition="python: mtool.checkPermission('plonehrm: view contracts viewlet', context)">


  <dl id="plonehrmContractViewlet" 
      class="module"
      tal:define="toLocalizedTime nocall:context/@@plone/toLocalizedTime;">
    <dt class="moduleHeader">
      <a id="contract_viewlet_end"
	 class="moduleButton" href=""
	 tal:condition="python: mtool.checkPermission('plonehrm: manage contracts', context)">
	<img src="exit_icon.gif"
             alt="End employment"
             title="End employment"
             i18n:attributes="title label_end_employment;
                              alt label_end_employment;" /></a>

      <a id="contract_viewlet_settings"
	 class="moduleButton" href=""
	 tal:condition="python: mtool.checkPermission('plonehrm: manage contracts', context)">
	<img src="settings_icon.gif"
             alt="Edit settings"
             title="Edit employee settings"
             i18n:attributes="title label_edit_settings;
                              alt label_edit_settings;" /></a>
      
      <a id="contract_viewlet_new"
	 class="moduleButton"
         tal:condition="python: mtool.checkPermission('plonehrm: manage contracts', context) and mtool.checkPermission('plonehrm: Add contract', context)"
         tal:attributes="href string:${here/absolute_url}/createObject?type_name=Contract">
	<img src="add-contract_icon.gif"
             alt="Add new contract"
             title="Add new contract"
             i18n:attributes="title add_new_contract;
                              alt add_new_contract;" /></a>
      <a id="contract_viewlet_edit"
	 class="moduleButton"
	 tal:condition="python: mtool.checkPermission('plonehrm: manage contracts', context) and mtool.checkPermission('plonehrm: Add contract', context) and view.number() > 0"
         tal:attributes="href string:${here/absolute_url}/createObject?type_name=Letter">
	<img src="add-letter_icon.gif"
               alt="Add change letter"
               title="Add change letter"
               i18n:attributes="title add_new_letter;
                                alt add_new_letter;" /></a>


      <!-- Alternative icon ^^^ add_alternative_icon.gif -->
      <span tal:omit-tag=""
            i18n:translate="head_contract">Contracts</span>
    </dt>
    <dd class="moduleItem lastItem">
      <!-- Display the list of contract and a table of informations
	   about the last contract. -->
      
      <tal:block tal:condition="python: view.view_mode == 'list'">

	<table tal:condition="context/getEndEmploymentDate"
	       class="contract-overview listing">
	  <tbody>
	    <tr>
	      <th i18n:translate="contract_label_end_employment_date">
		End employment date</th>
	      <td tal:content="context/getEndEmploymentDate" />
	    </tr>
	    <tr>
	      <th i18n:translate="contract_label_end_employment_reason">
		End employment reason</th>
	      <td tal:content="context/getEndEmploymentReason" />
	    </tr>
	  </tbody>
	</table>

	<table class="contract-overview listing" cellspacing="0" cellpadding="0"
               tal:condition="view/current_contract|nothing">
          <tbody>
            <tr>
              <th i18n:translate="contract_label_function"> Function
              </th>
              <td tal:content="view/get_function"
                  class="contract-info"> Salesman
              </td>
            </tr>
            <tr>
              <th i18n:translate="contract_label_wage"> Wage
              </th>
              <td class="contract-info">
                <span tal:content="structure context/portal_properties/plonehrm_properties/currency|nothing" />
                <span tal:content="view/wage">1.00</span>
              </td>
            </tr>
            <tr>  
              <th i18n:translate="contract_label_expires"> Expiration date </th>
              <td tal:content="python:toLocalizedTime(view.expires())"
                  class="contract-info"> 2007/12/31
              </td>
            </tr>
            <tr tal:condition="not:view/current_contract|nothing">
              <th i18n:translate="label_contract">
		contract
              </th>
              <td i18n:translate="label_no_contract">
		no contract
              </td>
            </tr>
            <tr tal:define="worktime view/sum_worktime"
		tal:condition="worktime">
              <th i18n:translate="contract_label_employed"> employed </th>
              <td>
                <span i18n:translate="label_contracted_year_and_month"
                      tal:condition="python:worktime['year'] and worktime['month']">
                  <tal:year i18n:name="year" tal:content="worktime/year" />
                  year(s) and
                  <span i18n:name="months" tal:replace="worktime/month" />
                  month(s)
                </span>
		
                <span i18n:translate="label_contracted_year"
                      tal:condition="python:worktime['year'] and not worktime['month']">
                  <tal:year i18n:name="year" tal:content="worktime/year" />
                  year(s)
                </span>
		
                <span i18n:translate="label_contracted_months"
                      tal:condition="python:not worktime['year'] and worktime['month']">
                  <span i18n:name="months" tal:replace="worktime/month" />
                  month(s)
                </span>
              </td>
            </tr>
          </tbody>
	</table>

   <table tal:condition="view/contract_list|nothing"
         class="contract-list listing">
	   <thead>
	      <tr>
	         <th i18n:translate="label_period" >
		   Period
		 </th>
	         <th i18n:translate="contract_label_wage">
		         Wage
		      </th>
	         <th i18n:translate="contract_label_hours">
		         Number of hours
		      </th>
	         <th class="document-type"></th>
		 <th class="delete-contract"
		     tal:condition="python: mtool.checkPermission('plonehrm: manage contracts', context)"></th>
	      </tr>
	   </thead>
      <tbody>
         <tr tal:repeat="info view/sorted_contracts"
               tal:attributes="class info/typ">
   	      <td>
		<span tal:replace="python: toLocalizedTime(info['contract'].getStartdate())" />
   		/ <span tal:replace="python: toLocalizedTime(info['contract'].expiry_date())" />
	      </td>
   	      <td tal:content="python: info['contract'].getWage()" />
	      <td tal:content="python: info['contract'].getHoursPerWeek()" />
            <td class="document-type">
               <a href="#"
   		  class="contract_list_link"
                  tal:attributes="href info/contract/absolute_url;
   				  onclick python:'javascript:contract_popup(this)'" >
   		         <img src="contract_icon.gif"
			      tal:attributes="title info/title"
			      tal:condition="info/contract/is_contract"/>
   		         <img src="letter_icon.gif"
			      tal:attributes="title info/title"
			      tal:condition="not: info/contract/is_contract"/>
               </a>
            </td>
            <td class="delete-contract"
		tal:condition="python: mtool.checkPermission('plonehrm: manage contracts', context)">
               <a href="#"
		  tal:attributes="href string: ${info/contract/absolute_url}/delete_confirmation" >
   		 <img src="delete_icon.gif" />
               </a>
            </td>

          </tr>
       </tbody>
   </table>
</tal:block>

      <!-- Displays edit settings form. -->
      <tal:block tal:condition="python: view.view_mode == 'settings'">
	<span i18n:translate="msg_contract_settings_explanation">
	  This form is used to set a start date for your employee if
	  his first contracts have not been stored in the tool.</span>
	<form name="contract_edit_settings_form"
              method="post">

	  <p id="contract_viewlet_settings_pastdate_error"
	     class="dont-show" i18n:translate="msg_error_past_start_date">
	    Date is supposed to be in the past.
	  </p>
	  
	  <p id="contract_viewlet_settings_baddate_error"
	     class="dont-show" i18n:translate="msg_error_invalid_date">
	    This date is not valid.
	  </p>
	  
          <label for="contract_settings_start_date"
                 i18n:translate="label_start_date">Start date</label>
	  
          <tal:start
             define="today python:modules['DateTime'].now();
                     utils python:modules['Products.CMFPlone.utils'];
                     uniqueItemIndex python:utils.RealIndexIterator(pos=0);
                     fieldName string:contract_settings_start_date;
                     id fieldName;
                     show_hm python:False;
                     show_ymd python:True;
                     starting_year python:1940;
                     ending_year python:today.year();
                     inputname fieldName;
                     formname string:contract_edit_settings_form;
                     inputvalue view/start_date;
                     tabindex python:1;">
            <metal:box use-macro="here/calendar_macros/macros/calendarDatePickerBox|here/calendar_slot/macros/calendarDatePickerBox">
              a calendar, hopefully
            </metal:box>
          </tal:start>
	  <br />
	  <input type="button"
		 id="contract_viewlet_save_settings"
		 class="context"
		 value="Save settings"
		 i18n:attributes="value label_save_contracts_settings" />
	  <input type="button"
		 id="contract_viewlet_cancel"
		 class="context"
		 value="Cancel"
		 i18n:domain="plone"
		 i18n:attributes="value label_cancel" />
	</form>
      </tal:block>

      <!-- Displays add contract/letter form. -->
      <tal:block tal:condition="python: view.view_mode in ['add_contract', 'add_letter']">
	<div tal:condition="not: view/can_create_contract">
	  <p tal:condition="not: view/can_create_contract"
	     i18n:translate="msg_missing_elements">
            You can not add any contract before setting up templates,
            functions and employment types.
	  </p>
	  <a tal:attributes="href python: context.absolute_url() + '/portal_contracts/'"
	     i18n:translate="msg_manage_portal_contracts">
            Manage contract settings</a>.
	</div>

	<form name="contract_add_contract_form"
              tal:condition="view/can_create_contract">
	  <label for="contract_form_title"
		 i18n:domain="plone"
		 i18n:translate="label_title">
	    Title</label><br />
	  <input type="text"
		 id="contract_form_title"
		 name="contract_form_title"
		 class="contract_field" />
	  <br />
	  <label for="contract_form_template"
		 i18n:translate="contract_label_template">
	    Template</label>
	  <br />
	  <p class="dont-show" id="contract_viewlet_no_template"
	     i18n:translate="msg_error_no_template">
	    You must specify a template for the contract.
	  </p>
	  <select id="contract_form_template"
		  name="contract_form_template"
		  class="contract_field">
	    <tal:block tal:condition="python: view.view_mode == 'add_contract'"
		       tal:repeat="template python: view.get_templates('contract')">
              <option tal:attributes="value template/id"
		      tal:content="template/Title" />
	    </tal:block>

	    <tal:block tal:condition="python: view.view_mode == 'add_letter'"
		       tal:repeat="template python: view.get_templates('letter')">
              <option tal:attributes="value template/id"
		      tal:content="template/Title" />
	    </tal:block>

	  </select>
	  <br />

	  <label for="contract_form_wage"
		 i18n:translate="contract_label_wage">
	    Wage</label>
	  <br />
	  <p class="dont-show" id="contract_viewlet_wage_no_float"
	     i18n:translate="msg_error_wage_no_float">
	    Wage must be a decimal number.
	  </p>
	  <input type="text"
		 id="contract_form_wage"
		 name="contract_form_wage"
		 class="contract_field"
		 tal:attributes="value view/default_wage"/>
	  <br />

	  <label for="contract_form_function"
		 i18n:translate="contract_label_function">
	    Function</label><br />
	  <select id="contract_form_function"
		  name="contract_form_function"
		  class="contract_field">
	    <tal:block tal:repeat="function view/get_functions">
              <option tal:condition="python: not function == view.default_function()"
		      tal:attributes="value function"
		      tal:content="function" />
              <option tal:condition="python: function == view.default_function()"
		      selected="selected"
		      tal:attributes="value function"
		      tal:content="function" />
	    </tal:block>
	  </select>
	  <br />

	  <label for="contract_form_startdate"
		 i18n:translate="contract_label_startdate">
	    Start date</label>
	  <br />
	  <p class="dont-show" id="contract_viewlet_invalid_date"
	     i18n:translate="msg_error_invalid_date">
	    This date is not a valid.
	  </p>
          <tal:start
             define="today python:modules['DateTime'].now();
                     utils python:modules['Products.CMFPlone.utils'];
                     uniqueItemIndex python:utils.RealIndexIterator(pos=0);
                     fieldName string:contract_form_startdate;
                     id fieldName;
                     show_hm python:False;
                     show_ymd python:True;
                     starting_year python:today.year() - 5;
                     ending_year python:today.year() + 5;
                     inputname fieldName;
                     formname string:contract_add_contract_form;
                     inputvalue view/default_start_date;
                     tabindex python:1;">
            <metal:box use-macro="here/calendar_macros/macros/calendarDatePickerBox|here/calendar_slot/macros/calendarDatePickerBox">
              a calendar, hopefully
            </metal:box>
          </tal:start>

	  <label for="contract_form_duration"
		 i18n:translate="contract_label_duration">
            Duration (months)</label>
	  <br />
	  <p class="dont-show" id="contract_viewlet_duration_no_integer"
             i18n:translate="msg_error_duration_no_integer">
            Duration must be an integer.
	  </p>
	  <input type="text"
		 id="contract_form_duration"
		 name="contract_form_duration"
		 class="contract_field" />
	  <br />

	  <label for="contract_form_trial_period"
		 i18n:translate="contract_label_trial_period">
            Trial period (months)</label><br />
	  <select id="contract_form_trial_period"
		  name="contract_form_trial_period"
		  class="contract_field">
            <tal:block tal:repeat="number python: range(0, 3)">
	      <option tal:attributes="value number"
		      tal:content="number" />
            </tal:block>
	  </select>
	  <br />

	  <label for="contract_form_employment_type"
		 i18n:translate="contract_label_employmentType">
	    Type of employment</label><br />
	  <select id="contract_form_employment_type"
		  name="contract_form_employment_type"
		  class="contract_field" >
	    <tal:block tal:repeat="type view/get_employment_types">
              <option tal:condition="python: not type == view.default_employment_type()"
		      tal:attributes="value type"
		      tal:content="type" />
              <option tal:condition="python: type == view.default_employment_type()"
		      selected="selected"
		      tal:attributes="value type"
		      tal:content="type" />
	    </tal:block>
	  </select>
	  <br />

	  <label for="contract_form_number_hours"
		 i18n:translate="contract_label_hours">
	    Number of hours</label>
	  <br />
	  <p class="dont-show" id="contract_viewlet_hours_no_integer"
	     i18n:translate="msg_error_hours_no_integer">
	    Number of hours must be an integer.
	  </p>
	  <input type="text"
		 id="contract_form_number_hours"
		 name="contract_form_number_hours"
		 class="contract_field"
		 tal:attributes="value view/default_hours" />
	  <br />

	  <label for="contract_form_workdays"
		 i18n:translate="contract_label_days_per_week">
	    Number of workdays per week</label>
	  <br />
	  <p class="dont-show" id="contract_viewlet_workdays_no_integer"
	     i18n:translate="msg_error_workdays_no_integer">
	    Number of workdays must be an integer.
	  </p>
	  <p class="dont-show" id="contract_viewlet_incorrect_workdays"
	     i18n:translate="msg_error_incorrect_workdays">
	    Number of days per week must be between 0 and 7.
	  </p>
	  <input type="text"
		 id="contract_form_workdays"
		 name="contract_form_workdays"
		 class="contract_field"
		 tal:attributes="value view/default_days_per_week" />
	  <br />

	  <tal:block tal:condition="view/is_arbo_manager"
		     tal:define="default_hours view/default_hour_spread">
	    <label for="contract_form_working_schedule"
		   i18n:translate="label_working_schedule">
	      Working schedule</label>
	    <br />
	    <select id="contract_form_working_schedule"
		    name="contract_form_working_schedule">
	      <option value="auto"
		      selected="selected"
		      tal:condition="python: default_hours.mode == 'auto'"
		      i18n:translate="label_evenly_spread">
		Evenly spread</option>
	      <option value="auto"
		      tal:condition="python: default_hours.mode != 'auto'"
		      i18n:translate="label_evenly_spread">
		Evenly spread</option>
	      <option value="manual"
		      selected="selected"
		      tal:condition="python: default_hours.mode == 'manual'"
		     i18n:translate="label_manually_spread">
		Manually spread</option>
	      <option value="manual"
		      tal:condition="python: default_hours.mode != 'manual'"
		     i18n:translate="label_manually_spread">
		Manually spread</option>
	      <option value="manual_oddeven"
		      selected="selected"
		      tal:condition="python: default_hours.mode == 'manual_oddeven'"
		     i18n:translate="label_manually_spread_oddeven">
		Manually spread (odd/even weeks)</option>
	      <option value="manual_oddeven"
		      tal:condition="python: default_hours.mode != 'manual_oddeven'"
		     i18n:translate="label_manually_spread_oddeven">
		Manually spread (odd/even weeks)</option>
	    </select>
	    <br />

	    <p class="dont-show" id="contract_viewlet_spread_to_high"
	       i18n:translate="msg_error_spread_to_high">
	      Total of hours you defined is greater than the number
	      of hours specified in the contract.
	    </p>

	    <p class="dont-show" id="contract_viewlet_more_than_24"
	       i18n:translate="msg_error_more_than_24">
	      You can not work more than 24 hours a day.
	    </p>

	    <p class="dont-show" id="contract_viewlet_invalid_hour_spread"
	       i18n:translate="msg_error_invalid_spread">
	      Hours must be decimal numbers.
	    </p>


	    <table id="contract_viewlet_manual_schedule"
		   tal:attributes="class python: (default_hours.mode == 'auto') and 'dont-show' or 'listing'">
	      <thead>
		<tr i18n:domain="plonelocales">
		  <th i18n:domain="contract"
		      i18n:translate="label_week">
		    Week</th>
		  <th i18n:translate="weekday_mon_short">
		    Mo</th>
		  <th  i18n:translate="weekday_tue_short">
		    Tu</th>
		  <th i18n:translate="weekday_wed_short">
		    We</th>
		  <th i18n:translate="weekday_thu_short">
		    Th</th>
		  <th i18n:translate="weekday_fri_abbr">
		    Fr</th>
		  <th i18n:translate="weekday_sat_short">
		    Sa</th>
		  <th i18n:translate="weekday_sun_short">
		    Su</th>
		</tr>
	      </thead>
	      <tbody>
		<tr tal:repeat="week python: ['odd', 'even']"
		    tal:attributes="id python: 'contract_viewlet_manual_schedule_' + week;
				    class python: (week == 'even' and default_hours.mode == 'manual') and 'dont-show' or ''">
		  <td tal:condition="python: week == 'odd' and not default_hours.mode == 'manual'"
		      i18n:translate="label_odd"
		      tal:attributes="id python: 'contract_viewlet_manual_schedule_odd_first_row'">
		    Odd</td>
		  <td tal:condition="python: week == 'odd' and default_hours.mode == 'manual'"
		      i18n:translate="label_normal"
		      tal:attributes="id python: 'contract_viewlet_manual_schedule_odd_first_row'">
		    Normal</td>
		  <td tal:condition="python: week == 'even'"
		      i18n:translate="label_even"
		      tal:attributes="id python: 'contract_viewlet_manual_schedule_even_first_row'">
		    Even</td>
		  <td tal:repeat="day python: range(0, 7)">
		    <input type="text"
			   tal:define="field_name python: 'schedule_' + week + '_' + str(day)"
			   tal:attributes="name field_name;
					   value python: default_hours.get_value_from_field(field_name)"/>
		  </td>
		</tr>
	      </tbody>
	    </table>
	  </tal:block>

	  <input type="button"
		 tal:condition="python: view.view_mode == 'add_contract'"
		 id="contract_viewlet_save_contract"
		 class="context"
		 value="Save contract"
		 i18n:attributes="value label_save_contract" />

	  <input type="button"
		 tal:condition="python: view.view_mode == 'add_letter'"
		 id="contract_viewlet_save_letter"
		 class="context"
		 value="Save letter"
		 i18n:attributes="value label_save_letter" />

	  <input type="button"
		 id="contract_viewlet_cancel"
		 class="context"
		 value="Cancel"
		 i18n:domain="plone"
		 i18n:attributes="value label_cancel" />
	</form>
      </tal:block>
      <tal:block tal:condition="python: view.view_mode ==
				'endEmployment'">
	<p i18n:translate="contract_msg_end_employment_explanation">
	  This form is used to terminate employment of the person.</p>

	<form name="contract_end_employment">
	  <label for="end_employment_reason"
		 i18n:translate="contract_form_label_end_employment_reason">
	    Reason</label>

	  <textarea name="end_employment_reason"
		    id="end_employment_reason"
		    tal:content="context/getEndEmploymentReason ">
	  </textarea>
	  <br />

	  <label for="end_employment_date"
		 i18n:translate="contract_form_label_end_employment_date">
	    Date</label>

	  <p class="dont-show" id="contract_viewlet_end_date_empty_error"
	     i18n:translate="msg_error_end_date_empty">
	    You must set an end date.
	  </p>
	  <p class="dont-show" id="contract_viewlet_end_date_invalid_error"
	     i18n:translate="msg_error_end_date_invalid">
	    This is not a valid date.
	  </p>

          <tal:start
             define="today python:modules['DateTime'].now();
                     utils python:modules['Products.CMFPlone.utils'];
                     uniqueItemIndex python:utils.RealIndexIterator(pos=0);
                     fieldName string:contract_end_employment_date;
                     id fieldName;
                     show_hm python:False;
                     show_ymd python:True;
                     starting_year python:today.year() - 5;
                     ending_year python:today.year() + 5;
                     inputname fieldName;
                     formname string:contract_end_employment;
                     inputvalue context/getEndEmploymentDate | today;
                     tabindex python:1;">
            <metal:box use-macro="here/calendar_macros/macros/calendarDatePickerBox|here/calendar_slot/macros/calendarDatePickerBox">
              a calendar, hopefully
            </metal:box>
          </tal:start>
	  <br />
	  
	  <input type="button"
		 id="contract_viewlet_end_employment"
		 class="context"
		 value="End employment"
		 i18n:attributes="value label_end_employment" />

	  <input type="button"
		 id="contract_viewlet_cancel"
		 class="context"
		 value="Cancel"
		 i18n:domain="plone"
		 i18n:attributes="value label_cancel" />
	</form>
      </tal:block>
    </dd>
  </dl>

  <SCRIPT LANGUAGE="JavaScript">
	  /* This function only opens the pop-up menu, link
	  desactivation is handled by KSS.*/
	  function contract_popup(context) {
	  conf='height=500,\
         width=600,\
         toolbar=no,\
         menubar=yes,\
         scrollbars=yes,\
         resizable=yes,\
         location=no,\
         directories=no,\
         status=no';
         window.open(context.href + '/@@contract_popup',
         'contract',
         config=conf);
	  }
	</SCRIPT>
</div>
