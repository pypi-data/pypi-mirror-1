<h1 tal:replace="structure context/manage_page_header">PAGE HEADER</h1>
<h2 tal:define="manage_tabs_message options/manage_tabs_message | nothing"
    tal:replace="structure context/manage_tabs">TABS</h2>

<tal:page tal:define="wfs view/getWorkflowMigration;
                      map view/getStateMapping" >

<tal:setwfs tal:condition="wfs"><tal:block tal:define="global workflow_from python:wfs[0];
                                                       global workflow_to python:wfs[1]" />
</tal:setwfs>
<tal:setwfs tal:condition="not:wfs"><tal:block tal:define="global workflow_from python:None;
                                                           global workflow_to python:None" />
</tal:setwfs>

<h3>Migrate content from one workflow to another</h3>

<blockquote tal:condition="request/out | nothing" tal:content="structure request/out" />

<form action="">

<fieldset>
<legend>Set the migration path</legend>
<p>Select the workflow you wish to migrate FROM:</p>

<select name="wf_from">
<option tal:condition="wfs" 
        tal:attributes="value workflow_from/id" tal:content="workflow_from/title" />
<option value="">-- Migrate from workflow --</option>
<option tal:repeat="wf view/listWorkflows" 
        tal:attributes="value wf/id" tal:content="wf/title" />
</select>

<p>Select the workflow you wish to migrate TO:</p>

<select name="wf_to">
<option tal:condition="wfs" 
        tal:attributes="value workflow_to/id" tal:content="workflow_to/title" />
<option value="">-- Migrate to workflow --</option>
<option tal:repeat="wf view/listWorkflows" 
        tal:attributes="value wf/id" tal:content="wf/title" />
</select>

<br /><br />
<input type="submit" name="set_migration" value="Choose workflow migration" />
</fieldset>

<tal:mapping tal:condition="wfs | nothing">

<br /><br />
<fieldset>
<legend>Map the workflow states</legend>
<table border="1" cellpadding="5"> 
<tr><th tal:content="workflow_from/title | wf_from"></th>
<th tal:content="workflow_to/title | wf_to"></th></tr>
<tr tal:repeat="from_state python:view.getStates(wf=workflow_from.id)">
<td>
<input type="hidden" name="state.from:records" tal:attributes="value from_state/id" />
<span tal:replace="from_state/title" />
</td><td>
<select name="state.to:records" tal:define="state_id python:map.get(from_state['id'],'not found');
                                this_state python:view.getStates(wf=workflow_to.id,id=state_id)">
<tal:selected tal:condition="this_state">
   <option tal:attributes="value this_state/id" tal:content="this_state/title" /> 
</tal:selected>
<option value="">-- Pick the state to move to --</option>
<option tal:repeat="to_state python:view.getStates(wf=workflow_to.id)" 
        tal:attributes="value to_state/id" tal:content="to_state/title" />
</select>
</td></tr>
</table>
<br /><br />
<input type="submit" name="set_migration" value="Edit state mapping" />
</fieldset>

<br /><br />
<fieldset>
<legend>Run the Workflow Migration</legend>
<label>Choose the locale:</label>
<input type="text" name="locale" size="50" value="/" />
<p>Specify a relative path. The default is the whole portal but if used in conjunction with CMFPlacefulWorkflow 
a particular locale may be required</p>
<input tal:condition="map" type="submit" name="run_migration" value="Run the migration" />
</fieldset>

</tal:mapping>

</form>

</tal:page>

<p>
    <a href="manage_overview">Return</a>
</p>


<h1 tal:replace="structure context/manage_page_footer">PAGE FOOTER</h1>

