<VirtualHost $bind>
    ServerName $host

    RewriteEngine On
    RewriteLog $log_dir/rewrite_${host}.log
    RewriteLogLevel 0

    CustomLog $log_dir/access_${host}.log ${log_format}
    ErrorLog $log_dir/error_${host}.log

    <Proxy http://$backend.backend_host:$backend.backend_port>
      Allow from all
    </Proxy>

    RewriteRule ^(.*)$ - [E=BACKEND_LOCATION:$backend.backend_host]
    RewriteRule ^(.*)$ - [E=BACKEND_PORT:$backend.backend_port]
    RewriteRule ^(.*)$ - [E=HOST:$backend.host]
    RewriteRule ^(.*)$ - [E=PORT:$port]
    #if $port == '80'
    RewriteRule ^(.*)$ - [E=PROTO:http]
    #else if $port == '443'
    RewriteRule ^(.*)$ - [E=PROTO:https]
    #end if
    #if $zope2_vhm_maps
    #for $path in $zope2_vhm_maps
    RewriteRule ^(.*)$ - [E=ZOPEPATH:$path]
    #if $backend._vhm_path
    RewriteRule  ^/${backend._vhm_path}(.*)$ http://%{ENV:BACKEND_LOCATION}:%{ENV:BACKEND_PORT}/VirtualHostBase/%{ENV:PROTO}/%{ENV:HOST}:%{ENV:PORT}/%{ENV:ZOPEPATH}/VirtualHostRoot/_vh_$backend._vhm_path$1 [L,P]
    RewriteRule  ^/(.*)$ http://%{ENV:BACKEND_LOCATION}:%{ENV:BACKEND_PORT}/VirtualHostBase/%{ENV:PROTO}/%{ENV:HOST}:%{ENV:PORT}/%{ENV:ZOPEPATH}/VirtualHostRoot/_vh_$backend._vhm_path/$1 [L,P]

    #else
    RewriteRule  ^/(.*)/$ http://%{ENV:BACKEND_LOCATION}:%{ENV:BACKEND_PORT}/VirtualHostBase/%{ENV:PROTO}/%{ENV:HOST}:%{ENV:PORT}/%{ENV:ZOPEPATH}/VirtualHostRoot/$1 [L,P]
    RewriteRule  ^/(.*)$ http://%{ENV:BACKEND_LOCATION}:%{ENV:BACKEND_PORT}/VirtualHostBase/%{ENV:PROTO}/%{ENV:HOST}:%{ENV:PORT}/%{ENV:ZOPEPATH}/VirtualHostRoot/$1 [L,P]

    #end if
    #end for
    #else
    RewriteRule  ^/(.*)/$ http://%{ENV:BACKEND_LOCATION}:%{ENV:BACKEND_PORT}/$1 [L,P]
    RewriteRule  ^/(.*)$ http://%{ENV:BACKEND_LOCATION}:%{ENV:BACKEND_PORT}/$1 [L,P]
    #end if

</VirtualHost>
