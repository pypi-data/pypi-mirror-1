<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>SimpleExampleEgg</title>
<meta name="Generator" content="Vim reStructured Text b20 - Vim7.0" />
<meta name="Author" content="Todd Greenwood" />
<meta name="Title" content="SimpleExampleEgg" />
<meta name="Keywords" content="python, egg, setuptools, distutils, tutorial, doctests, unit tests, deploy, install, example" />
<meta name="Date" content="Dec 2005" />

<link rel="stylesheet" href="default.css" type="text/css" />
<link rel="stylesheet" href="oldstyle.css" type="text/css" />

</head>
<body>


<h1 id="lsimpleexampleegg">SimpleExampleEgg</h1>
<table class="field" summary="Field list"><tr><td class="fkey">Author:</td><td class="fval"> Todd Greenwood</td></tr>

<tr><td class="fkey">Title:</td><td class="fval"> SimpleExampleEgg</td></tr>

<tr><td class="fkey">Keywords:</td><td class="fval"> python, egg, setuptools, distutils, tutorial, doctests, unit tests, deploy, install, example</td></tr>

<tr><td class="fkey">Version:</td><td class="fval"> 0.1</td></tr>

<tr><td class="fkey">License:</td><td class="fval"> GPL v. 2</td></tr>

<tr><td class="fkey">Date:</td><td class="fval"> Dec 2005</td></tr>
</table>

<p>
This aims to be a super simple example of python, setuptools, docutils, unit-tests, and eggs.
</p>

<span id="tocheader" class="toc">Contents</span>
<ul class="toc">
 <li class="h1"><a href="#lsimpleexampleegg">SimpleExampleEgg</a></li>
  <li class="h2"><a href="#lintroduction">Introduction</a></li>
  <li class="h2"><a href="#lbasic-source-files">Basic Source Files</a></li>
  <li class="h2"><a href="#ltests-and-building">Tests and Building</a></li>
   <li class="h3"><a href="#lbuilding-the-rest-docs">Building the REST docs</a></li>
  <li class="h2"><a href="#lbacktracking">Backtracking</a></li>
   <li class="h3"><a href="#lthe-ez-setup46py-file">The ez_setup.py file</a></li>
   <li class="h3"><a href="#lcreate-a-pipy-account58">Create a PiPy account:</a></li>
  <li class="h2"><a href="#lapp-deployment">App Deployment</a></li>
   <li class="h3"><a href="#lscript-generation">Script Generation</a></li>
   <li class="h3"><a href="#lbuilding">Building</a></li>
   <li class="h3"><a href="#ldeploy-locally-40dev-mode41">Deploy Locally (Dev Mode)</a></li>
   <li class="h3"><a href="#ldeploy-to-my-ftp-web-site">Deploy to my ftp web site</a></li>
   <li class="h3"><a href="#ldeploy-to-pipy">Deploy To pipy</a></li>
  <li class="h2"><a href="#linstall-the-app-">Install the app </a></li>
   <li class="h3"><a href="#ldownload">Download</a></li>
   <li class="h3"><a href="#linstall">Install</a></li>
   <li class="h3"><a href="#lrun-unit-tests">Run Unit Tests</a></li>
</ul>
<!--.. comment:: end of toc -->
<h2 id="lintroduction">Introduction</h2>

<p>
Hopefully, this will clarify, in my own mind, at least, how to make super simple apps that have all sorts of cool extras such as working unit tests, launch scripts, deploy and install flawlessly...etc. Ideally, I'll be able to write apps that 'just work'. So my end users can just point some tool (easy_install) at a file (an egg) and voila, a working app.
</p>

<p>
Here's what I'd like to have happen for this exercise:
</p>

 <ul class="circle">
 <li><p class="onlyli"> user clicks a link</p></li>
 <li><p class="firstli"> app downloads and installs</p></li>
 <li><p class="onlyli"> app runs it's internal test suite as part of the install</p></li>
        <li><p class="firstli"> if it fails, the install is stopped and 'rolled back' </p></li>
        <li><p class="onlyli"> or the user is given an error message</p></li>
 <li><p class="firstli"> if the install is successfull, a web browser is launched for the docs</p></li>
 <li><p class="onlyli"> or for the app</p>
</li>
</ul>

<p>
Along the way, I'll play around with:
</p>

 <ul class="circle">
 <li><p class="firstli"> deploying the app locally, to my own ftp site, and to pipy</p></li>
 <li><p class="firstli"> user may recieve the app via email, a web link, file copy, etc.</p></li>
 <li><p class="onlyli"> doctests and unit tests</p>
</li>
</ul>

<p>
Note, this documentation was written using Mikolaj Machowski's 
Vim reStructured Text plugin (<a href="http://skawina.eu.org/mikolaj/vst.html" title="vst">vst</a>). It is the coolest thing since the intraweb.
</p>

<h2 id="lbasic-source-files">Basic Source Files</h2>
<ol class="decimal">
<li><p class="firstli">dir listing:</p>
    <blockquote>

    <p>

<pre>
apple.py
docs
__init__.py
orange.py
simpletests.py
</pre>
    </p>

    </blockquote>
</li>
<li><p class="firstli">apple.py:</p>
    <blockquote>

    <p>

<pre>
import sys

def make_pie(who):
	"""
>>> import apple as a
>>> a.make_pie('Todd')
'Todd likes pie!!!'
	"""
	return '%s likes pie!!!'%who
#
def _test():
	import doctest
	return doctest.testmod()
#
if __name__ == "__main__":
    _test()
    if len(sys.argv)>1: print make_pie(sys.argv[1])
    </p>
</pre>

    </blockquote>
</li>
<li><p class="firstli">Let's run this tiny app to see what we get:</p>
    <blockquote>

    <p>
    <code>$ python apple.py Mr.Guido</code>
    </p>

    <p>

<pre>
Mr.Guido likes pie!!!
</pre>
    </p>

    </blockquote>
</li>
<li><p class="firstli">setup.py:</p>
    <blockquote>

    <p>

<pre>
from ez_setup import use_setuptools
use_setuptools()
from setuptools import setup, find_packages
#
setup(name = "SimpleExampleEgg",
    version = "0.1",
    description = "test",
    author = "Todd Greenwood",
    author_email = "t.greenwoodgeer@gmail.com",
    url = "http://www.angelfire.com/planet/tango",
	entry_points = {'console_scripts': [
		'make_apple_pie = fruit.apple.make_pie'
		]},
    packages = find_packages(exclude=['ez_setup'] ),
	package_data = {'':['docs/*.html', 'docs/*.rest','docs/*.vim']},
    test_suite = 'fruit.simpletests.getTestSuite',
    license = "GNU Lesser General Public License",
    classifiers = [
        "Development Status :: 1 - Alpha",
        "Intended Audience :: Developers",
        "License :: OSI Approved :: GNU Library or Lesser General Public License (LGPL)",
        "Programming Language :: Python",
        "Topic :: Database :: Front-Ends",
    ],
    zip_safe=True,
    )
    </p>
</pre>

    </blockquote>
</li>
<li><p class="firstli">simpletests.py:</p>
    <blockquote>

    <p>

<pre>
import apple
import unittest
import doctest
#
def getTestSuite():
	suite = unittest.TestSuite()
	for mod in apple,:
	    suite.addTest(doctest.DocTestSuite(mod))
	return suite
#
runner = unittest.TextTestRunner()
runner.run(getTestSuite())
    </p>
</pre>

    </blockquote>
</li></ol>
<h2 id="ltests-and-building">Tests and Building</h2>
<ol class="decimal">
<li><p class="firstli">Let's run the test suite:</p>
    <blockquote>

    <p>
    <code>$ python simpletests.py</code>
    </p>

    <p>

<pre>
.
----------------------------------------------------------------------
Ran 1 test in 0.012s

OK
</pre>
    </p>

    </blockquote>
</li>
<li><p class="firstli">Now, let's run the test suite from setuptools:</p>
    <blockquote>

    <p>
    <code>$ python setup.py test</code>
    </p>

    <p>

<pre>
running test
running egg_info
writing ./SimpleExampleEgg.egg-info/PKG-INFO
writing top-level names to ./SimpleExampleEgg.egg-info/top_level.txt
writing entry points to ./SimpleExampleEgg.egg-info/entry_points.txt
running build_ext
.
----------------------------------------------------------------------
Ran 1 test in 0.012s

OK
Doctest: fruit.apple.make_pie ... ok

----------------------------------------------------------------------
Ran 1 test in 0.001s

OK
</pre>
    </p>

    </blockquote>
</li>
<li><p class="firstli">Next, let's make sure the build system works. But first, I should mention
   that this documentation is generated via a vim pluggin.</p>
</li></ol>
<h3 id="lbuilding-the-rest-docs">Building the REST docs</h3>
<ol class="decimal">
<li><p class="firstli">So, while from a command line you would execute:</p>
    <blockquote>

    <p>
    <code>$ python setup bdist_egg</code>
    </p>

    <p>
    Because this doc lives in ./fruit/docs/readme.rest, I will use the pbu
    utility to walk the directory tree and launch setup.py. If you would like
    to build the docs, here is the process:
    </p>

    <ol class="loweralpha">
    <li><p class="firstli">install pbu:</p>
<pre>
 $ easy_install buildutils
</pre>

    </li>    
    <li><p class="firstli">build the egg using the 'pbu' utility:</p>
<pre>
 $ cd ./fruit/docs
 $ pbu dbist_egg
</pre>

</li></ol>
    </blockquote>
</li>
<li><p class="firstli">So that's exactly what the docs do. So, to see all this in action, build
 the docs :</p>
<pre>
 $ vim readme.rest -s runvim.vim

 BTW - runvim.vim is just a quickie script to execute :Vsti within vim,
 write, save, and exit vim.
</pre>

</li>
<li><p class="firstli">Back to the build system, let's do a build :</p>
    <blockquote>

    <p>

<pre>
running bdist_egg
running egg_info
writing ./SimpleExampleEgg.egg-info/PKG-INFO
writing top-level names to ./SimpleExampleEgg.egg-info/top_level.txt
writing entry points to ./SimpleExampleEgg.egg-info/entry_points.txt
installing library code to build/bdist.linux-i686/egg
running install_lib
warning: install_lib: 'build/lib' does not exist -- no Python modules to install
creating build/bdist.linux-i686/egg
creating build/bdist.linux-i686/egg/EGG-INFO
copying ./SimpleExampleEgg.egg-info/PKG-INFO -> build/bdist.linux-i686/egg/EGG-INFO
copying ./SimpleExampleEgg.egg-info/top_level.txt -> build/bdist.linux-i686/egg/EGG-INFO
copying ./SimpleExampleEgg.egg-info/entry_points.txt -> build/bdist.linux-i686/egg/EGG-INFO
creating 'dist/SimpleExampleEgg-0.1-py2.4.egg' and adding 'build/bdist.linux-i686/egg' to it
removing 'build/bdist.linux-i686/egg' (and everything under it)
</pre>
    </p>

    </blockquote>
</li>
<li><p class="firstli">And lastly, let's check to make sure that we have what we expect in the
   output:</p>
    <blockquote>

    <p>
    ``unzip -l /home/tgreenwo/active/SimpleExampleEgg/dist/SimpleExampleEgg-0.1-py2.4.egg'``
    </p>

    <p>

<pre>
Archive:  /home/tgreenwo/active/SimpleExampleEgg/dist/SimpleExampleEgg-0.1-py2.4.egg
  Length     Date   Time    Name
 --------    ----   ----    ----
      290  12-14-05 12:11   fruit/orange.py
      286  12-14-05 12:11   fruit/apple.py
        0  12-14-05 12:13   fruit/__init__.py
      240  12-14-05 12:26   fruit/simpletests.py
      556  12-14-05 14:16   fruit/orange.pyc
      625  12-14-05 14:16   fruit/apple.pyc
      124  12-14-05 14:16   fruit/__init__.pyc
      537  12-14-05 14:16   fruit/simpletests.pyc
    14863  12-14-05 12:36   fruit/docs/traditional.css
     6051  12-14-05 13:30   fruit/docs/readme.rest
    12978  12-14-05 13:07   fruit/docs/readme.html
     6464  12-14-05 12:43   fruit/docs/default.css
    14140  12-14-05 12:36   fruit/docs/oldstyle.css
      141  12-14-05 12:36   fruit/docs/vstrc.vim
      532  12-14-05 14:16   EGG-INFO/PKG-INFO
        6  12-14-05 14:16   EGG-INFO/top_level.txt
        0  12-14-05 14:16   EGG-INFO/zip-safe
 --------                   -------
    57833                   17 files
</pre>
    </p>

    </blockquote>
</li></ol>
<h2 id="lbacktracking">Backtracking</h2>

<p>
Some things I should mention....
</p>

 <ul class="circle">
 <li><p class="firstli"> apply the svn 'trick' to get the ez_setup file</p></li>
 <li><p class="firstli"> get a freebie ftp account to test uploading to</p></li>
 <li><p class="firstli"> create a pipy account so that you can upload there, too</p>
</li>
</ul>
<h3 id="lthe-ez-setup46py-file">The ez_setup.py file</h3>
<ol class="decimal">
<li><p class="firstli">Per the <a href="http://peak.telecommunity.com/DevCenter/setuptools" title="Peak">Peak</a> website, install ez_setup.py as an svn external thingy. Here are the steps:</p>
<pre>
 $ cd SimpleExampleEgg/
 $ svn propedit svn:externals .
 # enter this in the editor: 
 ez_setup svn://svn.eby-sarna.com/svnroot/ez_setup
 # slurp down the latest ez_setup file  
 $ svn update
 # you should see the ez_setup dir now..., if you don't, try
 $ svn propget svn:externals
 ez_setup svn://svn.eby-sarna.com/svnroot/ez_setup
</pre>

</li></ol>

<p>
1. TODO: figure out how to link from project to project in svn, so i only have
one project that has to source to the web.
</p>

<h3 id="lcreate-a-pipy-account58">Create a PiPy account:</h3>
<ol class="decimal">
<li><p class="firstli">this part is easy:</p>
<pre>
 $ python setup.py register
</pre>

</li>
<li><p class="firstli">now just follow the instructions..:</p>
<pre>
 running register
 We need to know who you are, so please choose either:
 1. use your existing login,
 2. register as a new user,
 3. have the server generate a new password for you (and email it to you),
   or
 4. quit
 Your selection [default 1]:
</pre>

</li></ol>
<h2 id="lapp-deployment">App Deployment</h2>
<dl>

<dt class="normal">Now, we want to do your basic 'app' stuff: </dt>
    <dd class="normal">
    <p>* script generation
    * build
    * deploy
    * test
    </p>

</dd>
</dl>
<h3 id="lscript-generation">Script Generation</h3>

<p>
The idea here is that if I have some cool command line app, then how do I
access it when it's all tucked inside an egg? The generated wrapper scripts do
just that.
</p>

<ol class="decimal">
<li><p class="firstli">add entry points to setup.py:</p>
<pre>
 setup(
 ...
 entry_points = {'console_scripts': [
     'make_apple_pie = fruit.apple.make_pie'
     ]},
</pre>

</li></ol>
<h3 id="lbuilding">Building</h3>

<p>
We did this already, but, we'll do it again here.
</p>

<ol class="decimal">
<li><p class="firstli">Build the app into an egg:</p>
    <blockquote>

    <p>
    <code>$ python setup bdist_egg</code>
    </p>

    <p>

<pre>
running bdist_egg
running egg_info
writing ./SimpleExampleEgg.egg-info/PKG-INFO
writing top-level names to ./SimpleExampleEgg.egg-info/top_level.txt
writing entry points to ./SimpleExampleEgg.egg-info/entry_points.txt
installing library code to build/bdist.linux-i686/egg
running install_lib
warning: install_lib: 'build/lib' does not exist -- no Python modules to install
creating build/bdist.linux-i686/egg
creating build/bdist.linux-i686/egg/EGG-INFO
copying ./SimpleExampleEgg.egg-info/PKG-INFO -> build/bdist.linux-i686/egg/EGG-INFO
copying ./SimpleExampleEgg.egg-info/top_level.txt -> build/bdist.linux-i686/egg/EGG-INFO
copying ./SimpleExampleEgg.egg-info/entry_points.txt -> build/bdist.linux-i686/egg/EGG-INFO
creating 'dist/SimpleExampleEgg-0.1-py2.4.egg' and adding 'build/bdist.linux-i686/egg' to it
removing 'build/bdist.linux-i686/egg' (and everything under it)
</pre>
    </p>

    </blockquote>
</li>
<li><p class="firstli">And lastly, let's check to make sure that we have what we expect in the
   output:</p>
    <blockquote>

    <p>
    ``unzip -l /home/tgreenwo/active/SimpleExampleEgg/fruit/docs/dist/SimpleExampleEgg-0.1-py2.4.egg'``
    </p>

    <p>

<pre>
Archive:  /home/tgreenwo/active/SimpleExampleEgg/fruit/docs/dist/SimpleExampleEgg-0.1-py2.4.egg
  Length     Date   Time    Name
 --------    ----   ----    ----
      532  12-14-05 14:54   EGG-INFO/PKG-INFO
        1  12-14-05 14:54   EGG-INFO/top_level.txt
       57  12-14-05 14:54   EGG-INFO/entry_points.txt
        0  12-14-05 14:54   EGG-INFO/zip-safe
 --------                   -------
      590                   4 files
</pre>
    </p>

    </blockquote>
</li></ol>
<h3 id="ldeploy-locally-40dev-mode41">Deploy Locally (Dev Mode)</h3>
<ol class="decimal">
<li><p class="firstli">create a deployment directory to house the egg links:</p>
<pre>
 $ cd working
 $ mkdir deploy
</pre>

</li>
<li><p class="firstli">add the 'deploy' directory to your pythonpath:</p>
    <blockquote>

    <p>

<pre>
		export PYTHONPATH=/home/tgreenwo/working/twisted:/home/tgreenwo/working/django:/home/tgreenwo/working/deploy
</pre>
    </p>

    </blockquote>
</li>
<li><p class="firstli">install the egg locally in dev mode:</p>
    <blockquote>

    <p>
    <code>$ python setup.py develop</code>
    </p>

    <p>

<pre>
running develop
running egg_info
writing ./SimpleExampleEgg.egg-info/PKG-INFO
writing top-level names to ./SimpleExampleEgg.egg-info/top_level.txt
writing entry points to ./SimpleExampleEgg.egg-info/entry_points.txt
running build_ext
Creating /usr/lib/python2.4/site-packages/SimpleExampleEgg.egg-link (link to .)
error: /usr/lib/python2.4/site-packages/SimpleExampleEgg.egg-link: Permission denied
</pre>
    </p>

    </blockquote>
</li>
<li><p class="firstli">this time, we specify the deploy directory:</p>
    <blockquote>

    <p>
    <code>$ python setup.py develop -d /home/tgreenwo/working/deploy</code>
    </p>

    <p>

<pre>
running develop
running egg_info
writing ./SimpleExampleEgg.egg-info/PKG-INFO
writing top-level names to ./SimpleExampleEgg.egg-info/top_level.txt
writing entry points to ./SimpleExampleEgg.egg-info/entry_points.txt
running build_ext
Creating /home/tgreenwo/data/working/deploy/SimpleExampleEgg.egg-link (link to .)
Installing make_apple_pie script to /home/tgreenwo/working/deploy

Installed /home/tgreenwo/active/SimpleExampleEgg/fruit/docs

Because this distribution was installed --multi-version or --install-dir,
before you can import modules from this package in an application, you
will need to 'import pkg_resources' and then use a 'require()' call
similar to one of these examples, in order to select the desired version:

    pkg_resources.require("SimpleExampleEgg")  # latest installed version
    pkg_resources.require("SimpleExampleEgg==0.1")  # this exact version
    pkg_resources.require("SimpleExampleEgg>=0.1")  # this version or higher

Processing dependencies for SimpleExampleEgg==0.1
</pre>
    </p>

    </blockquote>
</li></ol>
<h3 id="ldeploy-to-my-ftp-web-site">Deploy to my ftp web site</h3>
<ol class="decimal">
<li><p class="firstli">display passwords <strong><em>*******NOT TO BE PUBLISHED*********</em></strong></p>
    <blockquote>

    <p>
    <code>url</code>
    {readbang:cat /home/tgreenwo/active/SimpleExampleEgg/fruit/docs/passwords
    | grep -v # | awk '{print $1}'}
    </p>

    <p>
    <code>username</code>
    {readbang:cat /home/tgreenwo/active/SimpleExampleEgg/fruit/docs/passwords
    | grep -v # | awk '{print $2}'}
    </p>

    <p>
    <code>password</code>
    {readbang:cat /home/tgreenwo/active/SimpleExampleEgg/fruit/docs/passwords
    | grep -v # | awk '{print $3}'}
    </p>

    </blockquote>
</li></ol>
<h3 id="ldeploy-to-pipy">Deploy To pipy</h3>
<ol class="decimal">
<li><p class="firstli"></p>
</li></ol>
<h2 id="linstall-the-app-">Install the app </h2>
<h3 id="ldownload">Download</h3>
<h3 id="linstall">Install</h3>
<h3 id="lrun-unit-tests">Run Unit Tests</h3>
<!-- .. links:
 -->

</body>
</html>

