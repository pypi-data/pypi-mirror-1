<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="collective.geoxml">

  <metal:javascriptslot fill-slot="javascript_head_slot">

    <script src="http://maps.google.com/maps?file=api&v=2&key=xxx"
        tal:define="config context/@@maps_configuration;
                    apikey config/googlemaps_key"
        tal:attributes="src string:http://maps.google.com/maps?file=api&v=2&key=${apikey}"
        type="text/javascript"></script>

    <script src="egeoxml.js" type="text/javascript"
        tal:attributes="src string:${context/@@absolute_url}/++resource++egeoxml.js;"></script>

  </metal:javascriptslot>

<body>

<div metal:fill-slot="main"
     tal:define="context_url string:${context/absolute_url};">
    <tal:main-macro metal:define-macro="main">

        <div tal:replace="structure provider:plone.abovecontenttitle" />

        <h1 class="documentFirstHeading">
            <metal:field use-macro="python:here.widget('title', mode='view')">
            Title
            </metal:field>
        </h1>

        <div tal:replace="structure provider:plone.belowcontenttitle" />

        <p class="documentDescription">
            <metal:field use-macro="python:here.widget('description', mode='view')">
            Description
            </metal:field>
        </p>

        <div id="map" style="width: 600px; height: 500px"></div>

        <div tal:replace="structure provider:plone.abovecontentbody" />

        <div class="visualClear">&nbsp;</div>

        <div id="download">
            <a href=""
              tal:attributes="href string:${here/absolute_url}/download"
              i18n:translate="label_download">Download kml file</a>
        </div>

        <div tal:replace="structure provider:plone.belowcontentbody" />

  <form>
      <input id="zoom" type="hidden" value=""
        tal:attributes="value here/getZoom"/>
      <input id="map_type" type="hidden" value=""
        tal:attributes="value here/getMapType"/>
      <input id="map_url" type="hidden" value=""
        tal:attributes="value string:${here/absolute_url}/data.kml"/>
<!--       <input type="button" value="center" onclick="centerMap()"/> -->
      <input type="button" value="Save zoom level" onclick="saveZoom()"
        tal:condition="python:member and member.has_permission('Modify portal content', here)"/>
  </form>

<script type="text/javascript">
    //<![CDATA[

    var map;
    var exml = null;
    var zoom;
    var map_type;
    var map_url;


    function load() {
        zoom = parseInt(document.getElementById('zoom').value);

        map_type = document.getElementById('map_type').value;
        if (map_type=='satellite') {
            map_type=G_SATELLITE_MAP;
        } else if (map_type=='hybrid') {
            map_type=G_HYBRID_MAP;
        } else {
            map_type=G_NORMAL_MAP;
        }

        map_url = document.getElementById('map_url').value;

        if (GBrowserIsCompatible()) {
            map = new GMap2(document.getElementById("map"));
            map.setCenter(new GLatLng(0.0, 0.0), 11);
            map.addControl(new GLargeMapControl());
            map.addControl(new GMapTypeControl());

            exml = new EGeoXml("exml", map, map_url, {nozoom:true});
            exml.parse();
            GEvent.addListener(exml, "parsed", centerMap);
        }
    }

    function centerMap() {
        if (exml) {
            if (zoom==0) {
                map.setCenter(exml.bounds.getCenter());
            } else {
                map.setCenter(exml.bounds.getCenter(), zoom);
            }
            map.setMapType(map_type);
        }
    }

    function saveZoom() {
        if (exml) {
            zoom_level = map.getZoom();
            pathname = document.location.pathname;
            protocol = document.location.protocol;
            host = document.location.host;
            url = protocol+'//'+host+pathname+'/setZoom?value='+zoom_level;
            GDownloadUrl(url, notifySave);
        }
    }

    function notifySave() {
       alert('Zoom level saved.');
    }

    load();
    //]]>
</script>

    </tal:main-macro>
    <!-- Mark this view as being a main view template /-->
    <tal:block tal:define="global isViewTemplate python:True"/>
  </div>

</body>

</html>
