#!/usr/bin/env python
#
# Run all ScanBooker tests.
#
import os
import sys
import re
import unittest
from optparse import OptionParser

if __name__ == "__main__":
    usage  = 'usage: %prog [options] [module_name]'
    usage += '\n\tmodule_name specifies the module to test. '
    usage += 'If none supplied then run all tests.'
    parser = OptionParser(usage)
    parser.add_option('-v', '--verbose',
        action='store_true', dest='verbose', default=False,
        help='Be verbose in printing status messages')
    parser.add_option('-l', '--level',
        action='store', type='int', dest='level', default=1,
        help='Verbosity level of test runner')
    parser.add_option('-p', '--profile',
        action='store_true', dest='profile', default=False,
        help='Profile the performance of a test suite')
    
    (options, args) = parser.parse_args()
    # by default always 1 argument (name of file itself)
    suiteToRun = None
    moduleName = ''
    if len(args) == 0:
        moduleName = 'scanbooker.test'
    elif len(args) == 1:
        moduleName = args[0]
    else:
        print 'ERROR: you have supplied too many arguments\n'
        parser.print_help()
        sys.exit(1)

    # import after SETTINGS is set
    import scanbooker.soleInstance

    testModuleName = moduleName
    testModule = __import__(testModuleName,'','','*')
    testSuite = testModule.suite()
        
    testRunner = unittest.TextTestRunner(verbosity=options.level)
    if options.profile:
        import profile
        code = "result = testRunner.run(testSuite)"
        profile.run(code)
    else:
        result = testRunner.run(testSuite)
    if not result.wasSuccessful():
        sys.exit(1)

