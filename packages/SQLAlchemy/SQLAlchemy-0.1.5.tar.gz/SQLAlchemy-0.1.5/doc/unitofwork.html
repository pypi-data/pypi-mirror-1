<html>
<head>
	<title>
    Unit of Work - SQLAlchemy Documentation
</title>
</head>
<body>



<link href="style.css" rel="stylesheet" type="text/css"></link>
<link href="syntaxhighlight.css" rel="stylesheet" type="text/css"></link>

<link href="docs.css" rel="stylesheet" type="text/css"></link>
<script src="scripts.js"></script>


<div style="position:absolute;left:0px;top:0px;"><a name="top"></a>&nbsp;</div>

<div class="doccontainer">

<div class="docheader">

<div class="docheadertext" >Unit of Work</div>
<div class="">Version: 0.1.5   Last Updated: 03/26/06 22:14:16</div>
</div>



		<A name="unitofwork"></a>
		
	
<div class="topnav">


	
	<div class="topnavcontrol">
	View: <b>Paged</b> &nbsp;|&nbsp; <a href="documentation.html">One Page</a>
	</div>



<div class="topnavsectionlink">

<a href="index.html">Table of Contents</a>

<div class="prevnext">
Previous: <a href="datamapping.html">Basic Data Mapping</a>

&nbsp; | &nbsp;


Next: <a href="adv_datamapping.html">Advanced Data Mapping</a>

</div>
</div>


<div class="topnavmain">
	<div class="topnavheader">Unit of Work</div>
	<div class="topnavitems">
	


    
    
    <div class="toclink">
        <A style="" href="#unitofwork_overview">Overview</a>
    </div>
    
    <div class="toclinkcontainer">
    </div>


    
    
    <div class="toclink">
        <A style="" href="#unitofwork_session">The Session Interface</a>
    </div>
    
    <div class="toclinkcontainer">
        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_session_identitymap">Identity Map</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_session_changed">Whats Changed ?</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_session_commit">Commit</a>
    </div>

        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_session_commit_whatis">What Commit is, and Isn't</a>
    </div>

    </div>


    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_session_delete">Delete</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_session_clear">Clear</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_session_refreshexpire">Refresh / Expire</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_session_expunge">Expunge</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_session_import">Import Instance</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_session_begin">Begin</a>
    </div>

    </div>


    </div>


    
    
    <div class="toclink">
        <A style="" href="#unitofwork_advscope">Advanced UnitOfWork Management</a>
    </div>
    
    <div class="toclinkcontainer">
        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_advscope_transactionnesting">Nesting UnitOfWork in a Database Transaction</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_advscope_object">Per-Object Sessions</a>
    </div>

        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_advscope_object_nested">Nested Transaction Sessions</a>
    </div>

    </div>


    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_advscope_scope">Custom Session Objects/Custom Scopes</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#unitofwork_advscope_logging">Analyzing Object Commits</a>
    </div>

    </div>


    </div>



	</div>
</div>

</div>

		<div class="sectioncontent">
			




<div class="subsection" style="margin-left:10px;">

    <div class="sectiontext">


    
			
    
			

    
			

    </div>

        



<A name="unitofwork_overview"></a>

<div class="subsection" style="margin-left:20px;">

    <span class="sectionheadertext">Overview</span>
    <div class="sectiontext">


    <p>The concept behind Unit of Work is to track modifications to a field of objects, and then be able to commit those changes to the database in a single operation.  Theres a lot of advantages to this, including that your application doesn't need to worry about individual save operations on objects, nor about the required order for those operations, nor about excessive repeated calls to save operations that would be more efficiently aggregated into one step.  It also simplifies database transactions, providing a neat package with which to insert into the traditional database begin/commit phase.
    </p>
    <p>SQLAlchemy's unit of work includes these functions:
    <ul>
        <li>The ability to monitor scalar and list attributes on object instances, as well as object creates.  This is handled via the attributes package.</li>
        <li>The ability to maintain and process a list of modified objects, and based on the relationships set up by the mappers for those objects as well as the foreign key relationships of the underlying tables, figure out the proper order of operations so that referential integrity is maintained, and also so that on-the-fly values such as newly created primary keys can be propigated to dependent objects that need them before they are saved.  The central algorithm for this is the <b>topological sort</b>.</li>
        <li>The ability to define custom functionality that occurs within the unit-of-work commit phase, such as "before insert", "after insert", etc.  This is accomplished via MapperExtension.</li>
        <li>an Identity Map, which is a dictionary storing the one and only instance of an object for a particular table/primary key combination.  This allows many parts of an application to get a handle to a particular object without any chance of modifications going to two different places.</li>
        <li>Thread-local operation.  the Identity map as well as its enclosing Unit of Work are normally instantiated and accessed in a manner that is local to the current thread, within an object called a Session.  Another concurrently executing thread will therefore have its own Session, so unless an application explicitly shares objects between threads, the operation of the object relational mapping is automatically threadsafe.  Session objects can also be constructed manually to allow any user-defined scoping.</li>
    </ul></p>
    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>


        



<A name="unitofwork_session"></a>

<div class="subsection" style="margin-left:20px;">

    <span class="sectionheadertext">The Session Interface</span>
    <div class="sectiontext">


    <p>The current unit of work is accessed via a Session object.  The Session is available in a thread-local context from the objectstore module as follows:</p>
        

<div class="code">
<pre><span class="python_comment"># get the current thread's session
</span><span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">get_session</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre></div>

    <p>The Session object acts as a proxy to an underlying UnitOfWork object.  Common methods include commit(), begin(), clear(), and delete().  Most of these methods are available at the module level in the objectstore module, which operate upon the Session returned by the get_session() function:
    </p>
    

<div class="code">
<pre><span class="python_comment"># this...
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">get_session</span><span class="python_enclosure">()</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># is the same as this:
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre></div>


    <p>A description of the most important methods and concepts follows.</p>

    
			
    
    
			
        
    
			

    
			

    
			

    
			
    
    
			

    
			

    
			
    
    
    </div>

        



<A name="unitofwork_session_identitymap"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Identity Map</span>
    <div class="sectiontext">


    <p>The first concept to understand about the Unit of Work is that it is keeping track of all mapped objects which have been loaded from the database, as well as all mapped objects which have been saved to the database in the current session.  This means that everytime you issue a <code>select</code> call to a mapper which returns results, all of those objects are now installed within the current Session, mapped to their identity.</p>
    
    <p>In particular, it is insuring that only <b>one</b> instance of a particular object, corresponding to a particular database identity, exists within the Session at one time.  By "database identity" we mean a table or relational concept in the database combined with a particular primary key in that table. The session accomplishes this task using a dictionary known as an <b>Identity Map</b>.  When <code>select</code> or <code>get</code> calls on mappers issue queries to the database, they will in nearly all cases go out to the database on each call to fetch results.  However, when the mapper <b>instantiates</b> objects corresponding to the result set rows it receives, it will <b>check the current identity map first</b> before instantating a new object, and return <b>the same instance</b> already present in the identiy map if it already exists.</p>  
    
    <p>Example:</p>
    

<div class="code">
<pre><span class="python_name">mymapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">MyClass</span><span class="python_operator">, </span><span class="python_name">mytable</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">obj1 </span><span class="python_operator">= </span><span class="python_name">mymapper</span><span class="python_operator">.</span><span class="python_name">selectfirst</span><span class="python_enclosure">(</span><span class="python_name">mytable</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_operator">==</span><span class="python_number">15</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">obj2 </span><span class="python_operator">= </span><span class="python_name">mymapper</span><span class="python_operator">.</span><span class="python_name">selectfirst</span><span class="python_enclosure">(</span><span class="python_name">mytable</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">id</span><span class="python_operator">==</span><span class="python_number">15</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_operator">>>> </span><span class="python_name">obj1 </span><span class="python_keyword">is </span><span class="python_name">obj2</span><span class="python_operator">
</span><span class="python_name">True</span><span class="python_operator"></span></pre></div>

    <p>The Identity Map is an instance of <code>weakref.WeakValueDictionary</code>, so that when an in-memory object falls out of scope, it will be removed automatically.  However, this may not be instant if there are circular references upon the object.  The current SA attributes implementation places some circular refs upon objects, although this may change in the future.  There are other ways to remove object instances from the current session, as well as to clear the current session entirely, which are described later in this section.</p>
    <p>To view the Session's identity map, it is accessible via the <code>identity_map</code> accessor, and is an instance of <code>weakref.WeakValueDictionary</code>:</p>
    

<div class="code">
<pre><span class="python_operator">>>> </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">get_session</span><span class="python_enclosure">()</span><span class="python_operator">.</span><span class="python_name">identity_map</span><span class="python_operator">.</span><span class="python_name">values</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_enclosure">[</span><span class="python_operator"><</span><span class="python_name">__main__</span><span class="python_operator">.</span><span class="python_name">User object at </span><span class="python_number">0x712630</span><span class="python_operator">>, <</span><span class="python_name">__main__</span><span class="python_operator">.</span><span class="python_name">Address object at </span><span class="python_number">0x712a70</span><span class="python_operator">></span><span class="python_enclosure">]</span><span class="python_operator"></span></pre></div>


    <p>The identity of each object instance is available via the _instance_key property attached to each object instance, and is a tuple consisting of the object's class and an additional tuple of primary key values, in the order that they appear within the table definition:</p>
    

<div class="code">
<pre><span class="python_operator">>>> </span><span class="python_name">obj</span><span class="python_operator">.</span><span class="python_name">_instance_key </span><span class="python_operator">
</span><span class="python_enclosure">(</span><span class="python_operator"><</span><span class="python_keyword">class </span><span class="python_literal">'test.tables.User'</span><span class="python_operator">>, </span><span class="python_enclosure">(</span><span class="python_number">7</span><span class="python_operator">,</span><span class="python_enclosure">))</span><span class="python_operator"></span></pre></div>


    <p>
    At the moment that an object is assigned this key, it is also added to the current thread's unit-of-work's identity map.  
    </p>
    
    <p>The get() method on a mapper, which retrieves an object based on primary key identity, also checks in the current identity map first to save a database round-trip if possible.  In the case of an object lazy-loading a single child object, the get() method is used as well, so scalar-based lazy loads may in some cases not query the database; this is particularly important for backreference relationships as it can save a lot of queries.</p>
    
    <p>Methods on mappers and the objectstore module, which are relevant to identity include the following:</p>
    

<div class="code">
<pre><span class="python_comment"># assume 'm' is a mapper
</span><span class="python_name">m </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># get the identity key corresponding to a primary key
</span><span class="python_name">key </span><span class="python_operator">= </span><span class="python_name">m</span><span class="python_operator">.</span><span class="python_name">identity_key</span><span class="python_enclosure">(</span><span class="python_number">7</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># for composite key, list out the values in the order they
# appear in the table
</span><span class="python_name">key </span><span class="python_operator">= </span><span class="python_name">m</span><span class="python_operator">.</span><span class="python_name">identity_key</span><span class="python_enclosure">(</span><span class="python_number">12</span><span class="python_operator">, </span><span class="python_literal">'rev2'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># get the identity key given a primary key 
# value as a tuple and a class
</span><span class="python_name">key </span><span class="python_operator">= </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">get_id_key</span><span class="python_enclosure">((</span><span class="python_number">12</span><span class="python_operator">, </span><span class="python_literal">'rev2'</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># get the identity key for an object, whether or not it actually
# has one attached to it (m is the mapper for obj's class)
</span><span class="python_name">key </span><span class="python_operator">= </span><span class="python_name">m</span><span class="python_operator">.</span><span class="python_name">instance_key</span><span class="python_enclosure">(</span><span class="python_name">obj</span><span class="python_enclosure">)</span><span class="python_operator">
        </span>
<span class="python_comment"># is this key in the current identity map?
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">has_key</span><span class="python_enclosure">(</span><span class="python_name">key</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># is this object in the current identity map?
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">has_instance</span><span class="python_enclosure">(</span><span class="python_name">obj</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># get this object from the current identity map based on 
# singular/composite primary key, or if not go 
# and load from the database
</span><span class="python_name">obj </span><span class="python_operator">= </span><span class="python_name">m</span><span class="python_operator">.</span><span class="python_name">get</span><span class="python_enclosure">(</span><span class="python_number">12</span><span class="python_operator">, </span><span class="python_literal">'rev2'</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

    
    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>


        



<A name="unitofwork_session_changed"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Whats Changed ?</span>
    <div class="sectiontext">


    <p>The next concept is that in addition to the Session storing a record of all objects loaded or saved, it also stores records of all <b>newly created</b> objects,  records of all objects whose attributes have been <b>modified</b>, records of all objects that have been marked as <b>deleted</b>, and records of all <b>modified list-based attributes</b> where additions or deletions have occurred.  These lists are used when a <code>commit()</code> call is issued to save all changes.  After the commit occurs, these lists are all cleared out.</p>
    
    <p>These records are all tracked by a collection of <code>Set</code> objects (which are a SQLAlchemy-specific  instance called a <code>HashSet</code>) that are also viewable off the Session:</p>
    

<div class="code">
<pre><span class="python_comment"># new objects that were just constructed
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">new</span><span class="python_operator">
</span>
<span class="python_comment"># objects that exist in the database, that were modified
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">dirty</span><span class="python_operator">
</span>
<span class="python_comment"># objects that have been marked as deleted via session.delete(obj)
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">deleted</span><span class="python_operator">
</span>
<span class="python_comment"># list-based attributes thave been appended
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">modified_lists</span><span class="python_operator"></span></pre></div>

    <p>Heres an interactive example, assuming the <code>User</code> and <code>Address</code> mapper setup first outlined in <a href="datamapping.html#datamapping_relations" >Defining and Using Relationships</a>:</p>
    

<div class="code">
<pre><span class="python_literal">>>> </span><span class="python_comment"># get the current thread's session</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">get_session</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># create a new object, with a list-based attribute </span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_comment"># containing two more new objects</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">user_name</span><span class="python_operator">=</span><span class="python_literal">'Fred'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_name">city</span><span class="python_operator">=</span><span class="python_literal">'New York'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_name">city</span><span class="python_operator">=</span><span class="python_literal">'Boston'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># objects are in the "new" list</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">new</span><span class="python_operator">
</span><span class="python_enclosure">[</span><span class="python_operator"><</span><span class="python_name">__main__</span><span class="python_operator">.</span><span class="python_name">User object at </span><span class="python_number">0x713630</span><span class="python_operator">>, </span>
<span class="python_operator"><</span><span class="python_name">__main__</span><span class="python_operator">.</span><span class="python_name">Address object at </span><span class="python_number">0x713a70</span><span class="python_operator">>, </span>
<span class="python_operator"><</span><span class="python_name">__main__</span><span class="python_operator">.</span><span class="python_name">Address object at </span><span class="python_number">0x713b30</span><span class="python_operator">></span><span class="python_enclosure">]</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># view the "modified lists" member, </span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_comment"># reveals our two Address objects as well, inside of a list</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">modified_lists</span><span class="python_operator">
</span><span class="python_enclosure">[[</span><span class="python_operator"><</span><span class="python_name">__main__</span><span class="python_operator">.</span><span class="python_name">Address object at </span><span class="python_number">0x713a70</span><span class="python_operator">>, <</span><span class="python_name">__main__</span><span class="python_operator">.</span><span class="python_name">Address object at </span><span class="python_number">0x713b30</span><span class="python_operator">></span><span class="python_enclosure">]]</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># lets view what the class/ID is for the list object</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_enclosure">[</span><span class="python_literal">"%s %s" </span><span class="python_operator">% </span><span class="python_enclosure">(</span><span class="python_name">l</span><span class="python_operator">.</span><span class="python_name">__class__</span><span class="python_operator">, </span><span class="python_name">id</span><span class="python_enclosure">(</span><span class="python_name">l</span><span class="python_enclosure">)) </span><span class="python_keyword">for </span><span class="python_name">l </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">modified_lists</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_enclosure">[</span><span class="python_literal">'sqlalchemy.mapping.unitofwork.UOWListElement 7391872'</span><span class="python_enclosure">]</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># now commit</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># the "new" list is now empty</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">new</span><span class="python_operator">
</span><span class="python_enclosure">[]</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># the "modified lists" list is now empty</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">modified_lists</span><span class="python_operator">
</span><span class="python_enclosure">[]</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># now lets modify an object</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator">=</span><span class="python_literal">'Ed'</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># it gets placed in the "dirty" list</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">dirty</span><span class="python_operator">
</span><span class="python_enclosure">[</span><span class="python_operator"><</span><span class="python_name">__main__</span><span class="python_operator">.</span><span class="python_name">User object at </span><span class="python_number">0x713630</span><span class="python_operator">></span><span class="python_enclosure">]</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># delete one of the addresses </span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">delete</span><span class="python_enclosure">(</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">[</span><span class="python_number">0</span><span class="python_enclosure">])</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># and also delete it off the User object, note that</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_comment"># this is *not automatic* when using session.delete()</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_keyword">del </span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">deleted</span><span class="python_operator">
</span><span class="python_enclosure">[</span><span class="python_operator"><</span><span class="python_name">__main__</span><span class="python_operator">.</span><span class="python_name">Address object at </span><span class="python_number">0x713a70</span><span class="python_operator">></span><span class="python_enclosure">]    </span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># commit</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># all lists are cleared out</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">new</span><span class="python_operator">, </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">dirty</span><span class="python_operator">, </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">modified_lists</span><span class="python_operator">, </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">deleted</span><span class="python_operator">
</span><span class="python_enclosure">([]</span><span class="python_operator">, </span><span class="python_enclosure">[]</span><span class="python_operator">, </span><span class="python_enclosure">[]</span><span class="python_operator">, </span><span class="python_enclosure">[])</span><span class="python_operator">
</span>
<span class="python_literal">>>> </span><span class="python_comment"># identity map has the User and the one remaining Address</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">identity_map</span><span class="python_operator">.</span><span class="python_name">values</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_enclosure">[</span><span class="python_operator"><</span><span class="python_name">__main__</span><span class="python_operator">.</span><span class="python_name">Address object at </span><span class="python_number">0x713b30</span><span class="python_operator">>, <</span><span class="python_name">__main__</span><span class="python_operator">.</span><span class="python_name">User object at </span><span class="python_number">0x713630</span><span class="python_operator">></span><span class="python_enclosure">]</span><span class="python_operator"></span></pre></div>

    <p>Unlike the identity map, the <code>new</code>, <code>dirty</code>, <code>modified_lists</code>, and <code>deleted</code> lists are <b>not weak referencing.</b>  This means if you abandon all references to new or modified objects within a session, <b>they are still present</b> and will be saved on the next commit operation, unless they are removed from the Session explicitly (more on that later).  The <code>new</code> list may change in a future release to be weak-referencing, however for the <code>deleted</code> list, one can see that its quite natural for a an object marked as deleted to have no references in the application, yet a DELETE operation is still required.</p>
    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>


        



<A name="unitofwork_session_commit"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Commit</span>
    <div class="sectiontext">


    <p>This is the main gateway to what the Unit of Work does best, which is save everything !  It should be clear by now that a commit looks like:
    </p>
    

<div class="code">
<pre><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">get_session</span><span class="python_enclosure">()</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre></div>

    <p>It also can be called with a list of objects; in this form, the commit operation will be limited only to the objects specified in the list, as well as any child objects within <code>private</code> relationships for a delete operation:</p>
    

<div class="code">
<pre><span class="python_comment"># saves only user1 and address2.  all other modified
# objects remain present in the session.
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">get_session</span><span class="python_enclosure">()</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">(</span><span class="python_name">user1</span><span class="python_operator">, </span><span class="python_name">address2</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

    <p>This second form of commit should be used more carefully as it will not necessarily locate other dependent objects within the session, whose database representation may have foreign constraint relationships with the objects being operated upon.</p>
    
        
			
    
    </div>

        



<A name="unitofwork_session_commit_whatis"></a>

<div class="subsection" style="margin-left:40px;">

    <span class="sectionheadertext">What Commit is, and Isn't</span>
    <div class="sectiontext">


        <p>The purpose of the Commit operation is to instruct the Unit of Work to analyze its lists of modified objects, assemble them into a dependency graph, fire off the appopriate INSERT, UPDATE, and DELETE statements via the mappers related to those objects, and to synchronize column-based object attributes that correspond directly to updated/inserted database columns.  <b>And thats it.</b>  It does not affect any <code>relation</code>-based object attributes, that is attributes that reference other objects or lists of other objects, in any way.  A brief list of what will <b>not</b> happen includes:</p>
            <ul>
                <li>It will not append or delete any object instances to/from any list-based object attributes.  Any objects that have been created or marked as deleted will be updated as such in the database, but if a newly deleted object instance is still attached to a parent object's list, the object itself will remain in that list.</li>
                <li>It will not set or remove any scalar references to other objects, even if the corresponding database identifier columns have been committed.</li>
            </ul>
            <p>This means, if you set <code>address.user_id</code> to 5, that integer attribute will be saved, but it will not place an <code>Address</code> object in the <code>addresses</code> attribute of the corresponding  <code>User</code> object.  In some cases there may be a lazy-loader still attached to an object attribute which when first accesed performs a fresh load from the database and creates the appearance of this behavior, but this behavior should not be relied upon as it is specific to lazy loading and also may disappear in a future release.  Similarly, if the <code>Address</code> object is marked as deleted and a commit is issued, the correct DELETE statements will be issued, but if the object instance itself is still attached to the <code>User</code>, it will remain.</p>
        <P>So the primary guideline for dealing with commit() is, <b>the developer is responsible for maintaining in-memory objects and their relationships to each other, the unit of work is responsible for maintaining the database representation of the in-memory objects.</b>  The typical pattern is that the manipulation of objects *is* the way that changes get communicated to the unit of work, so that when the commit occurs, the objects are already in their correct in-memory representation and problems dont arise.  The manipulation of identifier attributes like integer key values as well as deletes in particular are a frequent source of confusion.</p>
        
        <p>A terrific feature of SQLAlchemy which is also a supreme source of confusion is the backreference feature, described in <a href="datamapping.html#datamapping_relations_backreferences" >Useful Feature: Backreferences</a>.  This feature allows two types of objects to maintain attributes that reference each other, typically one object maintaining a list of elements of the other side, which contains a scalar reference to the list-holding object.  When you append an element to the list, the element gets a "backreference" back to the object which has the list.  When you attach the list-holding element to the child element, the child element gets attached to the list.  <b>This feature has nothing to do whatsoever with the Unit of Work.*</b>  It is strictly a small convenience feature intended to support the developer's manual manipulation of in-memory objects, and the backreference operation happens at the moment objects are attached or removed to/from each other, independent of any kind of database operation.  It does not change the golden rule, that the developer is reponsible for maintaining in-memory object relationships.</p>
        <p>* there is an internal relationship between two <code>relations</code> that have a backreference, which state that a change operation is only logged once to the unit of work instead of two separate changes since the two changes are "equivalent", so a backreference does affect the information that is sent to the Unit of Work.  But the Unit of Work itself has no knowledge of this arrangement and has no ability to affect it.</p>
        
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>





</div>


        



<A name="unitofwork_session_delete"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Delete</span>
    <div class="sectiontext">


    <P>The delete call places an object or objects into the Unit of Work's list of objects to be marked as deleted:</p>
    

<div class="code">
<pre><span class="python_comment"># mark three objects to be deleted
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">get_session</span><span class="python_enclosure">()</span><span class="python_operator">.</span><span class="python_name">delete</span><span class="python_enclosure">(</span><span class="python_name">obj1</span><span class="python_operator">, </span><span class="python_name">obj2</span><span class="python_operator">, </span><span class="python_name">obj3</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># commit
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">get_session</span><span class="python_enclosure">()</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre></div>

    <p>When objects which contain references to other objects are deleted, the mappers for those related objects will issue UPDATE statements for those objects that should no longer contain references to the deleted object, setting foreign key identifiers to NULL.  Similarly, when a mapper contains relations with the <code>private=True</code> option, DELETE statements will be issued for objects within that relationship in addition to that of the primary deleted object; this is called a <b>cascading delete</b>.</p>
    <p>As stated before, the purpose of delete is strictly to issue DELETE statements to the database.  It does not affect the in-memory structure of objects, other than changing the identifying attributes on objects, such as setting foreign key identifiers on updated rows to None.  It has no effect on the status of references between object instances, nor any effect on the Python garbage-collection status of objects.</p>
    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>


        



<A name="unitofwork_session_clear"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Clear</span>
    <div class="sectiontext">


    <p>To clear out the current thread's UnitOfWork, which has the effect of discarding the Identity Map and the lists of all objects that have been modified, just issue a clear:
    </p>
    

<div class="code">
<pre><span class="python_comment"># via module
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">clear</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># or via Session
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">get_session</span><span class="python_enclosure">()</span><span class="python_operator">.</span><span class="python_name">clear</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre></div>

    <p>This is the easiest way to "start fresh", as in a web application that wants to have a newly loaded graph of objects on each request.  Any object instances created before the clear operation should either be discarded or at least not used with any Mapper or Unit Of Work operations (with the exception of <code>import_instance()</code>), as they no longer have any relationship to the current Unit of Work, and their behavior with regards to the current session is undefined.</p>
    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>


        



<A name="unitofwork_session_refreshexpire"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Refresh / Expire</span>
    <div class="sectiontext">


    <p>To assist with the Unit of Work's "sticky" behavior, individual objects can have all of their attributes immediately re-loaded from the database, or marked as "expired" which will cause a re-load to occur upon the next access of any of the object's mapped attributes.  This includes all relationships, so lazy-loaders will be re-initialized, eager relationships will be repopulated.  Any changes marked on the object are discarded:</p>
    

<div class="code">
<pre><span class="python_comment"># immediately re-load attributes on obj1, obj2
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">refresh</span><span class="python_enclosure">(</span><span class="python_name">obj1</span><span class="python_operator">, </span><span class="python_name">obj2</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># expire objects obj1, obj2, attributes will be reloaded
# on the next access:
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">expire</span><span class="python_enclosure">(</span><span class="python_name">obj1</span><span class="python_operator">, </span><span class="python_name">obj2</span><span class="python_operator">, </span><span class="python_name">obj3</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>


        



<A name="unitofwork_session_expunge"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Expunge</span>
    <div class="sectiontext">


    <P>Expunge simply removes all record of an object from the current Session.  This includes the identity map, and all history-tracking lists:</p>
    

<div class="code">
<pre><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">expunge</span><span class="python_enclosure">(</span><span class="python_name">obj1</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

    <p>Use <code>expunge</code> when youd like to remove an object altogether from memory, such as before calling <code>del</code> on it, which will prevent any "ghost" operations occuring when the session is committed.</p>
    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>


        



<A name="unitofwork_session_import"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Import Instance</span>
    <div class="sectiontext">


        <p>The _instance_key attribute placed on object instances is designed to work with objects that are serialized into strings and brought back again.  As it contains no references to internal structures or database connections, applications that use caches or session storage which require serialization (i.e. pickling) can store SQLAlchemy-loaded objects.  However, as mentioned earlier, an object with a particular database identity is only allowed to exist uniquely within the current unit-of-work scope.  So, upon deserializing such an object, it has to "check in" with the current Session.  This is achieved via the <code>import_instance()</code> method:</p>
        

<div class="code">
<pre><span class="python_comment"># deserialize an object
</span><span class="python_name">myobj </span><span class="python_operator">= </span><span class="python_name">pickle</span><span class="python_operator">.</span><span class="python_name">loads</span><span class="python_enclosure">(</span><span class="python_name">mystring</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># "import" it.  if the objectstore already had this object in the 
# identity map, then you get back the one from the current session.
</span><span class="python_name">myobj </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">import_instance</span><span class="python_enclosure">(</span><span class="python_name">myobj</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

    <p>Note that the import_instance() function will either mark the deserialized object as the official copy in the current identity map, which includes updating its _instance_key with the current application's class instance, or it will discard it and return the corresponding object that was already present.  Thats why its important to receive the return results from the method and use the result as the official object instance.</p>
    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>


        



<A name="unitofwork_session_begin"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Begin</span>
    <div class="sectiontext">


    <p>The "scope" of the unit of work commit can be controlled further by issuing a begin().  A begin operation constructs a new UnitOfWork object and sets it as the currently used UOW.  It maintains a reference to the original UnitOfWork as its "parent", and shares the same identity map of objects that have been loaded from the database within the scope of the parent UnitOfWork.  However, the "new", "dirty", and "deleted" lists are empty.  This has the effect that only changes that take place after the begin() operation get logged to the current UnitOfWork, and therefore those are the only changes that get commit()ted.  When the commit is complete, the "begun" UnitOfWork removes itself and places the parent UnitOfWork as the current one again.</p>
<p>The begin() method returns a transactional object, upon which you can call commit() or rollback().  <b>Only this transactional object controls the transaction</b> - commit() upon the Session will do nothing until commit() or rollback() is called upon the transactional object.</p>
    

<div class="code">
<pre><span class="python_comment"># modify an object
</span><span class="python_name">myobj1</span><span class="python_operator">.</span><span class="python_name">foo </span><span class="python_operator">= </span><span class="python_literal">"something new"</span><span class="python_operator">
</span>
<span class="python_comment"># begin 
</span><span class="python_name">trans </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">begin</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># modify another object
</span><span class="python_name">myobj2</span><span class="python_operator">.</span><span class="python_name">lala </span><span class="python_operator">= </span><span class="python_literal">"something new"</span><span class="python_operator">
</span>
<span class="python_comment"># only 'myobj2' is saved
</span><span class="python_name">trans</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre></div>

    <p>begin/commit supports the same "nesting" behavior as the SQLEngine (note this behavior is not the original "nested" behavior), meaning that many begin() calls can be made, but only the outermost transactional object will actually perform a commit().  Similarly, calls to the commit() method on the Session, which might occur in function calls within the transaction, will not do anything; this allows an external function caller to control the scope of transactions used within the functions.</p>
    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>





</div>


        



<A name="unitofwork_advscope"></a>

<div class="subsection" style="margin-left:20px;">

    <span class="sectionheadertext">Advanced UnitOfWork Management</span>
    <div class="sectiontext">



    
			


    
			

    
			

    
			
    
    
    </div>

        



<A name="unitofwork_advscope_transactionnesting"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Nesting UnitOfWork in a Database Transaction</span>
    <div class="sectiontext">


    <p>The UOW commit operation places its INSERT/UPDATE/DELETE operations within the scope of a database transaction controlled by a SQLEngine:
    

<div class="code">
<pre><span class="python_name">engine</span><span class="python_operator">.</span><span class="python_name">begin</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_keyword">try</span><span class="python_operator">:
    </span><span class="python_comment"># run objectstore update operations
</span><span class="python_keyword">except</span><span class="python_operator">:
    </span><span class="python_name">engine</span><span class="python_operator">.</span><span class="python_name">rollback</span><span class="python_enclosure">()</span><span class="python_operator">
    </span><span class="python_keyword">raise</span><span class="python_operator">
</span><span class="python_name">engine</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre></div>

    <p>If you recall from the <a href="dbengine.html#dbengine_transactions" >Transactions</a> section, the engine's begin()/commit() methods support reentrant behavior.  This means you can nest begin and commits and only have the outermost begin/commit pair actually take effect (rollbacks however, abort the whole operation at any stage).  From this it follows that the UnitOfWork commit operation can be nested within a transaction as well:</p>
    

<div class="code">
<pre><span class="python_name">engine</span><span class="python_operator">.</span><span class="python_name">begin</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_keyword">try</span><span class="python_operator">:
    </span><span class="python_comment"># perform custom SQL operations
</span><span class="python_operator">    </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator">
    </span><span class="python_comment"># perform custom SQL operations
</span><span class="python_operator"></span><span class="python_keyword">except</span><span class="python_operator">:
    </span><span class="python_name">engine</span><span class="python_operator">.</span><span class="python_name">rollback</span><span class="python_enclosure">()</span><span class="python_operator">
    </span><span class="python_keyword">raise</span><span class="python_operator">
</span><span class="python_name">engine</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre></div>

    
    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>


        



<A name="unitofwork_advscope_object"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Per-Object Sessions</span>
    <div class="sectiontext">


    <p>Sessions can be created on an ad-hoc basis and used for individual groups of objects and operations.  This has the effect of bypassing the normal thread-local Session and explicitly using a particular Session:</p>
    

<div class="code">
<pre><span class="python_comment"># make a new Session with a global UnitOfWork
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">Session</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># make objects bound to this Session
</span><span class="python_name">x </span><span class="python_operator">= </span><span class="python_name">MyObj</span><span class="python_enclosure">(</span><span class="python_name">_sa_session</span><span class="python_operator">=</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># perform mapper operations bound to this Session
# (this function coming soon)
</span><span class="python_name">r </span><span class="python_operator">= </span><span class="python_name">MyObj</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">using</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">id</span><span class="python_operator">=</span><span class="python_number">12</span><span class="python_enclosure">)</span><span class="python_operator">
    </span>
<span class="python_comment"># get the session that corresponds to an instance
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">get_session</span><span class="python_enclosure">(</span><span class="python_name">x</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># commit 
</span><span class="python_name">s</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># perform a block of operations with this session set within the current scope
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">push_session</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">try</span><span class="python_operator">:
    </span><span class="python_name">r </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">id</span><span class="python_operator">=</span><span class="python_number">12</span><span class="python_enclosure">)</span><span class="python_operator">
    </span><span class="python_name">x </span><span class="python_operator">= </span><span class="python_name">new MyObj</span><span class="python_enclosure">()</span><span class="python_operator">
    </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_keyword">finally</span><span class="python_operator">:
    </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">pop_session</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre></div>

    
			
    
    </div>

        



<A name="unitofwork_advscope_object_nested"></a>

<div class="subsection" style="margin-left:40px;">

    <span class="sectionheadertext">Nested Transaction Sessions</span>
    <div class="sectiontext">


    <p>Sessions also now support a "nested transaction" feature whereby a second Session can use a different database connection.  This can be used inside of a larger database transaction to issue commits to the database that will be committed independently of the larger transaction's status:</p>
    

<div class="code">
<pre><span class="python_name">engine</span><span class="python_operator">.</span><span class="python_name">begin</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_keyword">try</span><span class="python_operator">:
    </span><span class="python_name">a </span><span class="python_operator">= </span><span class="python_name">MyObj</span><span class="python_enclosure">()</span><span class="python_operator">
    </span><span class="python_name">b </span><span class="python_operator">= </span><span class="python_name">MyObj</span><span class="python_enclosure">()</span><span class="python_operator">
    </span>
    <span class="python_name">sess </span><span class="python_operator">= </span><span class="python_name">Session</span><span class="python_enclosure">(</span><span class="python_name">nest_on</span><span class="python_operator">=</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator">
    </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">push_session</span><span class="python_enclosure">(</span><span class="python_name">sess</span><span class="python_enclosure">)</span><span class="python_operator">
    </span><span class="python_keyword">try</span><span class="python_operator">:
        </span><span class="python_name">c </span><span class="python_operator">= </span><span class="python_name">MyObj</span><span class="python_enclosure">()</span><span class="python_operator">
        </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()    </span><span class="python_comment"># will commit "c" to the database,</span><span class="python_operator">
                                </span><span class="python_comment"># even if the external transaction rolls back
    </span><span class="python_operator"></span><span class="python_keyword">finally</span><span class="python_operator">:
        </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">pop_session</span><span class="python_enclosure">()</span><span class="python_operator">
    </span>
    <span class="python_operator"></span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()  </span><span class="python_comment"># commit "a" and "b" to the database</span><span class="python_operator">
    </span><span class="python_name">engine</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_keyword">except</span><span class="python_operator">:
    </span><span class="python_name">engine</span><span class="python_operator">.</span><span class="python_name">rollback</span><span class="python_enclosure">()</span><span class="python_operator">
    </span><span class="python_keyword">raise</span><span class="python_operator"></span></pre></div>

    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>





</div>


        



<A name="unitofwork_advscope_scope"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Custom Session Objects/Custom Scopes</span>
    <div class="sectiontext">



    <p>For users who want to make their own Session subclass, or replace the algorithm used to return scoped Session objects (i.e. the objectstore.get_session() method):</p>
    

<div class="code">
    <div class="codetitle">Create a Session</div>
<pre><span class="python_comment"># make a new Session
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">Session</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># set it as the current thread-local session
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">session_registry</span><span class="python_operator">.</span><span class="python_name">set</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

    

<div class="code">
    <div class="codetitle">Create a custom Registry Algorithm</div>
<pre><span class="python_comment"># set the objectstore's session registry to a different algorithm
</span>
<span class="python_keyword">def </span><span class="python_name">create_session</span><span class="python_enclosure">()</span><span class="python_operator">:
    </span><span class="python_literal">"""creates new sessions"""</span><span class="python_operator">
    </span><span class="python_keyword">return </span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">Session</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_keyword">def </span><span class="python_name">mykey</span><span class="python_enclosure">()</span><span class="python_operator">:
    </span><span class="python_literal">"""creates contextual keys to store scoped sessions"""</span><span class="python_operator">
    </span><span class="python_keyword">return </span><span class="python_literal">"mykey"</span><span class="python_operator">
    </span>
<span class="python_operator"></span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">session_registry </span><span class="python_operator">= </span><span class="python_name">sqlalchemy</span><span class="python_operator">.</span><span class="python_name">util</span><span class="python_operator">.</span><span class="python_name">ScopedRegistry</span><span class="python_enclosure">(</span><span class="python_name">createfunc</span><span class="python_operator">=</span><span class="python_name">create_session</span><span class="python_operator">, </span><span class="python_name">scopefunc</span><span class="python_operator">=</span><span class="python_name">mykey</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>


        



<A name="unitofwork_advscope_logging"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Analyzing Object Commits</span>
    <div class="sectiontext">


    <p>The objectstore module can log an extensive display of its "commit plans", which is a graph of its internal representation of objects before they are committed to the database.  To turn this logging on:
    

<div class="code">
<pre><span class="python_comment"># make an engine with echo_uow
</span><span class="python_name">engine </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'myengine...'</span><span class="python_operator">, </span><span class="python_name">echo_uow</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

    <p>Commits will then dump to the standard output displays like the following:</p>
    

<div class="code">
<pre>Task dump:
 UOWTask(6034768) 'User/users/6015696'
  |
  |- Save elements
  |- Save: UOWTaskElement(6034800): User(6016624) (save)
  |
  |- Save dependencies
  |- UOWDependencyProcessor(6035024) 'addresses' attribute on saved User's (UOWTask(6034768) 'User/users/6015696')
  |       |-UOWTaskElement(6034800): User(6016624) (save)
  |
  |- Delete dependencies
  |- UOWDependencyProcessor(6035056) 'addresses' attribute on User's to be deleted (UOWTask(6034768) 'User/users/6015696')
  |       |-(no objects)
  |
  |- Child tasks
  |- UOWTask(6034832) 'Address/email_addresses/6015344'
  |   |
  |   |- Save elements
  |   |- Save: UOWTaskElement(6034864): Address(6034384) (save)
  |   |- Save: UOWTaskElement(6034896): Address(6034256) (save)
  |   |----
  | 
  |----</pre></div>

    <p>The above graph can be read straight downwards to determine the order of operations.  It indicates "save User 6016624, process each element in the 'addresses' list on User 6016624, save Address 6034384, Address 6034256".
    
    </div>


    <a href="#unitofwork" class="toclink">back to section top</a>


</div>





</div>




    
<div class="sectionnavblock">
<div class="sectionnav">


        Previous: <a href="datamapping.html">Basic Data Mapping</a>

                |

        Next: <a href="adv_datamapping.html">Advanced Data Mapping</a>

</div>
</div>


</div>


		</div>






</div>

















<center>
</center>
</body>
</html>




