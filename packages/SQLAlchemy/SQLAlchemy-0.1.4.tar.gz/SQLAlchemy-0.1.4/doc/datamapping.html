<html>
<head>
	<title>
    Data Mapping - SQLAlchemy Documentation
</title>
</head>
<body>



<link href="style.css" rel="stylesheet" type="text/css"></link>
<link href="syntaxhighlight.css" rel="stylesheet" type="text/css"></link>

<link href="docs.css" rel="stylesheet" type="text/css"></link>
<script src="scripts.js"></script>


<div style="position:absolute;left:0px;top:0px;"><a name="top"></a>&nbsp;</div>

<div class="doccontainer">

<div class="docheader">

<div class="docheadertext" >Data Mapping</div>
<div class="">Version: 0.1.4   Last Updated: 03/13/06 12:39:29</div>
</div>



		<A name="datamapping"></a>
		
	
<div class="topnav">


	
	<div class="topnavcontrol">
	View: <b>Paged</b> &nbsp;|&nbsp; <a href="documentation.html">One Page</a>
	</div>



<div class="topnavsectionlink">

<a href="index.html">Table of Contents</a>

<div class="prevnext">
Previous: <a href="sqlconstruction.html">Constructing SQL Queries via Python Expressions</a>

&nbsp; | &nbsp;


Next: <a href="unitofwork.html">Unit of Work</a>

</div>
</div>


<div class="topnavmain">
	<div class="topnavheader">Basic Data Mapping</div>
	<div class="topnavitems">
	


    
    
    <div class="toclink">
        <A style="" href="#datamapping_synopsis">Synopsis</a>
    </div>
    
    <div class="toclinkcontainer">
        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#datamapping_synopsis_attaching">Attaching Mappers to their Class</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#datamapping_synopsis_overriding">Overriding Properties</a>
    </div>

    </div>


    </div>


    
    
    <div class="toclink">
        <A style="" href="#datamapping_selecting">Selecting from a Mapper</a>
    </div>
    
    <div class="toclinkcontainer">
    </div>


    
    
    <div class="toclink">
        <A style="" href="#datamapping_saving">Saving Objects</a>
    </div>
    
    <div class="toclinkcontainer">
    </div>


    
    
    <div class="toclink">
        <A style="" href="#datamapping_relations">Defining and Using Relationships</a>
    </div>
    
    <div class="toclinkcontainer">
        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#datamapping_relations_private">Useful Feature: Private Relations</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#datamapping_relations_backreferences">Useful Feature: Backreferences</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#datamapping_relations_cascade">Creating Relationships Automatically with cascade_mappers</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#datamapping_relations_lazyload">Selecting from Relationships: Lazy Load</a>
    </div>

        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#datamapping_relations_lazyload_relselectby">Useful Feature: Creating Joins via select_by</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#datamapping_relations_lazyload_refreshing">How to Refresh the List?</a>
    </div>

    </div>


    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#datamapping_relations_eagerload">Selecting from Relationships: Eager Load</a>
    </div>

    </div>


        
        
    <div class="toclinkcontainer">
    
    <div class="smalltoclink">
    <A href="#datamapping_relations_options">Switching Lazy/Eager, No Load</a>
    </div>

    </div>


    </div>


    
    
    <div class="toclink">
        <A style="" href="#datamapping_onetoone">One to One/Many to One</a>
    </div>
    
    <div class="toclinkcontainer">
    </div>


    
    
    <div class="toclink">
        <A style="" href="#datamapping_manytomany">Many to Many</a>
    </div>
    
    <div class="toclinkcontainer">
    </div>


    
    
    <div class="toclink">
        <A style="" href="#datamapping_association">Association Object</a>
    </div>
    
    <div class="toclinkcontainer">
    </div>



	</div>
</div>

</div>

		<div class="sectioncontent">
			




<div class="subsection" style="margin-left:10px;">

    <div class="sectiontext">


<p>Data mapping describes the process of defining <b>Mapper</b> objects, which associate table metadata with user-defined classes.  

The Mapper's role is to perform SQL operations upon the database, associating individual table rows with instances of those classes, and individual database columns with properties upon those instances, to transparently associate in-memory objects with a persistent database representation. </p>

<p>When a Mapper is created to associate a Table object with a class, all of the columns defined in the Table object are associated with the class via property accessors, which add overriding functionality to the normal process of setting and getting object attributes.  These property accessors also keep track of changes to object attributes; these changes will be stored to the database when the application "commits" the current transactional context (known as a <b>Unit of Work</b>).  The <span class="codeline">__init__()</span> method of the object is also decorated to communicate changes when new instances of the object are created.</p>

<p>The Mapper also provides the interface by which instances of the object are loaded from the database.  The primary method for this is its <span class="codeline">select()</span> method, which has similar arguments to a <span class="codeline">sqlalchemy.sql.Select</span> object.  But this select method executes automatically and returns results, instead of awaiting an execute() call.  Instead of returning a cursor-like object, it returns an array of objects.</p>

<p>The three elements to be defined, i.e. the Table metadata, the user-defined class, and the Mapper, are typically defined as module-level variables, and may be defined in any fashion suitable to the application, with the only requirement being that the class and table metadata are described before the mapper.  For the sake of example, we will be defining these elements close together, but this should not be construed as a requirement; since SQLAlchemy is not a framework, those decisions are left to the developer or an external framework.
</p>

			

			

			


			



			


			

			


    </div>

        



<A name="datamapping_synopsis"></a>

<div class="subsection" style="margin-left:20px;">

    <span class="sectionheadertext">Synopsis</span>
    <div class="sectiontext">


  <p>This is the simplest form of a full "round trip" of creating table meta data, creating a class, mapping the class to the table, getting some results, and saving changes.  For each concept, the following sections will dig in deeper to the available capabilities.</p>
        

<div class="code">
<pre><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span>
<span class="python_comment"># engine
</span><span class="python_name">engine </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">"sqlite://mydb.db"</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># table metadata
</span><span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">engine</span><span class="python_operator">, </span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">16</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'password'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">20</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># class definition 
</span><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
    </span>
<span class="python_comment"># create a mapper
</span><span class="python_operator"></span><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># select
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_68', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">usermapper</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">user_name</span><span class="python_operator">=</span><span class="python_literal">'fred'</span><span class="python_enclosure">)[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator"></span></pre><div id="popbox_68_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.password AS users_password <br/>
FROM users <br/>
WHERE users.user_name = :users_user_name ORDER BY users.oid<br/>
<br/>
{'users_user_name': 'fred'}</div><pre><span class="python_comment"># modify
</span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_literal">'fred jones'</span><span class="python_operator">
</span>
<span class="python_comment"># commit - saves everything that changed
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_69', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_69_div" class="codepop" style="display:none;">UPDATE users SET user_name=:user_name <br/>
 WHERE users.user_id = :user_id<br/>
<br/>
[{'user_name': 'fred jones', 'user_id': 1}]</div><pre><span class="python_operator"></span></pre></div>

    
			
    
			

    </div>

        



<A name="datamapping_synopsis_attaching"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Attaching Mappers to their Class</span>
    <div class="sectiontext">


    <p>For convenience's sake, the Mapper can be attached as an attribute on the class itself as well:</p>
        

<div class="code">
<pre><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">userlist </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">user_id</span><span class="python_operator">=</span><span class="python_number">12</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

    <p>There is also a full-blown "monkeypatch" function that creates a primary mapper, attaches the above mapper class property, and also the  methods <span class="codeline">get, get_by, select, select_by, selectone, commit</span> and <span class="codeline">delete</span>:</p>
    

<div class="code">
<pre><span class="python_name">assign_mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">userlist </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">user_id</span><span class="python_operator">=</span><span class="python_number">12</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

    <p>Other methods of associating mappers and finder methods with their corresponding classes, such as via common base classes or mixins, can be devised as well.  SQLAlchemy does not aim to dictate application architecture and will always allow the broadest variety of architectural patterns, but may include more helper objects and suggested architectures in the future.</p>
    
    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>


        



<A name="datamapping_synopsis_overriding"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Overriding Properties</span>
    <div class="sectiontext">


    <p>A common request is the ability to create custom class properties that override the behavior of setting/getting an attribute.  Currently, the easiest way to do this in SQLAlchemy is just how its done normally; define your attribute with a different name, such as "_attribute", and use a property to get/set its value.  The mapper just needs to be told of the special name:</p>
    

<div class="code">
<pre><span class="python_keyword">class </span><span class="python_name">MyClass</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">_set_email</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">email</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">_email </span><span class="python_operator">= </span><span class="python_name">email</span><span class="python_operator">
    </span><span class="python_keyword">def </span><span class="python_name">_get_email</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">email</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_keyword">return </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">_email</span><span class="python_operator">
    </span><span class="python_name">email </span><span class="python_operator">= </span><span class="python_name">property</span><span class="python_enclosure">(</span><span class="python_name">_get_email</span><span class="python_operator">, </span><span class="python_name">_set_email</span><span class="python_enclosure">)</span><span class="python_operator">
    </span>
<span class="python_operator"></span><span class="python_name">m </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">MyClass</span><span class="python_operator">, </span><span class="python_name">mytable</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
        <span class="python_comment"># map the '_email' attribute to the "email" column</span>
        <span class="python_comment"># on the table</span>
        <span class="python_literal">'_email'</span><span class="python_operator">: </span><span class="python_name">mytable</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">email</span>
<span class="python_enclosure">})</span><span class="python_operator"></span></pre></div>

    <p>In a later release, SQLAlchemy will also allow _get_email and _set_email to be attached directly to the "email" property created by the mapper, and will also allow this association to occur via decorators.</p>
    
    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>





</div>


        



<A name="datamapping_selecting"></a>

<div class="subsection" style="margin-left:20px;">

    <span class="sectionheadertext">Selecting from a Mapper</span>
    <div class="sectiontext">


    <p>There are a variety of ways to select from a mapper.  These range from minimalist to explicit.  Below is a synopsis of the these methods:</p>
        

<div class="code">
<pre><span class="python_comment"># select_by, using property names or column names as keys
# the keys are grouped together by an AND operator
</span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'john'</span><span class="python_operator">, </span><span class="python_name">street</span><span class="python_operator">=</span><span class="python_literal">'123 green street'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># select_by can also combine SQL criterion with key/value properties
</span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator">==</span><span class="python_literal">'john'</span><span class="python_operator">, </span>
        <span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">zip_code</span><span class="python_operator">==</span><span class="python_literal">'12345, street='</span><span class="python_number">123 </span><span class="python_name">green street</span><span class="python_operator">'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># get_by, which takes the same arguments as select_by
# returns a single scalar result or None if no results
</span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">id</span><span class="python_operator">=</span><span class="python_number">12</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># "dynamic" versions of select_by and get_by - everything past the 
# "select_by_" or "get_by_" is used as the key, and the function argument
# as the value
</span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select_by_name</span><span class="python_enclosure">(</span><span class="python_literal">'fred'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">get_by_name</span><span class="python_enclosure">(</span><span class="python_literal">'fred'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># get an object directly from its primary key.  this will bypass the SQL
# call if the object has already been loaded
</span><span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">get</span><span class="python_enclosure">(</span><span class="python_number">15</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># get an object that has a composite primary key of three columns.
# the order of the arguments matches that of the table meta data.
</span><span class="python_name">myobj </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">get</span><span class="python_enclosure">(</span><span class="python_number">27</span><span class="python_operator">, </span><span class="python_number">3</span><span class="python_operator">, </span><span class="python_literal">'receipts'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># using a WHERE criterion
</span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">or_</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">== </span><span class="python_literal">'john'</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator">==</span><span class="python_literal">'fred'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># using a WHERE criterion to get a scalar
</span><span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">selectone</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator">==</span><span class="python_literal">'john'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># using a full select object
</span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator">==</span><span class="python_literal">'john'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># using straight text  
</span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select_text</span><span class="python_enclosure">(</span><span class="python_literal">"select * from users where user_name='fred'"</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># or using a "text" object
</span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">text</span><span class="python_enclosure">(</span><span class="python_literal">"select * from users where user_name='fred'"</span><span class="python_operator">, </span><span class="python_name">engine</span><span class="python_operator">=</span><span class="python_name">engine</span><span class="python_enclosure">))</span><span class="python_operator"></span></pre></div>
    
    <p>The last few examples above show the usage of the mapper's table object to provide the columns for a WHERE Clause.  These columns are also accessible off of the mapped class directly.  When a mapper is assigned to a class, it also attaches a special property accessor <span class="codeline">c</span> to the class itself, which can be used just like the table metadata to access the columns of the table:</p>
        

<div class="code">
<pre><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">userlist </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">==</span><span class="python_number">12</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>
    

    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>


        



<A name="datamapping_saving"></a>

<div class="subsection" style="margin-left:20px;">

    <span class="sectionheadertext">Saving Objects</span>
    <div class="sectiontext">


    <p>When objects corresponding to mapped classes are created or manipulated, all changes are logged by a package called <span class="codeline">sqlalchemy.mapping.objectstore</span>.   The changes are then written to the database when an application calls <span class="codeline">objectstore.commit()</span>.  This pattern is known as a <b>Unit of Work</b>, and has many advantages over saving individual objects or attributes on those objects with individual method invocations.  Domain models can be built with far greater complexity with no concern over the order of saves and deletes, excessive database round-trips and write operations, or deadlocking issues.  The commit() operation uses a transaction as well, and will also perform "concurrency checking" to insure the proper number of rows were in fact affected (not supported with the current MySQL drivers). Transactional resources are used effectively in all cases; the unit of work handles all the details.</p>
    
    <p>When a mapper is created, the target class has its mapped properties decorated by specialized property accessors that track changes, and its <span class="codeline">__init__()</span> method is also decorated to mark new objects as "new".</p>
        

<div class="code">
<pre><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># create a new User
</span><span class="python_name">myuser </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">myuser</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_literal">'jane'</span><span class="python_operator">
</span><span class="python_name">myuser</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_literal">'hello123'</span><span class="python_operator">
</span>
<span class="python_comment"># create another new User      
</span><span class="python_name">myuser2 </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">myuser2</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_literal">'ed'</span><span class="python_operator">
</span><span class="python_name">myuser2</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_literal">'lalalala'</span><span class="python_operator">
</span>
<span class="python_comment"># load a third User from the database            
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_70', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">myuser3 </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator">==</span><span class="python_literal">'fred'</span><span class="python_enclosure">)[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator"></span></pre><div id="popbox_70_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, <br/>
users.user_name AS users_user_name, users.password AS users_password<br/>
FROM users WHERE users.user_name = :users_user_name<br/>
{'users_user_name': 'fred'}</div><pre><span class="python_name">myuser3</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_literal">'fredjones'</span><span class="python_operator">
</span>
<span class="python_comment"># save all changes            
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_71', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_71_div" class="codepop" style="display:none;">UPDATE users SET user_name=:user_name<br/>
WHERE users.user_id =:users_user_id<br/>
[{'users_user_id': 1, 'user_name': 'fredjones'}]<br/>
<br/>
INSERT INTO users (user_name, password) VALUES (:user_name, :password)<br/>
{'password': 'hello123', 'user_name': 'jane'}<br/>
<br/>
INSERT INTO users (user_name, password) VALUES (:user_name, :password)<br/>
{'password': 'lalalala', 'user_name': 'ed'}</div><pre><span class="python_operator"></span></pre></div>

    <p>In the examples above, we defined a User class with basically no properties or methods.  Theres no particular reason it has to be this way, the class can explicitly set up whatever properties it wants, whether or not they will be managed by the mapper.  It can also specify a constructor, with the restriction that the constructor is able to function with no arguments being passed to it (this restriction can be lifted with some extra parameters to the mapper; more on that later):</p>
        

<div class="code">
<pre><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_name">None</span><span class="python_operator">, </span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_name">None</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_id </span><span class="python_operator">= </span><span class="python_name">None</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_name">user_name</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_name">password</span><span class="python_operator">
    </span><span class="python_keyword">def </span><span class="python_name">get_name</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_keyword">return </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator">
    </span><span class="python_keyword">def </span><span class="python_name">__repr__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_keyword">return </span><span class="python_literal">"User id %s name %s password %s" </span><span class="python_operator">% </span><span class="python_enclosure">(</span><span class="python_name">repr</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_enclosure">)</span><span class="python_operator">, </span>
            <span class="python_name">repr</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">repr</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'john'</span><span class="python_operator">, </span><span class="python_literal">'foo'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_72', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_72_div" class="codepop" style="display:none;">INSERT INTO users (user_name, password) VALUES (:user_name, :password)<br/>
{'password': 'foo', 'user_name': 'john'}</div><pre><span class="python_operator">>>> </span><span class="python_name">u</span><span class="python_operator">
</span><span class="python_name">User id </span><span class="python_number">1 </span><span class="python_name">name </span><span class="python_literal">'john' </span><span class="python_name">password </span><span class="python_literal">'foo'</span><span class="python_operator"></span></pre></div>


<p>Recent versions of SQLAlchemy will only put modified object attributes columns into the UPDATE statements generated upon commit.  This is to conserve database traffic and also to successfully interact with a "deferred" attribute, which is a mapped object attribute against the mapper's primary table that isnt loaded until referenced by the application.</p>

    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>


        



<A name="datamapping_relations"></a>

<div class="subsection" style="margin-left:20px;">

    <span class="sectionheadertext">Defining and Using Relationships</span>
    <div class="sectiontext">


<p>So that covers how to map the columns in a table to an object, how to load objects, create new ones, and save changes.  The next step is how to define an object's relationships to other database-persisted objects.  This is done via the <span class="codeline">relation</span> function provided by the mapper module.  So with our User class, lets also define the User has having one or more mailing addresses.  First, the table metadata:</p>
        

<div class="code">
<pre><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span><span class="python_name">engine </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite'</span><span class="python_operator">, </span><span class="python_enclosure">{</span><span class="python_literal">'filename'</span><span class="python_operator">:</span><span class="python_literal">'mydb'</span><span class="python_enclosure">})</span><span class="python_operator">
</span>
<span class="python_comment"># define user table
</span><span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">engine</span><span class="python_operator">, </span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">16</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'password'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">20</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># define user address table
</span><span class="python_name">addresses </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_operator">, </span><span class="python_name">engine</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'address_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"users.user_id"</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'street'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">100</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'city'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">80</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'state'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">2</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'zip'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">10</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

<p>Of importance here is the addresses table's definition of a <b>foreign key</b> relationship to the users table, relating the user_id column into a parent-child relationship.  When a Mapper wants to indicate a relation of one object to another, this ForeignKey object is the default method by which the relationship is determined (although if you didn't define ForeignKeys, or you want to specify explicit relationship columns, that is available as well).   </p>
<p>So then lets define two classes, the familiar User class, as well as an Address class:

        

<div class="code">
<pre><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_name">None</span><span class="python_operator">, </span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_name">None</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_name">user_name</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_name">password</span><span class="python_operator">
        </span>
<span class="python_operator"></span><span class="python_keyword">class </span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">street</span><span class="python_operator">=</span><span class="python_name">None</span><span class="python_operator">, </span><span class="python_name">city</span><span class="python_operator">=</span><span class="python_name">None</span><span class="python_operator">, </span><span class="python_name">state</span><span class="python_operator">=</span><span class="python_name">None</span><span class="python_operator">, </span><span class="python_name">zip</span><span class="python_operator">=</span><span class="python_name">None</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">street </span><span class="python_operator">= </span><span class="python_name">street</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">city </span><span class="python_operator">= </span><span class="python_name">city</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">state </span><span class="python_operator">= </span><span class="python_name">state</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">zip </span><span class="python_operator">= </span><span class="python_name">zip</span><span class="python_operator"></span></pre></div>

<p>And then a Mapper that will define a relationship of the User and the Address classes to each other as well as their table metadata.  We will add an additional mapper keyword argument <span class="codeline">properties</span> which is a dictionary relating the name of an object property to a database relationship, in this case a <span class="codeline">relation</span> object against a newly defined  mapper for the Address class:</p>
        

<div class="code">
<pre><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
                    <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses</span><span class="python_enclosure">))</span>
                <span class="python_enclosure">}</span>
              <span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

<p>Lets do some operations with these classes and see what happens:</p>

        

<div class="code">
<pre><span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'jane'</span><span class="python_operator">, </span><span class="python_literal">'hihilala'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'123 anywhere street'</span><span class="python_operator">, </span><span class="python_literal">'big city'</span><span class="python_operator">, </span><span class="python_literal">'UT'</span><span class="python_operator">, </span><span class="python_literal">'76543'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'1 Park Place'</span><span class="python_operator">, </span><span class="python_literal">'some other city'</span><span class="python_operator">, </span><span class="python_literal">'OK'</span><span class="python_operator">, </span><span class="python_literal">'83923'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div class="codepop">INSERT INTO users (user_name, password) VALUES (:user_name, :password)<br/>
{'password': 'hihilala', 'user_name': 'jane'}<br/>
<br/>
INSERT INTO addresses (user_id, street, city, state, zip) VALUES (:user_id, :street, :city, :state, :zip)<br/>
{'city': 'big city', 'state': 'UT', 'street': '123 anywhere street', 'user_id':1, 'zip': '76543'}<br/>
<br/>
INSERT INTO addresses (user_id, street, city, state, zip) VALUES (:user_id, :street, :city, :state, :zip)<br/>
{'city': 'some other city', 'state': 'OK', 'street': '1 Park Place', 'user_id':1, 'zip': '83923'}</div><pre><span class="python_operator"></span></pre></div>

<p>A lot just happened there!  The Mapper object figured out how to relate rows in the addresses table to the users table, and also upon commit had to determine the proper order in which to insert rows.  After the insert, all the User and Address objects have all their new primary and foreign keys populated.</p>

<p>Also notice that when we created a Mapper on the User class which defined an 'addresses' relation, the newly created User instance magically had an "addresses" attribute which behaved like a list.   This list is in reality a property accessor function, which returns an instance of <span class="codeline">sqlalchemy.util.HistoryArraySet</span>, which fulfills the full set of Python list accessors, but maintains a <b>unique</b> set of objects (based on their in-memory identity), and also tracks additions and deletions to the list:</p>
        

<div class="code">
<pre><span class="python_keyword">del </span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">[</span><span class="python_number">1</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'27 New Place'</span><span class="python_operator">, </span><span class="python_literal">'Houston'</span><span class="python_operator">, </span><span class="python_literal">'TX'</span><span class="python_operator">, </span><span class="python_literal">'34839'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div class="codepop">UPDATE addresses SET user_id=:user_id<br/>
 WHERE addresses.address_id = :addresses_address_id<br/>
[{'user_id': None, 'addresses_address_id': 2}]<br/>
<br/>
INSERT INTO addresses (user_id, street, city, state, zip) <br/>
VALUES (:user_id, :street, :city, :state, :zip)<br/>
{'city': 'Houston', 'state': 'TX', 'street': '27 New Place', 'user_id': 1, 'zip': '34839'}</div><pre><span class="python_operator"></span></pre></div>


			

			

			
    
			
    
			
    
			


    </div>

        



<A name="datamapping_relations_private"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Useful Feature: Private Relations</span>
    <div class="sectiontext">


<p>So our one address that was removed from the list, was updated to have a user_id of <span class="codeline">None</span>, and a new address object was inserted to correspond to the new Address added to the User.  But now, theres a mailing address with no user_id floating around in the database of no use to anyone.  How can we avoid this ?  This is acheived by using the <span class="codeline">private=True</span> parameter of <span class="codeline">relation</span>:

        

<div class="code">
<pre><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
                    <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">private</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span>
                <span class="python_enclosure">}</span>
              <span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">del </span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">[</span><span class="python_number">1</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'27 New Place'</span><span class="python_operator">, </span><span class="python_literal">'Houston'</span><span class="python_operator">, </span><span class="python_literal">'TX'</span><span class="python_operator">, </span><span class="python_literal">'34839'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div class="codepop">INSERT INTO addresses (user_id, street, city, state, zip) <br/>
VALUES (:user_id, :street, :city, :state, :zip)<br/>
{'city': 'Houston', 'state': 'TX', 'street': '27 New Place', 'user_id': 1, 'zip': '34839'}<br/>
<br/>
DELETE FROM addresses WHERE addresses.address_id = :address_id<br/>
[{'address_id': 2}]</div><pre><span class="python_operator"></span></pre></div>

<p>In this case, with the private flag set, the element that was removed from the addresses list was also removed from the database.  By specifying the <span class="codeline">private</span> flag on a relation, it is indicated to the Mapper that these related objects exist only as children of the parent object, otherwise should be deleted.</p>

    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>


        



<A name="datamapping_relations_backreferences"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Useful Feature: Backreferences</span>
    <div class="sectiontext">


<p>By creating relations with the <span class="codeline">backref</span> keyword, a bi-directional relationship can be created which will keep both ends of the relationship updated automatically, even without any database queries being executed.  Below, the User mapper is created with an "addresses" property, and the corresponding Address mapper receives a "backreference" to the User object via the property name "user":
        

<div class="code">
<pre><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
                    <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_literal">'user'</span><span class="python_enclosure">)</span>
                <span class="python_enclosure">}</span>
              <span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'fred'</span><span class="python_operator">, </span><span class="python_literal">'hi'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">a1 </span><span class="python_operator">= </span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'123 anywhere street'</span><span class="python_operator">, </span><span class="python_literal">'big city'</span><span class="python_operator">, </span><span class="python_literal">'UT'</span><span class="python_operator">, </span><span class="python_literal">'76543'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">a2 </span><span class="python_operator">= </span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'1 Park Place'</span><span class="python_operator">, </span><span class="python_literal">'some other city'</span><span class="python_operator">, </span><span class="python_literal">'OK'</span><span class="python_operator">, </span><span class="python_literal">'83923'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># append a1 to u
</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">a1</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># attach u to a2
</span><span class="python_name">a2</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">u</span><span class="python_operator">
</span>
<span class="python_comment"># the bi-directional relation is maintained
</span><span class="python_operator">>>> </span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses </span><span class="python_operator">== </span><span class="python_enclosure">[</span><span class="python_name">a1</span><span class="python_operator">, </span><span class="python_name">a2</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_name">True</span><span class="python_operator">
>>> </span><span class="python_name">a1</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_keyword">is </span><span class="python_name">user </span><span class="python_keyword">and </span><span class="python_name">a2</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_keyword">is </span><span class="python_name">user</span><span class="python_operator">
</span><span class="python_name">True</span><span class="python_operator"></span></pre></div>


+<p>The backreference feature also works with many-to-many relationships, which are described later.  When creating a backreference, a corresponding property is placed on the child mapper.  The default arguments to this property can be overridden using the <span class="codeline">backref()</span> function:
        

<div class="code">
<pre><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
                    <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_name">backref</span><span class="python_enclosure">(</span><span class="python_literal">'user'</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_operator">, </span><span class="python_name">private</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">))</span>
                <span class="python_enclosure">}</span>
              <span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

<p>Note that when overriding a backreferenced property, we re-specify the backreference as well.  This will not override the existing 'addresses' property on the User class, but just sends a message to the attribute-management system that it should continue to maintain this backreference.</p>

    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>


        



<A name="datamapping_relations_cascade"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Creating Relationships Automatically with cascade_mappers</span>
    <div class="sectiontext">


<p>The mapper package has a helper function <span class="codeline">cascade_mappers()</span> which can simplify the task of linking several mappers together.  Given a list of classes and/or mappers, it identifies the foreign key relationships between the given mappers or corresponding class mappers, and creates relation() objects representing those relationships, including a backreference.  Attempts to find
the "secondary" table in a many-to-many relationship as well.  The names of the relations
are a lowercase version of the related class.  In the case of one-to-many or many-to-many,
the name is "pluralized", which currently is based on the English language (i.e. an 's' or 
'es' added to it):</p>
    

<div class="code">
<pre><span class="python_comment"># create two mappers.  the 'users' and 'addresses' tables have a foreign key
# relationship
</span><span class="python_name">mapper1 </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">mapper2 </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># cascade the two mappers together (can also specify User, Address as the arguments)
</span><span class="python_name">cascade_mappers</span><span class="python_enclosure">(</span><span class="python_name">mapper1</span><span class="python_operator">, </span><span class="python_name">mapper2</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># two new object instances
</span><span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'user1'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">a </span><span class="python_operator">= </span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'test'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># "addresses" and "user" property are automatically added
</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">a</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">a</span><span class="python_operator">.</span><span class="python_name">user</span><span class="python_operator"></span></pre></div>



    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>


        



<A name="datamapping_relations_lazyload"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Selecting from Relationships: Lazy Load</span>
    <div class="sectiontext">


    <P>We've seen how the <span class="codeline">relation</span> specifier affects the saving of an object and its child items, how does it affect selecting them?  By default, the relation keyword indicates that the related property should be attached a <b>Lazy Loader</b> when instances of the parent object are loaded from the database; this is just a callable function that when accessed will invoke a second SQL query to load the child objects of the parent.</p>
    
        

<div class="code">
<pre><span class="python_comment"># define a mapper
</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
                  <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">private</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span>
                <span class="python_enclosure">})</span><span class="python_operator">
        </span>
<span class="python_comment"># select users where username is 'jane', get the first element of the list
# this will incur a load operation for the parent table
</span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">user_name</span><span class="python_operator">=</span><span class="python_literal">'jane'</span><span class="python_enclosure">)[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator"></span></pre><div class="codepop">SELECT users.user_id AS users_user_id, <br/>
users.user_name AS users_user_name, users.password AS users_password<br/>
FROM users WHERE users.user_name = :users_user_name ORDER BY users.oid<br/>
{'users_user_name': 'jane'}</div><pre><span class="python_comment"># iterate through the User object's addresses.  this will incur an
# immediate load of those child items
</span><span class="python_keyword">for </span><span class="python_name">a </span><span class="python_keyword">in </span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">:</span></pre><div class="codepop">SELECT addresses.address_id AS addresses_address_id, <br/>
addresses.user_id AS addresses_user_id, addresses.street AS addresses_street, <br/>
addresses.city AS addresses_city, addresses.state AS addresses_state, <br/>
addresses.zip AS addresses_zip FROM addresses<br/>
WHERE addresses.user_id = :users_user_id ORDER BY addresses.oid<br/>
{'users_user_id': 1}</div><pre> 
<span class="python_operator">     </span><span class="python_keyword">print </span><span class="python_name">repr</span><span class="python_enclosure">(</span><span class="python_name">a</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>
    
        
			
        
			
    
    </div>

        



<A name="datamapping_relations_lazyload_relselectby"></a>

<div class="subsection" style="margin-left:40px;">

    <span class="sectionheadertext">Useful Feature: Creating Joins via select_by</span>
    <div class="sectiontext">


        <p>In mappers that have relationships, the <span class="codeline">select_by</span> method and its cousins include special functionality that can be used to create joins.  Just specify a key in the argument list which is not present in the primary mapper's list of properties or columns, but *is* present in the property list of one of its relationships:
        

<div class="code">
<pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_73', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">l </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">street</span><span class="python_operator">=</span><span class="python_literal">'123 Green Street'</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre><div id="popbox_73_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, <br/>
users.user_name AS users_user_name, users.password AS users_password<br/>
FROM users, addresses <br/>
WHERE users.user_id=addresses.user_id<br/>
AND addresses.street=:addresses_street<br/>
ORDER BY users.oid<br/>
{'addresses_street', '123 Green Street'}</div><pre><span class="python_operator"></span></pre></div>

                <p>The above example is shorthand for:</p>
        

<div class="code">
<pre><span class="python_name">l </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">and_</span><span class="python_enclosure">(</span>
          <span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">==</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">, </span>
          <span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">street</span><span class="python_operator">==</span><span class="python_literal">'123 Green Street'</span><span class="python_enclosure">)</span>
    <span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

        
                
    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>


        



<A name="datamapping_relations_lazyload_refreshing"></a>

<div class="subsection" style="margin-left:40px;">

    <span class="sectionheadertext">How to Refresh the List?</span>
    <div class="sectiontext">


        <p>Once the child list of Address objects is loaded, it is done loading for the lifetime of the object instance.  Changes to the list will not be interfered with by subsequent loads, and upon commit those changes will be saved.  Similarly, if a new User object is created and child Address objects added, a subsequent select operation which happens to touch upon that User instance, will also not affect the child list, since it is already loaded.</p>
        
        <p>The issue of when the mapper actually gets brand new objects from the database versus when it assumes the in-memory version is fine the way it is, is a subject of <b>transactional scope</b>.  Described in more detail in the Unit of Work section, for now it should be noted that the total storage of all newly created and selected objects, <b>within the scope of the current thread</b>, can be reset via releasing or otherwise disregarding all current object instances, and calling:</p>
        

<div class="code">
<pre><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">clear</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre></div>

        <p>This operation will clear out all currently mapped object instances, and subsequent select statements will load fresh copies from the databse.</p>
        
        <p>To operate upon a single object, just use the <span class="codeline">remove</span> function:</p>
        

<div class="code">
<pre><span class="python_comment"># (this function coming soon)
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">remove</span><span class="python_enclosure">(</span><span class="python_name">myobject</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

        
        
    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>





</div>


        



<A name="datamapping_relations_eagerload"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Selecting from Relationships: Eager Load</span>
    <div class="sectiontext">


        <p>With just a single parameter "lazy=False" specified to the relation object, the parent and child SQL queries can be joined together.

        

<div class="code">
<pre><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
                    <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_enclosure">)</span>
                <span class="python_enclosure">}</span>
              <span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">user_name</span><span class="python_operator">=</span><span class="python_literal">'jane'</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre><div class="codepop">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.password AS users_password, <br/>
addresses.address_id AS addresses_address_id, addresses.user_id AS addresses_user_id, <br/>
addresses.street AS addresses_street, addresses.city AS addresses_city, <br/>
addresses.state AS addresses_state, addresses.zip AS addresses_zip<br/>
FROM users LEFT OUTER JOIN addresses ON users.user_id = addresses.user_id<br/>
WHERE users.user_name = :users_user_name ORDER BY users.oid, addresses.oid<br/>
{'users_user_name': 'jane'}</div><pre><span class="python_keyword">for </span><span class="python_name">a </span><span class="python_keyword">in </span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">:  
    </span><span class="python_keyword">print </span><span class="python_name">repr</span><span class="python_enclosure">(</span><span class="python_name">a</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre></div>

        <P>Above, a pretty ambitious query is generated just by specifying that the User should be loaded with its child Addresses in one query.  When the mapper processes the results, it uses an <b>Identity Map</b> to keep track of objects that were already loaded, based on their primary key identity.  Through this method, the redundant rows produced by the join are organized into the distinct object instances they represent.</p>
        
        <p>The generation of this query is also immune to the effects of additional joins being specified in the original query.  To use our select_by example above, joining against the "addresses" table to locate users with a certain street results in this behavior:
        

<div class="code">
<pre><span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">street</span><span class="python_operator">=</span><span class="python_literal">'123 Green Street'</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre><div class="codepop">SELECT users.user_id AS users_user_id, <br/>
users.user_name AS users_user_name, users.password AS users_password, <br/>
addresses.address_id AS addresses_address_id, <br/>
addresses.user_id AS addresses_user_id, addresses.street AS addresses_street, <br/>
addresses.city AS addresses_city, addresses.state AS addresses_state, <br/>
addresses.zip AS addresses_zip<br/>
FROM addresses AS addresses_417c, <br/>
users LEFT OUTER JOIN addresses ON users.user_id = addresses.user_id<br/>
WHERE addresses_417c.street = :addresses_street <br/>
AND users.user_id = addresses_417c.user_id <br/>
ORDER BY users.oid, addresses.oid<br/>
{'addresses_street': '123 Green Street'}</div><pre><span class="python_operator"></span></pre></div>
        
            <p>The join implied by passing the "street" parameter is converted into an "aliasized" clause by the eager loader, so that it does not conflict with the join used to eager load the child address objects.</p>
    
    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>


        



<A name="datamapping_relations_options"></a>

<div class="subsection" style="margin-left:30px;">

    <span class="sectionheadertext">Switching Lazy/Eager, No Load</span>
    <div class="sectiontext">


    <p>The <span class="codeline">options</span> method of mapper provides an easy way to get alternate forms of a mapper from an original one.  The most common use of this feature is to change the "eager/lazy" loading behavior of a particular mapper, via the functions <span class="codeline">eagerload()</span>, <span class="codeline">lazyload()</span> and <span class="codeline">noload()</span>:
    </p>
        

<div class="code">
<pre><span class="python_comment"># user mapper with lazy addresses
</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
                       <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses</span><span class="python_enclosure">))</span>
                   <span class="python_enclosure">}</span>
          <span class="python_enclosure">)</span><span class="python_operator">
          </span>
<span class="python_comment"># make an eager loader                    
</span><span class="python_name">eagermapper </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">options</span><span class="python_enclosure">(</span><span class="python_name">eagerload</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">eagermapper</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># make another mapper that wont load the addresses at all
</span><span class="python_name">plainmapper </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">options</span><span class="python_enclosure">(</span><span class="python_name">noload</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># multiple options can be specified
</span><span class="python_name">mymapper </span><span class="python_operator">= </span><span class="python_name">oldmapper</span><span class="python_operator">.</span><span class="python_name">options</span><span class="python_enclosure">(</span><span class="python_name">lazyload</span><span class="python_enclosure">(</span><span class="python_literal">'tracker'</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">noload</span><span class="python_enclosure">(</span><span class="python_literal">'streets'</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">eagerload</span><span class="python_enclosure">(</span><span class="python_literal">'members'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># to specify a relation on a relation, separate the property names by a "."
</span><span class="python_name">mymapper </span><span class="python_operator">= </span><span class="python_name">oldmapper</span><span class="python_operator">.</span><span class="python_name">options</span><span class="python_enclosure">(</span><span class="python_name">eagerload</span><span class="python_enclosure">(</span><span class="python_literal">'orders.items'</span><span class="python_enclosure">))</span><span class="python_operator"></span></pre></div>
    
    
    
    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>





</div>


        



<A name="datamapping_onetoone"></a>

<div class="subsection" style="margin-left:20px;">

    <span class="sectionheadertext">One to One/Many to One</span>
    <div class="sectiontext">


<p>The above examples focused on the "one-to-many" relationship.  To do other forms of relationship is easy, as the <span class="codeline">relation</span> function can usually figure out what you want:</p>

        

<div class="code">
<pre><span class="python_comment"># a table to store a user's preferences for a site
</span><span class="python_name">prefs </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'user_prefs'</span><span class="python_operator">, </span><span class="python_name">engine</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'pref_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'stylename'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">20</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'save_password'</span><span class="python_operator">, </span><span class="python_name">Boolean</span><span class="python_operator">, </span><span class="python_name">nullable </span><span class="python_operator">= </span><span class="python_name">False</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'timezone'</span><span class="python_operator">, </span><span class="python_name">CHAR</span><span class="python_enclosure">(</span><span class="python_number">3</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">nullable </span><span class="python_operator">= </span><span class="python_name">False</span><span class="python_enclosure">)</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># user table gets 'preference_id' column added
</span><span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">engine</span><span class="python_operator">, </span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">16</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">nullable </span><span class="python_operator">= </span><span class="python_name">False</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'password'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">20</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">nullable </span><span class="python_operator">= </span><span class="python_name">False</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'preference_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"prefs.pref_id"</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># class definition for preferences
</span><span class="python_keyword">class </span><span class="python_name">UserPrefs</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span><span class="python_name">UserPrefs</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">UserPrefs</span><span class="python_operator">, </span><span class="python_name">prefs</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># address mapper
</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># make a new mapper referencing everything.
</span><span class="python_name">m </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_name">dict</span><span class="python_enclosure">(</span>
    <span class="python_name">addresses </span><span class="python_operator">= </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_operator">, </span><span class="python_name">private</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">preferences </span><span class="python_operator">= </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">UserPrefs</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_operator">, </span><span class="python_name">private</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># select
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_74', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">m</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">user_name</span><span class="python_operator">=</span><span class="python_literal">'fred'</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre><div id="popbox_74_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.password AS users_password, users.preference_id AS users_preference_id, <br/>
user_prefs.pref_id AS user_prefs_pref_id, user_prefs.stylename AS user_prefs_stylename, <br/>
user_prefs.save_password AS user_prefs_save_password, user_prefs.timezone AS user_prefs_timezone <br/>
FROM users LEFT OUTER JOIN user_prefs ON user_prefs.pref_id = users.preference_id <br/>
WHERE users.user_name = :users_user_name ORDER BY users.oid, user_prefs.oid<br/>
<br/>
{'users_user_name': 'fred'}</div><pre><span class="python_name">save_password </span><span class="python_operator">= </span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">preferences</span><span class="python_operator">.</span><span class="python_name">save_password</span><span class="python_operator">
</span>
<span class="python_comment"># modify
</span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">preferences</span><span class="python_operator">.</span><span class="python_name">stylename </span><span class="python_operator">= </span><span class="python_literal">'bluesteel'</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_75', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'freddy@hi.org'</span><span class="python_enclosure">))</span><span class="python_operator"></span></pre><div id="popbox_75_div" class="codepop" style="display:none;">SELECT email_addresses.address_id AS email_addresses_address_id, <br/>
email_addresses.user_id AS email_addresses_user_id, <br/>
email_addresses.email_address AS email_addresses_email_address <br/>
FROM email_addresses <br/>
WHERE email_addresses.user_id = :users_user_id <br/>
ORDER BY email_addresses.oid, email_addresses.oid<br/>
<br/>
{'users_user_id': 1}</div><pre><span class="python_comment"># commit
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_76', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_76_div" class="codepop" style="display:none;">UPDATE user_prefs SET stylename=:stylename<br/>
WHERE user_prefs.pref_id = :pref_id<br/>
<br/>
[{'stylename': 'bluesteel', 'pref_id': 1}]<br/>
<br/>
INSERT INTO email_addresses (address_id, user_id, email_address) <br/>
VALUES (:address_id, :user_id, :email_address)<br/>
<br/>
{'email_address': 'freddy@hi.org', 'address_id': None, 'user_id': 1}</div><pre><span class="python_operator"></span></pre></div>


    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>


        



<A name="datamapping_manytomany"></a>

<div class="subsection" style="margin-left:20px;">

    <span class="sectionheadertext">Many to Many</span>
    <div class="sectiontext">


<p>The <span class="codeline">relation</span> function handles a basic many-to-many relationship when you specify the association table:</p>
        

<div class="code">
<pre><span class="python_name">articles </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'articles'</span><span class="python_operator">, </span><span class="python_name">engine</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'article_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'headline'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">150</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">key</span><span class="python_operator">=</span><span class="python_literal">'headline'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'body'</span><span class="python_operator">, </span><span class="python_name">TEXT</span><span class="python_operator">, </span><span class="python_name">key</span><span class="python_operator">=</span><span class="python_literal">'body'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">keywords </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'keywords'</span><span class="python_operator">, </span><span class="python_name">engine</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">50</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">itemkeywords </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'article_keywords'</span><span class="python_operator">, </span><span class="python_name">engine</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'article_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"articles.article_id"</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"keywords.keyword_id"</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># class definitions
</span><span class="python_keyword">class </span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">name </span><span class="python_operator">= </span><span class="python_name">None</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">keyword_name </span><span class="python_operator">= </span><span class="python_name">name</span><span class="python_operator">
</span>
<span class="python_operator"></span><span class="python_keyword">class </span><span class="python_name">Article</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span>
<span class="python_comment"># define a mapper that does many-to-many on the 'itemkeywords' association 
# table
</span><span class="python_operator"></span><span class="python_name">Article</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Article</span><span class="python_operator">, </span><span class="python_name">articles</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_name">dict</span><span class="python_enclosure">(</span>
        <span class="python_name">keywords </span><span class="python_operator">= </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_operator">, </span><span class="python_name">keywords</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">itemkeywords</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_enclosure">)</span>
        <span class="python_enclosure">)</span>
    <span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">article </span><span class="python_operator">= </span><span class="python_name">Article</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">article</span><span class="python_operator">.</span><span class="python_name">headline </span><span class="python_operator">= </span><span class="python_literal">'a headline'</span><span class="python_operator">
</span><span class="python_name">article</span><span class="python_operator">.</span><span class="python_name">body </span><span class="python_operator">= </span><span class="python_literal">'this is the body'</span><span class="python_operator">
</span><span class="python_name">article</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'politics'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">article</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'entertainment'</span><span class="python_enclosure">))</span><span class="python_operator">
        </span><span class="python_literal"><a href="javascript:togglePopbox('popbox_77', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_operator">
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_77_div" class="codepop" style="display:none;">INSERT INTO keywords (name) VALUES (:name)<br/>
<br/>
{'name': 'politics'}<br/>
<br/>
INSERT INTO keywords (name) VALUES (:name)<br/>
<br/>
{'name': 'entertainment'}<br/>
<br/>
INSERT INTO articles (article_headline, article_body) VALUES (:article_headline, :article_body)<br/>
<br/>
{'article_body': 'this is the body', 'article_headline': 'a headline'}<br/>
<br/>
INSERT INTO article_keywords (article_id, keyword_id) VALUES (:article_id, :keyword_id)<br/>
<br/>
[{'keyword_id': 1, 'article_id': 1}, {'keyword_id': 2, 'article_id': 1}]</div><pre><span class="python_comment"># select articles based on a keyword.  select_by will handle the extra joins.
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_78', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">articles </span><span class="python_operator">= </span><span class="python_name">Article</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">keyword_name</span><span class="python_operator">=</span><span class="python_literal">'politics'</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre><div id="popbox_78_div" class="codepop" style="display:none;">SELECT articles.article_id AS articles_article_id, <br/>
articles.article_headline AS articles_article_headline, <br/>
articles.article_body AS articles_article_body, <br/>
keywords.keyword_id AS keywords_keyword_id, <br/>
keywords.keyword_name AS keywords_keyword_name <br/>
FROM keywords AS keywords_f008, <br/>
article_keywords AS article_keywords_dbf0, <br/>
articles LEFT OUTER JOIN article_keywords ON <br/>
articles.article_id = article_keywords.article_id <br/>
LEFT OUTER JOIN keywords ON <br/>
keywords.keyword_id = article_keywords.keyword_id <br/>
WHERE (keywords_f008.keyword_name = :keywords_keyword_name <br/>
AND articles.article_id = article_keywords_dbf0.article_id) <br/>
AND keywords_f008.keyword_id = article_keywords_dbf0.keyword_id <br/>
ORDER BY articles.oid, article_keywords.oid <br/>
{'keywords_keyword_name': 'politics'}</div><pre><span class="python_comment"># modify
</span><span class="python_name">a </span><span class="python_operator">= </span><span class="python_name">articles</span><span class="python_enclosure">[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_keyword">del </span><span class="python_name">a</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_enclosure">[</span><span class="python_operator">:</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_name">a</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'topstories'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">a</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'government'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># commit.  individual INSERT/DELETE operations will take place only for the list
# elements that changed.
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_79', 'show', 'hide')" class="codepoplink">sql</a>    </span><span class="python_operator">
</span><span class="python_name">objectstore</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_79_div" class="codepop" style="display:none;">INSERT INTO keywords (name) VALUES (:name)<br/>
<br/>
{'name': 'topstories'}<br/>
<br/>
INSERT INTO keywords (name) VALUES (:name)<br/>
<br/>
{'name': 'government'}<br/>
<br/>
DELETE FROM article_keywords <br/>
WHERE article_keywords.article_id = :article_id <br/>
AND article_keywords.keyword_id = :keyword_id<br/>
<br/>
[{'keyword_id': 1, 'article_id': 1}, {'keyword_id': 2, 'article_id': 1}]<br/>
<br/>
INSERT INTO article_keywords (article_id, keyword_id) VALUES (:article_id, :keyword_id)<br/>
<br/>
[{'keyword_id': 3, 'article_id': 1}, {'keyword_id': 4, 'article_id': 1}]</div><pre><span class="python_operator"></span></pre></div>


    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>


        



<A name="datamapping_association"></a>

<div class="subsection" style="margin-left:20px;">

    <span class="sectionheadertext">Association Object</span>
    <div class="sectiontext">



        <p>Many to Many can also be done with an association object, that adds additional information about how two items are related.  This association object is set up in basically the same way as any other mapped object.  However, since an association table typically has no primary key columns, you have to tell the mapper what columns will compose its "primary key", which are the two (or more) columns involved in the association.  Also, the relation function needs an additional hint as to the fact that this mapped object is an association object, via the "association" argument which points to the class or mapper representing the other side of the association.</p>
        

<div class="code">
<pre><span class="python_comment"># add "attached_by" column which will reference the user who attached this keyword
</span><span class="python_name">itemkeywords </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'article_keywords'</span><span class="python_operator">, </span><span class="python_name">engine</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'article_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"articles.article_id"</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"keywords.keyword_id"</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'attached_by'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"users.user_id"</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># define an association class
</span><span class="python_keyword">class </span><span class="python_name">KeywordAssociation</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span>
<span class="python_comment"># mapper for KeywordAssociation
# specify "primary key" columns manually
</span><span class="python_operator"></span><span class="python_name">KeywordAssociation</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">KeywordAssociation</span><span class="python_operator">, </span><span class="python_name">itemkeywords</span><span class="python_operator">,</span>
        <span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_enclosure">[</span><span class="python_name">itemkeywords</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">article_id</span><span class="python_operator">, </span><span class="python_name">itemkeywords</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">keyword_id</span><span class="python_enclosure">]</span><span class="python_operator">,</span>
        <span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
            <span class="python_literal">'keyword' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_operator">, </span><span class="python_name">lazy </span><span class="python_operator">= </span><span class="python_name">False</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_comment"># uses primary Keyword mapper</span>
            <span class="python_literal">'user' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">lazy </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">) </span><span class="python_comment"># uses primary User mapper</span>
        <span class="python_enclosure">}</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># mappers for Users, Keywords
</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">Keyword</span><span class="python_operator">.</span><span class="python_name">mapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_operator">, </span><span class="python_name">keywords</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># define the mapper. 
</span><span class="python_name">m </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Article</span><span class="python_operator">, </span><span class="python_name">articles</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'keywords'</span><span class="python_operator">:</span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">KeywordAssociation</span><span class="python_operator">.</span><span class="python_name">mapper</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_operator">, </span><span class="python_name">association</span><span class="python_operator">=</span><span class="python_name">Keyword</span><span class="python_enclosure">)</span>
        <span class="python_enclosure">}</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># bonus step - well, we do want to load the users in one shot, 
# so modify the mapper via an option.
# this returns a new mapper with the option switched on.
</span><span class="python_name">m2 </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_operator">.</span><span class="python_name">options</span><span class="python_enclosure">(</span><span class="python_name">eagerload</span><span class="python_enclosure">(</span><span class="python_literal">'keywords.user'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># select by keyword again
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_80', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">alist </span><span class="python_operator">= </span><span class="python_name">m2</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">keyword_name</span><span class="python_operator">=</span><span class="python_literal">'jacks_stories'</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre><div id="popbox_80_div" class="codepop" style="display:none;">SELECT articles.article_id AS articles_article_id, <br/>
articles.article_headline AS articles_article_headline, <br/>
articles.article_body AS articles_article_body, <br/>
article_keywords.article_id AS article_keywords_article_id, <br/>
article_keywords.keyword_id AS article_keywords_keyword_id, <br/>
article_keywords.attached_by AS article_keywords_attached_by, <br/>
users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.password AS users_password, users.preference_id AS users_preference_id, <br/>
keywords.keyword_id AS keywords_keyword_id, keywords.name AS keywords_name <br/>
FROM article_keywords article_keywords_3a64, keywords keywords_11b7, <br/>
articles LEFT OUTER JOIN article_keywords ON articles.article_id = article_keywords.article_id <br/>
LEFT OUTER JOIN users ON users.user_id = article_keywords.attached_by <br/>
LEFT OUTER JOIN keywords ON keywords.keyword_id = article_keywords.keyword_id <br/>
WHERE keywords_11b7.keyword_id = article_keywords_3a64.keyword_id <br/>
AND article_keywords_3a64.article_id = articles.article_id <br/>
AND keywords_11b7.name = :keywords_name <br/>
ORDER BY articles.oid, article_keywords.oid, users.oid, keywords.oid<br/>
<br/>
{'keywords_name': 'jacks_stories'}</div><pre><span class="python_comment"># user is available
</span><span class="python_keyword">for </span><span class="python_name">a </span><span class="python_keyword">in </span><span class="python_name">alist</span><span class="python_operator">:
    </span><span class="python_keyword">for </span><span class="python_name">k </span><span class="python_keyword">in </span><span class="python_name">a</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">:
        </span><span class="python_keyword">if </span><span class="python_name">k</span><span class="python_operator">.</span><span class="python_name">keyword</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_literal">'jacks_stories'</span><span class="python_operator">:
            </span><span class="python_keyword">print </span><span class="python_name">k</span><span class="python_operator">.</span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator"></span></pre></div>

        

    </div>


    <a href="#datamapping" class="toclink">back to section top</a>


</div>




    
<div class="sectionnavblock">
<div class="sectionnav">


        Previous: <a href="sqlconstruction.html">Constructing SQL Queries via Python Expressions</a>

                |

        Next: <a href="unitofwork.html">Unit of Work</a>

</div>
</div>


</div>


		</div>






</div>

















<center>
</center>
</body>
</html>




